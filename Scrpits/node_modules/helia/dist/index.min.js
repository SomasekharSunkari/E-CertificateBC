(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.Helia = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var Helia=(()=>{var TT=Object.create;var xu=Object.defineProperty;var AT=Object.getOwnPropertyDescriptor;var DT=Object.getOwnPropertyNames;var CT=Object.getPrototypeOf,PT=Object.prototype.hasOwnProperty;var D8=(r=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(r,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):r)(function(r){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+r+'" is not supported')});var $e=(r,e)=>()=>(r&&(e=r(r=0)),e);var K=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Ce=(r,e)=>{for(var t in e)xu(r,t,{get:e[t],enumerable:!0})},C8=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of DT(e))!PT.call(r,s)&&s!==t&&xu(r,s,{get:()=>e[s],enumerable:!(n=AT(e,s))||n.enumerable});return r};var re=(r,e,t)=>(t=r!=null?TT(CT(r)):{},C8(e||!r||!r.__esModule?xu(t,"default",{value:r,enumerable:!0}):t,r)),vu=r=>C8(xu({},"__esModule",{value:!0}),r);var zd=K((n$,P8)=>{var Ho=1e3,Wo=Ho*60,Go=Wo*60,Hi=Go*24,kT=Hi*7,NT=Hi*365.25;P8.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return OT(r);if(t==="number"&&isFinite(r))return e.long?BT(r):LT(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function OT(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*NT;case"weeks":case"week":case"w":return t*kT;case"days":case"day":case"d":return t*Hi;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Go;case"minutes":case"minute":case"mins":case"min":case"m":return t*Wo;case"seconds":case"second":case"secs":case"sec":case"s":return t*Ho;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function LT(r){var e=Math.abs(r);return e>=Hi?Math.round(r/Hi)+"d":e>=Go?Math.round(r/Go)+"h":e>=Wo?Math.round(r/Wo)+"m":e>=Ho?Math.round(r/Ho)+"s":r+"ms"}function BT(r){var e=Math.abs(r);return e>=Hi?_u(r,e,Hi,"day"):e>=Go?_u(r,e,Go,"hour"):e>=Wo?_u(r,e,Wo,"minute"):e>=Ho?_u(r,e,Ho,"second"):r+" ms"}function _u(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}});var N8=K((s$,k8)=>{function MT(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=s,t.enabled=o,t.humanize=zd(),t.destroy=l,Object.keys(r).forEach(u=>{t[u]=r[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let f=0;for(let h=0;h<u.length;h++)f=(f<<5)-f+u.charCodeAt(h),f|=0;return t.colors[Math.abs(f)%t.colors.length]}t.selectColor=e;function t(u){let f,h=null,d,p;function m(...g){if(!m.enabled)return;let y=m,w=Number(new Date),E=w-(f||w);y.diff=E,y.prev=f,y.curr=w,f=w,g[0]=t.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let R=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(v,I)=>{if(v==="%%")return"%";R++;let _=t.formatters[I];if(typeof _=="function"){let D=g[R];v=_.call(y,D),g.splice(R,1),R--}return v}),t.formatArgs.call(y,g),(y.log||t.log).apply(y,g)}return m.namespace=u,m.useColors=t.useColors(),m.color=t.selectColor(u),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==t.namespaces&&(d=t.namespaces,p=t.enabled(u)),p),set:g=>{h=g}}),typeof t.init=="function"&&t.init(m),m}function n(u,f){let h=t(this.namespace+(typeof f>"u"?":":f)+u);return h.log=this.log,h}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let f,h=(typeof u=="string"?u:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(u=h[f].replace(/\*/g,".*?"),u[0]==="-"?t.skips.push(new RegExp("^"+u.slice(1)+"$")):t.names.push(new RegExp("^"+u+"$")))}function i(){let u=[...t.names.map(a),...t.skips.map(a).map(f=>"-"+f)].join(",");return t.enable(""),u}function o(u){if(u[u.length-1]==="*")return!0;let f,h;for(f=0,h=t.skips.length;f<h;f++)if(t.skips[f].test(u))return!1;for(f=0,h=t.names.length;f<h;f++)if(t.names[f].test(u))return!0;return!1}function a(u){return u.toString().substring(2,u.toString().length-2).replace(/\.\*\?$/,"*")}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}k8.exports=MT});var $d=K((Mr,Su)=>{Mr.formatArgs=FT;Mr.save=KT;Mr.load=VT;Mr.useColors=UT;Mr.storage=qT();Mr.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Mr.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function UT(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function FT(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Su.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),r.splice(n,0,e)}Mr.log=console.debug||console.log||(()=>{});function KT(r){try{r?Mr.storage.setItem("debug",r):Mr.storage.removeItem("debug")}catch{}}function VT(){let r;try{r=Mr.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function qT(){try{return localStorage}catch{}}Su.exports=N8()(Mr);var{formatters:zT}=Su.exports;zT.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Qo=K((y$,V8)=>{"use strict";function K8(r,e){for(let t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function aA(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return K8(r,t)}catch{t.message=r.message,t.stack=r.stack;let s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(r)),K8(new s,t)}}V8.exports=aA});var yg=K((jW,gg)=>{gg.exports=mg;var pg=128,vD=127,_D=~vD,SD=Math.pow(2,31);function mg(r,e,t){e=e||[],t=t||0;for(var n=t;r>=SD;)e[t++]=r&255|pg,r/=128;for(;r&_D;)e[t++]=r&255|pg,r>>>=7;return e[t]=r|0,mg.bytes=t-n+1,e}});var Eg=K((ZW,wg)=>{wg.exports=w1;var RD=128,bg=127;function w1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw w1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&bg)<<s:(o&bg)*Math.pow(2,s),s+=7}while(o>=RD);return w1.bytes=i-n,t}});var vg=K((JW,xg)=>{var ID=Math.pow(2,7),TD=Math.pow(2,14),AD=Math.pow(2,21),DD=Math.pow(2,28),CD=Math.pow(2,35),PD=Math.pow(2,42),kD=Math.pow(2,49),ND=Math.pow(2,56),OD=Math.pow(2,63);xg.exports=function(r){return r<ID?1:r<TD?2:r<AD?3:r<DD?4:r<CD?5:r<PD?6:r<kD?7:r<ND?8:r<OD?9:10}});var Sg=K((eG,_g)=>{_g.exports={encode:yg(),decode:Eg(),encodingLength:vg()}});var Tg=K((tG,Ig)=>{"use strict";var Rg=Sg();Ig.exports=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");let e=[];for(;r.length>0;){let t=Rg.decode(r);e.push(t),r=r.slice(Rg.decode.bytes)}return e}});var Cg=K((hG,Dg)=>{Dg.exports=E1;var Ag=128,LD=127,BD=~LD,MD=Math.pow(2,31);function E1(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw E1.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=MD;)e[t++]=r&255|Ag,r/=128;for(;r&BD;)e[t++]=r&255|Ag,r>>>=7;return e[t]=r|0,E1.bytes=t-n+1,e}});var Ng=K((dG,kg)=>{kg.exports=x1;var UD=128,Pg=127;function x1(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a||s>49)throw x1.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Pg)<<s:(o&Pg)*Math.pow(2,s),s+=7}while(o>=UD);return x1.bytes=i-n,t}});var Lg=K((pG,Og)=>{var FD=Math.pow(2,7),KD=Math.pow(2,14),VD=Math.pow(2,21),qD=Math.pow(2,28),zD=Math.pow(2,35),$D=Math.pow(2,42),HD=Math.pow(2,49),WD=Math.pow(2,56),GD=Math.pow(2,63);Og.exports=function(r){return r<FD?1:r<KD?2:r<VD?3:r<qD?4:r<zD?5:r<$D?6:r<HD?7:r<WD?8:r<GD?9:10}});var Mg=K((mG,Bg)=>{Bg.exports={encode:Cg(),decode:Ng(),encodingLength:Lg()}});var Kg=K((yG,Fg)=>{"use strict";Fg.exports=QD;function QD(r,e){for(var t=new Array(arguments.length-1),n=0,s=2,i=!0;s<arguments.length;)t[n++]=arguments[s++];return new Promise(function(a,c){t[n]=function(u){if(i)if(i=!1,u)c(u);else{for(var f=new Array(arguments.length-1),h=0;h<f.length;)f[h++]=arguments[h];a.apply(null,f)}};try{r.apply(e||null,t)}catch(l){i&&(i=!1,c(l))}})}});var $g=K(zg=>{"use strict";var Nu=zg;Nu.length=function(e){var t=e.length;if(!t)return 0;for(var n=0;--t%4>1&&e.charAt(t)==="=";)++n;return Math.ceil(e.length*3)/4-n};var ta=new Array(64),qg=new Array(123);for(An=0;An<64;)qg[ta[An]=An<26?An+65:An<52?An+71:An<62?An-4:An-59|43]=An++;var An;Nu.encode=function(e,t,n){for(var s=null,i=[],o=0,a=0,c;t<n;){var l=e[t++];switch(a){case 0:i[o++]=ta[l>>2],c=(l&3)<<4,a=1;break;case 1:i[o++]=ta[c|l>>4],c=(l&15)<<2,a=2;break;case 2:i[o++]=ta[c|l>>6],i[o++]=ta[l&63],a=0;break}o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,i)),o=0)}return a&&(i[o++]=ta[c],i[o++]=61,a===1&&(i[o++]=61)),s?(o&&s.push(String.fromCharCode.apply(String,i.slice(0,o))),s.join("")):String.fromCharCode.apply(String,i.slice(0,o))};var Vg="invalid encoding";Nu.decode=function(e,t,n){for(var s=n,i=0,o,a=0;a<e.length;){var c=e.charCodeAt(a++);if(c===61&&i>1)break;if((c=qg[c])===void 0)throw Error(Vg);switch(i){case 0:o=c,i=1;break;case 1:t[n++]=o<<2|(c&48)>>4,o=c,i=2;break;case 2:t[n++]=(o&15)<<4|(c&60)>>2,o=c,i=3;break;case 3:t[n++]=(o&3)<<6|c,i=0;break}}if(i===1)throw Error(Vg);return n-s};Nu.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}});var Wg=K((wG,Hg)=>{"use strict";Hg.exports=Ou;function Ou(){this._listeners={}}Ou.prototype.on=function(e,t,n){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:n||this}),this};Ou.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var n=this._listeners[e],s=0;s<n.length;)n[s].fn===t?n.splice(s,1):++s;return this};Ou.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var n=[],s=1;s<arguments.length;)n.push(arguments[s++]);for(s=0;s<t.length;)t[s].fn.apply(t[s++].ctx,n)}return this}});var Jg=K((EG,Zg)=>{"use strict";Zg.exports=Gg(Gg);function Gg(r){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),n=t[3]===128;function s(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3]}function i(c,l,u){e[0]=c,l[u]=t[3],l[u+1]=t[2],l[u+2]=t[1],l[u+3]=t[0]}r.writeFloatLE=n?s:i,r.writeFloatBE=n?i:s;function o(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],e[0]}function a(c,l){return t[3]=c[l],t[2]=c[l+1],t[1]=c[l+2],t[0]=c[l+3],e[0]}r.readFloatLE=n?o:a,r.readFloatBE=n?a:o}():function(){function e(n,s,i,o){var a=s<0?1:0;if(a&&(s=-s),s===0)n(1/s>0?0:2147483648,i,o);else if(isNaN(s))n(2143289344,i,o);else if(s>34028234663852886e22)n((a<<31|2139095040)>>>0,i,o);else if(s<11754943508222875e-54)n((a<<31|Math.round(s/1401298464324817e-60))>>>0,i,o);else{var c=Math.floor(Math.log(s)/Math.LN2),l=Math.round(s*Math.pow(2,-c)*8388608)&8388607;n((a<<31|c+127<<23|l)>>>0,i,o)}}r.writeFloatLE=e.bind(null,Yg),r.writeFloatBE=e.bind(null,Qg);function t(n,s,i){var o=n(s,i),a=(o>>31)*2+1,c=o>>>23&255,l=o&8388607;return c===255?l?NaN:a*(1/0):c===0?a*1401298464324817e-60*l:a*Math.pow(2,c-150)*(l+8388608)}r.readFloatLE=t.bind(null,Xg),r.readFloatBE=t.bind(null,jg)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),n=t[7]===128;function s(c,l,u){e[0]=c,l[u]=t[0],l[u+1]=t[1],l[u+2]=t[2],l[u+3]=t[3],l[u+4]=t[4],l[u+5]=t[5],l[u+6]=t[6],l[u+7]=t[7]}function i(c,l,u){e[0]=c,l[u]=t[7],l[u+1]=t[6],l[u+2]=t[5],l[u+3]=t[4],l[u+4]=t[3],l[u+5]=t[2],l[u+6]=t[1],l[u+7]=t[0]}r.writeDoubleLE=n?s:i,r.writeDoubleBE=n?i:s;function o(c,l){return t[0]=c[l],t[1]=c[l+1],t[2]=c[l+2],t[3]=c[l+3],t[4]=c[l+4],t[5]=c[l+5],t[6]=c[l+6],t[7]=c[l+7],e[0]}function a(c,l){return t[7]=c[l],t[6]=c[l+1],t[5]=c[l+2],t[4]=c[l+3],t[3]=c[l+4],t[2]=c[l+5],t[1]=c[l+6],t[0]=c[l+7],e[0]}r.readDoubleLE=n?o:a,r.readDoubleBE=n?a:o}():function(){function e(n,s,i,o,a,c){var l=o<0?1:0;if(l&&(o=-o),o===0)n(0,a,c+s),n(1/o>0?0:2147483648,a,c+i);else if(isNaN(o))n(0,a,c+s),n(2146959360,a,c+i);else if(o>17976931348623157e292)n(0,a,c+s),n((l<<31|2146435072)>>>0,a,c+i);else{var u;if(o<22250738585072014e-324)u=o/5e-324,n(u>>>0,a,c+s),n((l<<31|u/4294967296)>>>0,a,c+i);else{var f=Math.floor(Math.log(o)/Math.LN2);f===1024&&(f=1023),u=o*Math.pow(2,-f),n(u*4503599627370496>>>0,a,c+s),n((l<<31|f+1023<<20|u*1048576&1048575)>>>0,a,c+i)}}}r.writeDoubleLE=e.bind(null,Yg,0,4),r.writeDoubleBE=e.bind(null,Qg,4,0);function t(n,s,i,o,a){var c=n(o,a+s),l=n(o,a+i),u=(l>>31)*2+1,f=l>>>20&2047,h=4294967296*(l&1048575)+c;return f===2047?h?NaN:u*(1/0):f===0?u*5e-324*h:u*Math.pow(2,f-1075)*(h+4503599627370496)}r.readDoubleLE=t.bind(null,Xg,0,4),r.readDoubleBE=t.bind(null,jg,4,0)}(),r}function Yg(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function Qg(r,e,t){e[t]=r>>>24,e[t+1]=r>>>16&255,e[t+2]=r>>>8&255,e[t+3]=r&255}function Xg(r,e){return(r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24)>>>0}function jg(r,e){return(r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3])>>>0}});var e5=K((exports,module)=>{"use strict";module.exports=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(r){}return null}});var r5=K(t5=>{"use strict";var v1=t5;v1.length=function(e){for(var t=0,n=0,s=0;s<e.length;++s)n=e.charCodeAt(s),n<128?t+=1:n<2048?t+=2:(n&64512)===55296&&(e.charCodeAt(s+1)&64512)===56320?(++s,t+=4):t+=3;return t};v1.read=function(e,t,n){var s=n-t;if(s<1)return"";for(var i=null,o=[],a=0,c;t<n;)c=e[t++],c<128?o[a++]=c:c>191&&c<224?o[a++]=(c&31)<<6|e[t++]&63:c>239&&c<365?(c=((c&7)<<18|(e[t++]&63)<<12|(e[t++]&63)<<6|e[t++]&63)-65536,o[a++]=55296+(c>>10),o[a++]=56320+(c&1023)):o[a++]=(c&15)<<12|(e[t++]&63)<<6|e[t++]&63,a>8191&&((i||(i=[])).push(String.fromCharCode.apply(String,o)),a=0);return i?(a&&i.push(String.fromCharCode.apply(String,o.slice(0,a))),i.join("")):String.fromCharCode.apply(String,o.slice(0,a))};v1.write=function(e,t,n){for(var s=n,i,o,a=0;a<e.length;++a)i=e.charCodeAt(a),i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):(i&64512)===55296&&((o=e.charCodeAt(a+1))&64512)===56320?(i=65536+((i&1023)<<10)+(o&1023),++a,t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128);return n-s}});var s5=K((vG,n5)=>{"use strict";n5.exports=XD;function XD(r,e,t){var n=t||8192,s=n>>>1,i=null,o=n;return function(c){if(c<1||c>s)return r(c);o+c>n&&(i=r(n),o=0);var l=e.call(i,o,o+=c);return o&7&&(o=(o|7)+1),l}}});var o5=K((_G,i5)=>{"use strict";i5.exports=Ft;var Bc=Rs();function Ft(r,e){this.lo=r>>>0,this.hi=e>>>0}var Zi=Ft.zero=new Ft(0,0);Zi.toNumber=function(){return 0};Zi.zzEncode=Zi.zzDecode=function(){return this};Zi.length=function(){return 1};var jD=Ft.zeroHash="\0\0\0\0\0\0\0\0";Ft.fromNumber=function(e){if(e===0)return Zi;var t=e<0;t&&(e=-e);var n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new Ft(n,s)};Ft.from=function(e){if(typeof e=="number")return Ft.fromNumber(e);if(Bc.isString(e))if(Bc.Long)e=Bc.Long.fromString(e);else return Ft.fromNumber(parseInt(e,10));return e.low||e.high?new Ft(e.low>>>0,e.high>>>0):Zi};Ft.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=~this.lo+1>>>0,n=~this.hi>>>0;return t||(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296};Ft.prototype.toLong=function(e){return Bc.Long?new Bc.Long(this.lo|0,this.hi|0,!!e):{low:this.lo|0,high:this.hi|0,unsigned:!!e}};var ri=String.prototype.charCodeAt;Ft.fromHash=function(e){return e===jD?Zi:new Ft((ri.call(e,0)|ri.call(e,1)<<8|ri.call(e,2)<<16|ri.call(e,3)<<24)>>>0,(ri.call(e,4)|ri.call(e,5)<<8|ri.call(e,6)<<16|ri.call(e,7)<<24)>>>0)};Ft.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)};Ft.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this};Ft.prototype.zzDecode=function(){var e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this};Ft.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}});var Rs=K(_1=>{"use strict";var ie=_1;ie.asPromise=Kg();ie.base64=$g();ie.EventEmitter=Wg();ie.float=Jg();ie.inquire=e5();ie.utf8=r5();ie.pool=s5();ie.LongBits=o5();ie.isNode=!!(typeof globalThis<"u"&&globalThis&&globalThis.process&&globalThis.process.versions&&globalThis.process.versions.node);ie.global=ie.isNode&&globalThis||typeof window<"u"&&window||typeof self<"u"&&self||_1;ie.emptyArray=Object.freeze?Object.freeze([]):[];ie.emptyObject=Object.freeze?Object.freeze({}):{};ie.isInteger=Number.isInteger||function(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e};ie.isString=function(e){return typeof e=="string"||e instanceof String};ie.isObject=function(e){return e&&typeof e=="object"};ie.isset=ie.isSet=function(e,t){var n=e[t];return n!=null&&e.hasOwnProperty(t)?typeof n!="object"||(Array.isArray(n)?n.length:Object.keys(n).length)>0:!1};ie.Buffer=function(){try{var r=ie.inquire("buffer").Buffer;return r.prototype.utf8Write?r:null}catch{return null}}();ie._Buffer_from=null;ie._Buffer_allocUnsafe=null;ie.newBuffer=function(e){return typeof e=="number"?ie.Buffer?ie._Buffer_allocUnsafe(e):new ie.Array(e):ie.Buffer?ie._Buffer_from(e):typeof Uint8Array>"u"?e:new Uint8Array(e)};ie.Array=typeof Uint8Array<"u"?Uint8Array:Array;ie.Long=ie.global.dcodeIO&&ie.global.dcodeIO.Long||ie.global.Long||ie.inquire("long");ie.key2Re=/^true|false|0|1$/;ie.key32Re=/^-?(?:0|[1-9][0-9]*)$/;ie.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/;ie.longToHash=function(e){return e?ie.LongBits.from(e).toHash():ie.LongBits.zeroHash};ie.longFromHash=function(e,t){var n=ie.LongBits.fromHash(e);return ie.Long?ie.Long.fromBits(n.lo,n.hi,t):n.toNumber(!!t)};function a5(r,e,t){for(var n=Object.keys(e),s=0;s<n.length;++s)(r[n[s]]===void 0||!t)&&(r[n[s]]=e[n[s]]);return r}ie.merge=a5;ie.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)};function c5(r){function e(t,n){if(!(this instanceof e))return new e(t,n);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:new Error().stack||""}),n&&a5(this,n)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return r},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}ie.newError=c5;ie.ProtocolError=c5("ProtocolError");ie.oneOfGetter=function(e){for(var t={},n=0;n<e.length;++n)t[e[n]]=1;return function(){for(var s=Object.keys(this),i=s.length-1;i>-1;--i)if(t[s[i]]===1&&this[s[i]]!==void 0&&this[s[i]]!==null)return s[i]}};ie.oneOfSetter=function(e){return function(t){for(var n=0;n<e.length;++n)e[n]!==t&&delete this[e[n]]}};ie.toJSONOptions={longs:String,enums:String,bytes:String,json:!0};ie._configure=function(){var r=ie.Buffer;if(!r){ie._Buffer_from=ie._Buffer_allocUnsafe=null;return}ie._Buffer_from=r.from!==Uint8Array.from&&r.from||function(t,n){return new r(t,n)},ie._Buffer_allocUnsafe=r.allocUnsafe||function(t){return new r(t)}}});var Bu=K((RG,d5)=>{"use strict";d5.exports=vt;var Dn=Rs(),R1,f5=Dn.LongBits,ZD=Dn.utf8;function Cn(r,e){return RangeError("index out of range: "+r.pos+" + "+(e||1)+" > "+r.len)}function vt(r){this.buf=r,this.pos=0,this.len=r.length}var l5=typeof Uint8Array<"u"?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new vt(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new vt(e);throw Error("illegal buffer")},h5=function(){return Dn.Buffer?function(t){return(vt.create=function(s){return Dn.Buffer.isBuffer(s)?new R1(s):l5(s)})(t)}:l5};vt.create=h5();vt.prototype._slice=Dn.Array.prototype.subarray||Dn.Array.prototype.slice;vt.prototype.uint32=function(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Cn(this,10);return e}}();vt.prototype.int32=function(){return this.uint32()|0};vt.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(e&1)|0};function S1(){var r=new f5(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r;if(r.lo=(r.lo|(this.buf[this.pos]&127)<<28)>>>0,r.hi=(r.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return r;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw Cn(this);if(r.lo=(r.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return r}return r.lo=(r.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,r}if(this.len-this.pos>4){for(;e<5;++e)if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}else for(;e<5;++e){if(this.pos>=this.len)throw Cn(this);if(r.hi=(r.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return r}throw Error("invalid varint encoding")}vt.prototype.bool=function(){return this.uint32()!==0};function Lu(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}vt.prototype.fixed32=function(){if(this.pos+4>this.len)throw Cn(this,4);return Lu(this.buf,this.pos+=4)};vt.prototype.sfixed32=function(){if(this.pos+4>this.len)throw Cn(this,4);return Lu(this.buf,this.pos+=4)|0};function u5(){if(this.pos+8>this.len)throw Cn(this,8);return new f5(Lu(this.buf,this.pos+=4),Lu(this.buf,this.pos+=4))}vt.prototype.float=function(){if(this.pos+4>this.len)throw Cn(this,4);var e=Dn.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};vt.prototype.double=function(){if(this.pos+8>this.len)throw Cn(this,4);var e=Dn.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};vt.prototype.bytes=function(){var e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw Cn(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(t,n);if(t===n){var s=Dn.Buffer;return s?s.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,t,n)};vt.prototype.string=function(){var e=this.bytes();return ZD.read(e,0,e.length)};vt.prototype.skip=function(e){if(typeof e=="number"){if(this.pos+e>this.len)throw Cn(this,e);this.pos+=e}else do if(this.pos>=this.len)throw Cn(this);while(this.buf[this.pos++]&128);return this};vt.prototype.skipType=function(r){switch(r){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(r=this.uint32()&7)!==4;)this.skipType(r);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+r+" at offset "+this.pos)}return this};vt._configure=function(r){R1=r,vt.create=h5(),R1._configure();var e=Dn.Long?"toLong":"toNumber";Dn.merge(vt.prototype,{int64:function(){return S1.call(this)[e](!1)},uint64:function(){return S1.call(this)[e](!0)},sint64:function(){return S1.call(this).zzDecode()[e](!1)},fixed64:function(){return u5.call(this)[e](!0)},sfixed64:function(){return u5.call(this)[e](!1)}})}});var I1=K((IG,g5)=>{"use strict";g5.exports=Ji;var m5=Bu();(Ji.prototype=Object.create(m5.prototype)).constructor=Ji;var p5=Rs();function Ji(r){m5.call(this,r)}Ji._configure=function(){p5.Buffer&&(Ji.prototype._slice=p5.Buffer.prototype.slice)};Ji.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};Ji._configure()});var Uu=K((TG,E5)=>{"use strict";E5.exports=Be;var cn=Rs(),T1,Mu=cn.LongBits,y5=cn.base64,b5=cn.utf8;function Mc(r,e,t){this.fn=r,this.len=e,this.next=void 0,this.val=t}function D1(){}function JD(r){this.head=r.head,this.tail=r.tail,this.len=r.len,this.next=r.states}function Be(){this.len=0,this.head=new Mc(D1,0,0),this.tail=this.head,this.states=null}var w5=function(){return cn.Buffer?function(){return(Be.create=function(){return new T1})()}:function(){return new Be}};Be.create=w5();Be.alloc=function(e){return new cn.Array(e)};cn.Array!==Array&&(Be.alloc=cn.pool(Be.alloc,cn.Array.prototype.subarray));Be.prototype._push=function(e,t,n){return this.tail=this.tail.next=new Mc(e,t,n),this.len+=t,this};function C1(r,e,t){e[t]=r&255}function eC(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}function P1(r,e){this.len=r,this.next=void 0,this.val=e}P1.prototype=Object.create(Mc.prototype);P1.prototype.fn=eC;Be.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new P1((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};Be.prototype.int32=function(e){return e<0?this._push(k1,10,Mu.fromNumber(e)):this.uint32(e)};Be.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)};function k1(r,e,t){for(;r.hi;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}Be.prototype.uint64=function(e){var t=Mu.from(e);return this._push(k1,t.length(),t)};Be.prototype.int64=Be.prototype.uint64;Be.prototype.sint64=function(e){var t=Mu.from(e).zzEncode();return this._push(k1,t.length(),t)};Be.prototype.bool=function(e){return this._push(C1,1,e?1:0)};function A1(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}Be.prototype.fixed32=function(e){return this._push(A1,4,e>>>0)};Be.prototype.sfixed32=Be.prototype.fixed32;Be.prototype.fixed64=function(e){var t=Mu.from(e);return this._push(A1,4,t.lo)._push(A1,4,t.hi)};Be.prototype.sfixed64=Be.prototype.fixed64;Be.prototype.float=function(e){return this._push(cn.float.writeFloatLE,4,e)};Be.prototype.double=function(e){return this._push(cn.float.writeDoubleLE,8,e)};var tC=cn.Array.prototype.set?function(e,t,n){t.set(e,n)}:function(e,t,n){for(var s=0;s<e.length;++s)t[n+s]=e[s]};Be.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(C1,1,0);if(cn.isString(e)){var n=Be.alloc(t=y5.length(e));y5.decode(e,n,0),e=n}return this.uint32(t)._push(tC,t,e)};Be.prototype.string=function(e){var t=b5.length(e);return t?this.uint32(t)._push(b5.write,t,e):this._push(C1,1,0)};Be.prototype.fork=function(){return this.states=new JD(this),this.head=this.tail=new Mc(D1,0,0),this.len=0,this};Be.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Mc(D1,0,0),this.len=0),this};Be.prototype.ldelim=function(){var e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n&&(this.tail.next=e.next,this.tail=t,this.len+=n),this};Be.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),n=0;e;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t};Be._configure=function(r){T1=r,Be.create=w5(),T1._configure()}});var N1=K((AG,v5)=>{"use strict";v5.exports=rs;var x5=Uu();(rs.prototype=Object.create(x5.prototype)).constructor=rs;var ni=Rs();function rs(){x5.call(this)}rs._configure=function(){rs.alloc=ni._Buffer_allocUnsafe,rs.writeBytesBuffer=ni.Buffer&&ni.Buffer.prototype instanceof Uint8Array&&ni.Buffer.prototype.set.name==="set"?function(e,t,n){t.set(e,n)}:function(e,t,n){if(e.copy)e.copy(t,n,0,e.length);else for(var s=0;s<e.length;)t[n++]=e[s++]}};rs.prototype.bytes=function(e){ni.isString(e)&&(e=ni._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(rs.writeBytesBuffer,t,e),this};function rC(r,e,t){r.length<40?ni.utf8.write(r,e,t):e.utf8Write?e.utf8Write(r,t):e.write(r,t)}rs.prototype.string=function(e){var t=ni.Buffer.byteLength(e);return this.uint32(t),t&&this._push(rC,t,e),this};rs._configure()});var O5=K((qY,N5)=>{"use strict";N5.exports=function(){return Date.now()}});var B5=K((zY,L5)=>{"use strict";var Gu=O5(),$1=class{constructor(e,t,n){let s=this;this._started=Gu(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(Gu()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);let t=Gu();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=Gu(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}};function wC(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new $1(arguments[0],arguments[1],r)}L5.exports=wC});var F5=K(($Y,U5)=>{"use strict";var{AbortController:EC}=globalThis,M5=B5(),H1=class r extends EC{constructor(e){super(),this._ms=e,this._timer=M5(()=>this.abort(),e),Object.setPrototypeOf(this,r.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=M5(()=>this.abort(),this._ms)}};U5.exports={TimeoutController:H1}});var Dr=K((eQ,X1)=>{"use strict";var sa=typeof Reflect=="object"?Reflect:null,$5=sa&&typeof sa.apply=="function"?sa.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Qu;sa&&typeof sa.ownKeys=="function"?Qu=sa.ownKeys:Object.getOwnPropertySymbols?Qu=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Qu=function(e){return Object.getOwnPropertyNames(e)};function RC(r){console&&console.warn&&console.warn(r)}var W5=Number.isNaN||function(e){return e!==e};function Xe(){Xe.init.call(this)}X1.exports=Xe;X1.exports.once=DC;Xe.EventEmitter=Xe;Xe.prototype._events=void 0;Xe.prototype._eventsCount=0;Xe.prototype._maxListeners=void 0;var H5=10;function Xu(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(Xe,"defaultMaxListeners",{enumerable:!0,get:function(){return H5},set:function(r){if(typeof r!="number"||r<0||W5(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");H5=r}});Xe.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};Xe.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||W5(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function G5(r){return r._maxListeners===void 0?Xe.defaultMaxListeners:r._maxListeners}Xe.prototype.getMaxListeners=function(){return G5(this)};Xe.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s=e==="error",i=this._events;if(i!==void 0)s=s&&i.error===void 0;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")$5(c,this,t);else for(var l=c.length,u=Z5(c,l),n=0;n<l;++n)$5(u[n],this,t);return!0};function Y5(r,e,t,n){var s,i,o;if(Xu(t),i=r._events,i===void 0?(i=r._events=Object.create(null),r._eventsCount=0):(i.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),i=r._events),o=i[e]),o===void 0)o=i[e]=t,++r._eventsCount;else if(typeof o=="function"?o=i[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),s=G5(r),s>0&&o.length>s&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,RC(a)}return r}Xe.prototype.addListener=function(e,t){return Y5(this,e,t,!1)};Xe.prototype.on=Xe.prototype.addListener;Xe.prototype.prependListener=function(e,t){return Y5(this,e,t,!0)};function IC(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Q5(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},s=IC.bind(n);return s.listener=t,n.wrapFn=s,s}Xe.prototype.once=function(e,t){return Xu(t),this.on(e,Q5(this,e,t)),this};Xe.prototype.prependOnceListener=function(e,t){return Xu(t),this.prependListener(e,Q5(this,e,t)),this};Xe.prototype.removeListener=function(e,t){var n,s,i,o,a;if(Xu(t),s=this._events,s===void 0)return this;if(n=s[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;i===0?n.shift():TC(n,i),n.length===1&&(s[e]=n[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};Xe.prototype.off=Xe.prototype.removeListener;Xe.prototype.removeAllListeners=function(e){var t,n,s;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var i=Object.keys(n),o;for(s=0;s<i.length;++s)o=i[s],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function X5(r,e,t){var n=r._events;if(n===void 0)return[];var s=n[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?AC(s):Z5(s,s.length)}Xe.prototype.listeners=function(e){return X5(this,e,!0)};Xe.prototype.rawListeners=function(e){return X5(this,e,!1)};Xe.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):j5.call(r,e)};Xe.prototype.listenerCount=j5;function j5(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}Xe.prototype.eventNames=function(){return this._eventsCount>0?Qu(this._events):[]};function Z5(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function TC(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function AC(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function DC(r,e){return new Promise(function(t,n){function s(o){r.removeListener(e,i),n(o)}function i(){typeof r.removeListener=="function"&&r.removeListener("error",s),t([].slice.call(arguments))}J5(r,e,i,{once:!0}),e!=="error"&&CC(r,s,{once:!0})})}function CC(r,e,t){typeof r.on=="function"&&J5(r,"error",e,t)}function J5(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function s(i){n.once&&r.removeEventListener(e,s),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var i6=K((n6,s6)=>{"use strict";var PC=Math.exp;n6=s6.exports=function(e){if(typeof e!="number")throw new Error("must provide a timespan to the moving average constructor");if(e<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let t,n=0,s=0,i=0,o,a={};function c(l,u){return 1-PC(-(l-u)/e)}return a.push=function(u,f){if(o){let h=c(u,o),d=f-t,p=h*d;t=h*f+(1-h)*t,n=(1-h)*(n+d*p),s=Math.sqrt(n),i=t+h*d}else t=f;o=u},a.movingAverage=function(){return t},a.variance=function(){return n},a.deviation=function(){return s},a.forecast=function(){return i},a}});var gy=K((PX,op)=>{"use strict";var lP=Object.prototype.hasOwnProperty,yr="~";function Gc(){}Object.create&&(Gc.prototype=Object.create(null),new Gc().__proto__||(yr=!1));function uP(r,e,t){this.fn=r,this.context=e,this.once=t||!1}function my(r,e,t,n,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var i=new uP(t,n||r,s),o=yr?yr+e:e;return r._events[o]?r._events[o].fn?r._events[o]=[r._events[o],i]:r._events[o].push(i):(r._events[o]=i,r._eventsCount++),r}function m0(r,e){--r._eventsCount===0?r._events=new Gc:delete r._events[e]}function ar(){this._events=new Gc,this._eventsCount=0}ar.prototype.eventNames=function(){var e=[],t,n;if(this._eventsCount===0)return e;for(n in t=this._events)lP.call(t,n)&&e.push(yr?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};ar.prototype.listeners=function(e){var t=yr?yr+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,o=new Array(i);s<i;s++)o[s]=n[s].fn;return o};ar.prototype.listenerCount=function(e){var t=yr?yr+e:e,n=this._events[t];return n?n.fn?1:n.length:0};ar.prototype.emit=function(e,t,n,s,i,o){var a=yr?yr+e:e;if(!this._events[a])return!1;var c=this._events[a],l=arguments.length,u,f;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),l){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,s),!0;case 5:return c.fn.call(c.context,t,n,s,i),!0;case 6:return c.fn.call(c.context,t,n,s,i,o),!0}for(f=1,u=new Array(l-1);f<l;f++)u[f-1]=arguments[f];c.fn.apply(c.context,u)}else{var h=c.length,d;for(f=0;f<h;f++)switch(c[f].once&&this.removeListener(e,c[f].fn,void 0,!0),l){case 1:c[f].fn.call(c[f].context);break;case 2:c[f].fn.call(c[f].context,t);break;case 3:c[f].fn.call(c[f].context,t,n);break;case 4:c[f].fn.call(c[f].context,t,n,s);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];c[f].fn.apply(c[f].context,u)}}return!0};ar.prototype.on=function(e,t,n){return my(this,e,t,n,!1)};ar.prototype.once=function(e,t,n){return my(this,e,t,n,!0)};ar.prototype.removeListener=function(e,t,n,s){var i=yr?yr+e:e;if(!this._events[i])return this;if(!t)return m0(this,i),this;var o=this._events[i];if(o.fn)o.fn===t&&(!s||o.once)&&(!n||o.context===n)&&m0(this,i);else{for(var a=0,c=[],l=o.length;a<l;a++)(o[a].fn!==t||s&&!o[a].once||n&&o[a].context!==n)&&c.push(o[a]);c.length?this._events[i]=c.length===1?c[0]:c:m0(this,i)}return this};ar.prototype.removeAllListeners=function(e){var t;return e?(t=yr?yr+e:e,this._events[t]&&m0(this,t)):(this._events=new Gc,this._eventsCount=0),this};ar.prototype.off=ar.prototype.removeListener;ar.prototype.addListener=ar.prototype.on;ar.prefixed=yr;ar.EventEmitter=ar;typeof op<"u"&&(op.exports=ar)});var Qe=K((mZ,Zy)=>{Zy.exports={options:{usePureJavaScript:!1}}});var t7=K((gZ,e7)=>{var Dp={};e7.exports=Dp;var Jy={};Dp.encode=function(r,e,t){if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');if(t!==void 0&&typeof t!="number")throw new TypeError('"maxline" must be a number.');var n="";if(!(r instanceof Uint8Array))n=RP(r,e);else{var s=0,i=e.length,o=e.charAt(0),a=[0];for(s=0;s<r.length;++s){for(var c=0,l=r[s];c<a.length;++c)l+=a[c]<<8,a[c]=l%i,l=l/i|0;for(;l>0;)a.push(l%i),l=l/i|0}for(s=0;r[s]===0&&s<r.length-1;++s)n+=o;for(s=a.length-1;s>=0;--s)n+=e[a[s]]}if(t){var u=new RegExp(".{1,"+t+"}","g");n=n.match(u).join(`\r
`)}return n};Dp.decode=function(r,e){if(typeof r!="string")throw new TypeError('"input" must be a string.');if(typeof e!="string")throw new TypeError('"alphabet" must be a string.');var t=Jy[e];if(!t){t=Jy[e]=[];for(var n=0;n<e.length;++n)t[e.charCodeAt(n)]=n}r=r.replace(/\s/g,"");for(var s=e.length,i=e.charAt(0),o=[0],n=0;n<r.length;n++){var a=t[r.charCodeAt(n)];if(a===void 0)return;for(var c=0,l=a;c<o.length;++c)l+=o[c]*s,o[c]=l&255,l>>=8;for(;l>0;)o.push(l&255),l>>=8}for(var u=0;r[u]===i&&u<r.length-1;++u)o.push(0);return typeof Buffer<"u"?Buffer.from(o.reverse()):new Uint8Array(o.reverse())};function RP(r,e){var t=0,n=e.length,s=e.charAt(0),i=[0];for(t=0;t<r.length();++t){for(var o=0,a=r.at(t);o<i.length;++o)a+=i[o]<<8,i[o]=a%n,a=a/n|0;for(;a>0;)i.push(a%n),a=a/n|0}var c="";for(t=0;r.at(t)===0&&t<r.length()-1;++t)c+=s;for(t=i.length-1;t>=0;--t)c+=e[i[t]];return c}});var Rt=K((yZ,i7)=>{var r7=Qe(),n7=t7(),S=i7.exports=r7.util=r7.util||{};(function(){if(typeof process<"u"&&process.nextTick&&!process.browser){S.nextTick=process.nextTick,typeof setImmediate=="function"?S.setImmediate=setImmediate:S.setImmediate=S.nextTick;return}if(typeof setImmediate=="function"){S.setImmediate=function(){return setImmediate.apply(void 0,arguments)},S.nextTick=function(a){return setImmediate(a)};return}if(S.setImmediate=function(a){setTimeout(a,0)},typeof window<"u"&&typeof window.postMessage=="function"){let a=function(c){if(c.source===window&&c.data===r){c.stopPropagation();var l=e.slice();e.length=0,l.forEach(function(u){u()})}};var o=a,r="forge.setImmediate",e=[];S.setImmediate=function(c){e.push(c),e.length===1&&window.postMessage(r,"*")},window.addEventListener("message",a,!0)}if(typeof MutationObserver<"u"){var t=Date.now(),n=!0,s=document.createElement("div"),e=[];new MutationObserver(function(){var c=e.slice();e.length=0,c.forEach(function(l){l()})}).observe(s,{attributes:!0});var i=S.setImmediate;S.setImmediate=function(c){Date.now()-t>15?(t=Date.now(),i(c)):(e.push(c),e.length===1&&s.setAttribute("a",n=!n))}}S.nextTick=S.setImmediate})();S.isNodejs=typeof process<"u"&&process.versions&&process.versions.node;S.globalScope=function(){return S.isNodejs?globalThis:typeof self>"u"?window:self}();S.isArray=Array.isArray||function(r){return Object.prototype.toString.call(r)==="[object Array]"};S.isArrayBuffer=function(r){return typeof ArrayBuffer<"u"&&r instanceof ArrayBuffer};S.isArrayBufferView=function(r){return r&&S.isArrayBuffer(r.buffer)&&r.byteLength!==void 0};function tl(r){if(!(r===8||r===16||r===24||r===32))throw new Error("Only 8, 16, 24, or 32 bits supported: "+r)}S.ByteBuffer=Cp;function Cp(r){if(this.data="",this.read=0,typeof r=="string")this.data=r;else if(S.isArrayBuffer(r)||S.isArrayBufferView(r))if(typeof Buffer<"u"&&r instanceof Buffer)this.data=r.toString("binary");else{var e=new Uint8Array(r);try{this.data=String.fromCharCode.apply(null,e)}catch{for(var t=0;t<e.length;++t)this.putByte(e[t])}}else(r instanceof Cp||typeof r=="object"&&typeof r.data=="string"&&typeof r.read=="number")&&(this.data=r.data,this.read=r.read);this._constructedStringLength=0}S.ByteStringBuffer=Cp;var IP=4096;S.ByteStringBuffer.prototype._optimizeConstructedString=function(r){this._constructedStringLength+=r,this._constructedStringLength>IP&&(this.data.substr(0,1),this._constructedStringLength=0)};S.ByteStringBuffer.prototype.length=function(){return this.data.length-this.read};S.ByteStringBuffer.prototype.isEmpty=function(){return this.length()<=0};S.ByteStringBuffer.prototype.putByte=function(r){return this.putBytes(String.fromCharCode(r))};S.ByteStringBuffer.prototype.fillWithByte=function(r,e){r=String.fromCharCode(r);for(var t=this.data;e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return this.data=t,this._optimizeConstructedString(e),this};S.ByteStringBuffer.prototype.putBytes=function(r){return this.data+=r,this._optimizeConstructedString(r.length),this};S.ByteStringBuffer.prototype.putString=function(r){return this.putBytes(S.encodeUtf8(r))};S.ByteStringBuffer.prototype.putInt16=function(r){return this.putBytes(String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt24=function(r){return this.putBytes(String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt32=function(r){return this.putBytes(String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255))};S.ByteStringBuffer.prototype.putInt16Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255))};S.ByteStringBuffer.prototype.putInt24Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255))};S.ByteStringBuffer.prototype.putInt32Le=function(r){return this.putBytes(String.fromCharCode(r&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>24&255))};S.ByteStringBuffer.prototype.putInt=function(r,e){tl(e);var t="";do e-=8,t+=String.fromCharCode(r>>e&255);while(e>0);return this.putBytes(t)};S.ByteStringBuffer.prototype.putSignedInt=function(r,e){return r<0&&(r+=2<<e-1),this.putInt(r,e)};S.ByteStringBuffer.prototype.putBuffer=function(r){return this.putBytes(r.getBytes())};S.ByteStringBuffer.prototype.getByte=function(){return this.data.charCodeAt(this.read++)};S.ByteStringBuffer.prototype.getInt16=function(){var r=this.data.charCodeAt(this.read)<<8^this.data.charCodeAt(this.read+1);return this.read+=2,r};S.ByteStringBuffer.prototype.getInt24=function(){var r=this.data.charCodeAt(this.read)<<16^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2);return this.read+=3,r};S.ByteStringBuffer.prototype.getInt32=function(){var r=this.data.charCodeAt(this.read)<<24^this.data.charCodeAt(this.read+1)<<16^this.data.charCodeAt(this.read+2)<<8^this.data.charCodeAt(this.read+3);return this.read+=4,r};S.ByteStringBuffer.prototype.getInt16Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8;return this.read+=2,r};S.ByteStringBuffer.prototype.getInt24Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16;return this.read+=3,r};S.ByteStringBuffer.prototype.getInt32Le=function(){var r=this.data.charCodeAt(this.read)^this.data.charCodeAt(this.read+1)<<8^this.data.charCodeAt(this.read+2)<<16^this.data.charCodeAt(this.read+3)<<24;return this.read+=4,r};S.ByteStringBuffer.prototype.getInt=function(r){tl(r);var e=0;do e=(e<<8)+this.data.charCodeAt(this.read++),r-=8;while(r>0);return e};S.ByteStringBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};S.ByteStringBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};S.ByteStringBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};S.ByteStringBuffer.prototype.at=function(r){return this.data.charCodeAt(this.read+r)};S.ByteStringBuffer.prototype.setAt=function(r,e){return this.data=this.data.substr(0,this.read+r)+String.fromCharCode(e)+this.data.substr(this.read+r+1),this};S.ByteStringBuffer.prototype.last=function(){return this.data.charCodeAt(this.data.length-1)};S.ByteStringBuffer.prototype.copy=function(){var r=S.createBuffer(this.data);return r.read=this.read,r};S.ByteStringBuffer.prototype.compact=function(){return this.read>0&&(this.data=this.data.slice(this.read),this.read=0),this};S.ByteStringBuffer.prototype.clear=function(){return this.data="",this.read=0,this};S.ByteStringBuffer.prototype.truncate=function(r){var e=Math.max(0,this.length()-r);return this.data=this.data.substr(this.read,e),this.read=0,this};S.ByteStringBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.length;++e){var t=this.data.charCodeAt(e);t<16&&(r+="0"),r+=t.toString(16)}return r};S.ByteStringBuffer.prototype.toString=function(){return S.decodeUtf8(this.bytes())};function TP(r,e){e=e||{},this.read=e.readOffset||0,this.growSize=e.growSize||1024;var t=S.isArrayBuffer(r),n=S.isArrayBufferView(r);if(t||n){t?this.data=new DataView(r):this.data=new DataView(r.buffer,r.byteOffset,r.byteLength),this.write="writeOffset"in e?e.writeOffset:this.data.byteLength;return}this.data=new DataView(new ArrayBuffer(0)),this.write=0,r!=null&&this.putBytes(r),"writeOffset"in e&&(this.write=e.writeOffset)}S.DataBuffer=TP;S.DataBuffer.prototype.length=function(){return this.write-this.read};S.DataBuffer.prototype.isEmpty=function(){return this.length()<=0};S.DataBuffer.prototype.accommodate=function(r,e){if(this.length()>=r)return this;e=Math.max(e||this.growSize,r);var t=new Uint8Array(this.data.buffer,this.data.byteOffset,this.data.byteLength),n=new Uint8Array(this.length()+e);return n.set(t),this.data=new DataView(n.buffer),this};S.DataBuffer.prototype.putByte=function(r){return this.accommodate(1),this.data.setUint8(this.write++,r),this};S.DataBuffer.prototype.fillWithByte=function(r,e){this.accommodate(e);for(var t=0;t<e;++t)this.data.setUint8(r);return this};S.DataBuffer.prototype.putBytes=function(r,e){if(S.isArrayBufferView(r)){var t=new Uint8Array(r.buffer,r.byteOffset,r.byteLength),n=t.byteLength-t.byteOffset;this.accommodate(n);var s=new Uint8Array(this.data.buffer,this.write);return s.set(t),this.write+=n,this}if(S.isArrayBuffer(r)){var t=new Uint8Array(r);this.accommodate(t.byteLength);var s=new Uint8Array(this.data.buffer);return s.set(t,this.write),this.write+=t.byteLength,this}if(r instanceof S.DataBuffer||typeof r=="object"&&typeof r.read=="number"&&typeof r.write=="number"&&S.isArrayBufferView(r.data)){var t=new Uint8Array(r.data.byteLength,r.read,r.length());this.accommodate(t.byteLength);var s=new Uint8Array(r.data.byteLength,this.write);return s.set(t),this.write+=t.byteLength,this}if(r instanceof S.ByteStringBuffer&&(r=r.data,e="binary"),e=e||"binary",typeof r=="string"){var i;if(e==="hex")return this.accommodate(Math.ceil(r.length/2)),i=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.hex.decode(r,i,this.write),this;if(e==="base64")return this.accommodate(Math.ceil(r.length/4)*3),i=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.base64.decode(r,i,this.write),this;if(e==="utf8"&&(r=S.encodeUtf8(r),e="binary"),e==="binary"||e==="raw")return this.accommodate(r.length),i=new Uint8Array(this.data.buffer,this.write),this.write+=S.binary.raw.decode(i),this;if(e==="utf16")return this.accommodate(r.length*2),i=new Uint16Array(this.data.buffer,this.write),this.write+=S.text.utf16.encode(i),this;throw new Error("Invalid encoding: "+e)}throw Error("Invalid parameter: "+r)};S.DataBuffer.prototype.putBuffer=function(r){return this.putBytes(r),r.clear(),this};S.DataBuffer.prototype.putString=function(r){return this.putBytes(r,"utf16")};S.DataBuffer.prototype.putInt16=function(r){return this.accommodate(2),this.data.setInt16(this.write,r),this.write+=2,this};S.DataBuffer.prototype.putInt24=function(r){return this.accommodate(3),this.data.setInt16(this.write,r>>8&65535),this.data.setInt8(this.write,r>>16&255),this.write+=3,this};S.DataBuffer.prototype.putInt32=function(r){return this.accommodate(4),this.data.setInt32(this.write,r),this.write+=4,this};S.DataBuffer.prototype.putInt16Le=function(r){return this.accommodate(2),this.data.setInt16(this.write,r,!0),this.write+=2,this};S.DataBuffer.prototype.putInt24Le=function(r){return this.accommodate(3),this.data.setInt8(this.write,r>>16&255),this.data.setInt16(this.write,r>>8&65535,!0),this.write+=3,this};S.DataBuffer.prototype.putInt32Le=function(r){return this.accommodate(4),this.data.setInt32(this.write,r,!0),this.write+=4,this};S.DataBuffer.prototype.putInt=function(r,e){tl(e),this.accommodate(e/8);do e-=8,this.data.setInt8(this.write++,r>>e&255);while(e>0);return this};S.DataBuffer.prototype.putSignedInt=function(r,e){return tl(e),this.accommodate(e/8),r<0&&(r+=2<<e-1),this.putInt(r,e)};S.DataBuffer.prototype.getByte=function(){return this.data.getInt8(this.read++)};S.DataBuffer.prototype.getInt16=function(){var r=this.data.getInt16(this.read);return this.read+=2,r};S.DataBuffer.prototype.getInt24=function(){var r=this.data.getInt16(this.read)<<8^this.data.getInt8(this.read+2);return this.read+=3,r};S.DataBuffer.prototype.getInt32=function(){var r=this.data.getInt32(this.read);return this.read+=4,r};S.DataBuffer.prototype.getInt16Le=function(){var r=this.data.getInt16(this.read,!0);return this.read+=2,r};S.DataBuffer.prototype.getInt24Le=function(){var r=this.data.getInt8(this.read)^this.data.getInt16(this.read+1,!0)<<8;return this.read+=3,r};S.DataBuffer.prototype.getInt32Le=function(){var r=this.data.getInt32(this.read,!0);return this.read+=4,r};S.DataBuffer.prototype.getInt=function(r){tl(r);var e=0;do e=(e<<8)+this.data.getInt8(this.read++),r-=8;while(r>0);return e};S.DataBuffer.prototype.getSignedInt=function(r){var e=this.getInt(r),t=2<<r-2;return e>=t&&(e-=t<<1),e};S.DataBuffer.prototype.getBytes=function(r){var e;return r?(r=Math.min(this.length(),r),e=this.data.slice(this.read,this.read+r),this.read+=r):r===0?e="":(e=this.read===0?this.data:this.data.slice(this.read),this.clear()),e};S.DataBuffer.prototype.bytes=function(r){return typeof r>"u"?this.data.slice(this.read):this.data.slice(this.read,this.read+r)};S.DataBuffer.prototype.at=function(r){return this.data.getUint8(this.read+r)};S.DataBuffer.prototype.setAt=function(r,e){return this.data.setUint8(r,e),this};S.DataBuffer.prototype.last=function(){return this.data.getUint8(this.write-1)};S.DataBuffer.prototype.copy=function(){return new S.DataBuffer(this)};S.DataBuffer.prototype.compact=function(){if(this.read>0){var r=new Uint8Array(this.data.buffer,this.read),e=new Uint8Array(r.byteLength);e.set(r),this.data=new DataView(e),this.write-=this.read,this.read=0}return this};S.DataBuffer.prototype.clear=function(){return this.data=new DataView(new ArrayBuffer(0)),this.read=this.write=0,this};S.DataBuffer.prototype.truncate=function(r){return this.write=Math.max(0,this.length()-r),this.read=Math.min(this.read,this.write),this};S.DataBuffer.prototype.toHex=function(){for(var r="",e=this.read;e<this.data.byteLength;++e){var t=this.data.getUint8(e);t<16&&(r+="0"),r+=t.toString(16)}return r};S.DataBuffer.prototype.toString=function(r){var e=new Uint8Array(this.data,this.read,this.length());if(r=r||"utf8",r==="binary"||r==="raw")return S.binary.raw.encode(e);if(r==="hex")return S.binary.hex.encode(e);if(r==="base64")return S.binary.base64.encode(e);if(r==="utf8")return S.text.utf8.decode(e);if(r==="utf16")return S.text.utf16.decode(e);throw new Error("Invalid encoding: "+r)};S.createBuffer=function(r,e){return e=e||"raw",r!==void 0&&e==="utf8"&&(r=S.encodeUtf8(r)),new S.ByteBuffer(r)};S.fillString=function(r,e){for(var t="";e>0;)e&1&&(t+=r),e>>>=1,e>0&&(r+=r);return t};S.xorBytes=function(r,e,t){for(var n="",s="",i="",o=0,a=0;t>0;--t,++o)s=r.charCodeAt(o)^e.charCodeAt(o),a>=10&&(n+=i,i="",a=0),i+=String.fromCharCode(s),++a;return n+=i,n};S.hexToBytes=function(r){var e="",t=0;for(r.length&!0&&(t=1,e+=String.fromCharCode(parseInt(r[0],16)));t<r.length;t+=2)e+=String.fromCharCode(parseInt(r.substr(t,2),16));return e};S.bytesToHex=function(r){return S.createBuffer(r).toHex()};S.int32ToBytes=function(r){return String.fromCharCode(r>>24&255)+String.fromCharCode(r>>16&255)+String.fromCharCode(r>>8&255)+String.fromCharCode(r&255)};var hi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",di=[62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,64,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51],s7="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";S.encode64=function(r,e){for(var t="",n="",s,i,o,a=0;a<r.length;)s=r.charCodeAt(a++),i=r.charCodeAt(a++),o=r.charCodeAt(a++),t+=hi.charAt(s>>2),t+=hi.charAt((s&3)<<4|i>>4),isNaN(i)?t+="==":(t+=hi.charAt((i&15)<<2|o>>6),t+=isNaN(o)?"=":hi.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};S.decode64=function(r){r=r.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(var e="",t,n,s,i,o=0;o<r.length;)t=di[r.charCodeAt(o++)-43],n=di[r.charCodeAt(o++)-43],s=di[r.charCodeAt(o++)-43],i=di[r.charCodeAt(o++)-43],e+=String.fromCharCode(t<<2|n>>4),s!==64&&(e+=String.fromCharCode((n&15)<<4|s>>2),i!==64&&(e+=String.fromCharCode((s&3)<<6|i)));return e};S.encodeUtf8=function(r){return unescape(encodeURIComponent(r))};S.decodeUtf8=function(r){return decodeURIComponent(escape(r))};S.binary={raw:{},hex:{},base64:{},base58:{},baseN:{encode:n7.encode,decode:n7.decode}};S.binary.raw.encode=function(r){return String.fromCharCode.apply(null,r)};S.binary.raw.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var s=t,i=0;i<r.length;++i)n[s++]=r.charCodeAt(i);return e?s-t:n};S.binary.hex.encode=S.bytesToHex;S.binary.hex.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/2))),t=t||0;var s=0,i=t;for(r.length&1&&(s=1,n[i++]=parseInt(r[0],16));s<r.length;s+=2)n[i++]=parseInt(r.substr(s,2),16);return e?i-t:n};S.binary.base64.encode=function(r,e){for(var t="",n="",s,i,o,a=0;a<r.byteLength;)s=r[a++],i=r[a++],o=r[a++],t+=hi.charAt(s>>2),t+=hi.charAt((s&3)<<4|i>>4),isNaN(i)?t+="==":(t+=hi.charAt((i&15)<<2|o>>6),t+=isNaN(o)?"=":hi.charAt(o&63)),e&&t.length>e&&(n+=t.substr(0,e)+`\r
`,t=t.substr(e));return n+=t,n};S.binary.base64.decode=function(r,e,t){var n=e;n||(n=new Uint8Array(Math.ceil(r.length/4)*3)),r=r.replace(/[^A-Za-z0-9\+\/\=]/g,""),t=t||0;for(var s,i,o,a,c=0,l=t;c<r.length;)s=di[r.charCodeAt(c++)-43],i=di[r.charCodeAt(c++)-43],o=di[r.charCodeAt(c++)-43],a=di[r.charCodeAt(c++)-43],n[l++]=s<<2|i>>4,o!==64&&(n[l++]=(i&15)<<4|o>>2,a!==64&&(n[l++]=(o&3)<<6|a));return e?l-t:n.subarray(0,l)};S.binary.base58.encode=function(r,e){return S.binary.baseN.encode(r,s7,e)};S.binary.base58.decode=function(r,e){return S.binary.baseN.decode(r,s7,e)};S.text={utf8:{},utf16:{}};S.text.utf8.encode=function(r,e,t){r=S.encodeUtf8(r);var n=e;n||(n=new Uint8Array(r.length)),t=t||0;for(var s=t,i=0;i<r.length;++i)n[s++]=r.charCodeAt(i);return e?s-t:n};S.text.utf8.decode=function(r){return S.decodeUtf8(String.fromCharCode.apply(null,r))};S.text.utf16.encode=function(r,e,t){var n=e;n||(n=new Uint8Array(r.length*2));var s=new Uint16Array(n.buffer);t=t||0;for(var i=t,o=t,a=0;a<r.length;++a)s[o++]=r.charCodeAt(a),i+=2;return e?i-t:n};S.text.utf16.decode=function(r){return String.fromCharCode.apply(null,new Uint16Array(r.buffer))};S.deflate=function(r,e,t){if(e=S.decode64(r.deflate(S.encode64(e)).rval),t){var n=2,s=e.charCodeAt(1);s&32&&(n=6),e=e.substring(n,e.length-4)}return e};S.inflate=function(r,e,t){var n=r.inflate(S.encode64(e)).rval;return n===null?null:S.decode64(n)};var Pp=function(r,e,t){if(!r)throw new Error("WebStorage not available.");var n;if(t===null?n=r.removeItem(e):(t=S.encode64(JSON.stringify(t)),n=r.setItem(e,t)),typeof n<"u"&&n.rval!==!0){var s=new Error(n.error.message);throw s.id=n.error.id,s.name=n.error.name,s}},kp=function(r,e){if(!r)throw new Error("WebStorage not available.");var t=r.getItem(e);if(r.init)if(t.rval===null){if(t.error){var n=new Error(t.error.message);throw n.id=t.error.id,n.name=t.error.name,n}t=null}else t=t.rval;return t!==null&&(t=JSON.parse(S.decode64(t))),t},AP=function(r,e,t,n){var s=kp(r,e);s===null&&(s={}),s[t]=n,Pp(r,e,s)},DP=function(r,e,t){var n=kp(r,e);return n!==null&&(n=t in n?n[t]:null),n},CP=function(r,e,t){var n=kp(r,e);if(n!==null&&t in n){delete n[t];var s=!0;for(var i in n){s=!1;break}s&&(n=null),Pp(r,e,n)}},PP=function(r,e){Pp(r,e,null)},C0=function(r,e,t){var n=null;typeof t>"u"&&(t=["web","flash"]);var s,i=!1,o=null;for(var a in t){s=t[a];try{if(s==="flash"||s==="both"){if(e[0]===null)throw new Error("Flash local storage not available.");n=r.apply(this,e),i=s==="flash"}(s==="web"||s==="both")&&(e[0]=localStorage,n=r.apply(this,e),i=!0)}catch(c){o=c}if(i)break}if(!i)throw o;return n};S.setItem=function(r,e,t,n,s){C0(AP,arguments,s)};S.getItem=function(r,e,t,n){return C0(DP,arguments,n)};S.removeItem=function(r,e,t,n){C0(CP,arguments,n)};S.clearItems=function(r,e,t){C0(PP,arguments,t)};S.isEmpty=function(r){for(var e in r)if(r.hasOwnProperty(e))return!1;return!0};S.format=function(r){for(var e=/%./g,t,n,s=0,i=[],o=0;t=e.exec(r);){n=r.substring(o,e.lastIndex-2),n.length>0&&i.push(n),o=e.lastIndex;var a=t[0][1];switch(a){case"s":case"o":s<arguments.length?i.push(arguments[s+++1]):i.push("<?>");break;case"%":i.push("%");break;default:i.push("<%"+a+"?>")}}return i.push(r.substring(o)),i.join("")};S.formatNumber=function(r,e,t,n){var s=r,i=isNaN(e=Math.abs(e))?2:e,o=t===void 0?",":t,a=n===void 0?".":n,c=s<0?"-":"",l=parseInt(s=Math.abs(+s||0).toFixed(i),10)+"",u=l.length>3?l.length%3:0;return c+(u?l.substr(0,u)+a:"")+l.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+a)+(i?o+Math.abs(s-l).toFixed(i).slice(2):"")};S.formatSize=function(r){return r>=1073741824?r=S.formatNumber(r/1073741824,2,".","")+" GiB":r>=1048576?r=S.formatNumber(r/1048576,2,".","")+" MiB":r>=1024?r=S.formatNumber(r/1024,0)+" KiB":r=S.formatNumber(r,0)+" bytes",r};S.bytesFromIP=function(r){return r.indexOf(".")!==-1?S.bytesFromIPv4(r):r.indexOf(":")!==-1?S.bytesFromIPv6(r):null};S.bytesFromIPv4=function(r){if(r=r.split("."),r.length!==4)return null;for(var e=S.createBuffer(),t=0;t<r.length;++t){var n=parseInt(r[t],10);if(isNaN(n))return null;e.putByte(n)}return e.getBytes()};S.bytesFromIPv6=function(r){var e=0;r=r.split(":").filter(function(o){return o.length===0&&++e,!0});for(var t=(8-r.length+e)*2,n=S.createBuffer(),s=0;s<8;++s){if(!r[s]||r[s].length===0){n.fillWithByte(0,t),t=0;continue}var i=S.hexToBytes(r[s]);i.length<2&&n.putByte(0),n.putBytes(i)}return n.getBytes()};S.bytesToIP=function(r){return r.length===4?S.bytesToIPv4(r):r.length===16?S.bytesToIPv6(r):null};S.bytesToIPv4=function(r){if(r.length!==4)return null;for(var e=[],t=0;t<r.length;++t)e.push(r.charCodeAt(t));return e.join(".")};S.bytesToIPv6=function(r){if(r.length!==16)return null;for(var e=[],t=[],n=0,s=0;s<r.length;s+=2){for(var i=S.bytesToHex(r[s]+r[s+1]);i[0]==="0"&&i!=="0";)i=i.substr(1);if(i==="0"){var o=t[t.length-1],a=e.length;!o||a!==o.end+1?t.push({start:a,end:a}):(o.end=a,o.end-o.start>t[n].end-t[n].start&&(n=t.length-1))}e.push(i)}if(t.length>0){var c=t[n];c.end-c.start>0&&(e.splice(c.start,c.end-c.start+1,""),c.start===0&&e.unshift(""),c.end===7&&e.push(""))}return e.join(":")};S.estimateCores=function(r,e){if(typeof r=="function"&&(e=r,r={}),r=r||{},"cores"in S&&!r.update)return e(null,S.cores);if(typeof navigator<"u"&&"hardwareConcurrency"in navigator&&navigator.hardwareConcurrency>0)return S.cores=navigator.hardwareConcurrency,e(null,S.cores);if(typeof Worker>"u")return S.cores=1,e(null,S.cores);if(typeof Blob>"u")return S.cores=2,e(null,S.cores);var t=URL.createObjectURL(new Blob(["(",function(){self.addEventListener("message",function(o){for(var a=Date.now(),c=a+4;Date.now()<c;);self.postMessage({st:a,et:c})})}.toString(),")()"],{type:"application/javascript"}));n([],5,16);function n(o,a,c){if(a===0){var l=Math.floor(o.reduce(function(u,f){return u+f},0)/o.length);return S.cores=Math.max(1,l),URL.revokeObjectURL(t),e(null,S.cores)}s(c,function(u,f){o.push(i(c,f)),n(o,a-1,c)})}function s(o,a){for(var c=[],l=[],u=0;u<o;++u){var f=new Worker(t);f.addEventListener("message",function(h){if(l.push(h.data),l.length===o){for(var d=0;d<o;++d)c[d].terminate();a(null,l)}}),c.push(f)}for(var u=0;u<o;++u)c[u].postMessage(u)}function i(o,a){for(var c=[],l=0;l<o;++l)for(var u=a[l],f=c[l]=[],h=0;h<o;++h)if(l!==h){var d=a[h];(u.st>d.st&&u.st<d.et||d.st>u.st&&d.st<u.et)&&f.push(h)}return c.reduce(function(p,m){return Math.max(p,m.length)},0)}}});var P0=K((bZ,o7)=>{var rl=Qe();rl.pki=rl.pki||{};var Np=o7.exports=rl.pki.oids=rl.oids=rl.oids||{};function q(r,e){Np[r]=e,Np[e]=r}function We(r,e){Np[r]=e}q("1.2.840.113549.1.1.1","rsaEncryption");q("1.2.840.113549.1.1.4","md5WithRSAEncryption");q("1.2.840.113549.1.1.5","sha1WithRSAEncryption");q("1.2.840.113549.1.1.7","RSAES-OAEP");q("1.2.840.113549.1.1.8","mgf1");q("1.2.840.113549.1.1.9","pSpecified");q("1.2.840.113549.1.1.10","RSASSA-PSS");q("1.2.840.113549.1.1.11","sha256WithRSAEncryption");q("1.2.840.113549.1.1.12","sha384WithRSAEncryption");q("1.2.840.113549.1.1.13","sha512WithRSAEncryption");q("1.3.101.112","EdDSA25519");q("1.2.840.10040.4.3","dsa-with-sha1");q("1.3.14.3.2.7","desCBC");q("1.3.14.3.2.26","sha1");q("1.3.14.3.2.29","sha1WithRSASignature");q("2.16.840.1.101.3.4.2.1","sha256");q("2.16.840.1.101.3.4.2.2","sha384");q("2.16.840.1.101.3.4.2.3","sha512");q("2.16.840.1.101.3.4.2.4","sha224");q("2.16.840.1.101.3.4.2.5","sha512-224");q("2.16.840.1.101.3.4.2.6","sha512-256");q("1.2.840.113549.2.2","md2");q("1.2.840.113549.2.5","md5");q("1.2.840.113549.1.7.1","data");q("1.2.840.113549.1.7.2","signedData");q("1.2.840.113549.1.7.3","envelopedData");q("1.2.840.113549.1.7.4","signedAndEnvelopedData");q("1.2.840.113549.1.7.5","digestedData");q("1.2.840.113549.1.7.6","encryptedData");q("1.2.840.113549.1.9.1","emailAddress");q("1.2.840.113549.1.9.2","unstructuredName");q("1.2.840.113549.1.9.3","contentType");q("1.2.840.113549.1.9.4","messageDigest");q("1.2.840.113549.1.9.5","signingTime");q("1.2.840.113549.1.9.6","counterSignature");q("1.2.840.113549.1.9.7","challengePassword");q("1.2.840.113549.1.9.8","unstructuredAddress");q("1.2.840.113549.1.9.14","extensionRequest");q("1.2.840.113549.1.9.20","friendlyName");q("1.2.840.113549.1.9.21","localKeyId");q("1.2.840.113549.1.9.22.1","x509Certificate");q("1.2.840.113549.1.12.10.1.1","keyBag");q("1.2.840.113549.1.12.10.1.2","pkcs8ShroudedKeyBag");q("1.2.840.113549.1.12.10.1.3","certBag");q("1.2.840.113549.1.12.10.1.4","crlBag");q("1.2.840.113549.1.12.10.1.5","secretBag");q("1.2.840.113549.1.12.10.1.6","safeContentsBag");q("1.2.840.113549.1.5.13","pkcs5PBES2");q("1.2.840.113549.1.5.12","pkcs5PBKDF2");q("1.2.840.113549.1.12.1.1","pbeWithSHAAnd128BitRC4");q("1.2.840.113549.1.12.1.2","pbeWithSHAAnd40BitRC4");q("1.2.840.113549.1.12.1.3","pbeWithSHAAnd3-KeyTripleDES-CBC");q("1.2.840.113549.1.12.1.4","pbeWithSHAAnd2-KeyTripleDES-CBC");q("1.2.840.113549.1.12.1.5","pbeWithSHAAnd128BitRC2-CBC");q("1.2.840.113549.1.12.1.6","pbewithSHAAnd40BitRC2-CBC");q("1.2.840.113549.2.7","hmacWithSHA1");q("1.2.840.113549.2.8","hmacWithSHA224");q("1.2.840.113549.2.9","hmacWithSHA256");q("1.2.840.113549.2.10","hmacWithSHA384");q("1.2.840.113549.2.11","hmacWithSHA512");q("1.2.840.113549.3.7","des-EDE3-CBC");q("2.16.840.1.101.3.4.1.2","aes128-CBC");q("2.16.840.1.101.3.4.1.22","aes192-CBC");q("2.16.840.1.101.3.4.1.42","aes256-CBC");q("2.5.4.3","commonName");q("2.5.4.4","surname");q("2.5.4.5","serialNumber");q("2.5.4.6","countryName");q("2.5.4.7","localityName");q("2.5.4.8","stateOrProvinceName");q("2.5.4.9","streetAddress");q("2.5.4.10","organizationName");q("2.5.4.11","organizationalUnitName");q("2.5.4.12","title");q("2.5.4.13","description");q("2.5.4.15","businessCategory");q("2.5.4.17","postalCode");q("2.5.4.42","givenName");q("1.3.6.1.4.1.311.60.2.1.2","jurisdictionOfIncorporationStateOrProvinceName");q("1.3.6.1.4.1.311.60.2.1.3","jurisdictionOfIncorporationCountryName");q("2.16.840.1.113730.1.1","nsCertType");q("2.16.840.1.113730.1.13","nsComment");We("2.5.29.1","authorityKeyIdentifier");We("2.5.29.2","keyAttributes");We("2.5.29.3","certificatePolicies");We("2.5.29.4","keyUsageRestriction");We("2.5.29.5","policyMapping");We("2.5.29.6","subtreesConstraint");We("2.5.29.7","subjectAltName");We("2.5.29.8","issuerAltName");We("2.5.29.9","subjectDirectoryAttributes");We("2.5.29.10","basicConstraints");We("2.5.29.11","nameConstraints");We("2.5.29.12","policyConstraints");We("2.5.29.13","basicConstraints");q("2.5.29.14","subjectKeyIdentifier");q("2.5.29.15","keyUsage");We("2.5.29.16","privateKeyUsagePeriod");q("2.5.29.17","subjectAltName");q("2.5.29.18","issuerAltName");q("2.5.29.19","basicConstraints");We("2.5.29.20","cRLNumber");We("2.5.29.21","cRLReason");We("2.5.29.22","expirationDate");We("2.5.29.23","instructionCode");We("2.5.29.24","invalidityDate");We("2.5.29.25","cRLDistributionPoints");We("2.5.29.26","issuingDistributionPoint");We("2.5.29.27","deltaCRLIndicator");We("2.5.29.28","issuingDistributionPoint");We("2.5.29.29","certificateIssuer");We("2.5.29.30","nameConstraints");q("2.5.29.31","cRLDistributionPoints");q("2.5.29.32","certificatePolicies");We("2.5.29.33","policyMappings");We("2.5.29.34","policyConstraints");q("2.5.29.35","authorityKeyIdentifier");We("2.5.29.36","policyConstraints");q("2.5.29.37","extKeyUsage");We("2.5.29.46","freshestCRL");We("2.5.29.54","inhibitAnyPolicy");q("1.3.6.1.4.1.11129.2.4.2","timestampList");q("1.3.6.1.5.5.7.1.1","authorityInfoAccess");q("1.3.6.1.5.5.7.3.1","serverAuth");q("1.3.6.1.5.5.7.3.2","clientAuth");q("1.3.6.1.5.5.7.3.3","codeSigning");q("1.3.6.1.5.5.7.3.4","emailProtection");q("1.3.6.1.5.5.7.3.8","timeStamping")});var sl=K((wZ,c7)=>{var nt=Qe();Rt();P0();var j=c7.exports=nt.asn1=nt.asn1||{};j.Class={UNIVERSAL:0,APPLICATION:64,CONTEXT_SPECIFIC:128,PRIVATE:192};j.Type={NONE:0,BOOLEAN:1,INTEGER:2,BITSTRING:3,OCTETSTRING:4,NULL:5,OID:6,ODESC:7,EXTERNAL:8,REAL:9,ENUMERATED:10,EMBEDDED:11,UTF8:12,ROID:13,SEQUENCE:16,SET:17,PRINTABLESTRING:19,IA5STRING:22,UTCTIME:23,GENERALIZEDTIME:24,BMPSTRING:30};j.create=function(r,e,t,n,s){if(nt.util.isArray(n)){for(var i=[],o=0;o<n.length;++o)n[o]!==void 0&&i.push(n[o]);n=i}var a={tagClass:r,type:e,constructed:t,composed:t||nt.util.isArray(n),value:n};return s&&"bitStringContents"in s&&(a.bitStringContents=s.bitStringContents,a.original=j.copy(a)),a};j.copy=function(r,e){var t;if(nt.util.isArray(r)){t=[];for(var n=0;n<r.length;++n)t.push(j.copy(r[n],e));return t}return typeof r=="string"?r:(t={tagClass:r.tagClass,type:r.type,constructed:r.constructed,composed:r.composed,value:j.copy(r.value,e)},e&&!e.excludeBitStringContents&&(t.bitStringContents=r.bitStringContents),t)};j.equals=function(r,e,t){if(nt.util.isArray(r)){if(!nt.util.isArray(e)||r.length!==e.length)return!1;for(var n=0;n<r.length;++n)if(!j.equals(r[n],e[n]))return!1;return!0}if(typeof r!=typeof e)return!1;if(typeof r=="string")return r===e;var s=r.tagClass===e.tagClass&&r.type===e.type&&r.constructed===e.constructed&&r.composed===e.composed&&j.equals(r.value,e.value);return t&&t.includeBitStringContents&&(s=s&&r.bitStringContents===e.bitStringContents),s};j.getBerValueLength=function(r){var e=r.getByte();if(e!==128){var t,n=e&128;return n?t=r.getInt((e&127)<<3):t=e,t}};function nl(r,e,t){if(t>e){var n=new Error("Too few bytes to parse DER.");throw n.available=r.length(),n.remaining=e,n.requested=t,n}}var kP=function(r,e){var t=r.getByte();if(e--,t!==128){var n,s=t&128;if(!s)n=t;else{var i=t&127;nl(r,e,i),n=r.getInt(i<<3)}if(n<0)throw new Error("Negative length: "+n);return n}};j.fromDer=function(r,e){e===void 0&&(e={strict:!0,parseAllBytes:!0,decodeBitStrings:!0}),typeof e=="boolean"&&(e={strict:e,parseAllBytes:!0,decodeBitStrings:!0}),"strict"in e||(e.strict=!0),"parseAllBytes"in e||(e.parseAllBytes=!0),"decodeBitStrings"in e||(e.decodeBitStrings=!0),typeof r=="string"&&(r=nt.util.createBuffer(r));var t=r.length(),n=k0(r,r.length(),0,e);if(e.parseAllBytes&&r.length()!==0){var s=new Error("Unparsed DER bytes remain after ASN.1 parsing.");throw s.byteCount=t,s.remaining=r.length(),s}return n};function k0(r,e,t,n){var s;nl(r,e,2);var i=r.getByte();e--;var o=i&192,a=i&31;s=r.length();var c=kP(r,e);if(e-=s-r.length(),c!==void 0&&c>e){if(n.strict){var l=new Error("Too few bytes to read ASN.1 value.");throw l.available=r.length(),l.remaining=e,l.requested=c,l}c=e}var u,f,h=(i&32)===32;if(h)if(u=[],c===void 0)for(;;){if(nl(r,e,2),r.bytes(2)===String.fromCharCode(0,0)){r.getBytes(2),e-=2;break}s=r.length(),u.push(k0(r,e,t+1,n)),e-=s-r.length()}else for(;c>0;)s=r.length(),u.push(k0(r,c,t+1,n)),e-=s-r.length(),c-=s-r.length();if(u===void 0&&o===j.Class.UNIVERSAL&&a===j.Type.BITSTRING&&(f=r.bytes(c)),u===void 0&&n.decodeBitStrings&&o===j.Class.UNIVERSAL&&a===j.Type.BITSTRING&&c>1){var d=r.read,p=e,m=0;if(a===j.Type.BITSTRING&&(nl(r,e,1),m=r.getByte(),e--),m===0)try{s=r.length();var g={strict:!0,decodeBitStrings:!0},y=k0(r,e,t+1,g),w=s-r.length();e-=w,a==j.Type.BITSTRING&&w++;var E=y.tagClass;w===c&&(E===j.Class.UNIVERSAL||E===j.Class.CONTEXT_SPECIFIC)&&(u=[y])}catch{}u===void 0&&(r.read=d,e=p)}if(u===void 0){if(c===void 0){if(n.strict)throw new Error("Non-constructed ASN.1 object of indefinite length.");c=e}if(a===j.Type.BMPSTRING)for(u="";c>0;c-=2)nl(r,e,2),u+=String.fromCharCode(r.getInt16()),e-=2;else u=r.getBytes(c),e-=c}var R=f===void 0?null:{bitStringContents:f};return j.create(o,a,h,u,R)}j.toDer=function(r){var e=nt.util.createBuffer(),t=r.tagClass|r.type,n=nt.util.createBuffer(),s=!1;if("bitStringContents"in r&&(s=!0,r.original&&(s=j.equals(r,r.original))),s)n.putBytes(r.bitStringContents);else if(r.composed){r.constructed?t|=32:n.putByte(0);for(var i=0;i<r.value.length;++i)r.value[i]!==void 0&&n.putBuffer(j.toDer(r.value[i]))}else if(r.type===j.Type.BMPSTRING)for(var i=0;i<r.value.length;++i)n.putInt16(r.value.charCodeAt(i));else r.type===j.Type.INTEGER&&r.value.length>1&&(r.value.charCodeAt(0)===0&&!(r.value.charCodeAt(1)&128)||r.value.charCodeAt(0)===255&&(r.value.charCodeAt(1)&128)===128)?n.putBytes(r.value.substr(1)):n.putBytes(r.value);if(e.putByte(t),n.length()<=127)e.putByte(n.length()&127);else{var o=n.length(),a="";do a+=String.fromCharCode(o&255),o=o>>>8;while(o>0);e.putByte(a.length|128);for(var i=a.length-1;i>=0;--i)e.putByte(a.charCodeAt(i))}return e.putBuffer(n),e};j.oidToDer=function(r){var e=r.split("."),t=nt.util.createBuffer();t.putByte(40*parseInt(e[0],10)+parseInt(e[1],10));for(var n,s,i,o,a=2;a<e.length;++a){n=!0,s=[],i=parseInt(e[a],10);do o=i&127,i=i>>>7,n||(o|=128),s.push(o),n=!1;while(i>0);for(var c=s.length-1;c>=0;--c)t.putByte(s[c])}return t};j.derToOid=function(r){var e;typeof r=="string"&&(r=nt.util.createBuffer(r));var t=r.getByte();e=Math.floor(t/40)+"."+t%40;for(var n=0;r.length()>0;)t=r.getByte(),n=n<<7,t&128?n+=t&127:(e+="."+(n+t),n=0);return e};j.utcTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,2),10);t=t>=50?1900+t:2e3+t;var n=parseInt(r.substr(2,2),10)-1,s=parseInt(r.substr(4,2),10),i=parseInt(r.substr(6,2),10),o=parseInt(r.substr(8,2),10),a=0;if(r.length>11){var c=r.charAt(10),l=10;c!=="+"&&c!=="-"&&(a=parseInt(r.substr(10,2),10),l+=2)}if(e.setUTCFullYear(t,n,s),e.setUTCHours(i,o,a,0),l&&(c=r.charAt(l),c==="+"||c==="-")){var u=parseInt(r.substr(l+1,2),10),f=parseInt(r.substr(l+4,2),10),h=u*60+f;h*=6e4,c==="+"?e.setTime(+e-h):e.setTime(+e+h)}return e};j.generalizedTimeToDate=function(r){var e=new Date,t=parseInt(r.substr(0,4),10),n=parseInt(r.substr(4,2),10)-1,s=parseInt(r.substr(6,2),10),i=parseInt(r.substr(8,2),10),o=parseInt(r.substr(10,2),10),a=parseInt(r.substr(12,2),10),c=0,l=0,u=!1;r.charAt(r.length-1)==="Z"&&(u=!0);var f=r.length-5,h=r.charAt(f);if(h==="+"||h==="-"){var d=parseInt(r.substr(f+1,2),10),p=parseInt(r.substr(f+4,2),10);l=d*60+p,l*=6e4,h==="+"&&(l*=-1),u=!0}return r.charAt(14)==="."&&(c=parseFloat(r.substr(14),10)*1e3),u?(e.setUTCFullYear(t,n,s),e.setUTCHours(i,o,a,c),e.setTime(+e+l)):(e.setFullYear(t,n,s),e.setHours(i,o,a,c)),e};j.dateToUtcTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push((""+r.getUTCFullYear()).substr(2)),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};j.dateToGeneralizedTime=function(r){if(typeof r=="string")return r;var e="",t=[];t.push(""+r.getUTCFullYear()),t.push(""+(r.getUTCMonth()+1)),t.push(""+r.getUTCDate()),t.push(""+r.getUTCHours()),t.push(""+r.getUTCMinutes()),t.push(""+r.getUTCSeconds());for(var n=0;n<t.length;++n)t[n].length<2&&(e+="0"),e+=t[n];return e+="Z",e};j.integerToDer=function(r){var e=nt.util.createBuffer();if(r>=-128&&r<128)return e.putSignedInt(r,8);if(r>=-32768&&r<32768)return e.putSignedInt(r,16);if(r>=-8388608&&r<8388608)return e.putSignedInt(r,24);if(r>=-2147483648&&r<2147483648)return e.putSignedInt(r,32);var t=new Error("Integer too large; max is 32-bits.");throw t.integer=r,t};j.derToInteger=function(r){typeof r=="string"&&(r=nt.util.createBuffer(r));var e=r.length()*8;if(e>32)throw new Error("Integer too large; max is 32-bits.");return r.getSignedInt(e)};j.validate=function(r,e,t,n){var s=!1;if((r.tagClass===e.tagClass||typeof e.tagClass>"u")&&(r.type===e.type||typeof e.type>"u"))if(r.constructed===e.constructed||typeof e.constructed>"u"){if(s=!0,e.value&&nt.util.isArray(e.value))for(var i=0,o=0;s&&o<e.value.length;++o)s=e.value[o].optional||!1,r.value[i]&&(s=j.validate(r.value[i],e.value[o],t,n),s?++i:e.value[o].optional&&(s=!0)),!s&&n&&n.push("["+e.name+'] Tag class "'+e.tagClass+'", type "'+e.type+'" expected value length "'+e.value.length+'", got "'+r.value.length+'"');if(s&&t&&(e.capture&&(t[e.capture]=r.value),e.captureAsn1&&(t[e.captureAsn1]=r),e.captureBitStringContents&&"bitStringContents"in r&&(t[e.captureBitStringContents]=r.bitStringContents),e.captureBitStringValue&&"bitStringContents"in r)){var a;if(r.bitStringContents.length<2)t[e.captureBitStringValue]="";else{var c=r.bitStringContents.charCodeAt(0);if(c!==0)throw new Error("captureBitStringValue only supported for zero unused bits");t[e.captureBitStringValue]=r.bitStringContents.slice(1)}}}else n&&n.push("["+e.name+'] Expected constructed "'+e.constructed+'", got "'+r.constructed+'"');else n&&(r.tagClass!==e.tagClass&&n.push("["+e.name+'] Expected tag class "'+e.tagClass+'", got "'+r.tagClass+'"'),r.type!==e.type&&n.push("["+e.name+'] Expected type "'+e.type+'", got "'+r.type+'"'));return s};var a7=/[^\\u0000-\\u00ff]/;j.prettyPrint=function(r,e,t){var n="";e=e||0,t=t||2,e>0&&(n+=`
`);for(var s="",i=0;i<e*t;++i)s+=" ";switch(n+=s+"Tag: ",r.tagClass){case j.Class.UNIVERSAL:n+="Universal:";break;case j.Class.APPLICATION:n+="Application:";break;case j.Class.CONTEXT_SPECIFIC:n+="Context-Specific:";break;case j.Class.PRIVATE:n+="Private:";break}if(r.tagClass===j.Class.UNIVERSAL)switch(n+=r.type,r.type){case j.Type.NONE:n+=" (None)";break;case j.Type.BOOLEAN:n+=" (Boolean)";break;case j.Type.INTEGER:n+=" (Integer)";break;case j.Type.BITSTRING:n+=" (Bit string)";break;case j.Type.OCTETSTRING:n+=" (Octet string)";break;case j.Type.NULL:n+=" (Null)";break;case j.Type.OID:n+=" (Object Identifier)";break;case j.Type.ODESC:n+=" (Object Descriptor)";break;case j.Type.EXTERNAL:n+=" (External or Instance of)";break;case j.Type.REAL:n+=" (Real)";break;case j.Type.ENUMERATED:n+=" (Enumerated)";break;case j.Type.EMBEDDED:n+=" (Embedded PDV)";break;case j.Type.UTF8:n+=" (UTF8)";break;case j.Type.ROID:n+=" (Relative Object Identifier)";break;case j.Type.SEQUENCE:n+=" (Sequence)";break;case j.Type.SET:n+=" (Set)";break;case j.Type.PRINTABLESTRING:n+=" (Printable String)";break;case j.Type.IA5String:n+=" (IA5String (ASCII))";break;case j.Type.UTCTIME:n+=" (UTC time)";break;case j.Type.GENERALIZEDTIME:n+=" (Generalized time)";break;case j.Type.BMPSTRING:n+=" (BMP String)";break}else n+=r.type;if(n+=`
`,n+=s+"Constructed: "+r.constructed+`
`,r.composed){for(var o=0,a="",i=0;i<r.value.length;++i)r.value[i]!==void 0&&(o+=1,a+=j.prettyPrint(r.value[i],e+1,t),i+1<r.value.length&&(a+=","));n+=s+"Sub values: "+o+a}else{if(n+=s+"Value: ",r.type===j.Type.OID){var c=j.derToOid(r.value);n+=c,nt.pki&&nt.pki.oids&&c in nt.pki.oids&&(n+=" ("+nt.pki.oids[c]+") ")}if(r.type===j.Type.INTEGER)try{n+=j.derToInteger(r.value)}catch{n+="0x"+nt.util.bytesToHex(r.value)}else if(r.type===j.Type.BITSTRING){if(r.value.length>1?n+="0x"+nt.util.bytesToHex(r.value.slice(1)):n+="(none)",r.value.length>0){var l=r.value.charCodeAt(0);l==1?n+=" (1 unused bit shown)":l>1&&(n+=" ("+l+" unused bits shown)")}}else if(r.type===j.Type.OCTETSTRING)a7.test(r.value)||(n+="("+r.value+") "),n+="0x"+nt.util.bytesToHex(r.value);else if(r.type===j.Type.UTF8)try{n+=nt.util.decodeUtf8(r.value)}catch(u){if(u.message==="URI malformed")n+="0x"+nt.util.bytesToHex(r.value)+" (malformed UTF8)";else throw u}else r.type===j.Type.PRINTABLESTRING||r.type===j.Type.IA5String?n+=r.value:a7.test(r.value)?n+="0x"+nt.util.bytesToHex(r.value):r.value.length===0?n+="[null]":n+=r.value}return n}});var Lp=K((EZ,l7)=>{var zt=Qe();Rt();l7.exports=zt.cipher=zt.cipher||{};zt.cipher.algorithms=zt.cipher.algorithms||{};zt.cipher.createCipher=function(r,e){var t=r;if(typeof t=="string"&&(t=zt.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new zt.cipher.BlockCipher({algorithm:t,key:e,decrypt:!1})};zt.cipher.createDecipher=function(r,e){var t=r;if(typeof t=="string"&&(t=zt.cipher.getAlgorithm(t),t&&(t=t())),!t)throw new Error("Unsupported algorithm: "+r);return new zt.cipher.BlockCipher({algorithm:t,key:e,decrypt:!0})};zt.cipher.registerAlgorithm=function(r,e){r=r.toUpperCase(),zt.cipher.algorithms[r]=e};zt.cipher.getAlgorithm=function(r){return r=r.toUpperCase(),r in zt.cipher.algorithms?zt.cipher.algorithms[r]:null};var Op=zt.cipher.BlockCipher=function(r){this.algorithm=r.algorithm,this.mode=this.algorithm.mode,this.blockSize=this.mode.blockSize,this._finish=!1,this._input=null,this.output=null,this._op=r.decrypt?this.mode.decrypt:this.mode.encrypt,this._decrypt=r.decrypt,this.algorithm.initialize(r)};Op.prototype.start=function(r){r=r||{};var e={};for(var t in r)e[t]=r[t];e.decrypt=this._decrypt,this._finish=!1,this._input=zt.util.createBuffer(),this.output=r.output||zt.util.createBuffer(),this.mode.start(e)};Op.prototype.update=function(r){for(r&&this._input.putBuffer(r);!this._op.call(this.mode,this._input,this.output,this._finish)&&!this._finish;);this._input.compact()};Op.prototype.finish=function(r){r&&(this.mode.name==="ECB"||this.mode.name==="CBC")&&(this.mode.pad=function(t){return r(this.blockSize,t,!1)},this.mode.unpad=function(t){return r(this.blockSize,t,!0)});var e={};return e.decrypt=this._decrypt,e.overflow=this._input.length()%this.blockSize,!(!this._decrypt&&this.mode.pad&&!this.mode.pad(this._input,e)||(this._finish=!0,this.update(),this._decrypt&&this.mode.unpad&&!this.mode.unpad(this.output,e))||this.mode.afterFinish&&!this.mode.afterFinish(this.output,e))}});var Mp=K((xZ,u7)=>{var $t=Qe();Rt();$t.cipher=$t.cipher||{};var Pe=u7.exports=$t.cipher.modes=$t.cipher.modes||{};Pe.ecb=function(r){r=r||{},this.name="ECB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};Pe.ecb.prototype.start=function(r){};Pe.ecb.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};Pe.ecb.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n])};Pe.ecb.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};Pe.ecb.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};Pe.cbc=function(r){r=r||{},this.name="CBC",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints)};Pe.cbc.prototype.start=function(r){if(r.iv===null){if(!this._prev)throw new Error("Invalid IV parameter.");this._iv=this._prev.slice(0)}else if("iv"in r)this._iv=N0(r.iv,this.blockSize),this._prev=this._iv.slice(0);else throw new Error("Invalid IV parameter.")};Pe.cbc.prototype.encrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=this._prev[n]^r.getInt32();this.cipher.encrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._outBlock[n]);this._prev=this._outBlock};Pe.cbc.prototype.decrypt=function(r,e,t){if(r.length()<this.blockSize&&!(t&&r.length()>0))return!0;for(var n=0;n<this._ints;++n)this._inBlock[n]=r.getInt32();this.cipher.decrypt(this._inBlock,this._outBlock);for(var n=0;n<this._ints;++n)e.putInt32(this._prev[n]^this._outBlock[n]);this._prev=this._inBlock.slice(0)};Pe.cbc.prototype.pad=function(r,e){var t=r.length()===this.blockSize?this.blockSize:this.blockSize-r.length();return r.fillWithByte(t,t),!0};Pe.cbc.prototype.unpad=function(r,e){if(e.overflow>0)return!1;var t=r.length(),n=r.at(t-1);return n>this.blockSize<<2?!1:(r.truncate(n),!0)};Pe.cfb=function(r){r=r||{},this.name="CFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialBlock=new Array(this._ints),this._partialOutput=$t.util.createBuffer(),this._partialBytes=0};Pe.cfb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=N0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Pe.cfb.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)this._inBlock[s]=r.getInt32()^this._outBlock[s],e.putInt32(this._inBlock[s]);return}var i=(this.blockSize-n)%this.blockSize;i>0&&(i=this.blockSize-i),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialBlock[s]=r.getInt32()^this._outBlock[s],this._partialOutput.putInt32(this._partialBlock[s]);if(i>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._partialBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),i>0&&!t)return e.putBytes(this._partialOutput.getBytes(i-this._partialBytes)),this._partialBytes=i,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Pe.cfb.prototype.decrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)this._inBlock[s]=r.getInt32(),e.putInt32(this._inBlock[s]^this._outBlock[s]);return}var i=(this.blockSize-n)%this.blockSize;i>0&&(i=this.blockSize-i),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialBlock[s]=r.getInt32(),this._partialOutput.putInt32(this._partialBlock[s]^this._outBlock[s]);if(i>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._partialBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),i>0&&!t)return e.putBytes(this._partialOutput.getBytes(i-this._partialBytes)),this._partialBytes=i,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Pe.ofb=function(r){r=r||{},this.name="OFB",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=$t.util.createBuffer(),this._partialBytes=0};Pe.ofb.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=N0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Pe.ofb.prototype.encrypt=function(r,e,t){var n=r.length();if(r.length()===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)e.putInt32(r.getInt32()^this._outBlock[s]),this._inBlock[s]=this._outBlock[s];return}var i=(this.blockSize-n)%this.blockSize;i>0&&(i=this.blockSize-i),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(i>0)r.read-=this.blockSize;else for(var s=0;s<this._ints;++s)this._inBlock[s]=this._outBlock[s];if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),i>0&&!t)return e.putBytes(this._partialOutput.getBytes(i-this._partialBytes)),this._partialBytes=i,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0};Pe.ofb.prototype.decrypt=Pe.ofb.prototype.encrypt;Pe.ctr=function(r){r=r||{},this.name="CTR",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=null,this._outBlock=new Array(this._ints),this._partialOutput=$t.util.createBuffer(),this._partialBytes=0};Pe.ctr.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");this._iv=N0(r.iv,this.blockSize),this._inBlock=this._iv.slice(0),this._partialBytes=0};Pe.ctr.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize)for(var s=0;s<this._ints;++s)e.putInt32(r.getInt32()^this._outBlock[s]);else{var i=(this.blockSize-n)%this.blockSize;i>0&&(i=this.blockSize-i),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(i>0&&(r.read-=this.blockSize),this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),i>0&&!t)return e.putBytes(this._partialOutput.getBytes(i-this._partialBytes)),this._partialBytes=i,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}O0(this._inBlock)};Pe.ctr.prototype.decrypt=Pe.ctr.prototype.encrypt;Pe.gcm=function(r){r=r||{},this.name="GCM",this.cipher=r.cipher,this.blockSize=r.blockSize||16,this._ints=this.blockSize/4,this._inBlock=new Array(this._ints),this._outBlock=new Array(this._ints),this._partialOutput=$t.util.createBuffer(),this._partialBytes=0,this._R=3774873600};Pe.gcm.prototype.start=function(r){if(!("iv"in r))throw new Error("Invalid IV parameter.");var e=$t.util.createBuffer(r.iv);this._cipherLength=0;var t;if("additionalData"in r?t=$t.util.createBuffer(r.additionalData):t=$t.util.createBuffer(),"tagLength"in r?this._tagLength=r.tagLength:this._tagLength=128,this._tag=null,r.decrypt&&(this._tag=$t.util.createBuffer(r.tag).getBytes(),this._tag.length!==this._tagLength/8))throw new Error("Authentication tag does not match tag length.");this._hashBlock=new Array(this._ints),this.tag=null,this._hashSubkey=new Array(this._ints),this.cipher.encrypt([0,0,0,0],this._hashSubkey),this.componentBits=4,this._m=this.generateHashTable(this._hashSubkey,this.componentBits);var n=e.length();if(n===12)this._j0=[e.getInt32(),e.getInt32(),e.getInt32(),1];else{for(this._j0=[0,0,0,0];e.length()>0;)this._j0=this.ghash(this._hashSubkey,this._j0,[e.getInt32(),e.getInt32(),e.getInt32(),e.getInt32()]);this._j0=this.ghash(this._hashSubkey,this._j0,[0,0].concat(Bp(n*8)))}this._inBlock=this._j0.slice(0),O0(this._inBlock),this._partialBytes=0,t=$t.util.createBuffer(t),this._aDataLength=Bp(t.length()*8);var s=t.length()%this.blockSize;for(s&&t.fillWithByte(0,this.blockSize-s),this._s=[0,0,0,0];t.length()>0;)this._s=this.ghash(this._hashSubkey,this._s,[t.getInt32(),t.getInt32(),t.getInt32(),t.getInt32()])};Pe.gcm.prototype.encrypt=function(r,e,t){var n=r.length();if(n===0)return!0;if(this.cipher.encrypt(this._inBlock,this._outBlock),this._partialBytes===0&&n>=this.blockSize){for(var s=0;s<this._ints;++s)e.putInt32(this._outBlock[s]^=r.getInt32());this._cipherLength+=this.blockSize}else{var i=(this.blockSize-n)%this.blockSize;i>0&&(i=this.blockSize-i),this._partialOutput.clear();for(var s=0;s<this._ints;++s)this._partialOutput.putInt32(r.getInt32()^this._outBlock[s]);if(i<=0||t){if(t){var o=n%this.blockSize;this._cipherLength+=o,this._partialOutput.truncate(this.blockSize-o)}else this._cipherLength+=this.blockSize;for(var s=0;s<this._ints;++s)this._outBlock[s]=this._partialOutput.getInt32();this._partialOutput.read-=this.blockSize}if(this._partialBytes>0&&this._partialOutput.getBytes(this._partialBytes),i>0&&!t)return r.read-=this.blockSize,e.putBytes(this._partialOutput.getBytes(i-this._partialBytes)),this._partialBytes=i,!0;e.putBytes(this._partialOutput.getBytes(n-this._partialBytes)),this._partialBytes=0}this._s=this.ghash(this._hashSubkey,this._s,this._outBlock),O0(this._inBlock)};Pe.gcm.prototype.decrypt=function(r,e,t){var n=r.length();if(n<this.blockSize&&!(t&&n>0))return!0;this.cipher.encrypt(this._inBlock,this._outBlock),O0(this._inBlock),this._hashBlock[0]=r.getInt32(),this._hashBlock[1]=r.getInt32(),this._hashBlock[2]=r.getInt32(),this._hashBlock[3]=r.getInt32(),this._s=this.ghash(this._hashSubkey,this._s,this._hashBlock);for(var s=0;s<this._ints;++s)e.putInt32(this._outBlock[s]^this._hashBlock[s]);n<this.blockSize?this._cipherLength+=n%this.blockSize:this._cipherLength+=this.blockSize};Pe.gcm.prototype.afterFinish=function(r,e){var t=!0;e.decrypt&&e.overflow&&r.truncate(this.blockSize-e.overflow),this.tag=$t.util.createBuffer();var n=this._aDataLength.concat(Bp(this._cipherLength*8));this._s=this.ghash(this._hashSubkey,this._s,n);var s=[];this.cipher.encrypt(this._j0,s);for(var i=0;i<this._ints;++i)this.tag.putInt32(this._s[i]^s[i]);return this.tag.truncate(this.tag.length()%(this._tagLength/8)),e.decrypt&&this.tag.bytes()!==this._tag&&(t=!1),t};Pe.gcm.prototype.multiply=function(r,e){for(var t=[0,0,0,0],n=e.slice(0),s=0;s<128;++s){var i=r[s/32|0]&1<<31-s%32;i&&(t[0]^=n[0],t[1]^=n[1],t[2]^=n[2],t[3]^=n[3]),this.pow(n,n)}return t};Pe.gcm.prototype.pow=function(r,e){for(var t=r[3]&1,n=3;n>0;--n)e[n]=r[n]>>>1|(r[n-1]&1)<<31;e[0]=r[0]>>>1,t&&(e[0]^=this._R)};Pe.gcm.prototype.tableMultiply=function(r){for(var e=[0,0,0,0],t=0;t<32;++t){var n=t/8|0,s=r[n]>>>(7-t%8)*4&15,i=this._m[t][s];e[0]^=i[0],e[1]^=i[1],e[2]^=i[2],e[3]^=i[3]}return e};Pe.gcm.prototype.ghash=function(r,e,t){return e[0]^=t[0],e[1]^=t[1],e[2]^=t[2],e[3]^=t[3],this.tableMultiply(e)};Pe.gcm.prototype.generateHashTable=function(r,e){for(var t=8/e,n=4*t,s=16*t,i=new Array(s),o=0;o<s;++o){var a=[0,0,0,0],c=o/n|0,l=(n-1-o%n)*e;a[c]=1<<e-1<<l,i[o]=this.generateSubHashTable(this.multiply(a,r),e)}return i};Pe.gcm.prototype.generateSubHashTable=function(r,e){var t=1<<e,n=t>>>1,s=new Array(t);s[n]=r.slice(0);for(var i=n>>>1;i>0;)this.pow(s[2*i],s[i]=[]),i>>=1;for(i=2;i<n;){for(var o=1;o<i;++o){var a=s[i],c=s[o];s[i+o]=[a[0]^c[0],a[1]^c[1],a[2]^c[2],a[3]^c[3]]}i*=2}for(s[0]=[0,0,0,0],i=n+1;i<t;++i){var l=s[i^n];s[i]=[r[0]^l[0],r[1]^l[1],r[2]^l[2],r[3]^l[3]]}return s};function N0(r,e){if(typeof r=="string"&&(r=$t.util.createBuffer(r)),$t.util.isArray(r)&&r.length>4){var t=r;r=$t.util.createBuffer();for(var n=0;n<t.length;++n)r.putByte(t[n])}if(r.length()<e)throw new Error("Invalid IV length; got "+r.length()+" bytes and expected "+e+" bytes.");if(!$t.util.isArray(r)){for(var s=[],i=e/4,n=0;n<i;++n)s.push(r.getInt32());r=s}return r}function O0(r){r[r.length-1]=r[r.length-1]+1&4294967295}function Bp(r){return[r/4294967296|0,r&4294967295]}});var B0=K((vZ,p7)=>{var et=Qe();Lp();Mp();Rt();p7.exports=et.aes=et.aes||{};et.aes.startEncrypting=function(r,e,t,n){var s=L0({key:r,output:t,decrypt:!1,mode:n});return s.start(e),s};et.aes.createEncryptionCipher=function(r,e){return L0({key:r,output:null,decrypt:!1,mode:e})};et.aes.startDecrypting=function(r,e,t,n){var s=L0({key:r,output:t,decrypt:!0,mode:n});return s.start(e),s};et.aes.createDecryptionCipher=function(r,e){return L0({key:r,output:null,decrypt:!0,mode:e})};et.aes.Algorithm=function(r,e){Kp||h7();var t=this;t.name=r,t.mode=new e({blockSize:16,cipher:{encrypt:function(n,s){return Fp(t._w,n,s,!1)},decrypt:function(n,s){return Fp(t._w,n,s,!0)}}}),t._init=!1};et.aes.Algorithm.prototype.initialize=function(r){if(!this._init){var e=r.key,t;if(typeof e=="string"&&(e.length===16||e.length===24||e.length===32))e=et.util.createBuffer(e);else if(et.util.isArray(e)&&(e.length===16||e.length===24||e.length===32)){t=e,e=et.util.createBuffer();for(var n=0;n<t.length;++n)e.putByte(t[n])}if(!et.util.isArray(e)){t=e,e=[];var s=t.length();if(s===16||s===24||s===32){s=s>>>2;for(var n=0;n<s;++n)e.push(t.getInt32())}}if(!et.util.isArray(e)||!(e.length===4||e.length===6||e.length===8))throw new Error("Invalid key parameter.");var i=this.mode.name,o=["CFB","OFB","CTR","GCM"].indexOf(i)!==-1;this._w=d7(e,r.decrypt&&!o),this._init=!0}};et.aes._expandKey=function(r,e){return Kp||h7(),d7(r,e)};et.aes._updateBlock=Fp;pa("AES-ECB",et.cipher.modes.ecb);pa("AES-CBC",et.cipher.modes.cbc);pa("AES-CFB",et.cipher.modes.cfb);pa("AES-OFB",et.cipher.modes.ofb);pa("AES-CTR",et.cipher.modes.ctr);pa("AES-GCM",et.cipher.modes.gcm);function pa(r,e){var t=function(){return new et.aes.Algorithm(r,e)};et.cipher.registerAlgorithm(r,t)}var Kp=!1,da=4,br,Up,f7,co,On;function h7(){Kp=!0,f7=[0,1,2,4,8,16,32,64,128,27,54];for(var r=new Array(256),e=0;e<128;++e)r[e]=e<<1,r[e+128]=e+128<<1^283;br=new Array(256),Up=new Array(256),co=new Array(4),On=new Array(4);for(var e=0;e<4;++e)co[e]=new Array(256),On[e]=new Array(256);for(var t=0,n=0,s,i,o,a,c,l,u,e=0;e<256;++e){a=n^n<<1^n<<2^n<<3^n<<4,a=a>>8^a&255^99,br[t]=a,Up[a]=t,c=r[a],s=r[t],i=r[s],o=r[i],l=c<<24^a<<16^a<<8^(a^c),u=(s^i^o)<<24^(t^o)<<16^(t^i^o)<<8^(t^s^o);for(var f=0;f<4;++f)co[f][t]=l,On[f][a]=u,l=l<<24|l>>>8,u=u<<24|u>>>8;t===0?t=n=1:(t=s^r[r[r[s^o]]],n^=r[r[n]])}}function d7(r,e){for(var t=r.slice(0),n,s=1,i=t.length,o=i+6+1,a=da*o,c=i;c<a;++c)n=t[c-1],c%i===0?(n=br[n>>>16&255]<<24^br[n>>>8&255]<<16^br[n&255]<<8^br[n>>>24]^f7[s]<<24,s++):i>6&&c%i===4&&(n=br[n>>>24]<<24^br[n>>>16&255]<<16^br[n>>>8&255]<<8^br[n&255]),t[c]=t[c-i]^n;if(e){var l,u=On[0],f=On[1],h=On[2],d=On[3],p=t.slice(0);a=t.length;for(var c=0,m=a-da;c<a;c+=da,m-=da)if(c===0||c===a-da)p[c]=t[m],p[c+1]=t[m+3],p[c+2]=t[m+2],p[c+3]=t[m+1];else for(var g=0;g<da;++g)l=t[m+g],p[c+(3&-g)]=u[br[l>>>24]]^f[br[l>>>16&255]]^h[br[l>>>8&255]]^d[br[l&255]];t=p}return t}function Fp(r,e,t,n){var s=r.length/4-1,i,o,a,c,l;n?(i=On[0],o=On[1],a=On[2],c=On[3],l=Up):(i=co[0],o=co[1],a=co[2],c=co[3],l=br);var u,f,h,d,p,m,g;u=e[0]^r[0],f=e[n?3:1]^r[1],h=e[2]^r[2],d=e[n?1:3]^r[3];for(var y=3,w=1;w<s;++w)p=i[u>>>24]^o[f>>>16&255]^a[h>>>8&255]^c[d&255]^r[++y],m=i[f>>>24]^o[h>>>16&255]^a[d>>>8&255]^c[u&255]^r[++y],g=i[h>>>24]^o[d>>>16&255]^a[u>>>8&255]^c[f&255]^r[++y],d=i[d>>>24]^o[u>>>16&255]^a[f>>>8&255]^c[h&255]^r[++y],u=p,f=m,h=g;t[0]=l[u>>>24]<<24^l[f>>>16&255]<<16^l[h>>>8&255]<<8^l[d&255]^r[++y],t[n?3:1]=l[f>>>24]<<24^l[h>>>16&255]<<16^l[d>>>8&255]<<8^l[u&255]^r[++y],t[2]=l[h>>>24]<<24^l[d>>>16&255]<<16^l[u>>>8&255]<<8^l[f&255]^r[++y],t[n?1:3]=l[d>>>24]<<24^l[u>>>16&255]<<16^l[f>>>8&255]<<8^l[h&255]^r[++y]}function L0(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="AES-"+e,n;r.decrypt?n=et.cipher.createDecipher(t,r.key):n=et.cipher.createCipher(t,r.key);var s=n.start;return n.start=function(i,o){var a=null;o instanceof et.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=i,s.call(n,o)},n}});var y7=K((_Z,g7)=>{var ut=Qe();Lp();Mp();Rt();g7.exports=ut.des=ut.des||{};ut.des.startEncrypting=function(r,e,t,n){var s=M0({key:r,output:t,decrypt:!1,mode:n||(e===null?"ECB":"CBC")});return s.start(e),s};ut.des.createEncryptionCipher=function(r,e){return M0({key:r,output:null,decrypt:!1,mode:e})};ut.des.startDecrypting=function(r,e,t,n){var s=M0({key:r,output:t,decrypt:!0,mode:n||(e===null?"ECB":"CBC")});return s.start(e),s};ut.des.createDecryptionCipher=function(r,e){return M0({key:r,output:null,decrypt:!0,mode:e})};ut.des.Algorithm=function(r,e){var t=this;t.name=r,t.mode=new e({blockSize:8,cipher:{encrypt:function(n,s){return m7(t._keys,n,s,!1)},decrypt:function(n,s){return m7(t._keys,n,s,!0)}}}),t._init=!1};ut.des.Algorithm.prototype.initialize=function(r){if(!this._init){var e=ut.util.createBuffer(r.key);if(this.name.indexOf("3DES")===0&&e.length()!==24)throw new Error("Invalid Triple-DES key size: "+e.length()*8);this._keys=VP(e),this._init=!0}};ss("DES-ECB",ut.cipher.modes.ecb);ss("DES-CBC",ut.cipher.modes.cbc);ss("DES-CFB",ut.cipher.modes.cfb);ss("DES-OFB",ut.cipher.modes.ofb);ss("DES-CTR",ut.cipher.modes.ctr);ss("3DES-ECB",ut.cipher.modes.ecb);ss("3DES-CBC",ut.cipher.modes.cbc);ss("3DES-CFB",ut.cipher.modes.cfb);ss("3DES-OFB",ut.cipher.modes.ofb);ss("3DES-CTR",ut.cipher.modes.ctr);function ss(r,e){var t=function(){return new ut.des.Algorithm(r,e)};ut.cipher.registerAlgorithm(r,t)}var NP=[16843776,0,65536,16843780,16842756,66564,4,65536,1024,16843776,16843780,1024,16778244,16842756,16777216,4,1028,16778240,16778240,66560,66560,16842752,16842752,16778244,65540,16777220,16777220,65540,0,1028,66564,16777216,65536,16843780,4,16842752,16843776,16777216,16777216,1024,16842756,65536,66560,16777220,1024,4,16778244,66564,16843780,65540,16842752,16778244,16777220,1028,66564,16843776,1028,16778240,16778240,0,65540,66560,0,16842756],OP=[-2146402272,-2147450880,32768,1081376,1048576,32,-2146435040,-2147450848,-2147483616,-2146402272,-2146402304,-2147483648,-2147450880,1048576,32,-2146435040,1081344,1048608,-2147450848,0,-2147483648,32768,1081376,-2146435072,1048608,-2147483616,0,1081344,32800,-2146402304,-2146435072,32800,0,1081376,-2146435040,1048576,-2147450848,-2146435072,-2146402304,32768,-2146435072,-2147450880,32,-2146402272,1081376,32,32768,-2147483648,32800,-2146402304,1048576,-2147483616,1048608,-2147450848,-2147483616,1048608,1081344,0,-2147450880,32800,-2147483648,-2146435040,-2146402272,1081344],LP=[520,134349312,0,134348808,134218240,0,131592,134218240,131080,134217736,134217736,131072,134349320,131080,134348800,520,134217728,8,134349312,512,131584,134348800,134348808,131592,134218248,131584,131072,134218248,8,134349320,512,134217728,134349312,134217728,131080,520,131072,134349312,134218240,0,512,131080,134349320,134218240,134217736,512,0,134348808,134218248,131072,134217728,134349320,8,131592,131584,134217736,134348800,134218248,520,134348800,131592,8,134348808,131584],BP=[8396801,8321,8321,128,8396928,8388737,8388609,8193,0,8396800,8396800,8396929,129,0,8388736,8388609,1,8192,8388608,8396801,128,8388608,8193,8320,8388737,1,8320,8388736,8192,8396928,8396929,129,8388736,8388609,8396800,8396929,129,0,0,8396800,8320,8388736,8388737,1,8396801,8321,8321,128,8396929,129,1,8192,8388609,8193,8396928,8388737,8193,8320,8388608,8396801,128,8388608,8192,8396928],MP=[256,34078976,34078720,1107296512,524288,256,1073741824,34078720,1074266368,524288,33554688,1074266368,1107296512,1107820544,524544,1073741824,33554432,1074266112,1074266112,0,1073742080,1107820800,1107820800,33554688,1107820544,1073742080,0,1107296256,34078976,33554432,1107296256,524544,524288,1107296512,256,33554432,1073741824,34078720,1107296512,1074266368,33554688,1073741824,1107820544,34078976,1074266368,256,33554432,1107820544,1107820800,524544,1107296256,1107820800,34078720,0,1074266112,1107296256,524544,33554688,1073742080,524288,0,1074266112,34078976,1073742080],UP=[536870928,541065216,16384,541081616,541065216,16,541081616,4194304,536887296,4210704,4194304,536870928,4194320,536887296,536870912,16400,0,4194320,536887312,16384,4210688,536887312,16,541065232,541065232,0,4210704,541081600,16400,4210688,541081600,536870912,536887296,16,541065232,4210688,541081616,4194304,16400,536870928,4194304,536887296,536870912,16400,536870928,541081616,4210688,541065216,4210704,541081600,0,541065232,16,16384,541065216,4210704,16384,4194320,536887312,0,541081600,536870912,4194320,536887312],FP=[2097152,69206018,67110914,0,2048,67110914,2099202,69208064,69208066,2097152,0,67108866,2,67108864,69206018,2050,67110912,2099202,2097154,67110912,67108866,69206016,69208064,2097154,69206016,2048,2050,69208066,2099200,2,67108864,2099200,67108864,2099200,2097152,67110914,67110914,69206018,69206018,2,2097154,67108864,67110912,2097152,69208064,2050,2099202,69208064,2050,67108866,69208066,69206016,2099200,0,2,69208066,0,2099202,69206016,2048,67108866,67110912,2048,2097154],KP=[268439616,4096,262144,268701760,268435456,268439616,64,268435456,262208,268697600,268701760,266240,268701696,266304,4096,64,268697600,268435520,268439552,4160,266240,262208,268697664,268701696,4160,0,0,268697664,268435520,268439552,266304,262144,266304,262144,268701696,4096,64,268697664,4096,266304,268439552,64,268435520,268697600,268697664,268435456,262144,268439616,0,268701760,262208,268435520,268697600,268439552,268439616,0,268701760,266240,266240,4160,4160,262208,268435456,268701696];function VP(r){for(var e=[0,4,536870912,536870916,65536,65540,536936448,536936452,512,516,536871424,536871428,66048,66052,536936960,536936964],t=[0,1,1048576,1048577,67108864,67108865,68157440,68157441,256,257,1048832,1048833,67109120,67109121,68157696,68157697],n=[0,8,2048,2056,16777216,16777224,16779264,16779272,0,8,2048,2056,16777216,16777224,16779264,16779272],s=[0,2097152,134217728,136314880,8192,2105344,134225920,136323072,131072,2228224,134348800,136445952,139264,2236416,134356992,136454144],i=[0,262144,16,262160,0,262144,16,262160,4096,266240,4112,266256,4096,266240,4112,266256],o=[0,1024,32,1056,0,1024,32,1056,33554432,33555456,33554464,33555488,33554432,33555456,33554464,33555488],a=[0,268435456,524288,268959744,2,268435458,524290,268959746,0,268435456,524288,268959744,2,268435458,524290,268959746],c=[0,65536,2048,67584,536870912,536936448,536872960,536938496,131072,196608,133120,198656,537001984,537067520,537004032,537069568],l=[0,262144,0,262144,2,262146,2,262146,33554432,33816576,33554432,33816576,33554434,33816578,33554434,33816578],u=[0,268435456,8,268435464,0,268435456,8,268435464,1024,268436480,1032,268436488,1024,268436480,1032,268436488],f=[0,32,0,32,1048576,1048608,1048576,1048608,8192,8224,8192,8224,1056768,1056800,1056768,1056800],h=[0,16777216,512,16777728,2097152,18874368,2097664,18874880,67108864,83886080,67109376,83886592,69206016,85983232,69206528,85983744],d=[0,4096,134217728,134221824,524288,528384,134742016,134746112,16,4112,134217744,134221840,524304,528400,134742032,134746128],p=[0,4,256,260,0,4,256,260,1,5,257,261,1,5,257,261],m=r.length()>8?3:1,g=[],y=[0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0],w=0,E,R=0;R<m;R++){var x=r.getInt32(),v=r.getInt32();E=(x>>>4^v)&252645135,v^=E,x^=E<<4,E=(v>>>-16^x)&65535,x^=E,v^=E<<-16,E=(x>>>2^v)&858993459,v^=E,x^=E<<2,E=(v>>>-16^x)&65535,x^=E,v^=E<<-16,E=(x>>>1^v)&1431655765,v^=E,x^=E<<1,E=(v>>>8^x)&16711935,x^=E,v^=E<<8,E=(x>>>1^v)&1431655765,v^=E,x^=E<<1,E=x<<8|v>>>20&240,x=v<<24|v<<8&16711680|v>>>8&65280|v>>>24&240,v=E;for(var I=0;I<y.length;++I){y[I]?(x=x<<2|x>>>26,v=v<<2|v>>>26):(x=x<<1|x>>>27,v=v<<1|v>>>27),x&=-15,v&=-15;var _=e[x>>>28]|t[x>>>24&15]|n[x>>>20&15]|s[x>>>16&15]|i[x>>>12&15]|o[x>>>8&15]|a[x>>>4&15],D=c[v>>>28]|l[v>>>24&15]|u[v>>>20&15]|f[v>>>16&15]|h[v>>>12&15]|d[v>>>8&15]|p[v>>>4&15];E=(D>>>16^_)&65535,g[w++]=_^E,g[w++]=D^E<<16}}return g}function m7(r,e,t,n){var s=r.length===32?3:9,i;s===3?i=n?[30,-2,-2]:[0,32,2]:i=n?[94,62,-2,32,64,2,30,-2,-2]:[0,32,2,62,30,-2,64,96,2];var o,a=e[0],c=e[1];o=(a>>>4^c)&252645135,c^=o,a^=o<<4,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,a=a<<1|a>>>31,c=c<<1|c>>>31;for(var l=0;l<s;l+=3){for(var u=i[l+1],f=i[l+2],h=i[l];h!=u;h+=f){var d=c^r[h],p=(c>>>4|c<<28)^r[h+1];o=a,a=c,c=o^(OP[d>>>24&63]|BP[d>>>16&63]|UP[d>>>8&63]|KP[d&63]|NP[p>>>24&63]|LP[p>>>16&63]|MP[p>>>8&63]|FP[p&63])}o=a,a=c,c=o}a=a>>>1|a<<31,c=c>>>1|c<<31,o=(a>>>1^c)&1431655765,c^=o,a^=o<<1,o=(c>>>8^a)&16711935,a^=o,c^=o<<8,o=(c>>>2^a)&858993459,a^=o,c^=o<<2,o=(a>>>16^c)&65535,c^=o,a^=o<<16,o=(a>>>4^c)&252645135,c^=o,a^=o<<4,t[0]=a,t[1]=c}function M0(r){r=r||{};var e=(r.mode||"CBC").toUpperCase(),t="DES-"+e,n;r.decrypt?n=ut.cipher.createDecipher(t,r.key):n=ut.cipher.createCipher(t,r.key);var s=n.start;return n.start=function(i,o){var a=null;o instanceof ut.util.ByteBuffer&&(a=o,o={}),o=o||{},o.output=a,o.iv=i,s.call(n,o)},n}});var lo=K((SZ,b7)=>{var U0=Qe();b7.exports=U0.md=U0.md||{};U0.md.algorithms=U0.md.algorithms||{}});var E7=K((RZ,w7)=>{var As=Qe();lo();Rt();var qP=w7.exports=As.hmac=As.hmac||{};qP.create=function(){var r=null,e=null,t=null,n=null,s={};return s.start=function(i,o){if(i!==null)if(typeof i=="string")if(i=i.toLowerCase(),i in As.md.algorithms)e=As.md.algorithms[i].create();else throw new Error('Unknown hash algorithm "'+i+'"');else e=i;if(o===null)o=r;else{if(typeof o=="string")o=As.util.createBuffer(o);else if(As.util.isArray(o)){var a=o;o=As.util.createBuffer();for(var c=0;c<a.length;++c)o.putByte(a[c])}var l=o.length();l>e.blockLength&&(e.start(),e.update(o.bytes()),o=e.digest()),t=As.util.createBuffer(),n=As.util.createBuffer(),l=o.length();for(var c=0;c<l;++c){var a=o.at(c);t.putByte(54^a),n.putByte(92^a)}if(l<e.blockLength)for(var a=e.blockLength-l,c=0;c<a;++c)t.putByte(54),n.putByte(92);r=o,t=t.bytes(),n=n.bytes()}e.start(),e.update(t)},s.update=function(i){e.update(i)},s.getMac=function(){var i=e.digest().bytes();return e.start(),e.update(n),e.update(i),e.digest()},s.digest=s.getMac,s}});var il=K(()=>{});var Vp=K((AZ,x7)=>{var wr=Qe();E7();lo();Rt();var zP=wr.pkcs5=wr.pkcs5||{},Ds;wr.util.isNodejs&&!wr.options.usePureJavaScript&&(Ds=il());x7.exports=wr.pbkdf2=zP.pbkdf2=function(r,e,t,n,s,i){if(typeof s=="function"&&(i=s,s=null),wr.util.isNodejs&&!wr.options.usePureJavaScript&&Ds.pbkdf2&&(s===null||typeof s!="object")&&(Ds.pbkdf2Sync.length>4||!s||s==="sha1"))return typeof s!="string"&&(s="sha1"),r=Buffer.from(r,"binary"),e=Buffer.from(e,"binary"),i?Ds.pbkdf2Sync.length===4?Ds.pbkdf2(r,e,t,n,function(E,R){if(E)return i(E);i(null,R.toString("binary"))}):Ds.pbkdf2(r,e,t,n,s,function(E,R){if(E)return i(E);i(null,R.toString("binary"))}):Ds.pbkdf2Sync.length===4?Ds.pbkdf2Sync(r,e,t,n).toString("binary"):Ds.pbkdf2Sync(r,e,t,n,s).toString("binary");if((typeof s>"u"||s===null)&&(s="sha1"),typeof s=="string"){if(!(s in wr.md.algorithms))throw new Error("Unknown hash algorithm: "+s);s=wr.md[s].create()}var o=s.digestLength;if(n>4294967295*o){var a=new Error("Derived key is too long.");if(i)return i(a);throw a}var c=Math.ceil(n/o),l=n-(c-1)*o,u=wr.hmac.create();u.start(s,r);var f="",h,d,p;if(!i){for(var m=1;m<=c;++m){u.start(null,null),u.update(e),u.update(wr.util.int32ToBytes(m)),h=p=u.digest().getBytes();for(var g=2;g<=t;++g)u.start(null,null),u.update(p),d=u.digest().getBytes(),h=wr.util.xorBytes(h,d,o),p=d;f+=m<c?h:h.substr(0,l)}return f}var m=1,g;function y(){if(m>c)return i(null,f);u.start(null,null),u.update(e),u.update(wr.util.int32ToBytes(m)),h=p=u.digest().getBytes(),g=2,w()}function w(){if(g<=t)return u.start(null,null),u.update(p),d=u.digest().getBytes(),h=wr.util.xorBytes(h,d,o),p=d,++g,wr.util.setImmediate(w);f+=m<c?h:h.substr(0,l),++m,y()}y()}});var S7=K((DZ,_7)=>{var K0=Qe();Rt();var v7=_7.exports=K0.pem=K0.pem||{};v7.encode=function(r,e){e=e||{};var t="-----BEGIN "+r.type+`-----\r
`,n;if(r.procType&&(n={name:"Proc-Type",values:[String(r.procType.version),r.procType.type]},t+=F0(n)),r.contentDomain&&(n={name:"Content-Domain",values:[r.contentDomain]},t+=F0(n)),r.dekInfo&&(n={name:"DEK-Info",values:[r.dekInfo.algorithm]},r.dekInfo.parameters&&n.values.push(r.dekInfo.parameters),t+=F0(n)),r.headers)for(var s=0;s<r.headers.length;++s)t+=F0(r.headers[s]);return r.procType&&(t+=`\r
`),t+=K0.util.encode64(r.body,e.maxline||64)+`\r
`,t+="-----END "+r.type+`-----\r
`,t};v7.decode=function(r){for(var e=[],t=/\s*-----BEGIN ([A-Z0-9- ]+)-----\r?\n?([\x21-\x7e\s]+?(?:\r?\n\r?\n))?([:A-Za-z0-9+\/=\s]+?)-----END \1-----/g,n=/([\x21-\x7e]+):\s*([\x21-\x7e\s^:]+)/,s=/\r?\n/,i;i=t.exec(r),!!i;){var o=i[1];o==="NEW CERTIFICATE REQUEST"&&(o="CERTIFICATE REQUEST");var a={type:o,procType:null,contentDomain:null,dekInfo:null,headers:[],body:K0.util.decode64(i[3])};if(e.push(a),!!i[2]){for(var c=i[2].split(s),l=0;i&&l<c.length;){for(var u=c[l].replace(/\s+$/,""),f=l+1;f<c.length;++f){var h=c[f];if(!/\s/.test(h[0]))break;u+=h,l=f}if(i=u.match(n),i){for(var d={name:i[1],values:[]},p=i[2].split(","),m=0;m<p.length;++m)d.values.push($P(p[m]));if(a.procType)if(!a.contentDomain&&d.name==="Content-Domain")a.contentDomain=p[0]||"";else if(!a.dekInfo&&d.name==="DEK-Info"){if(d.values.length===0)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must have at least one subfield.');a.dekInfo={algorithm:p[0],parameters:p[1]||null}}else a.headers.push(d);else{if(d.name!=="Proc-Type")throw new Error('Invalid PEM formatted message. The first encapsulated header must be "Proc-Type".');if(d.values.length!==2)throw new Error('Invalid PEM formatted message. The "Proc-Type" header must have two subfields.');a.procType={version:p[0],type:p[1]}}}++l}if(a.procType==="ENCRYPTED"&&!a.dekInfo)throw new Error('Invalid PEM formatted message. The "DEK-Info" header must be present if "Proc-Type" is "ENCRYPTED".')}}if(e.length===0)throw new Error("Invalid PEM formatted message.");return e};function F0(r){for(var e=r.name+": ",t=[],n=function(c,l){return" "+l},s=0;s<r.values.length;++s)t.push(r.values[s].replace(/^(\S+\r\n)/,n));e+=t.join(",")+`\r
`;for(var i=0,o=-1,s=0;s<e.length;++s,++i)if(i>65&&o!==-1){var a=e[o];a===","?(++o,e=e.substr(0,o)+`\r
 `+e.substr(o)):e=e.substr(0,o)+`\r
`+a+e.substr(o+1),i=s-o-1,o=-1,++s}else(e[s]===" "||e[s]==="	"||e[s]===",")&&(o=s);return e}function $P(r){return r.replace(/^\s+/,"")}});var C7=K((CZ,D7)=>{var is=Qe();lo();Rt();var I7=D7.exports=is.sha256=is.sha256||{};is.md.sha256=is.md.algorithms.sha256=I7;I7.create=function(){T7||HP();var r=null,e=is.util.createBuffer(),t=new Array(64),n={algorithm:"sha256",blockLength:64,digestLength:32,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var s=n.messageLengthSize/4,i=0;i<s;++i)n.fullMessageLength.push(0);return e=is.util.createBuffer(),r={h0:1779033703,h1:3144134277,h2:1013904242,h3:2773480762,h4:1359893119,h5:2600822924,h6:528734635,h7:1541459225},n},n.start(),n.update=function(s,i){i==="utf8"&&(s=is.util.encodeUtf8(s));var o=s.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(s),R7(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var s=is.util.createBuffer();s.putBytes(e.bytes());var i=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=i&n.blockLength-1;s.putBytes(qp.substr(0,n.blockLength-o));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,s.putInt32(l>>>0),l=a>>>0;s.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4,h5:r.h5,h6:r.h6,h7:r.h7};R7(f,t,s);var h=is.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h.putInt32(f.h5),h.putInt32(f.h6),h.putInt32(f.h7),h},n};var qp=null,T7=!1,A7=null;function HP(){qp=String.fromCharCode(128),qp+=is.util.fillString(String.fromCharCode(0),64),A7=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],T7=!0}function R7(r,e,t){for(var n,s,i,o,a,c,l,u,f,h,d,p,m,g,y,w=t.length();w>=64;){for(l=0;l<16;++l)e[l]=t.getInt32();for(;l<64;++l)n=e[l-2],n=(n>>>17|n<<15)^(n>>>19|n<<13)^n>>>10,s=e[l-15],s=(s>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,e[l]=n+e[l-7]+s+e[l-16]|0;for(u=r.h0,f=r.h1,h=r.h2,d=r.h3,p=r.h4,m=r.h5,g=r.h6,y=r.h7,l=0;l<64;++l)o=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7),a=g^p&(m^g),i=(u>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),c=u&f|h&(u^f),n=y+o+a+A7[l]+e[l],s=i+c,y=g,g=m,m=p,p=d+n>>>0,d=h,h=f,f=u,u=n+s>>>0;r.h0=r.h0+u|0,r.h1=r.h1+f|0,r.h2=r.h2+h|0,r.h3=r.h3+d|0,r.h4=r.h4+p|0,r.h5=r.h5+m|0,r.h6=r.h6+g|0,r.h7=r.h7+y|0,w-=64}}});var k7=K((PZ,P7)=>{var os=Qe();Rt();var V0=null;os.util.isNodejs&&!os.options.usePureJavaScript&&!process.versions["node-webkit"]&&(V0=il());var WP=P7.exports=os.prng=os.prng||{};WP.create=function(r){for(var e={plugin:r,key:null,seed:null,time:null,reseeds:0,generated:0,keyBytes:""},t=r.md,n=new Array(32),s=0;s<32;++s)n[s]=t.create();e.pools=n,e.pool=0,e.generate=function(l,u){if(!u)return e.generateSync(l);var f=e.plugin.cipher,h=e.plugin.increment,d=e.plugin.formatKey,p=e.plugin.formatSeed,m=os.util.createBuffer();e.key=null,g();function g(y){if(y)return u(y);if(m.length()>=l)return u(null,m.getBytes(l));if(e.generated>1048575&&(e.key=null),e.key===null)return os.util.nextTick(function(){i(g)});var w=f(e.key,e.seed);e.generated+=w.length,m.putBytes(w),e.key=d(f(e.key,h(e.seed))),e.seed=p(f(e.key,e.seed)),os.util.setImmediate(g)}},e.generateSync=function(l){var u=e.plugin.cipher,f=e.plugin.increment,h=e.plugin.formatKey,d=e.plugin.formatSeed;e.key=null;for(var p=os.util.createBuffer();p.length()<l;){e.generated>1048575&&(e.key=null),e.key===null&&o();var m=u(e.key,e.seed);e.generated+=m.length,p.putBytes(m),e.key=h(u(e.key,f(e.seed))),e.seed=d(u(e.key,e.seed))}return p.getBytes(l)};function i(l){if(e.pools[0].messageLength>=32)return a(),l();var u=32-e.pools[0].messageLength<<5;e.seedFile(u,function(f,h){if(f)return l(f);e.collect(h),a(),l()})}function o(){if(e.pools[0].messageLength>=32)return a();var l=32-e.pools[0].messageLength<<5;e.collect(e.seedFileSync(l)),a()}function a(){e.reseeds=e.reseeds===4294967295?0:e.reseeds+1;var l=e.plugin.md.create();l.update(e.keyBytes);for(var u=1,f=0;f<32;++f)e.reseeds%u===0&&(l.update(e.pools[f].digest().getBytes()),e.pools[f].start()),u=u<<1;e.keyBytes=l.digest().getBytes(),l.start(),l.update(e.keyBytes);var h=l.digest().getBytes();e.key=e.plugin.formatKey(e.keyBytes),e.seed=e.plugin.formatSeed(h),e.generated=0}function c(l){var u=null,f=os.util.globalScope,h=f.crypto||f.msCrypto;h&&h.getRandomValues&&(u=function(x){return h.getRandomValues(x)});var d=os.util.createBuffer();if(u)for(;d.length()<l;){var p=Math.max(1,Math.min(l-d.length(),65536)/4),m=new Uint32Array(Math.floor(p));try{u(m);for(var g=0;g<m.length;++g)d.putInt32(m[g])}catch(x){if(!(typeof QuotaExceededError<"u"&&x instanceof QuotaExceededError))throw x}}if(d.length()<l)for(var y,w,E,R=Math.floor(Math.random()*65536);d.length()<l;){w=16807*(R&65535),y=16807*(R>>16),w+=(y&32767)<<16,w+=y>>15,w=(w&2147483647)+(w>>31),R=w&4294967295;for(var g=0;g<3;++g)E=R>>>(g<<3),E^=Math.floor(Math.random()*256),d.putByte(E&255)}return d.getBytes(l)}return V0?(e.seedFile=function(l,u){V0.randomBytes(l,function(f,h){if(f)return u(f);u(null,h.toString())})},e.seedFileSync=function(l){return V0.randomBytes(l).toString()}):(e.seedFile=function(l,u){try{u(null,c(l))}catch(f){u(f)}},e.seedFileSync=c),e.collect=function(l){for(var u=l.length,f=0;f<u;++f)e.pools[e.pool].update(l.substr(f,1)),e.pool=e.pool===31?0:e.pool+1},e.collectInt=function(l,u){for(var f="",h=0;h<u;h+=8)f+=String.fromCharCode(l>>h&255);e.collect(f)},e.registerWorker=function(l){if(l===self)e.seedFile=function(f,h){function d(p){var m=p.data;m.forge&&m.forge.prng&&(self.removeEventListener("message",d),h(m.forge.prng.err,m.forge.prng.bytes))}self.addEventListener("message",d),self.postMessage({forge:{prng:{needed:f}}})};else{var u=function(f){var h=f.data;h.forge&&h.forge.prng&&e.seedFile(h.forge.prng.needed,function(d,p){l.postMessage({forge:{prng:{err:d,bytes:p}}})})};l.addEventListener("message",u)}},e}});var ol=K((kZ,zp)=>{var Ht=Qe();B0();C7();k7();Rt();(function(){if(Ht.random&&Ht.random.getBytes){zp.exports=Ht.random;return}(function(r){var e={},t=new Array(4),n=Ht.util.createBuffer();e.formatKey=function(f){var h=Ht.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),Ht.aes._expandKey(f,!1)},e.formatSeed=function(f){var h=Ht.util.createBuffer(f);return f=new Array(4),f[0]=h.getInt32(),f[1]=h.getInt32(),f[2]=h.getInt32(),f[3]=h.getInt32(),f},e.cipher=function(f,h){return Ht.aes._updateBlock(f,h,t,!1),n.putInt32(t[0]),n.putInt32(t[1]),n.putInt32(t[2]),n.putInt32(t[3]),n.getBytes()},e.increment=function(f){return++f[3],f},e.md=Ht.md.sha256;function s(){var f=Ht.prng.create(e);return f.getBytes=function(h,d){return f.generate(h,d)},f.getBytesSync=function(h){return f.generate(h)},f}var i=s(),o=null,a=Ht.util.globalScope,c=a.crypto||a.msCrypto;if(c&&c.getRandomValues&&(o=function(f){return c.getRandomValues(f)}),Ht.options.usePureJavaScript||!Ht.util.isNodejs&&!o){if(typeof window>"u"||window.document,i.collectInt(+new Date,32),typeof navigator<"u"){var l="";for(var u in navigator)try{typeof navigator[u]=="string"&&(l+=navigator[u])}catch{}i.collect(l),l=null}r&&(r().mousemove(function(f){i.collectInt(f.clientX,16),i.collectInt(f.clientY,16)}),r().keypress(function(f){i.collectInt(f.charCode,8)}))}if(!Ht.random)Ht.random=i;else for(var u in i)Ht.random[u]=i[u];Ht.random.createInstance=s,zp.exports=Ht.random})(typeof jQuery<"u"?jQuery:null)})()});var B7=K((NZ,L7)=>{var Cr=Qe();Rt();var $p=[217,120,249,196,25,221,181,237,40,233,253,121,74,160,216,157,198,126,55,131,43,118,83,142,98,76,100,136,68,139,251,162,23,154,89,245,135,179,79,19,97,69,109,141,9,129,125,50,189,143,64,235,134,183,123,11,240,149,33,34,92,107,78,130,84,214,101,147,206,96,178,28,115,86,192,20,167,140,241,220,18,117,202,31,59,190,228,209,66,61,212,48,163,60,182,38,111,191,14,218,70,105,7,87,39,242,29,155,188,148,67,3,248,17,199,246,144,239,62,231,6,195,213,47,200,102,30,215,8,232,234,222,128,82,238,247,132,170,114,172,53,77,106,42,150,26,210,113,90,21,73,116,75,159,208,94,4,24,164,236,194,224,65,110,15,81,203,204,36,145,175,80,161,244,112,57,153,124,58,133,35,184,180,122,252,2,54,91,37,85,151,49,45,93,250,152,227,138,146,174,5,223,41,16,103,108,186,201,211,0,230,207,225,158,168,44,99,22,1,63,88,226,137,169,13,56,52,27,171,51,255,176,187,72,12,95,185,177,205,46,197,243,219,71,229,165,156,119,10,166,32,104,254,127,193,173],N7=[1,2,3,5],GP=function(r,e){return r<<e&65535|(r&65535)>>16-e},YP=function(r,e){return(r&65535)>>e|r<<16-e&65535};L7.exports=Cr.rc2=Cr.rc2||{};Cr.rc2.expandKey=function(r,e){typeof r=="string"&&(r=Cr.util.createBuffer(r)),e=e||128;var t=r,n=r.length(),s=e,i=Math.ceil(s/8),o=255>>(s&7),a;for(a=n;a<128;a++)t.putByte($p[t.at(a-1)+t.at(a-n)&255]);for(t.setAt(128-i,$p[t.at(128-i)&o]),a=127-i;a>=0;a--)t.setAt(a,$p[t.at(a+1)^t.at(a+i)]);return t};var O7=function(r,e,t){var n=!1,s=null,i=null,o=null,a,c,l,u,f=[];for(r=Cr.rc2.expandKey(r,e),l=0;l<64;l++)f.push(r.getInt16Le());t?(a=function(p){for(l=0;l<4;l++)p[l]+=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),p[l]=GP(p[l],N7[l]),u++},c=function(p){for(l=0;l<4;l++)p[l]+=f[p[(l+3)%4]&63]}):(a=function(p){for(l=3;l>=0;l--)p[l]=YP(p[l],N7[l]),p[l]-=f[u]+(p[(l+3)%4]&p[(l+2)%4])+(~p[(l+3)%4]&p[(l+1)%4]),u--},c=function(p){for(l=3;l>=0;l--)p[l]-=f[p[(l+3)%4]&63]});var h=function(p){var m=[];for(l=0;l<4;l++){var g=s.getInt16Le();o!==null&&(t?g^=o.getInt16Le():o.putInt16Le(g)),m.push(g&65535)}u=t?0:63;for(var y=0;y<p.length;y++)for(var w=0;w<p[y][0];w++)p[y][1](m);for(l=0;l<4;l++)o!==null&&(t?o.putInt16Le(m[l]):m[l]^=o.getInt16Le()),i.putInt16Le(m[l])},d=null;return d={start:function(p,m){p&&typeof p=="string"&&(p=Cr.util.createBuffer(p)),n=!1,s=Cr.util.createBuffer(),i=m||new Cr.util.createBuffer,o=p,d.output=i},update:function(p){for(n||s.putBuffer(p);s.length()>=8;)h([[5,a],[1,c],[6,a],[1,c],[5,a]])},finish:function(p){var m=!0;if(t)if(p)m=p(8,s,!t);else{var g=s.length()===8?8:8-s.length();s.fillWithByte(g,g)}if(m&&(n=!0,d.update()),!t&&(m=s.length()===0,m))if(p)m=p(8,i,!t);else{var y=i.length(),w=i.at(y-1);w>y?m=!1:i.truncate(w)}return m}},d};Cr.rc2.startEncrypting=function(r,e,t){var n=Cr.rc2.createEncryptionCipher(r,128);return n.start(e,t),n};Cr.rc2.createEncryptionCipher=function(r,e){return O7(r,e,!0)};Cr.rc2.startDecrypting=function(r,e,t){var n=Cr.rc2.createDecryptionCipher(r,128);return n.start(e,t),n};Cr.rc2.createDecryptionCipher=function(r,e){return O7(r,e,!1)}});var $0=K((OZ,$7)=>{var Hp=Qe();$7.exports=Hp.jsbn=Hp.jsbn||{};var Cs,QP=0xdeadbeefcafe,M7=(QP&16777215)==15715070;function V(r,e,t){this.data=[],r!=null&&(typeof r=="number"?this.fromNumber(r,e,t):e==null&&typeof r!="string"?this.fromString(r,256):this.fromString(r,e))}Hp.jsbn.BigInteger=V;function Me(){return new V(null)}function XP(r,e,t,n,s,i){for(;--i>=0;){var o=e*this.data[r++]+t.data[n]+s;s=Math.floor(o/67108864),t.data[n++]=o&67108863}return s}function jP(r,e,t,n,s,i){for(var o=e&32767,a=e>>15;--i>=0;){var c=this.data[r]&32767,l=this.data[r++]>>15,u=a*c+l*o;c=o*c+((u&32767)<<15)+t.data[n]+(s&1073741823),s=(c>>>30)+(u>>>15)+a*l+(s>>>30),t.data[n++]=c&1073741823}return s}function U7(r,e,t,n,s,i){for(var o=e&16383,a=e>>14;--i>=0;){var c=this.data[r]&16383,l=this.data[r++]>>14,u=a*c+l*o;c=o*c+((u&16383)<<14)+t.data[n]+s,s=(c>>28)+(u>>14)+a*l,t.data[n++]=c&268435455}return s}typeof navigator>"u"?(V.prototype.am=U7,Cs=28):M7&&navigator.appName=="Microsoft Internet Explorer"?(V.prototype.am=jP,Cs=30):M7&&navigator.appName!="Netscape"?(V.prototype.am=XP,Cs=26):(V.prototype.am=U7,Cs=28);V.prototype.DB=Cs;V.prototype.DM=(1<<Cs)-1;V.prototype.DV=1<<Cs;var Wp=52;V.prototype.FV=Math.pow(2,Wp);V.prototype.F1=Wp-Cs;V.prototype.F2=2*Cs-Wp;var ZP="0123456789abcdefghijklmnopqrstuvwxyz",q0=new Array,ma,hn;ma="0".charCodeAt(0);for(hn=0;hn<=9;++hn)q0[ma++]=hn;ma="a".charCodeAt(0);for(hn=10;hn<36;++hn)q0[ma++]=hn;ma="A".charCodeAt(0);for(hn=10;hn<36;++hn)q0[ma++]=hn;function F7(r){return ZP.charAt(r)}function K7(r,e){var t=q0[r.charCodeAt(e)];return t??-1}function JP(r){for(var e=this.t-1;e>=0;--e)r.data[e]=this.data[e];r.t=this.t,r.s=this.s}function ek(r){this.t=1,this.s=r<0?-1:0,r>0?this.data[0]=r:r<-1?this.data[0]=r+this.DV:this.t=0}function pi(r){var e=Me();return e.fromInt(r),e}function tk(r,e){var t;if(e==16)t=4;else if(e==8)t=3;else if(e==256)t=8;else if(e==2)t=1;else if(e==32)t=5;else if(e==4)t=2;else{this.fromRadix(r,e);return}this.t=0,this.s=0;for(var n=r.length,s=!1,i=0;--n>=0;){var o=t==8?r[n]&255:K7(r,n);if(o<0){r.charAt(n)=="-"&&(s=!0);continue}s=!1,i==0?this.data[this.t++]=o:i+t>this.DB?(this.data[this.t-1]|=(o&(1<<this.DB-i)-1)<<i,this.data[this.t++]=o>>this.DB-i):this.data[this.t-1]|=o<<i,i+=t,i>=this.DB&&(i-=this.DB)}t==8&&r[0]&128&&(this.s=-1,i>0&&(this.data[this.t-1]|=(1<<this.DB-i)-1<<i)),this.clamp(),s&&V.ZERO.subTo(this,this)}function rk(){for(var r=this.s&this.DM;this.t>0&&this.data[this.t-1]==r;)--this.t}function nk(r){if(this.s<0)return"-"+this.negate().toString(r);var e;if(r==16)e=4;else if(r==8)e=3;else if(r==2)e=1;else if(r==32)e=5;else if(r==4)e=2;else return this.toRadix(r);var t=(1<<e)-1,n,s=!1,i="",o=this.t,a=this.DB-o*this.DB%e;if(o-- >0)for(a<this.DB&&(n=this.data[o]>>a)>0&&(s=!0,i=F7(n));o>=0;)a<e?(n=(this.data[o]&(1<<a)-1)<<e-a,n|=this.data[--o]>>(a+=this.DB-e)):(n=this.data[o]>>(a-=e)&t,a<=0&&(a+=this.DB,--o)),n>0&&(s=!0),s&&(i+=F7(n));return s?i:"0"}function sk(){var r=Me();return V.ZERO.subTo(this,r),r}function ik(){return this.s<0?this.negate():this}function ok(r){var e=this.s-r.s;if(e!=0)return e;var t=this.t;if(e=t-r.t,e!=0)return this.s<0?-e:e;for(;--t>=0;)if((e=this.data[t]-r.data[t])!=0)return e;return 0}function z0(r){var e=1,t;return(t=r>>>16)!=0&&(r=t,e+=16),(t=r>>8)!=0&&(r=t,e+=8),(t=r>>4)!=0&&(r=t,e+=4),(t=r>>2)!=0&&(r=t,e+=2),(t=r>>1)!=0&&(r=t,e+=1),e}function ak(){return this.t<=0?0:this.DB*(this.t-1)+z0(this.data[this.t-1]^this.s&this.DM)}function ck(r,e){var t;for(t=this.t-1;t>=0;--t)e.data[t+r]=this.data[t];for(t=r-1;t>=0;--t)e.data[t]=0;e.t=this.t+r,e.s=this.s}function lk(r,e){for(var t=r;t<this.t;++t)e.data[t-r]=this.data[t];e.t=Math.max(this.t-r,0),e.s=this.s}function uk(r,e){var t=r%this.DB,n=this.DB-t,s=(1<<n)-1,i=Math.floor(r/this.DB),o=this.s<<t&this.DM,a;for(a=this.t-1;a>=0;--a)e.data[a+i+1]=this.data[a]>>n|o,o=(this.data[a]&s)<<t;for(a=i-1;a>=0;--a)e.data[a]=0;e.data[i]=o,e.t=this.t+i+1,e.s=this.s,e.clamp()}function fk(r,e){e.s=this.s;var t=Math.floor(r/this.DB);if(t>=this.t){e.t=0;return}var n=r%this.DB,s=this.DB-n,i=(1<<n)-1;e.data[0]=this.data[t]>>n;for(var o=t+1;o<this.t;++o)e.data[o-t-1]|=(this.data[o]&i)<<s,e.data[o-t]=this.data[o]>>n;n>0&&(e.data[this.t-t-1]|=(this.s&i)<<s),e.t=this.t-t,e.clamp()}function hk(r,e){for(var t=0,n=0,s=Math.min(r.t,this.t);t<s;)n+=this.data[t]-r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n-=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n-=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n-=r.s}e.s=n<0?-1:0,n<-1?e.data[t++]=this.DV+n:n>0&&(e.data[t++]=n),e.t=t,e.clamp()}function dk(r,e){var t=this.abs(),n=r.abs(),s=t.t;for(e.t=s+n.t;--s>=0;)e.data[s]=0;for(s=0;s<n.t;++s)e.data[s+t.t]=t.am(0,n.data[s],e,s,0,t.t);e.s=0,e.clamp(),this.s!=r.s&&V.ZERO.subTo(e,e)}function pk(r){for(var e=this.abs(),t=r.t=2*e.t;--t>=0;)r.data[t]=0;for(t=0;t<e.t-1;++t){var n=e.am(t,e.data[t],r,2*t,0,1);(r.data[t+e.t]+=e.am(t+1,2*e.data[t],r,2*t+1,n,e.t-t-1))>=e.DV&&(r.data[t+e.t]-=e.DV,r.data[t+e.t+1]=1)}r.t>0&&(r.data[r.t-1]+=e.am(t,e.data[t],r,2*t,0,1)),r.s=0,r.clamp()}function mk(r,e,t){var n=r.abs();if(!(n.t<=0)){var s=this.abs();if(s.t<n.t){e?.fromInt(0),t!=null&&this.copyTo(t);return}t==null&&(t=Me());var i=Me(),o=this.s,a=r.s,c=this.DB-z0(n.data[n.t-1]);c>0?(n.lShiftTo(c,i),s.lShiftTo(c,t)):(n.copyTo(i),s.copyTo(t));var l=i.t,u=i.data[l-1];if(u!=0){var f=u*(1<<this.F1)+(l>1?i.data[l-2]>>this.F2:0),h=this.FV/f,d=(1<<this.F1)/f,p=1<<this.F2,m=t.t,g=m-l,y=e??Me();for(i.dlShiftTo(g,y),t.compareTo(y)>=0&&(t.data[t.t++]=1,t.subTo(y,t)),V.ONE.dlShiftTo(l,y),y.subTo(i,i);i.t<l;)i.data[i.t++]=0;for(;--g>=0;){var w=t.data[--m]==u?this.DM:Math.floor(t.data[m]*h+(t.data[m-1]+p)*d);if((t.data[m]+=i.am(0,w,t,g,0,l))<w)for(i.dlShiftTo(g,y),t.subTo(y,t);t.data[m]<--w;)t.subTo(y,t)}e!=null&&(t.drShiftTo(l,e),o!=a&&V.ZERO.subTo(e,e)),t.t=l,t.clamp(),c>0&&t.rShiftTo(c,t),o<0&&V.ZERO.subTo(t,t)}}}function gk(r){var e=Me();return this.abs().divRemTo(r,null,e),this.s<0&&e.compareTo(V.ZERO)>0&&r.subTo(e,e),e}function uo(r){this.m=r}function yk(r){return r.s<0||r.compareTo(this.m)>=0?r.mod(this.m):r}function bk(r){return r}function wk(r){r.divRemTo(this.m,null,r)}function Ek(r,e,t){r.multiplyTo(e,t),this.reduce(t)}function xk(r,e){r.squareTo(e),this.reduce(e)}uo.prototype.convert=yk;uo.prototype.revert=bk;uo.prototype.reduce=wk;uo.prototype.mulTo=Ek;uo.prototype.sqrTo=xk;function vk(){if(this.t<1)return 0;var r=this.data[0];if(!(r&1))return 0;var e=r&3;return e=e*(2-(r&15)*e)&15,e=e*(2-(r&255)*e)&255,e=e*(2-((r&65535)*e&65535))&65535,e=e*(2-r*e%this.DV)%this.DV,e>0?this.DV-e:-e}function fo(r){this.m=r,this.mp=r.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<r.DB-15)-1,this.mt2=2*r.t}function _k(r){var e=Me();return r.abs().dlShiftTo(this.m.t,e),e.divRemTo(this.m,null,e),r.s<0&&e.compareTo(V.ZERO)>0&&this.m.subTo(e,e),e}function Sk(r){var e=Me();return r.copyTo(e),this.reduce(e),e}function Rk(r){for(;r.t<=this.mt2;)r.data[r.t++]=0;for(var e=0;e<this.m.t;++e){var t=r.data[e]&32767,n=t*this.mpl+((t*this.mph+(r.data[e]>>15)*this.mpl&this.um)<<15)&r.DM;for(t=e+this.m.t,r.data[t]+=this.m.am(0,n,r,e,0,this.m.t);r.data[t]>=r.DV;)r.data[t]-=r.DV,r.data[++t]++}r.clamp(),r.drShiftTo(this.m.t,r),r.compareTo(this.m)>=0&&r.subTo(this.m,r)}function Ik(r,e){r.squareTo(e),this.reduce(e)}function Tk(r,e,t){r.multiplyTo(e,t),this.reduce(t)}fo.prototype.convert=_k;fo.prototype.revert=Sk;fo.prototype.reduce=Rk;fo.prototype.mulTo=Tk;fo.prototype.sqrTo=Ik;function Ak(){return(this.t>0?this.data[0]&1:this.s)==0}function Dk(r,e){if(r>4294967295||r<1)return V.ONE;var t=Me(),n=Me(),s=e.convert(this),i=z0(r)-1;for(s.copyTo(t);--i>=0;)if(e.sqrTo(t,n),(r&1<<i)>0)e.mulTo(n,s,t);else{var o=t;t=n,n=o}return e.revert(t)}function Ck(r,e){var t;return r<256||e.isEven()?t=new uo(e):t=new fo(e),this.exp(r,t)}V.prototype.copyTo=JP;V.prototype.fromInt=ek;V.prototype.fromString=tk;V.prototype.clamp=rk;V.prototype.dlShiftTo=ck;V.prototype.drShiftTo=lk;V.prototype.lShiftTo=uk;V.prototype.rShiftTo=fk;V.prototype.subTo=hk;V.prototype.multiplyTo=dk;V.prototype.squareTo=pk;V.prototype.divRemTo=mk;V.prototype.invDigit=vk;V.prototype.isEven=Ak;V.prototype.exp=Dk;V.prototype.toString=nk;V.prototype.negate=sk;V.prototype.abs=ik;V.prototype.compareTo=ok;V.prototype.bitLength=ak;V.prototype.mod=gk;V.prototype.modPowInt=Ck;V.ZERO=pi(0);V.ONE=pi(1);function Pk(){var r=Me();return this.copyTo(r),r}function kk(){if(this.s<0){if(this.t==1)return this.data[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this.data[0];if(this.t==0)return 0}return(this.data[1]&(1<<32-this.DB)-1)<<this.DB|this.data[0]}function Nk(){return this.t==0?this.s:this.data[0]<<24>>24}function Ok(){return this.t==0?this.s:this.data[0]<<16>>16}function Lk(r){return Math.floor(Math.LN2*this.DB/Math.log(r))}function Bk(){return this.s<0?-1:this.t<=0||this.t==1&&this.data[0]<=0?0:1}function Mk(r){if(r==null&&(r=10),this.signum()==0||r<2||r>36)return"0";var e=this.chunkSize(r),t=Math.pow(r,e),n=pi(t),s=Me(),i=Me(),o="";for(this.divRemTo(n,s,i);s.signum()>0;)o=(t+i.intValue()).toString(r).substr(1)+o,s.divRemTo(n,s,i);return i.intValue().toString(r)+o}function Uk(r,e){this.fromInt(0),e==null&&(e=10);for(var t=this.chunkSize(e),n=Math.pow(e,t),s=!1,i=0,o=0,a=0;a<r.length;++a){var c=K7(r,a);if(c<0){r.charAt(a)=="-"&&this.signum()==0&&(s=!0);continue}o=e*o+c,++i>=t&&(this.dMultiply(n),this.dAddOffset(o,0),i=0,o=0)}i>0&&(this.dMultiply(Math.pow(e,i)),this.dAddOffset(o,0)),s&&V.ZERO.subTo(this,this)}function Fk(r,e,t){if(typeof e=="number")if(r<2)this.fromInt(1);else for(this.fromNumber(r,t),this.testBit(r-1)||this.bitwiseTo(V.ONE.shiftLeft(r-1),Gp,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(e);)this.dAddOffset(2,0),this.bitLength()>r&&this.subTo(V.ONE.shiftLeft(r-1),this);else{var n=new Array,s=r&7;n.length=(r>>3)+1,e.nextBytes(n),s>0?n[0]&=(1<<s)-1:n[0]=0,this.fromString(n,256)}}function Kk(){var r=this.t,e=new Array;e[0]=this.s;var t=this.DB-r*this.DB%8,n,s=0;if(r-- >0)for(t<this.DB&&(n=this.data[r]>>t)!=(this.s&this.DM)>>t&&(e[s++]=n|this.s<<this.DB-t);r>=0;)t<8?(n=(this.data[r]&(1<<t)-1)<<8-t,n|=this.data[--r]>>(t+=this.DB-8)):(n=this.data[r]>>(t-=8)&255,t<=0&&(t+=this.DB,--r)),n&128&&(n|=-256),s==0&&(this.s&128)!=(n&128)&&++s,(s>0||n!=this.s)&&(e[s++]=n);return e}function Vk(r){return this.compareTo(r)==0}function qk(r){return this.compareTo(r)<0?this:r}function zk(r){return this.compareTo(r)>0?this:r}function $k(r,e,t){var n,s,i=Math.min(r.t,this.t);for(n=0;n<i;++n)t.data[n]=e(this.data[n],r.data[n]);if(r.t<this.t){for(s=r.s&this.DM,n=i;n<this.t;++n)t.data[n]=e(this.data[n],s);t.t=this.t}else{for(s=this.s&this.DM,n=i;n<r.t;++n)t.data[n]=e(s,r.data[n]);t.t=r.t}t.s=e(this.s,r.s),t.clamp()}function Hk(r,e){return r&e}function Wk(r){var e=Me();return this.bitwiseTo(r,Hk,e),e}function Gp(r,e){return r|e}function Gk(r){var e=Me();return this.bitwiseTo(r,Gp,e),e}function V7(r,e){return r^e}function Yk(r){var e=Me();return this.bitwiseTo(r,V7,e),e}function q7(r,e){return r&~e}function Qk(r){var e=Me();return this.bitwiseTo(r,q7,e),e}function Xk(){for(var r=Me(),e=0;e<this.t;++e)r.data[e]=this.DM&~this.data[e];return r.t=this.t,r.s=~this.s,r}function jk(r){var e=Me();return r<0?this.rShiftTo(-r,e):this.lShiftTo(r,e),e}function Zk(r){var e=Me();return r<0?this.lShiftTo(-r,e):this.rShiftTo(r,e),e}function Jk(r){if(r==0)return-1;var e=0;return r&65535||(r>>=16,e+=16),r&255||(r>>=8,e+=8),r&15||(r>>=4,e+=4),r&3||(r>>=2,e+=2),r&1||++e,e}function eN(){for(var r=0;r<this.t;++r)if(this.data[r]!=0)return r*this.DB+Jk(this.data[r]);return this.s<0?this.t*this.DB:-1}function tN(r){for(var e=0;r!=0;)r&=r-1,++e;return e}function rN(){for(var r=0,e=this.s&this.DM,t=0;t<this.t;++t)r+=tN(this.data[t]^e);return r}function nN(r){var e=Math.floor(r/this.DB);return e>=this.t?this.s!=0:(this.data[e]&1<<r%this.DB)!=0}function sN(r,e){var t=V.ONE.shiftLeft(r);return this.bitwiseTo(t,e,t),t}function iN(r){return this.changeBit(r,Gp)}function oN(r){return this.changeBit(r,q7)}function aN(r){return this.changeBit(r,V7)}function cN(r,e){for(var t=0,n=0,s=Math.min(r.t,this.t);t<s;)n+=this.data[t]+r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;if(r.t<this.t){for(n+=r.s;t<this.t;)n+=this.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;t<r.t;)n+=r.data[t],e.data[t++]=n&this.DM,n>>=this.DB;n+=r.s}e.s=n<0?-1:0,n>0?e.data[t++]=n:n<-1&&(e.data[t++]=this.DV+n),e.t=t,e.clamp()}function lN(r){var e=Me();return this.addTo(r,e),e}function uN(r){var e=Me();return this.subTo(r,e),e}function fN(r){var e=Me();return this.multiplyTo(r,e),e}function hN(r){var e=Me();return this.divRemTo(r,e,null),e}function dN(r){var e=Me();return this.divRemTo(r,null,e),e}function pN(r){var e=Me(),t=Me();return this.divRemTo(r,e,t),new Array(e,t)}function mN(r){this.data[this.t]=this.am(0,r-1,this,0,0,this.t),++this.t,this.clamp()}function gN(r,e){if(r!=0){for(;this.t<=e;)this.data[this.t++]=0;for(this.data[e]+=r;this.data[e]>=this.DV;)this.data[e]-=this.DV,++e>=this.t&&(this.data[this.t++]=0),++this.data[e]}}function al(){}function z7(r){return r}function yN(r,e,t){r.multiplyTo(e,t)}function bN(r,e){r.squareTo(e)}al.prototype.convert=z7;al.prototype.revert=z7;al.prototype.mulTo=yN;al.prototype.sqrTo=bN;function wN(r){return this.exp(r,new al)}function EN(r,e,t){var n=Math.min(this.t+r.t,e);for(t.s=0,t.t=n;n>0;)t.data[--n]=0;var s;for(s=t.t-this.t;n<s;++n)t.data[n+this.t]=this.am(0,r.data[n],t,n,0,this.t);for(s=Math.min(r.t,e);n<s;++n)this.am(0,r.data[n],t,n,0,e-n);t.clamp()}function xN(r,e,t){--e;var n=t.t=this.t+r.t-e;for(t.s=0;--n>=0;)t.data[n]=0;for(n=Math.max(e-this.t,0);n<r.t;++n)t.data[this.t+n-e]=this.am(e-n,r.data[n],t,0,0,this.t+n-e);t.clamp(),t.drShiftTo(1,t)}function ga(r){this.r2=Me(),this.q3=Me(),V.ONE.dlShiftTo(2*r.t,this.r2),this.mu=this.r2.divide(r),this.m=r}function vN(r){if(r.s<0||r.t>2*this.m.t)return r.mod(this.m);if(r.compareTo(this.m)<0)return r;var e=Me();return r.copyTo(e),this.reduce(e),e}function _N(r){return r}function SN(r){for(r.drShiftTo(this.m.t-1,this.r2),r.t>this.m.t+1&&(r.t=this.m.t+1,r.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);r.compareTo(this.r2)<0;)r.dAddOffset(1,this.m.t+1);for(r.subTo(this.r2,r);r.compareTo(this.m)>=0;)r.subTo(this.m,r)}function RN(r,e){r.squareTo(e),this.reduce(e)}function IN(r,e,t){r.multiplyTo(e,t),this.reduce(t)}ga.prototype.convert=vN;ga.prototype.revert=_N;ga.prototype.reduce=SN;ga.prototype.mulTo=IN;ga.prototype.sqrTo=RN;function TN(r,e){var t=r.bitLength(),n,s=pi(1),i;if(t<=0)return s;t<18?n=1:t<48?n=3:t<144?n=4:t<768?n=5:n=6,t<8?i=new uo(e):e.isEven()?i=new ga(e):i=new fo(e);var o=new Array,a=3,c=n-1,l=(1<<n)-1;if(o[1]=i.convert(this),n>1){var u=Me();for(i.sqrTo(o[1],u);a<=l;)o[a]=Me(),i.mulTo(u,o[a-2],o[a]),a+=2}var f=r.t-1,h,d=!0,p=Me(),m;for(t=z0(r.data[f])-1;f>=0;){for(t>=c?h=r.data[f]>>t-c&l:(h=(r.data[f]&(1<<t+1)-1)<<c-t,f>0&&(h|=r.data[f-1]>>this.DB+t-c)),a=n;!(h&1);)h>>=1,--a;if((t-=a)<0&&(t+=this.DB,--f),d)o[h].copyTo(s),d=!1;else{for(;a>1;)i.sqrTo(s,p),i.sqrTo(p,s),a-=2;a>0?i.sqrTo(s,p):(m=s,s=p,p=m),i.mulTo(p,o[h],s)}for(;f>=0&&!(r.data[f]&1<<t);)i.sqrTo(s,p),m=s,s=p,p=m,--t<0&&(t=this.DB-1,--f)}return i.revert(s)}function AN(r){var e=this.s<0?this.negate():this.clone(),t=r.s<0?r.negate():r.clone();if(e.compareTo(t)<0){var n=e;e=t,t=n}var s=e.getLowestSetBit(),i=t.getLowestSetBit();if(i<0)return e;for(s<i&&(i=s),i>0&&(e.rShiftTo(i,e),t.rShiftTo(i,t));e.signum()>0;)(s=e.getLowestSetBit())>0&&e.rShiftTo(s,e),(s=t.getLowestSetBit())>0&&t.rShiftTo(s,t),e.compareTo(t)>=0?(e.subTo(t,e),e.rShiftTo(1,e)):(t.subTo(e,t),t.rShiftTo(1,t));return i>0&&t.lShiftTo(i,t),t}function DN(r){if(r<=0)return 0;var e=this.DV%r,t=this.s<0?r-1:0;if(this.t>0)if(e==0)t=this.data[0]%r;else for(var n=this.t-1;n>=0;--n)t=(e*t+this.data[n])%r;return t}function CN(r){var e=r.isEven();if(this.isEven()&&e||r.signum()==0)return V.ZERO;for(var t=r.clone(),n=this.clone(),s=pi(1),i=pi(0),o=pi(0),a=pi(1);t.signum()!=0;){for(;t.isEven();)t.rShiftTo(1,t),e?((!s.isEven()||!i.isEven())&&(s.addTo(this,s),i.subTo(r,i)),s.rShiftTo(1,s)):i.isEven()||i.subTo(r,i),i.rShiftTo(1,i);for(;n.isEven();)n.rShiftTo(1,n),e?((!o.isEven()||!a.isEven())&&(o.addTo(this,o),a.subTo(r,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(r,a),a.rShiftTo(1,a);t.compareTo(n)>=0?(t.subTo(n,t),e&&s.subTo(o,s),i.subTo(a,i)):(n.subTo(t,n),e&&o.subTo(s,o),a.subTo(i,a))}if(n.compareTo(V.ONE)!=0)return V.ZERO;if(a.compareTo(r)>=0)return a.subtract(r);if(a.signum()<0)a.addTo(r,a);else return a;return a.signum()<0?a.add(r):a}var Ln=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509],PN=(1<<26)/Ln[Ln.length-1];function kN(r){var e,t=this.abs();if(t.t==1&&t.data[0]<=Ln[Ln.length-1]){for(e=0;e<Ln.length;++e)if(t.data[0]==Ln[e])return!0;return!1}if(t.isEven())return!1;for(e=1;e<Ln.length;){for(var n=Ln[e],s=e+1;s<Ln.length&&n<PN;)n*=Ln[s++];for(n=t.modInt(n);e<s;)if(n%Ln[e++]==0)return!1}return t.millerRabin(r)}function NN(r){var e=this.subtract(V.ONE),t=e.getLowestSetBit();if(t<=0)return!1;for(var n=e.shiftRight(t),s=ON(),i,o=0;o<r;++o){do i=new V(this.bitLength(),s);while(i.compareTo(V.ONE)<=0||i.compareTo(e)>=0);var a=i.modPow(n,this);if(a.compareTo(V.ONE)!=0&&a.compareTo(e)!=0){for(var c=1;c++<t&&a.compareTo(e)!=0;)if(a=a.modPowInt(2,this),a.compareTo(V.ONE)==0)return!1;if(a.compareTo(e)!=0)return!1}}return!0}function ON(){return{nextBytes:function(r){for(var e=0;e<r.length;++e)r[e]=Math.floor(Math.random()*256)}}}V.prototype.chunkSize=Lk;V.prototype.toRadix=Mk;V.prototype.fromRadix=Uk;V.prototype.fromNumber=Fk;V.prototype.bitwiseTo=$k;V.prototype.changeBit=sN;V.prototype.addTo=cN;V.prototype.dMultiply=mN;V.prototype.dAddOffset=gN;V.prototype.multiplyLowerTo=EN;V.prototype.multiplyUpperTo=xN;V.prototype.modInt=DN;V.prototype.millerRabin=NN;V.prototype.clone=Pk;V.prototype.intValue=kk;V.prototype.byteValue=Nk;V.prototype.shortValue=Ok;V.prototype.signum=Bk;V.prototype.toByteArray=Kk;V.prototype.equals=Vk;V.prototype.min=qk;V.prototype.max=zk;V.prototype.and=Wk;V.prototype.or=Gk;V.prototype.xor=Yk;V.prototype.andNot=Qk;V.prototype.not=Xk;V.prototype.shiftLeft=jk;V.prototype.shiftRight=Zk;V.prototype.getLowestSetBit=eN;V.prototype.bitCount=rN;V.prototype.testBit=nN;V.prototype.setBit=iN;V.prototype.clearBit=oN;V.prototype.flipBit=aN;V.prototype.add=lN;V.prototype.subtract=uN;V.prototype.multiply=fN;V.prototype.divide=hN;V.prototype.remainder=dN;V.prototype.divideAndRemainder=pN;V.prototype.modPow=TN;V.prototype.modInverse=CN;V.prototype.pow=wN;V.prototype.gcd=AN;V.prototype.isProbablePrime=kN});var Q7=K((LZ,Y7)=>{var as=Qe();lo();Rt();var W7=Y7.exports=as.sha1=as.sha1||{};as.md.sha1=as.md.algorithms.sha1=W7;W7.create=function(){G7||LN();var r=null,e=as.util.createBuffer(),t=new Array(80),n={algorithm:"sha1",blockLength:64,digestLength:20,messageLength:0,fullMessageLength:null,messageLengthSize:8};return n.start=function(){n.messageLength=0,n.fullMessageLength=n.messageLength64=[];for(var s=n.messageLengthSize/4,i=0;i<s;++i)n.fullMessageLength.push(0);return e=as.util.createBuffer(),r={h0:1732584193,h1:4023233417,h2:2562383102,h3:271733878,h4:3285377520},n},n.start(),n.update=function(s,i){i==="utf8"&&(s=as.util.encodeUtf8(s));var o=s.length;n.messageLength+=o,o=[o/4294967296>>>0,o>>>0];for(var a=n.fullMessageLength.length-1;a>=0;--a)n.fullMessageLength[a]+=o[1],o[1]=o[0]+(n.fullMessageLength[a]/4294967296>>>0),n.fullMessageLength[a]=n.fullMessageLength[a]>>>0,o[0]=o[1]/4294967296>>>0;return e.putBytes(s),H7(r,t,e),(e.read>2048||e.length()===0)&&e.compact(),n},n.digest=function(){var s=as.util.createBuffer();s.putBytes(e.bytes());var i=n.fullMessageLength[n.fullMessageLength.length-1]+n.messageLengthSize,o=i&n.blockLength-1;s.putBytes(Yp.substr(0,n.blockLength-o));for(var a,c,l=n.fullMessageLength[0]*8,u=0;u<n.fullMessageLength.length-1;++u)a=n.fullMessageLength[u+1]*8,c=a/4294967296>>>0,l+=c,s.putInt32(l>>>0),l=a>>>0;s.putInt32(l);var f={h0:r.h0,h1:r.h1,h2:r.h2,h3:r.h3,h4:r.h4};H7(f,t,s);var h=as.util.createBuffer();return h.putInt32(f.h0),h.putInt32(f.h1),h.putInt32(f.h2),h.putInt32(f.h3),h.putInt32(f.h4),h},n};var Yp=null,G7=!1;function LN(){Yp=String.fromCharCode(128),Yp+=as.util.fillString(String.fromCharCode(0),64),G7=!0}function H7(r,e,t){for(var n,s,i,o,a,c,l,u,f=t.length();f>=64;){for(s=r.h0,i=r.h1,o=r.h2,a=r.h3,c=r.h4,u=0;u<16;++u)n=t.getInt32(),e[u]=n,l=a^i&(o^a),n=(s<<5|s>>>27)+l+c+1518500249+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;for(;u<20;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=a^i&(o^a),n=(s<<5|s>>>27)+l+c+1518500249+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;for(;u<32;++u)n=e[u-3]^e[u-8]^e[u-14]^e[u-16],n=n<<1|n>>>31,e[u]=n,l=i^o^a,n=(s<<5|s>>>27)+l+c+1859775393+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;for(;u<40;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=i^o^a,n=(s<<5|s>>>27)+l+c+1859775393+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;for(;u<60;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=i&o|a&(i^o),n=(s<<5|s>>>27)+l+c+2400959708+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;for(;u<80;++u)n=e[u-6]^e[u-16]^e[u-28]^e[u-32],n=n<<2|n>>>30,e[u]=n,l=i^o^a,n=(s<<5|s>>>27)+l+c+3395469782+n,c=a,a=o,o=(i<<30|i>>>2)>>>0,i=s,s=n;r.h0=r.h0+s|0,r.h1=r.h1+i|0,r.h2=r.h2+o|0,r.h3=r.h3+a|0,r.h4=r.h4+c|0,f-=64}}});var Z7=K((BZ,j7)=>{var cs=Qe();Rt();ol();Q7();var X7=j7.exports=cs.pkcs1=cs.pkcs1||{};X7.encode_rsa_oaep=function(r,e,t){var n,s,i,o;typeof t=="string"?(n=t,s=arguments[3]||void 0,i=arguments[4]||void 0):t&&(n=t.label||void 0,s=t.seed||void 0,i=t.md||void 0,t.mgf1&&t.mgf1.md&&(o=t.mgf1.md)),i?i.start():i=cs.md.sha1.create(),o||(o=i);var a=Math.ceil(r.n.bitLength()/8),c=a-2*i.digestLength-2;if(e.length>c){var l=new Error("RSAES-OAEP input message length is too long.");throw l.length=e.length,l.maxLength=c,l}n||(n=""),i.update(n,"raw");for(var u=i.digest(),f="",h=c-e.length,d=0;d<h;d++)f+="\0";var p=u.getBytes()+f+""+e;if(!s)s=cs.random.getBytes(i.digestLength);else if(s.length!==i.digestLength){var l=new Error("Invalid RSAES-OAEP seed. The seed length must match the digest length.");throw l.seedLength=s.length,l.digestLength=i.digestLength,l}var m=H0(s,a-i.digestLength-1,o),g=cs.util.xorBytes(p,m,p.length),y=H0(g,i.digestLength,o),w=cs.util.xorBytes(s,y,s.length);return"\0"+w+g};X7.decode_rsa_oaep=function(r,e,t){var n,s,i;typeof t=="string"?(n=t,s=arguments[3]||void 0):t&&(n=t.label||void 0,s=t.md||void 0,t.mgf1&&t.mgf1.md&&(i=t.mgf1.md));var o=Math.ceil(r.n.bitLength()/8);if(e.length!==o){var g=new Error("RSAES-OAEP encoded message length is invalid.");throw g.length=e.length,g.expectedLength=o,g}if(s===void 0?s=cs.md.sha1.create():s.start(),i||(i=s),o<2*s.digestLength+2)throw new Error("RSAES-OAEP key is too short for the hash function.");n||(n=""),s.update(n,"raw");for(var a=s.digest().getBytes(),c=e.charAt(0),l=e.substring(1,s.digestLength+1),u=e.substring(1+s.digestLength),f=H0(u,s.digestLength,i),h=cs.util.xorBytes(l,f,l.length),d=H0(h,o-s.digestLength-1,i),p=cs.util.xorBytes(u,d,u.length),m=p.substring(0,s.digestLength),g=c!=="\0",y=0;y<s.digestLength;++y)g|=a.charAt(y)!==m.charAt(y);for(var w=1,E=s.digestLength,R=s.digestLength;R<p.length;R++){var x=p.charCodeAt(R),v=x&1^1,I=w?65534:0;g|=x&I,w=w&v,E+=w}if(g||p.charCodeAt(E)!==1)throw new Error("Invalid RSAES-OAEP padding.");return p.substring(E+1)};function H0(r,e,t){t||(t=cs.md.sha1.create());for(var n="",s=Math.ceil(e/t.digestLength),i=0;i<s;++i){var o=String.fromCharCode(i>>24&255,i>>16&255,i>>8&255,i&255);t.start(),t.update(r+o),n+=t.digest().getBytes()}return n.substring(0,e)}});var J7=K((MZ,Qp)=>{var mi=Qe();Rt();$0();ol();(function(){if(mi.prime){Qp.exports=mi.prime;return}var r=Qp.exports=mi.prime=mi.prime||{},e=mi.jsbn.BigInteger,t=[6,4,2,4,2,4,6,2],n=new e(null);n.fromInt(30);var s=function(f,h){return f|h};r.generateProbablePrime=function(f,h,d){typeof h=="function"&&(d=h,h={}),h=h||{};var p=h.algorithm||"PRIMEINC";typeof p=="string"&&(p={name:p}),p.options=p.options||{};var m=h.prng||mi.random,g={nextBytes:function(y){for(var w=m.getBytesSync(y.length),E=0;E<y.length;++E)y[E]=w.charCodeAt(E)}};if(p.name==="PRIMEINC")return i(f,g,p.options,d);throw new Error("Invalid prime generation algorithm: "+p.name)};function i(f,h,d,p){return"workers"in d?c(f,h,d,p):o(f,h,d,p)}function o(f,h,d,p){var m=l(f,h),g=0,y=u(m.bitLength());"millerRabinTests"in d&&(y=d.millerRabinTests);var w=10;"maxBlockTime"in d&&(w=d.maxBlockTime),a(m,f,h,g,y,w,p)}function a(f,h,d,p,m,g,y){var w=+new Date;do{if(f.bitLength()>h&&(f=l(h,d)),f.isProbablePrime(m))return y(null,f);f.dAddOffset(t[p++%8],0)}while(g<0||+new Date-w<g);mi.util.setImmediate(function(){a(f,h,d,p,m,g,y)})}function c(f,h,d,p){if(typeof Worker>"u")return o(f,h,d,p);var m=l(f,h),g=d.workers,y=d.workLoad||100,w=y*30/8,E=d.workerScript||"forge/prime.worker.js";if(g===-1)return mi.util.estimateCores(function(x,v){x&&(v=2),g=v-1,R()});R();function R(){g=Math.max(1,g);for(var x=[],v=0;v<g;++v)x[v]=new Worker(E);for(var I=g,v=0;v<g;++v)x[v].addEventListener("message",D);var _=!1;function D(O){if(!_){--I;var N=O.data;if(N.found){for(var U=0;U<x.length;++U)x[U].terminate();return _=!0,p(null,new e(N.prime,16))}m.bitLength()>f&&(m=l(f,h));var z=m.toString(16);O.target.postMessage({hex:z,workLoad:y}),m.dAddOffset(w,0)}}}}function l(f,h){var d=new e(f,h),p=f-1;return d.testBit(p)||d.bitwiseTo(e.ONE.shiftLeft(p),s,d),d.dAddOffset(31-d.mod(n).byteValue(),0),d}function u(f){return f<=100?27:f<=150?18:f<=200?15:f<=250?12:f<=300?9:f<=350?8:f<=400?7:f<=500?6:f<=600?5:f<=800?4:f<=1250?3:2}})()});var G0=K((UZ,o9)=>{var ue=Qe();sl();$0();P0();Z7();J7();ol();Rt();typeof Oe>"u"&&(Oe=ue.jsbn.BigInteger);var Oe,Xp=ue.util.isNodejs?il():null,C=ue.asn1,dn=ue.util;ue.pki=ue.pki||{};o9.exports=ue.pki.rsa=ue.rsa=ue.rsa||{};var xe=ue.pki,BN=[6,4,2,4,2,4,6,2],MN={name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"PrivateKeyInfo.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"PrivateKeyInfo.privateKeyAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"privateKeyOid"}]},{name:"PrivateKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"privateKey"}]},UN={name:"RSAPrivateKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPrivateKey.version",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyVersion"},{name:"RSAPrivateKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyModulus"},{name:"RSAPrivateKey.publicExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPublicExponent"},{name:"RSAPrivateKey.privateExponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrivateExponent"},{name:"RSAPrivateKey.prime1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime1"},{name:"RSAPrivateKey.prime2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyPrime2"},{name:"RSAPrivateKey.exponent1",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent1"},{name:"RSAPrivateKey.exponent2",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyExponent2"},{name:"RSAPrivateKey.coefficient",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"privateKeyCoefficient"}]},FN={name:"RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"RSAPublicKey.modulus",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyModulus"},{name:"RSAPublicKey.exponent",tagClass:C.Class.UNIVERSAL,type:C.Type.INTEGER,constructed:!1,capture:"publicKeyExponent"}]},KN=ue.pki.rsa.publicKeyValidator={name:"SubjectPublicKeyInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,captureAsn1:"subjectPublicKeyInfo",value:[{name:"SubjectPublicKeyInfo.AlgorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"publicKeyOid"}]},{name:"SubjectPublicKeyInfo.subjectPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.BITSTRING,constructed:!1,value:[{name:"SubjectPublicKeyInfo.subjectPublicKey.RSAPublicKey",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,optional:!0,captureAsn1:"rsaPublicKey"}]}]},VN={name:"DigestInfo",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm",tagClass:C.Class.UNIVERSAL,type:C.Type.SEQUENCE,constructed:!0,value:[{name:"DigestInfo.DigestAlgorithm.algorithmIdentifier",tagClass:C.Class.UNIVERSAL,type:C.Type.OID,constructed:!1,capture:"algorithmIdentifier"},{name:"DigestInfo.DigestAlgorithm.parameters",tagClass:C.Class.UNIVERSAL,type:C.Type.NULL,capture:"parameters",optional:!0,constructed:!1}]},{name:"DigestInfo.digest",tagClass:C.Class.UNIVERSAL,type:C.Type.OCTETSTRING,constructed:!1,capture:"digest"}]},qN=function(r){var e;if(r.algorithm in xe.oids)e=xe.oids[r.algorithm];else{var t=new Error("Unknown message digest algorithm.");throw t.algorithm=r.algorithm,t}var n=C.oidToDer(e).getBytes(),s=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]),i=C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[]);i.value.push(C.create(C.Class.UNIVERSAL,C.Type.OID,!1,n)),i.value.push(C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,""));var o=C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,r.digest().getBytes());return s.value.push(i),s.value.push(o),C.toDer(s).getBytes()},s9=function(r,e,t){if(t)return r.modPow(e.e,e.n);if(!e.p||!e.q)return r.modPow(e.d,e.n);e.dP||(e.dP=e.d.mod(e.p.subtract(Oe.ONE))),e.dQ||(e.dQ=e.d.mod(e.q.subtract(Oe.ONE))),e.qInv||(e.qInv=e.q.modInverse(e.p));var n;do n=new Oe(ue.util.bytesToHex(ue.random.getBytes(e.n.bitLength()/8)),16);while(n.compareTo(e.n)>=0||!n.gcd(e.n).equals(Oe.ONE));r=r.multiply(n.modPow(e.e,e.n)).mod(e.n);for(var s=r.mod(e.p).modPow(e.dP,e.p),i=r.mod(e.q).modPow(e.dQ,e.q);s.compareTo(i)<0;)s=s.add(e.p);var o=s.subtract(i).multiply(e.qInv).mod(e.p).multiply(e.q).add(i);return o=o.multiply(n.modInverse(e.n)).mod(e.n),o};xe.rsa.encrypt=function(r,e,t){var n=t,s,i=Math.ceil(e.n.bitLength()/8);t!==!1&&t!==!0?(n=t===2,s=i9(r,e,t)):(s=ue.util.createBuffer(),s.putBytes(r));for(var o=new Oe(s.toHex(),16),a=s9(o,e,n),c=a.toString(16),l=ue.util.createBuffer(),u=i-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(ue.util.hexToBytes(c)),l.getBytes()};xe.rsa.decrypt=function(r,e,t,n){var s=Math.ceil(e.n.bitLength()/8);if(r.length!==s){var i=new Error("Encrypted message length is invalid.");throw i.length=r.length,i.expected=s,i}var o=new Oe(ue.util.createBuffer(r).toHex(),16);if(o.compareTo(e.n)>=0)throw new Error("Encrypted message is invalid.");for(var a=s9(o,e,t),c=a.toString(16),l=ue.util.createBuffer(),u=s-Math.ceil(c.length/2);u>0;)l.putByte(0),--u;return l.putBytes(ue.util.hexToBytes(c)),n!==!1?W0(l.getBytes(),e,t):l.getBytes()};xe.rsa.createKeyPairGenerationState=function(r,e,t){typeof r=="string"&&(r=parseInt(r,10)),r=r||2048,t=t||{};var n=t.prng||ue.random,s={nextBytes:function(a){for(var c=n.getBytesSync(a.length),l=0;l<a.length;++l)a[l]=c.charCodeAt(l)}},i=t.algorithm||"PRIMEINC",o;if(i==="PRIMEINC")o={algorithm:i,state:0,bits:r,rng:s,eInt:e||65537,e:new Oe(null),p:null,q:null,qBits:r>>1,pBits:r-(r>>1),pqState:0,num:null,keys:null},o.e.fromInt(o.eInt);else throw new Error("Invalid key generation algorithm: "+i);return o};xe.rsa.stepKeyPairGenerationState=function(r,e){"algorithm"in r||(r.algorithm="PRIMEINC");var t=new Oe(null);t.fromInt(30);for(var n=0,s=function(f,h){return f|h},i=+new Date,o,a=0;r.keys===null&&(e<=0||a<e);){if(r.state===0){var c=r.p===null?r.pBits:r.qBits,l=c-1;r.pqState===0?(r.num=new Oe(c,r.rng),r.num.testBit(l)||r.num.bitwiseTo(Oe.ONE.shiftLeft(l),s,r.num),r.num.dAddOffset(31-r.num.mod(t).byteValue(),0),n=0,++r.pqState):r.pqState===1?r.num.bitLength()>c?r.pqState=0:r.num.isProbablePrime($N(r.num.bitLength()))?++r.pqState:r.num.dAddOffset(BN[n++%8],0):r.pqState===2?r.pqState=r.num.subtract(Oe.ONE).gcd(r.e).compareTo(Oe.ONE)===0?3:0:r.pqState===3&&(r.pqState=0,r.p===null?r.p=r.num:r.q=r.num,r.p!==null&&r.q!==null&&++r.state,r.num=null)}else if(r.state===1)r.p.compareTo(r.q)<0&&(r.num=r.p,r.p=r.q,r.q=r.num),++r.state;else if(r.state===2)r.p1=r.p.subtract(Oe.ONE),r.q1=r.q.subtract(Oe.ONE),r.phi=r.p1.multiply(r.q1),++r.state;else if(r.state===3)r.phi.gcd(r.e).compareTo(Oe.ONE)===0?++r.state:(r.p=null,r.q=null,r.state=0);else if(r.state===4)r.n=r.p.multiply(r.q),r.n.bitLength()===r.bits?++r.state:(r.q=null,r.state=0);else if(r.state===5){var u=r.e.modInverse(r.phi);r.keys={privateKey:xe.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:xe.rsa.setPublicKey(r.n,r.e)}}o=+new Date,a+=o-i,i=o}return r.keys!==null};xe.rsa.generateKeyPair=function(r,e,t,n){if(arguments.length===1?typeof r=="object"?(t=r,r=void 0):typeof r=="function"&&(n=r,r=void 0):arguments.length===2?typeof r=="number"?typeof e=="function"?(n=e,e=void 0):typeof e!="number"&&(t=e,e=void 0):(t=r,n=e,r=void 0,e=void 0):arguments.length===3&&(typeof e=="number"?typeof t=="function"&&(n=t,t=void 0):(n=t,t=e,e=void 0)),t=t||{},r===void 0&&(r=t.bits||2048),e===void 0&&(e=t.e||65537),!ue.options.usePureJavaScript&&!t.prng&&r>=256&&r<=16384&&(e===65537||e===3)){if(n){if(e9("generateKeyPair"))return Xp.generateKeyPair("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}},function(a,c,l){if(a)return n(a);n(null,{privateKey:xe.privateKeyFromPem(l),publicKey:xe.publicKeyFromPem(c)})});if(t9("generateKey")&&t9("exportKey"))return dn.globalScope.crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:n9(e),hash:{name:"SHA-256"}},!0,["sign","verify"]).then(function(a){return dn.globalScope.crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(void 0,function(a){n(a)}).then(function(a){if(a){var c=xe.privateKeyFromAsn1(C.fromDer(ue.util.createBuffer(a)));n(null,{privateKey:c,publicKey:xe.setRsaPublicKey(c.n,c.e)})}});if(r9("generateKey")&&r9("exportKey")){var s=dn.globalScope.msCrypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:n9(e),hash:{name:"SHA-256"}},!0,["sign","verify"]);s.oncomplete=function(a){var c=a.target.result,l=dn.globalScope.msCrypto.subtle.exportKey("pkcs8",c.privateKey);l.oncomplete=function(u){var f=u.target.result,h=xe.privateKeyFromAsn1(C.fromDer(ue.util.createBuffer(f)));n(null,{privateKey:h,publicKey:xe.setRsaPublicKey(h.n,h.e)})},l.onerror=function(u){n(u)}},s.onerror=function(a){n(a)};return}}else if(e9("generateKeyPairSync")){var i=Xp.generateKeyPairSync("rsa",{modulusLength:r,publicExponent:e,publicKeyEncoding:{type:"spki",format:"pem"},privateKeyEncoding:{type:"pkcs8",format:"pem"}});return{privateKey:xe.privateKeyFromPem(i.privateKey),publicKey:xe.publicKeyFromPem(i.publicKey)}}}var o=xe.rsa.createKeyPairGenerationState(r,e,t);if(!n)return xe.rsa.stepKeyPairGenerationState(o,0),o.keys;zN(o,t,n)};xe.setRsaPublicKey=xe.rsa.setPublicKey=function(r,e){var t={n:r,e};return t.encrypt=function(n,s,i){if(typeof s=="string"?s=s.toUpperCase():s===void 0&&(s="RSAES-PKCS1-V1_5"),s==="RSAES-PKCS1-V1_5")s={encode:function(a,c,l){return i9(a,c,2).getBytes()}};else if(s==="RSA-OAEP"||s==="RSAES-OAEP")s={encode:function(a,c){return ue.pkcs1.encode_rsa_oaep(c,a,i)}};else if(["RAW","NONE","NULL",null].indexOf(s)!==-1)s={encode:function(a){return a}};else if(typeof s=="string")throw new Error('Unsupported encryption scheme: "'+s+'".');var o=s.encode(n,t,!0);return xe.rsa.encrypt(o,t,!0)},t.verify=function(n,s,i,o){typeof i=="string"?i=i.toUpperCase():i===void 0&&(i="RSASSA-PKCS1-V1_5"),o===void 0&&(o={_parseAllDigestBytes:!0}),"_parseAllDigestBytes"in o||(o._parseAllDigestBytes=!0),i==="RSASSA-PKCS1-V1_5"?i={verify:function(c,l){l=W0(l,t,!0);var u=C.fromDer(l,{parseAllBytes:o._parseAllDigestBytes}),f={},h=[];if(!C.validate(u,VN,f,h)){var d=new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value.");throw d.errors=h,d}var p=C.derToOid(f.algorithmIdentifier);if(!(p===ue.oids.md2||p===ue.oids.md5||p===ue.oids.sha1||p===ue.oids.sha224||p===ue.oids.sha256||p===ue.oids.sha384||p===ue.oids.sha512||p===ue.oids["sha512-224"]||p===ue.oids["sha512-256"])){var d=new Error("Unknown RSASSA-PKCS1-v1_5 DigestAlgorithm identifier.");throw d.oid=p,d}if((p===ue.oids.md2||p===ue.oids.md5)&&!("parameters"in f))throw new Error("ASN.1 object does not contain a valid RSASSA-PKCS1-v1_5 DigestInfo value. Missing algorithm identifer NULL parameters.");return c===f.digest}}:(i==="NONE"||i==="NULL"||i===null)&&(i={verify:function(c,l){return l=W0(l,t,!0),c===l}});var a=xe.rsa.decrypt(s,t,!0,!1);return i.verify(n,a,t.n.bitLength())},t};xe.setRsaPrivateKey=xe.rsa.setPrivateKey=function(r,e,t,n,s,i,o,a){var c={n:r,e,d:t,p:n,q:s,dP:i,dQ:o,qInv:a};return c.decrypt=function(l,u,f){typeof u=="string"?u=u.toUpperCase():u===void 0&&(u="RSAES-PKCS1-V1_5");var h=xe.rsa.decrypt(l,c,!1,!1);if(u==="RSAES-PKCS1-V1_5")u={decode:W0};else if(u==="RSA-OAEP"||u==="RSAES-OAEP")u={decode:function(d,p){return ue.pkcs1.decode_rsa_oaep(p,d,f)}};else if(["RAW","NONE","NULL",null].indexOf(u)!==-1)u={decode:function(d){return d}};else throw new Error('Unsupported encryption scheme: "'+u+'".');return u.decode(h,c,!1)},c.sign=function(l,u){var f=!1;typeof u=="string"&&(u=u.toUpperCase()),u===void 0||u==="RSASSA-PKCS1-V1_5"?(u={encode:qN},f=1):(u==="NONE"||u==="NULL"||u===null)&&(u={encode:function(){return l}},f=1);var h=u.encode(l,c.n.bitLength());return xe.rsa.encrypt(h,c,f)},c};xe.wrapRsaPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(xe.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.OCTETSTRING,!1,C.toDer(r).getBytes())])};xe.privateKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,MN,e,t)&&(r=C.fromDer(ue.util.createBuffer(e.privateKey))),e={},t=[],!C.validate(r,UN,e,t)){var n=new Error("Cannot read private key. ASN.1 object does not contain an RSAPrivateKey.");throw n.errors=t,n}var s,i,o,a,c,l,u,f;return s=ue.util.createBuffer(e.privateKeyModulus).toHex(),i=ue.util.createBuffer(e.privateKeyPublicExponent).toHex(),o=ue.util.createBuffer(e.privateKeyPrivateExponent).toHex(),a=ue.util.createBuffer(e.privateKeyPrime1).toHex(),c=ue.util.createBuffer(e.privateKeyPrime2).toHex(),l=ue.util.createBuffer(e.privateKeyExponent1).toHex(),u=ue.util.createBuffer(e.privateKeyExponent2).toHex(),f=ue.util.createBuffer(e.privateKeyCoefficient).toHex(),xe.setRsaPrivateKey(new Oe(s,16),new Oe(i,16),new Oe(o,16),new Oe(a,16),new Oe(c,16),new Oe(l,16),new Oe(u,16),new Oe(f,16))};xe.privateKeyToAsn1=xe.privateKeyToRSAPrivateKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,C.integerToDer(0).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.e)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.d)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.p)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.q)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.dP)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.dQ)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.qInv))])};xe.publicKeyFromAsn1=function(r){var e={},t=[];if(C.validate(r,KN,e,t)){var n=C.derToOid(e.publicKeyOid);if(n!==xe.oids.rsaEncryption){var s=new Error("Cannot read public key. Unknown OID.");throw s.oid=n,s}r=e.rsaPublicKey}if(t=[],!C.validate(r,FN,e,t)){var s=new Error("Cannot read public key. ASN.1 object does not contain an RSAPublicKey.");throw s.errors=t,s}var i=ue.util.createBuffer(e.publicKeyModulus).toHex(),o=ue.util.createBuffer(e.publicKeyExponent).toHex();return xe.setRsaPublicKey(new Oe(i,16),new Oe(o,16))};xe.publicKeyToAsn1=xe.publicKeyToSubjectPublicKeyInfo=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.OID,!1,C.oidToDer(xe.oids.rsaEncryption).getBytes()),C.create(C.Class.UNIVERSAL,C.Type.NULL,!1,"")]),C.create(C.Class.UNIVERSAL,C.Type.BITSTRING,!1,[xe.publicKeyToRSAPublicKey(r)])])};xe.publicKeyToRSAPublicKey=function(r){return C.create(C.Class.UNIVERSAL,C.Type.SEQUENCE,!0,[C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.n)),C.create(C.Class.UNIVERSAL,C.Type.INTEGER,!1,ls(r.e))])};function i9(r,e,t){var n=ue.util.createBuffer(),s=Math.ceil(e.n.bitLength()/8);if(r.length>s-11){var i=new Error("Message is too long for PKCS#1 v1.5 padding.");throw i.length=r.length,i.max=s-11,i}n.putByte(0),n.putByte(t);var o=s-3-r.length,a;if(t===0||t===1){a=t===0?0:255;for(var c=0;c<o;++c)n.putByte(a)}else for(;o>0;){for(var l=0,u=ue.random.getBytes(o),c=0;c<o;++c)a=u.charCodeAt(c),a===0?++l:n.putByte(a);o=l}return n.putByte(0),n.putBytes(r),n}function W0(r,e,t,n){var s=Math.ceil(e.n.bitLength()/8),i=ue.util.createBuffer(r),o=i.getByte(),a=i.getByte();if(o!==0||t&&a!==0&&a!==1||!t&&a!=2||t&&a===0&&typeof n>"u")throw new Error("Encryption block is invalid.");var c=0;if(a===0){c=s-3-n;for(var l=0;l<c;++l)if(i.getByte()!==0)throw new Error("Encryption block is invalid.")}else if(a===1)for(c=0;i.length()>1;){if(i.getByte()!==255){--i.read;break}++c}else if(a===2)for(c=0;i.length()>1;){if(i.getByte()===0){--i.read;break}++c}var u=i.getByte();if(u!==0||c!==s-3-i.length())throw new Error("Encryption block is invalid.");return i.getBytes()}function zN(r,e,t){typeof e=="function"&&(t=e,e={}),e=e||{};var n={algorithm:{name:e.algorithm||"PRIMEINC",options:{workers:e.workers||2,workLoad:e.workLoad||100,workerScript:e.workerScript}}};"prng"in e&&(n.prng=e.prng),s();function s(){i(r.pBits,function(a,c){if(a)return t(a);if(r.p=c,r.q!==null)return o(a,r.q);i(r.qBits,o)})}function i(a,c){ue.prime.generateProbablePrime(a,n,c)}function o(a,c){if(a)return t(a);if(r.q=c,r.p.compareTo(r.q)<0){var l=r.p;r.p=r.q,r.q=l}if(r.p.subtract(Oe.ONE).gcd(r.e).compareTo(Oe.ONE)!==0){r.p=null,s();return}if(r.q.subtract(Oe.ONE).gcd(r.e).compareTo(Oe.ONE)!==0){r.q=null,i(r.qBits,o);return}if(r.p1=r.p.subtract(Oe.ONE),r.q1=r.q.subtract(Oe.ONE),r.phi=r.p1.multiply(r.q1),r.phi.gcd(r.e).compareTo(Oe.ONE)!==0){r.p=r.q=null,s();return}if(r.n=r.p.multiply(r.q),r.n.bitLength()!==r.bits){r.q=null,i(r.qBits,o);return}var u=r.e.modInverse(r.phi);r.keys={privateKey:xe.rsa.setPrivateKey(r.n,r.e,u,r.p,r.q,u.mod(r.p1),u.mod(r.q1),r.q.modInverse(r.p)),publicKey:xe.rsa.setPublicKey(r.n,r.e)},t(null,r.keys)}}function ls(r){var e=r.toString(16);e[0]>="8"&&(e="00"+e);var t=ue.util.hexToBytes(e);return t.length>1&&(t.charCodeAt(0)===0&&!(t.charCodeAt(1)&128)||t.charCodeAt(0)===255&&(t.charCodeAt(1)&128)===128)?t.substr(1):t}function $N(r){return r<=100?27:r<=150?18:r<=200?15:r<=250?12:r<=300?9:r<=350?8:r<=400?7:r<=500?6:r<=600?5:r<=800?4:r<=1250?3:2}function e9(r){return ue.util.isNodejs&&typeof Xp[r]=="function"}function t9(r){return typeof dn.globalScope<"u"&&typeof dn.globalScope.crypto=="object"&&typeof dn.globalScope.crypto.subtle=="object"&&typeof dn.globalScope.crypto.subtle[r]=="function"}function r9(r){return typeof dn.globalScope<"u"&&typeof dn.globalScope.msCrypto=="object"&&typeof dn.globalScope.msCrypto.subtle=="object"&&typeof dn.globalScope.msCrypto.subtle[r]=="function"}function n9(r){for(var e=ue.util.hexToBytes(r.toString(16)),t=new Uint8Array(e.length),n=0;n<e.length;++n)t[n]=e.charCodeAt(n);return t}});var h9=K((FZ,f9)=>{var ee=Qe();B0();sl();y7();lo();P0();Vp();S7();ol();B7();G0();Rt();typeof a9>"u"&&(a9=ee.jsbn.BigInteger);var a9,M=ee.asn1,Se=ee.pki=ee.pki||{};f9.exports=Se.pbe=ee.pbe=ee.pbe||{};var ho=Se.oids,HN={name:"EncryptedPrivateKeyInfo",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedPrivateKeyInfo.encryptionAlgorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"AlgorithmIdentifier.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encryptionOid"},{name:"AlgorithmIdentifier.parameters",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,captureAsn1:"encryptionParams"}]},{name:"EncryptedPrivateKeyInfo.encryptedData",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encryptedData"}]},WN={name:"PBES2Algorithms",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.keyDerivationFunc.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"kdfOid"},{name:"PBES2Algorithms.params",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.params.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"kdfSalt"},{name:"PBES2Algorithms.params.iterationCount",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"kdfIterationCount"},{name:"PBES2Algorithms.params.keyLength",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,optional:!0,capture:"keyLength"},{name:"PBES2Algorithms.params.prf",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,optional:!0,value:[{name:"PBES2Algorithms.params.prf.algorithm",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"prfOid"}]}]}]},{name:"PBES2Algorithms.encryptionScheme",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"PBES2Algorithms.encryptionScheme.oid",tagClass:M.Class.UNIVERSAL,type:M.Type.OID,constructed:!1,capture:"encOid"},{name:"PBES2Algorithms.encryptionScheme.iv",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"encIv"}]}]},GN={name:"pkcs-12PbeParams",tagClass:M.Class.UNIVERSAL,type:M.Type.SEQUENCE,constructed:!0,value:[{name:"pkcs-12PbeParams.salt",tagClass:M.Class.UNIVERSAL,type:M.Type.OCTETSTRING,constructed:!1,capture:"salt"},{name:"pkcs-12PbeParams.iterations",tagClass:M.Class.UNIVERSAL,type:M.Type.INTEGER,constructed:!1,capture:"iterations"}]};Se.encryptPrivateKeyInfo=function(r,e,t){t=t||{},t.saltSize=t.saltSize||8,t.count=t.count||2048,t.algorithm=t.algorithm||"aes128",t.prfAlgorithm=t.prfAlgorithm||"sha1";var n=ee.random.getBytesSync(t.saltSize),s=t.count,i=M.integerToDer(s),o,a,c;if(t.algorithm.indexOf("aes")===0||t.algorithm==="des"){var l,u,f;switch(t.algorithm){case"aes128":o=16,l=16,u=ho["aes128-CBC"],f=ee.aes.createEncryptionCipher;break;case"aes192":o=24,l=16,u=ho["aes192-CBC"],f=ee.aes.createEncryptionCipher;break;case"aes256":o=32,l=16,u=ho["aes256-CBC"],f=ee.aes.createEncryptionCipher;break;case"des":o=8,l=8,u=ho.desCBC,f=ee.des.createEncryptionCipher;break;default:var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var d="hmacWith"+t.prfAlgorithm.toUpperCase(),p=u9(d),m=ee.pkcs5.pbkdf2(e,n,s,o,p),g=ee.random.getBytesSync(l),y=f(m);y.start(g),y.update(M.toDer(r)),y.finish(),c=y.output.getBytes();var w=YN(n,i,o,d);a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(ho.pkcs5PBES2).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(ho.pkcs5PBKDF2).getBytes()),w]),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(u).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,g)])])])}else if(t.algorithm==="3des"){o=24;var E=new ee.util.ByteBuffer(n),m=Se.pbe.generatePkcs12Key(e,E,1,s,o),g=Se.pbe.generatePkcs12Key(e,E,2,s,o),y=ee.des.createEncryptionCipher(m);y.start(g),y.update(M.toDer(r)),y.finish(),c=y.output.getBytes(),a=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(ho["pbeWithSHAAnd3-KeyTripleDES-CBC"]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,n),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,i.getBytes())])])}else{var h=new Error("Cannot encrypt private key. Unknown encryption algorithm.");throw h.algorithm=t.algorithm,h}var R=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[a,M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,c)]);return R};Se.decryptPrivateKeyInfo=function(r,e){var t=null,n={},s=[];if(!M.validate(r,HN,n,s)){var i=new Error("Cannot read encrypted private key. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw i.errors=s,i}var o=M.derToOid(n.encryptionOid),a=Se.pbe.getCipher(o,n.encryptionParams,e),c=ee.util.createBuffer(n.encryptedData);return a.update(c),a.finish()&&(t=M.fromDer(a.output)),t};Se.encryptedPrivateKeyToPem=function(r,e){var t={type:"ENCRYPTED PRIVATE KEY",body:M.toDer(r).getBytes()};return ee.pem.encode(t,{maxline:e})};Se.encryptedPrivateKeyFromPem=function(r){var e=ee.pem.decode(r)[0];if(e.type!=="ENCRYPTED PRIVATE KEY"){var t=new Error('Could not convert encrypted private key from PEM; PEM header type is "ENCRYPTED PRIVATE KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert encrypted private key from PEM; PEM is encrypted.");return M.fromDer(e.body)};Se.encryptRsaPrivateKey=function(r,e,t){if(t=t||{},!t.legacy){var n=Se.wrapRsaPrivateKey(Se.privateKeyToAsn1(r));return n=Se.encryptPrivateKeyInfo(n,e,t),Se.encryptedPrivateKeyToPem(n)}var s,i,o,a;switch(t.algorithm){case"aes128":s="AES-128-CBC",o=16,i=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"aes192":s="AES-192-CBC",o=24,i=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"aes256":s="AES-256-CBC",o=32,i=ee.random.getBytesSync(16),a=ee.aes.createEncryptionCipher;break;case"3des":s="DES-EDE3-CBC",o=24,i=ee.random.getBytesSync(8),a=ee.des.createEncryptionCipher;break;case"des":s="DES-CBC",o=8,i=ee.random.getBytesSync(8),a=ee.des.createEncryptionCipher;break;default:var c=new Error('Could not encrypt RSA private key; unsupported encryption algorithm "'+t.algorithm+'".');throw c.algorithm=t.algorithm,c}var l=ee.pbe.opensslDeriveBytes(e,i.substr(0,8),o),u=a(l);u.start(i),u.update(M.toDer(Se.privateKeyToAsn1(r))),u.finish();var f={type:"RSA PRIVATE KEY",procType:{version:"4",type:"ENCRYPTED"},dekInfo:{algorithm:s,parameters:ee.util.bytesToHex(i).toUpperCase()},body:u.output.getBytes()};return ee.pem.encode(f)};Se.decryptRsaPrivateKey=function(r,e){var t=null,n=ee.pem.decode(r)[0];if(n.type!=="ENCRYPTED PRIVATE KEY"&&n.type!=="PRIVATE KEY"&&n.type!=="RSA PRIVATE KEY"){var s=new Error('Could not convert private key from PEM; PEM header type is not "ENCRYPTED PRIVATE KEY", "PRIVATE KEY", or "RSA PRIVATE KEY".');throw s.headerType=s,s}if(n.procType&&n.procType.type==="ENCRYPTED"){var i,o;switch(n.dekInfo.algorithm){case"DES-CBC":i=8,o=ee.des.createDecryptionCipher;break;case"DES-EDE3-CBC":i=24,o=ee.des.createDecryptionCipher;break;case"AES-128-CBC":i=16,o=ee.aes.createDecryptionCipher;break;case"AES-192-CBC":i=24,o=ee.aes.createDecryptionCipher;break;case"AES-256-CBC":i=32,o=ee.aes.createDecryptionCipher;break;case"RC2-40-CBC":i=5,o=function(f){return ee.rc2.createDecryptionCipher(f,40)};break;case"RC2-64-CBC":i=8,o=function(f){return ee.rc2.createDecryptionCipher(f,64)};break;case"RC2-128-CBC":i=16,o=function(f){return ee.rc2.createDecryptionCipher(f,128)};break;default:var s=new Error('Could not decrypt private key; unsupported encryption algorithm "'+n.dekInfo.algorithm+'".');throw s.algorithm=n.dekInfo.algorithm,s}var a=ee.util.hexToBytes(n.dekInfo.parameters),c=ee.pbe.opensslDeriveBytes(e,a.substr(0,8),i),l=o(c);if(l.start(a),l.update(ee.util.createBuffer(n.body)),l.finish())t=l.output.getBytes();else return t}else t=n.body;return n.type==="ENCRYPTED PRIVATE KEY"?t=Se.decryptPrivateKeyInfo(M.fromDer(t),e):t=M.fromDer(t),t!==null&&(t=Se.privateKeyFromAsn1(t)),t};Se.pbe.generatePkcs12Key=function(r,e,t,n,s,i){var o,a;if(typeof i>"u"||i===null){if(!("sha1"in ee.md))throw new Error('"sha1" hash algorithm unavailable.');i=ee.md.sha1.create()}var c=i.digestLength,l=i.blockLength,u=new ee.util.ByteBuffer,f=new ee.util.ByteBuffer;if(r!=null){for(a=0;a<r.length;a++)f.putInt16(r.charCodeAt(a));f.putInt16(0)}var h=f.length(),d=e.length(),p=new ee.util.ByteBuffer;p.fillWithByte(t,l);var m=l*Math.ceil(d/l),g=new ee.util.ByteBuffer;for(a=0;a<m;a++)g.putByte(e.at(a%d));var y=l*Math.ceil(h/l),w=new ee.util.ByteBuffer;for(a=0;a<y;a++)w.putByte(f.at(a%h));var E=g;E.putBuffer(w);for(var R=Math.ceil(s/c),x=1;x<=R;x++){var v=new ee.util.ByteBuffer;v.putBytes(p.bytes()),v.putBytes(E.bytes());for(var I=0;I<n;I++)i.start(),i.update(v.getBytes()),v=i.digest();var _=new ee.util.ByteBuffer;for(a=0;a<l;a++)_.putByte(v.at(a%c));var D=Math.ceil(d/l)+Math.ceil(h/l),O=new ee.util.ByteBuffer;for(o=0;o<D;o++){var N=new ee.util.ByteBuffer(E.getBytes(l)),U=511;for(a=_.length()-1;a>=0;a--)U=U>>8,U+=_.at(a)+N.at(a),N.setAt(a,U&255);O.putBuffer(N)}E=O,u.putBuffer(v)}return u.truncate(u.length()-s),u};Se.pbe.getCipher=function(r,e,t){switch(r){case Se.oids.pkcs5PBES2:return Se.pbe.getCipherForPBES2(r,e,t);case Se.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:case Se.oids["pbewithSHAAnd40BitRC2-CBC"]:return Se.pbe.getCipherForPKCS12PBE(r,e,t);default:var n=new Error("Cannot read encrypted PBE data block. Unsupported OID.");throw n.oid=r,n.supportedOids=["pkcs5PBES2","pbeWithSHAAnd3-KeyTripleDES-CBC","pbewithSHAAnd40BitRC2-CBC"],n}};Se.pbe.getCipherForPBES2=function(r,e,t){var n={},s=[];if(!M.validate(e,WN,n,s)){var i=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw i.errors=s,i}if(r=M.derToOid(n.kdfOid),r!==Se.oids.pkcs5PBKDF2){var i=new Error("Cannot read encrypted private key. Unsupported key derivation function OID.");throw i.oid=r,i.supportedOids=["pkcs5PBKDF2"],i}if(r=M.derToOid(n.encOid),r!==Se.oids["aes128-CBC"]&&r!==Se.oids["aes192-CBC"]&&r!==Se.oids["aes256-CBC"]&&r!==Se.oids["des-EDE3-CBC"]&&r!==Se.oids.desCBC){var i=new Error("Cannot read encrypted private key. Unsupported encryption scheme OID.");throw i.oid=r,i.supportedOids=["aes128-CBC","aes192-CBC","aes256-CBC","des-EDE3-CBC","desCBC"],i}var o=n.kdfSalt,a=ee.util.createBuffer(n.kdfIterationCount);a=a.getInt(a.length()<<3);var c,l;switch(Se.oids[r]){case"aes128-CBC":c=16,l=ee.aes.createDecryptionCipher;break;case"aes192-CBC":c=24,l=ee.aes.createDecryptionCipher;break;case"aes256-CBC":c=32,l=ee.aes.createDecryptionCipher;break;case"des-EDE3-CBC":c=24,l=ee.des.createDecryptionCipher;break;case"desCBC":c=8,l=ee.des.createDecryptionCipher;break}var u=l9(n.prfOid),f=ee.pkcs5.pbkdf2(t,o,a,c,u),h=n.encIv,d=l(f);return d.start(h),d};Se.pbe.getCipherForPKCS12PBE=function(r,e,t){var n={},s=[];if(!M.validate(e,GN,n,s)){var i=new Error("Cannot read password-based-encryption algorithm parameters. ASN.1 object is not a supported EncryptedPrivateKeyInfo.");throw i.errors=s,i}var o=ee.util.createBuffer(n.salt),a=ee.util.createBuffer(n.iterations);a=a.getInt(a.length()<<3);var c,l,u;switch(r){case Se.oids["pbeWithSHAAnd3-KeyTripleDES-CBC"]:c=24,l=8,u=ee.des.startDecrypting;break;case Se.oids["pbewithSHAAnd40BitRC2-CBC"]:c=5,l=8,u=function(m,g){var y=ee.rc2.createDecryptionCipher(m,40);return y.start(g,null),y};break;default:var i=new Error("Cannot read PKCS #12 PBE data block. Unsupported OID.");throw i.oid=r,i}var f=l9(n.prfOid),h=Se.pbe.generatePkcs12Key(t,o,1,a,c,f);f.start();var d=Se.pbe.generatePkcs12Key(t,o,2,a,l,f);return u(h,d)};Se.pbe.opensslDeriveBytes=function(r,e,t,n){if(typeof n>"u"||n===null){if(!("md5"in ee.md))throw new Error('"md5" hash algorithm unavailable.');n=ee.md.md5.create()}e===null&&(e="");for(var s=[c9(n,r+e)],i=16,o=1;i<t;++o,i+=16)s.push(c9(n,s[o-1]+r+e));return s.join("").substr(0,t)};function c9(r,e){return r.start().update(e).digest().getBytes()}function l9(r){var e;if(!r)e="hmacWithSHA1";else if(e=Se.oids[M.derToOid(r)],!e){var t=new Error("Unsupported PRF OID.");throw t.oid=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}return u9(e)}function u9(r){var e=ee.md;switch(r){case"hmacWithSHA224":e=ee.md.sha512;case"hmacWithSHA1":case"hmacWithSHA256":case"hmacWithSHA384":case"hmacWithSHA512":r=r.substr(8).toLowerCase();break;default:var t=new Error("Unsupported PRF algorithm.");throw t.algorithm=r,t.supported=["hmacWithSHA1","hmacWithSHA224","hmacWithSHA256","hmacWithSHA384","hmacWithSHA512"],t}if(!e||!(r in e))throw new Error("Unknown hash algorithm: "+r);return e[r].create()}function YN(r,e,t,n){var s=M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OCTETSTRING,!1,r),M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,e.getBytes())]);return n!=="hmacWithSHA1"&&s.value.push(M.create(M.Class.UNIVERSAL,M.Type.INTEGER,!1,ee.util.hexToBytes(t.toString(16))),M.create(M.Class.UNIVERSAL,M.Type.SEQUENCE,!0,[M.create(M.Class.UNIVERSAL,M.Type.OID,!1,M.oidToDer(Se.oids[n]).getBytes()),M.create(M.Class.UNIVERSAL,M.Type.NULL,!1,"")])),s}});var eb=K((dee,J9)=>{var at=Qe();lo();Rt();var ml=J9.exports=at.sha512=at.sha512||{};at.md.sha512=at.md.algorithms.sha512=ml;var j9=at.sha384=at.sha512.sha384=at.sha512.sha384||{};j9.create=function(){return ml.create("SHA-384")};at.md.sha384=at.md.algorithms.sha384=j9;at.sha512.sha256=at.sha512.sha256||{create:function(){return ml.create("SHA-512/256")}};at.md["sha512/256"]=at.md.algorithms["sha512/256"]=at.sha512.sha256;at.sha512.sha224=at.sha512.sha224||{create:function(){return ml.create("SHA-512/224")}};at.md["sha512/224"]=at.md.algorithms["sha512/224"]=at.sha512.sha224;ml.create=function(r){if(Z9||iL(),typeof r>"u"&&(r="SHA-512"),!(r in bo))throw new Error("Invalid SHA-512 algorithm: "+r);for(var e=bo[r],t=null,n=at.util.createBuffer(),s=new Array(80),i=0;i<80;++i)s[i]=new Array(2);var o=64;switch(r){case"SHA-384":o=48;break;case"SHA-512/256":o=32;break;case"SHA-512/224":o=28;break}var a={algorithm:r.replace("-","").toLowerCase(),blockLength:128,digestLength:o,messageLength:0,fullMessageLength:null,messageLengthSize:16};return a.start=function(){a.messageLength=0,a.fullMessageLength=a.messageLength128=[];for(var c=a.messageLengthSize/4,l=0;l<c;++l)a.fullMessageLength.push(0);n=at.util.createBuffer(),t=new Array(e.length);for(var l=0;l<e.length;++l)t[l]=e[l].slice(0);return a},a.start(),a.update=function(c,l){l==="utf8"&&(c=at.util.encodeUtf8(c));var u=c.length;a.messageLength+=u,u=[u/4294967296>>>0,u>>>0];for(var f=a.fullMessageLength.length-1;f>=0;--f)a.fullMessageLength[f]+=u[1],u[1]=u[0]+(a.fullMessageLength[f]/4294967296>>>0),a.fullMessageLength[f]=a.fullMessageLength[f]>>>0,u[0]=u[1]/4294967296>>>0;return n.putBytes(c),X9(t,s,n),(n.read>2048||n.length()===0)&&n.compact(),a},a.digest=function(){var c=at.util.createBuffer();c.putBytes(n.bytes());var l=a.fullMessageLength[a.fullMessageLength.length-1]+a.messageLengthSize,u=l&a.blockLength-1;c.putBytes(w2.substr(0,a.blockLength-u));for(var f,h,d=a.fullMessageLength[0]*8,p=0;p<a.fullMessageLength.length-1;++p)f=a.fullMessageLength[p+1]*8,h=f/4294967296>>>0,d+=h,c.putInt32(d>>>0),d=f>>>0;c.putInt32(d);for(var m=new Array(t.length),p=0;p<t.length;++p)m[p]=t[p].slice(0);X9(m,s,c);var g=at.util.createBuffer(),y;r==="SHA-512"?y=m.length:r==="SHA-384"?y=m.length-2:y=m.length-4;for(var p=0;p<y;++p)g.putInt32(m[p][0]),(p!==y-1||r!=="SHA-512/224")&&g.putInt32(m[p][1]);return g},a};var w2=null,Z9=!1,E2=null,bo=null;function iL(){w2=String.fromCharCode(128),w2+=at.util.fillString(String.fromCharCode(0),128),E2=[[1116352408,3609767458],[1899447441,602891725],[3049323471,3964484399],[3921009573,2173295548],[961987163,4081628472],[1508970993,3053834265],[2453635748,2937671579],[2870763221,3664609560],[3624381080,2734883394],[310598401,1164996542],[607225278,1323610764],[1426881987,3590304994],[1925078388,4068182383],[2162078206,991336113],[2614888103,633803317],[3248222580,3479774868],[3835390401,2666613458],[4022224774,944711139],[264347078,2341262773],[604807628,2007800933],[770255983,1495990901],[1249150122,1856431235],[1555081692,3175218132],[1996064986,2198950837],[2554220882,3999719339],[2821834349,766784016],[2952996808,2566594879],[3210313671,3203337956],[3336571891,1034457026],[3584528711,2466948901],[113926993,3758326383],[338241895,168717936],[666307205,1188179964],[773529912,1546045734],[1294757372,1522805485],[1396182291,2643833823],[1695183700,2343527390],[1986661051,1014477480],[2177026350,1206759142],[2456956037,344077627],[2730485921,1290863460],[2820302411,3158454273],[3259730800,3505952657],[3345764771,106217008],[3516065817,3606008344],[3600352804,1432725776],[4094571909,1467031594],[275423344,851169720],[430227734,3100823752],[506948616,1363258195],[659060556,3750685593],[883997877,3785050280],[958139571,3318307427],[1322822218,3812723403],[1537002063,2003034995],[1747873779,3602036899],[1955562222,1575990012],[2024104815,1125592928],[2227730452,2716904306],[2361852424,442776044],[2428436474,593698344],[2756734187,3733110249],[3204031479,2999351573],[3329325298,3815920427],[3391569614,3928383900],[3515267271,566280711],[3940187606,3454069534],[4118630271,4000239992],[116418474,1914138554],[174292421,2731055270],[289380356,3203993006],[460393269,320620315],[685471733,587496836],[852142971,1086792851],[1017036298,365543100],[1126000580,2618297676],[1288033470,3409855158],[1501505948,4234509866],[1607167915,987167468],[1816402316,1246189591]],bo={},bo["SHA-512"]=[[1779033703,4089235720],[3144134277,2227873595],[1013904242,4271175723],[2773480762,1595750129],[1359893119,2917565137],[2600822924,725511199],[528734635,4215389547],[1541459225,327033209]],bo["SHA-384"]=[[3418070365,3238371032],[1654270250,914150663],[2438529370,812702999],[355462360,4144912697],[1731405415,4290775857],[2394180231,1750603025],[3675008525,1694076839],[1203062813,3204075428]],bo["SHA-512/256"]=[[573645204,4230739756],[2673172387,3360449730],[596883563,1867755857],[2520282905,1497426621],[2519219938,2827943907],[3193839141,1401305490],[721525244,746961066],[246885852,2177182882]],bo["SHA-512/224"]=[[2352822216,424955298],[1944164710,2312950998],[502970286,855612546],[1738396948,1479516111],[258812777,2077511080],[2011393907,79989058],[1067287976,1780299464],[286451373,2446758561]],Z9=!0}function X9(r,e,t){for(var n,s,i,o,a,c,l,u,f,h,d,p,m,g,y,w,E,R,x,v,I,_,D,O,N,U,z,te,P,L,B,F,T,$,Y,Z=t.length();Z>=128;){for(P=0;P<16;++P)e[P][0]=t.getInt32()>>>0,e[P][1]=t.getInt32()>>>0;for(;P<80;++P)F=e[P-2],L=F[0],B=F[1],n=((L>>>19|B<<13)^(B>>>29|L<<3)^L>>>6)>>>0,s=((L<<13|B>>>19)^(B<<3|L>>>29)^(L<<26|B>>>6))>>>0,$=e[P-15],L=$[0],B=$[1],i=((L>>>1|B<<31)^(L>>>8|B<<24)^L>>>7)>>>0,o=((L<<31|B>>>1)^(L<<24|B>>>8)^(L<<25|B>>>7))>>>0,T=e[P-7],Y=e[P-16],B=s+T[1]+o+Y[1],e[P][0]=n+T[0]+i+Y[0]+(B/4294967296>>>0)>>>0,e[P][1]=B>>>0;for(m=r[0][0],g=r[0][1],y=r[1][0],w=r[1][1],E=r[2][0],R=r[2][1],x=r[3][0],v=r[3][1],I=r[4][0],_=r[4][1],D=r[5][0],O=r[5][1],N=r[6][0],U=r[6][1],z=r[7][0],te=r[7][1],P=0;P<80;++P)l=((I>>>14|_<<18)^(I>>>18|_<<14)^(_>>>9|I<<23))>>>0,u=((I<<18|_>>>14)^(I<<14|_>>>18)^(_<<23|I>>>9))>>>0,f=(N^I&(D^N))>>>0,h=(U^_&(O^U))>>>0,a=((m>>>28|g<<4)^(g>>>2|m<<30)^(g>>>7|m<<25))>>>0,c=((m<<4|g>>>28)^(g<<30|m>>>2)^(g<<25|m>>>7))>>>0,d=(m&y|E&(m^y))>>>0,p=(g&w|R&(g^w))>>>0,B=te+u+h+E2[P][1]+e[P][1],n=z+l+f+E2[P][0]+e[P][0]+(B/4294967296>>>0)>>>0,s=B>>>0,B=c+p,i=a+d+(B/4294967296>>>0)>>>0,o=B>>>0,z=N,te=U,N=D,U=O,D=I,O=_,B=v+s,I=x+n+(B/4294967296>>>0)>>>0,_=B>>>0,x=E,v=R,E=y,R=w,y=m,w=g,B=s+o,m=n+i+(B/4294967296>>>0)>>>0,g=B>>>0;B=r[0][1]+g,r[0][0]=r[0][0]+m+(B/4294967296>>>0)>>>0,r[0][1]=B>>>0,B=r[1][1]+w,r[1][0]=r[1][0]+y+(B/4294967296>>>0)>>>0,r[1][1]=B>>>0,B=r[2][1]+R,r[2][0]=r[2][0]+E+(B/4294967296>>>0)>>>0,r[2][1]=B>>>0,B=r[3][1]+v,r[3][0]=r[3][0]+x+(B/4294967296>>>0)>>>0,r[3][1]=B>>>0,B=r[4][1]+_,r[4][0]=r[4][0]+I+(B/4294967296>>>0)>>>0,r[4][1]=B>>>0,B=r[5][1]+O,r[5][0]=r[5][0]+D+(B/4294967296>>>0)>>>0,r[5][1]=B>>>0,B=r[6][1]+U,r[6][0]=r[6][0]+N+(B/4294967296>>>0)>>>0,r[6][1]=B>>>0,B=r[7][1]+te,r[7][0]=r[7][0]+z+(B/4294967296>>>0)>>>0,r[7][1]=B>>>0,Z-=128}}});var Cb=K((Yte,Db)=>{"use strict";Db.exports=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;let e=Object.getPrototypeOf(r);return e===null||e===Object.prototype}});var Bb=K((Ob,Lb)=>{"use strict";var gf=Cb(),{hasOwnProperty:kb}=Object.prototype,{propertyIsEnumerable:UL}=Object,Ca=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),FL=Ob,Pb={concatArrays:!1,ignoreUndefined:!1},yf=r=>{let e=[];for(let t in r)kb.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){let t=Object.getOwnPropertySymbols(r);for(let n of t)UL.call(r,n)&&e.push(n)}return e};function Pa(r){return Array.isArray(r)?KL(r):gf(r)?VL(r):r}function KL(r){let e=r.slice(0,0);return yf(r).forEach(t=>{Ca(e,t,Pa(r[t]))}),e}function VL(r){let e=Object.getPrototypeOf(r)===null?Object.create(null):{};return yf(r).forEach(t=>{Ca(e,t,Pa(r[t]))}),e}var Nb=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?Ca(r,s,B2(r[s],e[s],n)):Ca(r,s,Pa(e[s])))}),r),qL=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{let o=[];for(let a=0;a<i.length;a++)kb.call(i,a)&&(o.push(String(a)),i===r?Ca(n,s++,i[a]):Ca(n,s++,Pa(i[a])));n=Nb(n,i,yf(i).filter(a=>!o.includes(a)),t)}),n};function B2(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?qL(r,e,t):!gf(e)||!gf(r)?Pa(e):Nb(r,e,yf(e),t)}Lb.exports=function(...r){let e=B2(Pa(Pb),this!==FL&&this||{},Pb),t={_:{}};for(let n of r)if(n!==void 0){if(!gf(n))throw new TypeError("`"+n+"` is not an Option Object");t=B2(t,{_:n},e)}return t._}});var Fb=K((Xte,Ub)=>{"use strict";function zL(r){return r>=55296&&r<=56319}function $L(r){return r>=56320&&r<=57343}Ub.exports=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],zL(o)&&$L(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t}});var Vb=K((jte,Kb)=>{"use strict";function HL(r){return r>=55296&&r<=56319}function WL(r){return r>=56320&&r<=57343}Kb.exports=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),WL(s)?i!=null&&HL(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n}});var zb=K((Zte,qb)=>{"use strict";var GL=Fb(),YL=Vb();qb.exports=GL.bind(null,YL)});var Wb=K((Jte,Hb)=>{"use strict";var QL=zb(),XL=/[\/\?<>\\:\*\|"]/g,jL=/[\x00-\x1f\x80-\x9f]/g,ZL=/^\.+$/,JL=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,eB=/[\. ]+$/;function $b(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(XL,e).replace(jL,e).replace(ZL,e).replace(JL,e).replace(eB,e);return QL(t,255)}Hb.exports=function(r,e){var t=e&&e.replacement||"",n=$b(r,t);return t===""?n:$b(n,"")}});var xw=K(Cl=>{(function(){var r,e,t,n,s,i,o,a;a=function(c){var l,u,f,h;return l=(c&255<<24)>>>24,u=(c&255<<16)>>>16,f=(c&65280)>>>8,h=c&255,[l,u,f,h].join(".")},o=function(c){var l,u,f,h,d,p;for(l=[],f=h=0;h<=3&&c.length!==0;f=++h){if(f>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}p=e(c),d=p[0],u=p[1],c=c.substring(u),l.push(d)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var l,u,f,h,d;for(h=0,l=10,u="9",f=0,c.length>1&&c[f]==="0"&&(c[f+1]==="x"||c[f+1]==="X"?(f+=2,l=16):"0"<=c[f+1]&&c[f+1]<="9"&&(f++,l=8,u="7")),d=f;f<c.length;){if("0"<=c[f]&&c[f]<=u)h=h*l+(t(c[f])-n)>>>0;else if(l===16)if("a"<=c[f]&&c[f]<="f")h=h*l+(10+t(c[f])-i)>>>0;else if("A"<=c[f]&&c[f]<="F")h=h*l+(10+t(c[f])-s)>>>0;else break;else break;if(h>4294967295)throw new Error("too large");f++}if(f===d)throw new Error("empty octet");return[h,f]},r=function(){function c(l,u){var f,h,d,p;if(typeof l!="string")throw new Error("Missing `net' parameter");if(u||(p=l.split("/",2),l=p[0],u=p[1]),u||(u=32),typeof u=="string"&&u.indexOf(".")>-1){try{this.maskLong=o(u)}catch(m){throw f=m,new Error("Invalid mask: "+u)}for(h=d=32;d>=0;h=--d)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(u||u===0)this.bitmask=parseInt(u,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch(m){throw f=m,new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+u);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var u,f,h;for(h=o(this.first),f=o(this.last),u=0;h<=f;)l(a(h),h,u),u++,h++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),Cl.ip2long=o,Cl.long2ip=a,Cl.Netmask=r}).call(Cl)});var Rw=K((Sw,Nf)=>{(function(r){"use strict";let e="(0?\\d+|0x[a-f0-9]+)",t={fourOctet:new RegExp(`^${e}\\.${e}\\.${e}\\.${e}$`,"i"),threeOctet:new RegExp(`^${e}\\.${e}\\.${e}$`,"i"),twoOctet:new RegExp(`^${e}\\.${e}$`,"i"),longValue:new RegExp(`^${e}$`,"i")},n=new RegExp("^0[0-7]+$","i"),s=new RegExp("^0x[a-f0-9]+$","i"),i="%[0-9a-z]{1,}",o="(?:[0-9a-f]+::?)+",a={zoneIndex:new RegExp(i,"i"),native:new RegExp(`^(::)?(${o})?([0-9a-f]+)?(::)?(${i})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${e}\\.${e}\\.${e}\\.${e}(${i})?)$`,"i"),transitional:new RegExp(`^((?:${o})|(?:::)(?:${o})?)${e}\\.${e}\\.${e}\\.${e}(${i})?$`,"i")};function c(d,p){if(d.indexOf("::")!==d.lastIndexOf("::"))return null;let m=0,g=-1,y=(d.match(a.zoneIndex)||[])[0],w,E;for(y&&(y=y.substring(1),d=d.replace(/%.+$/,""));(g=d.indexOf(":",g+1))>=0;)m++;if(d.substr(0,2)==="::"&&m--,d.substr(-2,2)==="::"&&m--,m>p)return null;for(E=p-m,w=":";E--;)w+="0:";return d=d.replace("::",w),d[0]===":"&&(d=d.slice(1)),d[d.length-1]===":"&&(d=d.slice(0,-1)),p=function(){let R=d.split(":"),x=[];for(let v=0;v<R.length;v++)x.push(parseInt(R[v],16));return x}(),{parts:p,zoneId:y}}function l(d,p,m,g){if(d.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let y=0,w;for(;g>0;){if(w=m-g,w<0&&(w=0),d[y]>>w!==p[y]>>w)return!1;g-=m,y+=1}return!0}function u(d){if(s.test(d))return parseInt(d,16);if(d[0]==="0"&&!isNaN(parseInt(d[1],10))){if(n.test(d))return parseInt(d,8);throw new Error(`ipaddr: cannot parse ${d} as octal`)}return parseInt(d,10)}function f(d,p){for(;d.length<p;)d=`0${d}`;return d}let h={};h.IPv4=function(){function d(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let m,g;for(m=0;m<p.length;m++)if(g=p[m],!(0<=g&&g<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return d.prototype.SpecialRanges={unspecified:[[new d([0,0,0,0]),8]],broadcast:[[new d([255,255,255,255]),32]],multicast:[[new d([224,0,0,0]),4]],linkLocal:[[new d([169,254,0,0]),16]],loopback:[[new d([127,0,0,0]),8]],carrierGradeNat:[[new d([100,64,0,0]),10]],private:[[new d([10,0,0,0]),8],[new d([172,16,0,0]),12],[new d([192,168,0,0]),16]],reserved:[[new d([192,0,0,0]),24],[new d([192,0,2,0]),24],[new d([192,88,99,0]),24],[new d([198,18,0,0]),15],[new d([198,51,100,0]),24],[new d([203,0,113,0]),24],[new d([240,0,0,0]),4]]},d.prototype.kind=function(){return"ipv4"},d.prototype.match=function(p,m){let g;if(m===void 0&&(g=p,p=g[0],m=g[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,g={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},y,w,E;for(y=3;y>=0;y-=1)if(w=this.octets[y],w in g){if(E=g[w],m&&E!==0)return null;E!==8&&(m=!0),p+=E}else return null;return 32-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){return this.octets.slice(0)},d.prototype.toIPv4MappedAddress=function(){return h.IPv6.parse(`::ffff:${this.toString()}`)},d.prototype.toNormalizedString=function(){return this.toString()},d.prototype.toString=function(){return this.octets.join(".")},d}(),h.IPv4.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),g=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],w=0;for(;w<4;)y.push(parseInt(m[w],10)|parseInt(g[w],10)^255),w++;return new this(y)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.isIPv4=function(d){return this.parser(d)!==null},h.IPv4.isValid=function(d){try{return new this(this.parser(d)),!0}catch{return!1}},h.IPv4.isValidFourPartDecimal=function(d){return!!(h.IPv4.isValid(d)&&d.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},h.IPv4.networkAddressFromCIDR=function(d){let p,m,g,y,w;try{for(p=this.parseCIDR(d),g=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],m=0;m<4;)y.push(parseInt(g[m],10)&parseInt(w[m],10)),m++;return new this(y)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},h.IPv4.parse=function(d){let p=this.parser(d);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},h.IPv4.parseCIDR=function(d){let p;if(p=d.match(/^(.+)\/(\d+)$/)){let m=parseInt(p[2]);if(m>=0&&m<=32){let g=[this.parse(p[1]),m];return Object.defineProperty(g,"toString",{value:function(){return this.join("/")}}),g}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},h.IPv4.parser=function(d){let p,m,g;if(p=d.match(t.fourOctet))return function(){let y=p.slice(1,6),w=[];for(let E=0;E<y.length;E++)m=y[E],w.push(u(m));return w}();if(p=d.match(t.longValue)){if(g=u(p[1]),g>4294967295||g<0)throw new Error("ipaddr: address outside defined range");return function(){let y=[],w;for(w=0;w<=24;w+=8)y.push(g>>w&255);return y}().reverse()}else return(p=d.match(t.twoOctet))?function(){let y=p.slice(1,4),w=[];if(g=u(y[1]),g>16777215||g<0)throw new Error("ipaddr: address outside defined range");return w.push(u(y[0])),w.push(g>>16&255),w.push(g>>8&255),w.push(g&255),w}():(p=d.match(t.threeOctet))?function(){let y=p.slice(1,5),w=[];if(g=u(y[2]),g>65535||g<0)throw new Error("ipaddr: address outside defined range");return w.push(u(y[0])),w.push(u(y[1])),w.push(g>>8&255),w.push(g&255),w}():null},h.IPv4.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>32)throw new Error("ipaddr: invalid IPv4 prefix length");let p=[0,0,0,0],m=0,g=Math.floor(d/8);for(;m<g;)p[m]=255,m++;return g<4&&(p[g]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.IPv6=function(){function d(p,m){let g,y;if(p.length===16)for(this.parts=[],g=0;g<=14;g+=2)this.parts.push(p[g]<<8|p[g+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(g=0;g<this.parts.length;g++)if(y=this.parts[g],!(0<=y&&y<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");m&&(this.zoneId=m)}return d.prototype.SpecialRanges={unspecified:[new d([0,0,0,0,0,0,0,0]),128],linkLocal:[new d([65152,0,0,0,0,0,0,0]),10],multicast:[new d([65280,0,0,0,0,0,0,0]),8],loopback:[new d([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new d([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new d([0,0,0,0,0,65535,0,0]),96],rfc6145:[new d([0,0,0,0,65535,0,0,0]),96],rfc6052:[new d([100,65435,0,0,0,0,0,0]),96],"6to4":[new d([8194,0,0,0,0,0,0,0]),16],teredo:[new d([8193,0,0,0,0,0,0,0]),32],reserved:[[new d([8193,3512,0,0,0,0,0,0]),32]],benchmarking:[new d([8193,2,0,0,0,0,0,0]),48],amt:[new d([8193,3,0,0,0,0,0,0]),32],as112v6:[new d([8193,4,274,0,0,0,0,0]),48],deprecated:[new d([8193,16,0,0,0,0,0,0]),28],orchid2:[new d([8193,32,0,0,0,0,0,0]),28]},d.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},d.prototype.kind=function(){return"ipv6"},d.prototype.match=function(p,m){let g;if(m===void 0&&(g=p,p=g[0],m=g[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,m)},d.prototype.prefixLengthFromSubnetMask=function(){let p=0,m=!1,g={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},y,w;for(let E=7;E>=0;E-=1)if(y=this.parts[E],y in g){if(w=g[y],m&&w!==0)return null;w!==16&&(m=!0),p+=w}else return null;return 128-p},d.prototype.range=function(){return h.subnetMatch(this,this.SpecialRanges)},d.prototype.toByteArray=function(){let p,m=[],g=this.parts;for(let y=0;y<g.length;y++)p=g[y],m.push(p>>8),m.push(p&255);return m},d.prototype.toFixedLengthString=function(){let p=function(){let g=[];for(let y=0;y<this.parts.length;y++)g.push(f(this.parts[y].toString(16),4));return g}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");let p=this.parts.slice(-2),m=p[0],g=p[1];return new h.IPv4([m>>8,m&255,g>>8,g&255])},d.prototype.toNormalizedString=function(){let p=function(){let g=[];for(let y=0;y<this.parts.length;y++)g.push(this.parts[y].toString(16));return g}.call(this).join(":"),m="";return this.zoneId&&(m=`%${this.zoneId}`),p+m},d.prototype.toRFC5952String=function(){let p=/((^|:)(0(:|$)){2,})/g,m=this.toNormalizedString(),g=0,y=-1,w;for(;w=p.exec(m);)w[0].length>y&&(g=w.index,y=w[0].length);return y<0?m:`${m.substring(0,g)}::${m.substring(g+y)}`},d.prototype.toString=function(){return this.toRFC5952String()},d}(),h.IPv6.broadcastAddressFromCIDR=function(d){try{let p=this.parseCIDR(d),m=p[0].toByteArray(),g=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],w=0;for(;w<16;)y.push(parseInt(m[w],10)|parseInt(g[w],10)^255),w++;return new this(y)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},h.IPv6.isIPv6=function(d){return this.parser(d)!==null},h.IPv6.isValid=function(d){if(typeof d=="string"&&d.indexOf(":")===-1)return!1;try{let p=this.parser(d);return new this(p.parts,p.zoneId),!0}catch{return!1}},h.IPv6.networkAddressFromCIDR=function(d){let p,m,g,y,w;try{for(p=this.parseCIDR(d),g=p[0].toByteArray(),w=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),y=[],m=0;m<16;)y.push(parseInt(g[m],10)&parseInt(w[m],10)),m++;return new this(y)}catch(E){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${E})`)}},h.IPv6.parse=function(d){let p=this.parser(d);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},h.IPv6.parseCIDR=function(d){let p,m,g;if((m=d.match(/^(.+)\/(\d+)$/))&&(p=parseInt(m[2]),p>=0&&p<=128))return g=[this.parse(m[1]),p],Object.defineProperty(g,"toString",{value:function(){return this.join("/")}}),g;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},h.IPv6.parser=function(d){let p,m,g,y,w,E;if(g=d.match(a.deprecatedTransitional))return this.parser(`::ffff:${g[1]}`);if(a.native.test(d))return c(d,8);if((g=d.match(a.transitional))&&(E=g[6]||"",p=c(g[1].slice(0,-1)+E,6),p.parts)){for(w=[parseInt(g[2]),parseInt(g[3]),parseInt(g[4]),parseInt(g[5])],m=0;m<w.length;m++)if(y=w[m],!(0<=y&&y<=255))return null;return p.parts.push(w[0]<<8|w[1]),p.parts.push(w[2]<<8|w[3]),{parts:p.parts,zoneId:p.zoneId}}return null},h.IPv6.subnetMaskFromPrefixLength=function(d){if(d=parseInt(d),d<0||d>128)throw new Error("ipaddr: invalid IPv6 prefix length");let p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],m=0,g=Math.floor(d/8);for(;m<g;)p[m]=255,m++;return g<16&&(p[g]=Math.pow(2,d%8)-1<<8-d%8),new this(p)},h.fromByteArray=function(d){let p=d.length;if(p===4)return new h.IPv4(d);if(p===16)return new h.IPv6(d);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},h.isValid=function(d){return h.IPv6.isValid(d)||h.IPv4.isValid(d)},h.parse=function(d){if(h.IPv6.isValid(d))return h.IPv6.parse(d);if(h.IPv4.isValid(d))return h.IPv4.parse(d);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},h.parseCIDR=function(d){try{return h.IPv6.parseCIDR(d)}catch{try{return h.IPv4.parseCIDR(d)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},h.process=function(d){let p=this.parse(d);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},h.subnetMatch=function(d,p,m){let g,y,w,E;m==null&&(m="unicast");for(y in p)if(Object.prototype.hasOwnProperty.call(p,y)){for(w=p[y],w[0]&&!(w[0]instanceof Array)&&(w=[w]),g=0;g<w.length;g++)if(E=w[g],d.kind()===E[0].kind()&&d.match.apply(d,E))return y}return m},typeof Nf<"u"&&Nf.exports?Nf.exports=h:r.ipaddr=h})(Sw)});var Ww=K((Yie,Hw)=>{"use strict";Hw.exports=$w;var zB=zd(),Ii=$w.prototype,$B=new Date%1e9;function HB(){return(Math.random()*1e9>>>0)+$B++}function $w(r){r=r||{},this.id=r.id||HB(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}Ii.has=function(r){return r in this._lookup};Ii.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};Ii.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};Ii.set=function(r,e,t){var n=this._lookup[r],s=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,s)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(s),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(s.meta=t.meta),t.refresh&&(s.refresh=t.ttl)),this};Ii.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};Ii.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=zB(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};Ii.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};Ii.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}}});var Ol=K((moe,eE)=>{eE.exports=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:!!e}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}}});var rE=K((yoe,tE)=>{tE.exports=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){let e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){let t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();let n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}}});var sE=K((boe,nE)=>{var QB=rE();nE.exports=QB});var Xr=K((Eoe,iE)=>{iE.exports=class{constructor(e,t,n,s){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof s>"u"?!1:s}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=!!e}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}}});var Ka=K((voe,aE)=>{var dm=Ol(),XB=sE(),oE=Xr();aE.exports=class extends dm{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new XB}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,s,i,o={}){let a=this._getRateLimiterRes(n,s,i);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+s&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(l=>{t(l)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,s,i,o=!1,a={}){this.insuranceLimiter instanceof dm?this.insuranceLimiter[t](i,o,a).then(c=>{n(c)}).catch(c=>{s(c)}):s(e)}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof dm))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){let s=t*1e3;return this._block(this.getKey(e),this.points+1,s,n)}set(e,t,n,s={}){let i=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,i,s)}consume(e,t=1,n={}){return new Promise((s,i)=>{let o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return i(new oE(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(s,i,o,t,c)}).catch(c=>{this._handleError(c,"consume",s,i,e,t,n)})})}penalty(e,t=1,n={}){let s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,t,a))}).catch(a=>{this._handleError(a,"penalty",i,o,e,t,n)})})}reward(e,t=1,n={}){let s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,-t,a))}).catch(a=>{this._handleError(a,"reward",i,o,e,t,n)})})}get(e,t={}){let n=this.getKey(e);return new Promise((s,i)=>{this._get(n,t).then(o=>{s(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",s,i,e,t)})})}delete(e,t={}){let n=this.getKey(e);return new Promise((s,i)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),s(o)}).catch(o=>{this._handleError(o,"delete",s,i,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,s={}){return new Promise((i,o)=>{this._upsert(e,t,n,!0,s).then(()=>{i(new oE(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",i,o,this.parseKey(e),n/1e3,s)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,s=!1,i={}){throw new Error("You have to implement the method '_upsert'!")}}});var lE=K((_oe,cE)=>{var jB=Ka(),ZB=Xr(),pm="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ",mm=class extends jB{constructor(e){super(e),this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,this.useRedisPackage=e.useRedisPackage,this.useRedis3AndLowerPackage=e.useRedis3AndLowerPackage,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:pm})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[s,i]=n;Array.isArray(s)&&([,s]=s,[,i]=i);let o=new ZB;return o.consumedPoints=parseInt(s),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=i,o}async _upsert(e,t,n,s=!1){if(!this._isRedisReady())throw new Error("Redis connection is not ready");let i=Math.floor(n/1e3),o=this.client.multi();return s?(i>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.set(e,t,"EX",i):o.set(e,t,{EX:i}):o.set(e,t),!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.pttl(e).exec(!0):o.pTTL(e).exec(!0)):i>0?!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.rlflxIncr([e].concat([String(t),String(i)])):this.useRedis3AndLowerPackage?new Promise((a,c)=>{let l=function(u,f){return u?c(u):a(f)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,i,l):this.client.eval(pm,1,e,t,i,l)}):this.client.eval(pm,{keys:[e],arguments:[String(t),String(i)]}):!this.useRedisPackage&&!this.useRedis3AndLowerPackage?o.incrby(e,t).pttl(e).exec(!0):o.incrBy(e,t).pTTL(e).exec(!0)}async _get(e){if(!this._isRedisReady())throw new Error("Redis connection is not ready");return!this.useRedisPackage&&!this.useRedis3AndLowerPackage?this.client.multi().get(e).pttl(e).exec().then(t=>{let[[,n]]=t;return n===null?null:t}):this.client.multi().get(e).pTTL(e).exec(!0).then(t=>{let[n]=t;return n===null?null:t})}_delete(e){return this.client.del(e).then(t=>t>0)}};cE.exports=mm});var hE=K((Soe,fE)=>{var JB=Ka(),eM=Xr();function uE(r){try{let e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(s=>parseInt(s));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}var gm=class r extends JB{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=uE(this.client)}):(this._initCollection(),this._driverVersion=uE(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?r.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){let t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){let s=new eM,i;return typeof n.value>"u"?i=n:i=n.value,s.isFirstInDuration=i.points===t,s.consumedPoints=i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire!==null?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,s}_upsert(e,t,n,s=!1,i={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let o=i.attrs||{},a,c;s?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));let l={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?l.returnDocument="after":l.returnOriginal=!1,new Promise((u,f)=>{this._collection.findOneAndUpdate(a,c,l).then(h=>{u(h)}).catch(h=>{if(h&&h.code===11e3){let d=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),p={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(d,p,l).then(m=>{u(m)}).catch(m=>{m&&m.code===11e3?this._upsert(e,t,n,s).then(g=>u(g)).catch(g=>f(g)):f(m)})}else f(h)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let n=t.attrs||{},s=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(s)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));let n=t.attrs||{},s=Object.assign({key:e},n);return this._collection.deleteOne(s).then(i=>i.deletedCount>0)}};fE.exports=gm});var pE=K((Roe,dE)=>{var tM=Ka(),rM=Xr(),ym=class extends tM{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,s)=>{if(n)return t(n);e(s)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,s=>{if(s)return this._releaseConnection(n),t(s);n.query(this._getCreateTableStmt(),i=>{if(i)return this._releaseConnection(n),t(i);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){let s=new rM,[i]=n;return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_upsertTransaction(e,t,n,s,i){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);let l=Date.now(),u=s>0?l+s:null,f,h;i?(f=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,h=[this.dbName,this.tableName,t,n,u,n,u]):(f=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,h=[this.dbName,this.tableName,t,n,u,l,n,n,l,u]),e.query(f,h,d=>{if(d)return e.rollback(),a(d);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(p,m)=>{if(p)return e.rollback(),a(p);e.query("COMMIT",g=>{if(g)return e.rollback(),a(g);o(m)})})})})})}_upsert(e,t,n,s=!1){return this.tableCreated?new Promise((i,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,s).then(c=>{i(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(i,o)=>{i?n(i):o.length===0?t(null):t(o),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(i,o)=>{i?n(i):t(o.affectedRows>0),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}};dE.exports=ym});var gE=K((Ioe,mE)=>{var nM=Ka(),sM=Xr(),bm=class extends nM{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?typeof t=="function"&&t():this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{let n={name:"rlflx-clear-expired",text:`DELETE FROM ${this.tableName} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this.tableName} ( 
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){let t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){let s=new sM,i=n.rows[0];return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_query(e){let n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((s,i)=>{this._getConnection().then(o=>{o.query(n).then(a=>{s(a),this._releaseConnection(o)}).catch(a=>{i(a),this._releaseConnection(o)})}).catch(o=>{i(o)})})}_upsert(e,t,n,s=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));let i=n>0?Date.now()+n:null,o=s?" $3 ":` CASE
             WHEN ${this.tableName}.expire <= $4 THEN $3
             ELSE ${this.tableName}.expire
            END `;return this._query({name:s?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this.tableName} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this.tableName}.expire <= $4 OR 1=${s?1:0}) THEN $2
                          ELSE ${this.tableName}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,i,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this.tableName} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(s=>{s.rowCount===0&&(s=null),t(s)}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this.tableName} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};mE.exports=bm});var yE=K(()=>{});var wE=K((Coe,bE)=>{bE.exports=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}}});var xE=K((koe,EE)=>{var iM=wE(),wm=Xr();EE.exports=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){let s=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return s!==0?(this._storage[e].value=this._storage[e].value+t,new wm(0,s,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){let s=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new iM(t,s>0?new Date(Date.now()+s):null),s>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},s),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new wm(0,s===0?-1:s,this._storage[e].value,!0)}get(e){if(this._storage[e]){let t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new wm(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}}});var xm=K((Noe,_E)=>{var oM=Ol(),aM=xE(),vE=Xr(),Em=class extends oM{constructor(e={}){super(e),this._memoryStorage=new aM}consume(e,t=1,n={}){return new Promise((s,i)=>{let o=this.getKey(e),a=this._getKeySecDuration(n),c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),i(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let l=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));l<this.execEvenlyMinDelayMs&&(l=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(s,l,c)}else s(c)})}penalty(e,t=1,n={}){let s=this.getKey(e);return new Promise(i=>{let o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}reward(e,t=1,n={}){let s=this.getKey(e);return new Promise(i=>{let o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}block(e,t){let n=t*1e3,s=this.points+1;return this._memoryStorage.set(this.getKey(e),s,t),Promise.resolve(new vE(0,n===0?-1:n,s))}set(e,t,n){let s=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new vE(0,s===0?-1:s,t))}get(e){let t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};_E.exports=Em});var CE=K((Ooe,DE)=>{var SE=yE(),cM=il(),lM=Ol(),IE=xm(),uM=Xr(),bn="rate_limiter_flexible",za=null,RE=function(r,e,t,n){let s;n===null||n===!0||n===!1?s=n:s={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:bn,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:s})},TE=function(r){setTimeout(()=>{this._initiated?process.send(r):typeof this._promises[r.promiseId]<"u"&&TE.call(this,r)},30)},Va=function(r,e,t,n,s){let i={channel:bn,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:s}};this._initiated?process.send(i):TE.call(this,i)},AE=function(r,e){if(!e||e.channel!==bn||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{RE(r,e,"resolve",n)}).catch(n=>{RE(r,e,"reject",n)})},fM=function(r){if(!r||r.channel!==bn||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new uM(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},hM=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},qa=function(r,e){let t=process.hrtime(),n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=cM.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n},vm=class{constructor(){if(za)return za;this._rateLimiters={},SE.setMaxListeners(0),SE.on("message",(e,t)=>{t&&t.channel===bn&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new IE(t.opts)),e.send({channel:bn,type:"init",keyPrefix:t.opts.keyPrefix})):AE.call(this,e,t)}),za=this}},_m=class{constructor(e){if(za)return za;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",s=>{let i=s.raw;if(i&&i.channel===bn&&i.type==="init")typeof this._rateLimiters[i.opts.keyPrefix]>"u"&&(this._rateLimiters[i.opts.keyPrefix]=new IE(i.opts)),e.sendDataToProcessId(s.process.pm_id,{data:{},topic:bn,channel:bn,type:"init",keyPrefix:i.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{let o={send:a=>{let c=a;c.topic=bn,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(s.process.pm_id,c,(l,u)=>{l&&console.log(l,u)})}};AE.call(this,o,i)}})}),za=this}},Sm=class extends lM{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),process.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,process.on("message",t=>{t&&t.channel===bn&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:fM.call(this,t)}),process.send({channel:bn,type:"init",opts:hM.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((s,i)=>{let o=qa.call(this,s,i);Va.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((s,i)=>{let o=qa.call(this,s,i);Va.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((s,i)=>{let o=qa.call(this,s,i);Va.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((s,i)=>{let o=qa.call(this,s,i);Va.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,s)=>{let i=qa.call(this,n,s);Va.call(this,"get",i,e,t)})}delete(e,t={}){return new Promise((n,s)=>{let i=qa.call(this,n,s);Va.call(this,"delete",i,e,t)})}};DE.exports={RateLimiterClusterMaster:vm,RateLimiterClusterMasterPM2:_m,RateLimiterCluster:Sm}});var kE=K((Loe,PE)=>{var dM=Ka(),pM=Xr(),Rm=class extends dM{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){let s=new pM;return s.consumedPoints=parseInt(n.consumedPoints),s.isFirstInDuration=n.consumedPoints===t,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=n.msBeforeNext,s}_upsert(e,t,n,s=!1,i={}){return new Promise((o,a)=>{let c=Date.now(),l=Math.floor(n/1e3);s?this.client.set(e,t,l,u=>{u?a(u):this.client.set(`${e}_expire`,l>0?c+l*1e3:-1,l,()=>{let f={consumedPoints:t,msBeforeNext:l>0?l*1e3:-1};o(f)})}):this.client.incr(e,t,(u,f)=>{u||f===!1?this.client.add(e,t,l,(h,d)=>{if(h||!d)if(typeof i.attemptNumber>"u"||i.attemptNumber<3){let p=Object.assign({},i);p.attemptNumber=p.attemptNumber?p.attemptNumber+1:1,this._upsert(e,t,n,s,p).then(m=>o(m)).catch(m=>a(m))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,l>0?c+l*1e3:-1,l,()=>{let p={consumedPoints:t,msBeforeNext:l>0?l*1e3:-1};o(p)})}):this.client.get(`${e}_expire`,(h,d)=>{if(h)a(h);else{let p=d===!1?0:d,m={consumedPoints:f,msBeforeNext:p>=0?Math.max(p-c,0):-1};o(m)}})})})}_get(e){return new Promise((t,n)=>{let s=Date.now();this.client.get(e,(i,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{let l=c===!1?0:c,u={consumedPoints:o,msBeforeNext:l>=0?Math.max(l-s,0):-1};t(u)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):i===!1?t(i):this.client.del(`${e}_expire`,o=>{o?n(o):t(i)})})})}};PE.exports=Rm});var LE=K((Moe,OE)=>{var NE=Xr();OE.exports=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new NE(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new NE(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}}});var ME=K((Foe,BE)=>{var mM=Ol();BE.exports=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof mM))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,s)=>{let i=[];this._limiters.forEach(o=>{i.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(i).then(o=>{let a={},c=!1;o.forEach(l=>{l.rejected===!0&&(c=!0)});for(let l=0;l<o.length;l++)c&&o[l].rejected===!0?a[this._limiters[l].keyPrefix]=o[l].rej:c||(a[this._limiters[l].keyPrefix]=o[l]);c?s(a):n(a)})})}}});var FE=K((Voe,UE)=>{UE.exports=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}}});var zE=K((zoe,qE)=>{var KE=FE(),VE=4294967295,Im="limiter";qE.exports=class{constructor(e,t={maxQueueSize:VE}){this._queueLimiters={KEY_DEFAULT:new Kf(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=Im){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=Im){return this._queueLimiters[t]||(this._queueLimiters[t]=new Kf(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};var Kf=class{constructor(e,t={maxQueueSize:VE,key:Im}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){let t=this;return new Promise((n,s)=>{if(e>t._limiterFlexible.points){s(new KE(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,s,e):t._limiterFlexible.consume(t._key,e).then(i=>{n(i.remainingPoints)}).catch(i=>{i instanceof Error?s(i):(t._queueRequest.call(t,n,s,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),i.msBeforeNext)))})})}_queueRequest(e,t,n){let s=this;s._queue.length<s._maxQueueSize?s._queue.push({resolve:e,reject:t,tokens:n}):t(new KE(`Number of requests reached it's maximum ${s._maxQueueSize}`))}_processFIFO(){let e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;let t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}});var HE=K((Hoe,$E)=>{var Tm=Xr();$E.exports=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new Tm(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(s=>s instanceof Tm?this._burstLimiter.consume(e,t,n).then(i=>Promise.resolve(this._combineRes(s,i))).catch(i=>i instanceof Tm?Promise.reject(this._combineRes(s,i)):Promise.reject(i)):Promise.reject(s))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}}});var Am=K((Woe,WE)=>{var gM=lE(),yM=hE(),bM=pE(),wM=gE(),{RateLimiterClusterMaster:EM,RateLimiterClusterMasterPM2:xM,RateLimiterCluster:vM}=CE(),_M=xm(),SM=kE(),RM=LE(),IM=ME(),TM=zE(),AM=HE(),DM=Xr();WE.exports={RateLimiterRedis:gM,RateLimiterMongo:yM,RateLimiterMySQL:bM,RateLimiterPostgres:wM,RateLimiterMemory:_M,RateLimiterMemcache:SM,RateLimiterClusterMaster:EM,RateLimiterClusterMasterPM2:xM,RateLimiterCluster:vM,RLWrapperBlackAndWhite:RM,RateLimiterUnion:IM,RateLimiterQueue:TM,BurstyRateLimiter:AM,RateLimiterRes:DM}});var ux=K((sue,lx)=>{"use strict";lx.exports=zl;var Wm=Rs();(zl.prototype=Object.create(Wm.EventEmitter.prototype)).constructor=zl;function zl(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");Wm.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=!!e,this.responseDelimited=!!t}zl.prototype.rpcCall=function r(e,t,n,s,i){if(!s)throw TypeError("request must be specified");var o=this;if(!i)return Wm.asPromise(r,o,e,t,n,s);if(!o.rpcImpl){setTimeout(function(){i(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,l){if(c)return o.emit("error",c,e),i(c);if(l===null){o.end(!0);return}if(!(l instanceof n))try{l=n[o.responseDelimited?"decodeDelimited":"decode"](l)}catch(u){return o.emit("error",u,e),i(u)}return o.emit("data",l,e),i(null,l)})}catch(a){o.emit("error",a,e),setTimeout(function(){i(a)},0);return}};zl.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}});var hx=K(fx=>{"use strict";var jM=fx;jM.Service=ux()});var px=K((oue,dx)=>{"use strict";dx.exports={}});var yx=K(gx=>{"use strict";var Lr=gx;Lr.build="minimal";Lr.Writer=Uu();Lr.BufferWriter=N1();Lr.Reader=Bu();Lr.BufferReader=I1();Lr.util=Rs();Lr.rpc=hx();Lr.roots=px();Lr.configure=mx;function mx(){Lr.util._configure(),Lr.Writer._configure(Lr.BufferWriter),Lr.Reader._configure(Lr.BufferReader)}mx()});var Gm=K((cue,bx)=>{"use strict";bx.exports=yx()});var Ex=K((wx,$l)=>{(function(r,e){typeof define=="function"&&define.amd?define(["protobufjs/minimal"],e):typeof D8=="function"&&typeof $l=="object"&&$l&&$l.exports&&($l.exports=e(Gm()))})(wx,function(r){"use strict";var e=r.Reader,t=r.Writer,n=r.util,s=r.roots.default||(r.roots.default={});return s.RPC=function(){function i(a){if(this.subscriptions=[],this.messages=[],a)for(var c=Object.keys(a),l=0;l<c.length;++l)a[c[l]]!=null&&(this[c[l]]=a[c[l]])}i.prototype.subscriptions=n.emptyArray,i.prototype.messages=n.emptyArray,i.prototype.control=null;var o;return Object.defineProperty(i.prototype,"_control",{get:n.oneOfGetter(o=["control"]),set:n.oneOfSetter(o)}),i.encode=function(c,l){if(l||(l=t.create()),c.subscriptions!=null&&c.subscriptions.length)for(var u=0;u<c.subscriptions.length;++u)s.RPC.SubOpts.encode(c.subscriptions[u],l.uint32(10).fork()).ldelim();if(c.messages!=null&&c.messages.length)for(var u=0;u<c.messages.length;++u)s.RPC.Message.encode(c.messages[u],l.uint32(18).fork()).ldelim();return c.control!=null&&Object.hasOwnProperty.call(c,"control")&&s.RPC.ControlMessage.encode(c.control,l.uint32(26).fork()).ldelim(),l},i.decode=function(c,l){c instanceof e||(c=e.create(c));for(var u=l===void 0?c.len:c.pos+l,f=new s.RPC;c.pos<u;){var h=c.uint32();switch(h>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(s.RPC.SubOpts.decode(c,c.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(s.RPC.Message.decode(c,c.uint32()));break;case 3:f.control=s.RPC.ControlMessage.decode(c,c.uint32());break;default:c.skipType(h&7);break}}return f},i.fromObject=function(c){if(c instanceof s.RPC)return c;var l=new s.RPC;if(c.subscriptions){if(!Array.isArray(c.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var u=0;u<c.subscriptions.length;++u){if(typeof c.subscriptions[u]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[u]=s.RPC.SubOpts.fromObject(c.subscriptions[u])}}if(c.messages){if(!Array.isArray(c.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var u=0;u<c.messages.length;++u){if(typeof c.messages[u]!="object")throw TypeError(".RPC.messages: object expected");l.messages[u]=s.RPC.Message.fromObject(c.messages[u])}}if(c.control!=null){if(typeof c.control!="object")throw TypeError(".RPC.control: object expected");l.control=s.RPC.ControlMessage.fromObject(c.control)}return l},i.toObject=function(c,l){l||(l={});var u={};if((l.arrays||l.defaults)&&(u.subscriptions=[],u.messages=[]),c.subscriptions&&c.subscriptions.length){u.subscriptions=[];for(var f=0;f<c.subscriptions.length;++f)u.subscriptions[f]=s.RPC.SubOpts.toObject(c.subscriptions[f],l)}if(c.messages&&c.messages.length){u.messages=[];for(var f=0;f<c.messages.length;++f)u.messages[f]=s.RPC.Message.toObject(c.messages[f],l)}return c.control!=null&&c.hasOwnProperty("control")&&(u.control=s.RPC.ControlMessage.toObject(c.control,l),l.oneofs&&(u._control="control")),u},i.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},i.SubOpts=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.subscribe=null,a.prototype.topic=null;var c;return Object.defineProperty(a.prototype,"_subscribe",{get:n.oneOfGetter(c=["subscribe"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_topic",{get:n.oneOfGetter(c=["topic"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.subscribe!=null&&Object.hasOwnProperty.call(u,"subscribe")&&f.uint32(8).bool(u.subscribe),u.topic!=null&&Object.hasOwnProperty.call(u,"topic")&&f.uint32(18).string(u.topic),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.SubOpts;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.subscribe=u.bool();break;case 2:d.topic=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.SubOpts)return u;var f=new s.RPC.SubOpts;return u.subscribe!=null&&(f.subscribe=!!u.subscribe),u.topic!=null&&(f.topic=String(u.topic)),f},a.toObject=function(u,f){f||(f={});var h={};return u.subscribe!=null&&u.hasOwnProperty("subscribe")&&(h.subscribe=u.subscribe,f.oneofs&&(h._subscribe="subscribe")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic,f.oneofs&&(h._topic="topic")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.Message=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.from=null,a.prototype.data=null,a.prototype.seqno=null,a.prototype.topic="",a.prototype.signature=null,a.prototype.key=null;var c;return Object.defineProperty(a.prototype,"_from",{get:n.oneOfGetter(c=["from"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_data",{get:n.oneOfGetter(c=["data"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_seqno",{get:n.oneOfGetter(c=["seqno"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signature",{get:n.oneOfGetter(c=["signature"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_key",{get:n.oneOfGetter(c=["key"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.from!=null&&Object.hasOwnProperty.call(u,"from")&&f.uint32(10).bytes(u.from),u.data!=null&&Object.hasOwnProperty.call(u,"data")&&f.uint32(18).bytes(u.data),u.seqno!=null&&Object.hasOwnProperty.call(u,"seqno")&&f.uint32(26).bytes(u.seqno),f.uint32(34).string(u.topic),u.signature!=null&&Object.hasOwnProperty.call(u,"signature")&&f.uint32(42).bytes(u.signature),u.key!=null&&Object.hasOwnProperty.call(u,"key")&&f.uint32(50).bytes(u.key),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.Message;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.from=u.bytes();break;case 2:d.data=u.bytes();break;case 3:d.seqno=u.bytes();break;case 4:d.topic=u.string();break;case 5:d.signature=u.bytes();break;case 6:d.key=u.bytes();break;default:u.skipType(p&7);break}}if(!d.hasOwnProperty("topic"))throw n.ProtocolError("missing required 'topic'",{instance:d});return d},a.fromObject=function(u){if(u instanceof s.RPC.Message)return u;var f=new s.RPC.Message;return u.from!=null&&(typeof u.from=="string"?n.base64.decode(u.from,f.from=n.newBuffer(n.base64.length(u.from)),0):u.from.length&&(f.from=u.from)),u.data!=null&&(typeof u.data=="string"?n.base64.decode(u.data,f.data=n.newBuffer(n.base64.length(u.data)),0):u.data.length&&(f.data=u.data)),u.seqno!=null&&(typeof u.seqno=="string"?n.base64.decode(u.seqno,f.seqno=n.newBuffer(n.base64.length(u.seqno)),0):u.seqno.length&&(f.seqno=u.seqno)),u.topic!=null&&(f.topic=String(u.topic)),u.signature!=null&&(typeof u.signature=="string"?n.base64.decode(u.signature,f.signature=n.newBuffer(n.base64.length(u.signature)),0):u.signature.length&&(f.signature=u.signature)),u.key!=null&&(typeof u.key=="string"?n.base64.decode(u.key,f.key=n.newBuffer(n.base64.length(u.key)),0):u.key.length&&(f.key=u.key)),f},a.toObject=function(u,f){f||(f={});var h={};return f.defaults&&(h.topic=""),u.from!=null&&u.hasOwnProperty("from")&&(h.from=f.bytes===String?n.base64.encode(u.from,0,u.from.length):f.bytes===Array?Array.prototype.slice.call(u.from):u.from,f.oneofs&&(h._from="from")),u.data!=null&&u.hasOwnProperty("data")&&(h.data=f.bytes===String?n.base64.encode(u.data,0,u.data.length):f.bytes===Array?Array.prototype.slice.call(u.data):u.data,f.oneofs&&(h._data="data")),u.seqno!=null&&u.hasOwnProperty("seqno")&&(h.seqno=f.bytes===String?n.base64.encode(u.seqno,0,u.seqno.length):f.bytes===Array?Array.prototype.slice.call(u.seqno):u.seqno,f.oneofs&&(h._seqno="seqno")),u.topic!=null&&u.hasOwnProperty("topic")&&(h.topic=u.topic),u.signature!=null&&u.hasOwnProperty("signature")&&(h.signature=f.bytes===String?n.base64.encode(u.signature,0,u.signature.length):f.bytes===Array?Array.prototype.slice.call(u.signature):u.signature,f.oneofs&&(h._signature="signature")),u.key!=null&&u.hasOwnProperty("key")&&(h.key=f.bytes===String?n.base64.encode(u.key,0,u.key.length):f.bytes===Array?Array.prototype.slice.call(u.key):u.key,f.oneofs&&(h._key="key")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.ControlMessage=function(){function a(c){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.ihave=n.emptyArray,a.prototype.iwant=n.emptyArray,a.prototype.graft=n.emptyArray,a.prototype.prune=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)s.RPC.ControlIHave.encode(l.ihave[f],u.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)s.RPC.ControlIWant.encode(l.iwant[f],u.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)s.RPC.ControlGraft.encode(l.graft[f],u.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)s.RPC.ControlPrune.encode(l.prune[f],u.uint32(34).fork()).ldelim();return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new s.RPC.ControlMessage;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.ihave&&h.ihave.length||(h.ihave=[]),h.ihave.push(s.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:h.iwant&&h.iwant.length||(h.iwant=[]),h.iwant.push(s.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:h.graft&&h.graft.length||(h.graft=[]),h.graft.push(s.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:h.prune&&h.prune.length||(h.prune=[]),h.prune.push(s.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof s.RPC.ControlMessage)return l;var u=new s.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");u.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");u.ihave[f]=s.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");u.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");u.iwant[f]=s.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");u.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");u.graft[f]=s.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");u.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");u.prune[f]=s.RPC.ControlPrune.fromObject(l.prune[f])}}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var h=0;h<l.ihave.length;++h)f.ihave[h]=s.RPC.ControlIHave.toObject(l.ihave[h],u)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var h=0;h<l.iwant.length;++h)f.iwant[h]=s.RPC.ControlIWant.toObject(l.iwant[h],u)}if(l.graft&&l.graft.length){f.graft=[];for(var h=0;h<l.graft.length;++h)f.graft[h]=s.RPC.ControlGraft.toObject(l.graft[h],u)}if(l.prune&&l.prune.length){f.prune=[];for(var h=0;h<l.prune.length;++h)f.prune[h]=s.RPC.ControlPrune.toObject(l.prune[h],u)}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.ControlIHave=function(){function a(l){if(this.messageIDs=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.messageIDs=n.emptyArray;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.messageIDs!=null&&u.messageIDs.length)for(var h=0;h<u.messageIDs.length;++h)f.uint32(18).bytes(u.messageIDs[h]);return f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlIHave;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.messageIDs&&d.messageIDs.length||(d.messageIDs=[]),d.messageIDs.push(u.bytes());break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlIHave)return u;var f=new s.RPC.ControlIHave;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.messageIDs){if(!Array.isArray(u.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var h=0;h<u.messageIDs.length;++h)typeof u.messageIDs[h]=="string"?n.base64.decode(u.messageIDs[h],f.messageIDs[h]=n.newBuffer(n.base64.length(u.messageIDs[h])),0):u.messageIDs[h].length&&(f.messageIDs[h]=u.messageIDs[h])}return f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.messageIDs=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.messageIDs&&u.messageIDs.length){h.messageIDs=[];for(var d=0;d<u.messageIDs.length;++d)h.messageIDs[d]=f.bytes===String?n.base64.encode(u.messageIDs[d],0,u.messageIDs[d].length):f.bytes===Array?Array.prototype.slice.call(u.messageIDs[d]):u.messageIDs[d]}return h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.ControlIWant=function(){function a(c){if(this.messageIDs=[],c)for(var l=Object.keys(c),u=0;u<l.length;++u)c[l[u]]!=null&&(this[l[u]]=c[l[u]])}return a.prototype.messageIDs=n.emptyArray,a.encode=function(l,u){if(u||(u=t.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)u.uint32(10).bytes(l.messageIDs[f]);return u},a.decode=function(l,u){l instanceof e||(l=e.create(l));for(var f=u===void 0?l.len:l.pos+u,h=new s.RPC.ControlIWant;l.pos<f;){var d=l.uint32();switch(d>>>3){case 1:h.messageIDs&&h.messageIDs.length||(h.messageIDs=[]),h.messageIDs.push(l.bytes());break;default:l.skipType(d&7);break}}return h},a.fromObject=function(l){if(l instanceof s.RPC.ControlIWant)return l;var u=new s.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");u.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?n.base64.decode(l.messageIDs[f],u.messageIDs[f]=n.newBuffer(n.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(u.messageIDs[f]=l.messageIDs[f])}return u},a.toObject=function(l,u){u||(u={});var f={};if((u.arrays||u.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var h=0;h<l.messageIDs.length;++h)f.messageIDs[h]=u.bytes===String?n.base64.encode(l.messageIDs[h],0,l.messageIDs[h].length):u.bytes===Array?Array.prototype.slice.call(l.messageIDs[h]):l.messageIDs[h]}return f},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.ControlGraft=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlGraft;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlGraft)return u;var f=new s.RPC.ControlGraft;return u.topicID!=null&&(f.topicID=String(u.topicID)),f},a.toObject=function(u,f){f||(f={});var h={};return u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.ControlPrune=function(){function a(l){if(this.peers=[],l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.topicID=null,a.prototype.peers=n.emptyArray,a.prototype.backoff=null;var c;return Object.defineProperty(a.prototype,"_topicID",{get:n.oneOfGetter(c=["topicID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_backoff",{get:n.oneOfGetter(c=["backoff"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){if(f||(f=t.create()),u.topicID!=null&&Object.hasOwnProperty.call(u,"topicID")&&f.uint32(10).string(u.topicID),u.peers!=null&&u.peers.length)for(var h=0;h<u.peers.length;++h)s.RPC.PeerInfo.encode(u.peers[h],f.uint32(18).fork()).ldelim();return u.backoff!=null&&Object.hasOwnProperty.call(u,"backoff")&&f.uint32(24).uint64(u.backoff),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.ControlPrune;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.topicID=u.string();break;case 2:d.peers&&d.peers.length||(d.peers=[]),d.peers.push(s.RPC.PeerInfo.decode(u,u.uint32()));break;case 3:d.backoff=u.uint64();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.ControlPrune)return u;var f=new s.RPC.ControlPrune;if(u.topicID!=null&&(f.topicID=String(u.topicID)),u.peers){if(!Array.isArray(u.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var h=0;h<u.peers.length;++h){if(typeof u.peers[h]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[h]=s.RPC.PeerInfo.fromObject(u.peers[h])}}return u.backoff!=null&&(n.Long?(f.backoff=n.Long.fromValue(u.backoff)).unsigned=!0:typeof u.backoff=="string"?f.backoff=parseInt(u.backoff,10):typeof u.backoff=="number"?f.backoff=u.backoff:typeof u.backoff=="object"&&(f.backoff=new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0))),f},a.toObject=function(u,f){f||(f={});var h={};if((f.arrays||f.defaults)&&(h.peers=[]),u.topicID!=null&&u.hasOwnProperty("topicID")&&(h.topicID=u.topicID,f.oneofs&&(h._topicID="topicID")),u.peers&&u.peers.length){h.peers=[];for(var d=0;d<u.peers.length;++d)h.peers[d]=s.RPC.PeerInfo.toObject(u.peers[d],f)}return u.backoff!=null&&u.hasOwnProperty("backoff")&&(typeof u.backoff=="number"?h.backoff=f.longs===String?String(u.backoff):u.backoff:h.backoff=f.longs===String?n.Long.prototype.toString.call(u.backoff):f.longs===Number?new n.LongBits(u.backoff.low>>>0,u.backoff.high>>>0).toNumber(!0):u.backoff,f.oneofs&&(h._backoff="backoff")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i.PeerInfo=function(){function a(l){if(l)for(var u=Object.keys(l),f=0;f<u.length;++f)l[u[f]]!=null&&(this[u[f]]=l[u[f]])}a.prototype.peerID=null,a.prototype.signedPeerRecord=null;var c;return Object.defineProperty(a.prototype,"_peerID",{get:n.oneOfGetter(c=["peerID"]),set:n.oneOfSetter(c)}),Object.defineProperty(a.prototype,"_signedPeerRecord",{get:n.oneOfGetter(c=["signedPeerRecord"]),set:n.oneOfSetter(c)}),a.encode=function(u,f){return f||(f=t.create()),u.peerID!=null&&Object.hasOwnProperty.call(u,"peerID")&&f.uint32(10).bytes(u.peerID),u.signedPeerRecord!=null&&Object.hasOwnProperty.call(u,"signedPeerRecord")&&f.uint32(18).bytes(u.signedPeerRecord),f},a.decode=function(u,f){u instanceof e||(u=e.create(u));for(var h=f===void 0?u.len:u.pos+f,d=new s.RPC.PeerInfo;u.pos<h;){var p=u.uint32();switch(p>>>3){case 1:d.peerID=u.bytes();break;case 2:d.signedPeerRecord=u.bytes();break;default:u.skipType(p&7);break}}return d},a.fromObject=function(u){if(u instanceof s.RPC.PeerInfo)return u;var f=new s.RPC.PeerInfo;return u.peerID!=null&&(typeof u.peerID=="string"?n.base64.decode(u.peerID,f.peerID=n.newBuffer(n.base64.length(u.peerID)),0):u.peerID.length&&(f.peerID=u.peerID)),u.signedPeerRecord!=null&&(typeof u.signedPeerRecord=="string"?n.base64.decode(u.signedPeerRecord,f.signedPeerRecord=n.newBuffer(n.base64.length(u.signedPeerRecord)),0):u.signedPeerRecord.length&&(f.signedPeerRecord=u.signedPeerRecord)),f},a.toObject=function(u,f){f||(f={});var h={};return u.peerID!=null&&u.hasOwnProperty("peerID")&&(h.peerID=f.bytes===String?n.base64.encode(u.peerID,0,u.peerID.length):f.bytes===Array?Array.prototype.slice.call(u.peerID):u.peerID,f.oneofs&&(h._peerID="peerID")),u.signedPeerRecord!=null&&u.hasOwnProperty("signedPeerRecord")&&(h.signedPeerRecord=f.bytes===String?n.base64.encode(u.signedPeerRecord,0,u.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(u.signedPeerRecord):u.signedPeerRecord,f.oneofs&&(h._signedPeerRecord="signedPeerRecord")),h},a.prototype.toJSON=function(){return this.constructor.toObject(this,r.util.toJSONOptions)},a}(),i}(),s})});var Px=K((Oue,Cx)=>{"use strict";function gt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}gt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};gt.prototype.get=function(e){return this.peekAt(e)};gt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};gt.prototype.peekFront=function(){return this.peek()};gt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(gt.prototype,"length",{get:function(){return this.size()}});gt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};gt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};gt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};gt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};gt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};gt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};gt.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};gt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,l=this._list.length,u=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>u;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var f=o.length;for(i=0;i<f;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-f+l&this._capacityMask);u<c;)this.push(arguments[u++]);for(i=0;i<f;i++)this.push(o[i])}return a}else return this.remove(n,t)}};gt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};gt.prototype.isEmpty=function(){return this._head===this._tail};gt.prototype.toArray=function(){return this._copyArray(!1)};gt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var s=0;s<t;s++)this._list[s]=e[s]};gt.prototype._copyArray=function(e,t){var n=this._list,s=n.length,i=this.length;if(t=t|i,t==i&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<s;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o};gt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};gt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};gt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};Cx.exports=gt});var C3=K((Vde,Qv)=>{Qv.exports=r=>async function*(){let e=/\r?\n/,t=new TextDecoder("utf8"),n="";for await(let s of r){typeof s=="string"&&(s=new TextEncoder().encode(s)),n+=t.decode(s,{stream:!0});let i=n.split(e);n=i.pop();for(let o=0;o<i.length;o++)yield JSON.parse(i[o])}n+=t.decode(),n&&(yield JSON.parse(n))}()});var jv=K((qde,Xv)=>{Xv.exports=r=>async function*(){for await(let e of r)yield JSON.stringify(e)+`
`}()});var Zv=K((zde,kh)=>{kh.exports=C3();kh.exports.parse=C3();kh.exports.stringify=jv()});var E_=K((Rpe,w_)=>{w_.exports=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}}});var cS=K((B4e,aS)=>{"use strict";function qK(r){if(r.length>=255)throw new TypeError("Alphabet too long");for(var e=new Uint8Array(256),t=0;t<e.length;t++)e[t]=255;for(var n=0;n<r.length;n++){var s=r.charAt(n),i=s.charCodeAt(0);if(e[i]!==255)throw new TypeError(s+" is ambiguous");e[i]=n}var o=r.length,a=r.charAt(0),c=Math.log(o)/Math.log(256),l=Math.log(256)/Math.log(o);function u(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";for(var p=0,m=0,g=0,y=d.length;g!==y&&d[g]===0;)g++,p++;for(var w=(y-g)*l+1>>>0,E=new Uint8Array(w);g!==y;){for(var R=d[g],x=0,v=w-1;(R!==0||x<m)&&v!==-1;v--,x++)R+=256*E[v]>>>0,E[v]=R%o>>>0,R=R/o>>>0;if(R!==0)throw new Error("Non-zero carry");m=x,g++}for(var I=w-m;I!==w&&E[I]===0;)I++;for(var _=a.repeat(p);I<w;++I)_+=r.charAt(E[I]);return _}function f(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;var p=0;if(d[p]!==" "){for(var m=0,g=0;d[p]===a;)m++,p++;for(var y=(d.length-p)*c+1>>>0,w=new Uint8Array(y);d[p];){var E=e[d.charCodeAt(p)];if(E===255)return;for(var R=0,x=y-1;(E!==0||R<g)&&x!==-1;x--,R++)E+=o*w[x]>>>0,w[x]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");g=R,p++}if(d[p]!==" "){for(var v=y-g;v!==y&&w[v]===0;)v++;for(var I=new Uint8Array(m+(y-v)),_=m;v!==y;)I[_++]=w[v++];return I}}}function h(d){var p=f(d);if(p)return p;throw new Error("Non-base"+o+" character")}return{encode:u,decodeUnsafe:f,decode:h}}aS.exports=qK});var pd=K((M4e,lS)=>{"use strict";var zK=new TextDecoder,$K=r=>zK.decode(r),HK=new TextEncoder,WK=r=>HK.encode(r);function GK(r,e){let t=new Uint8Array(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return t}lS.exports={decodeText:$K,encodeText:WK,concat:GK}});var fS=K((U4e,uS)=>{"use strict";var{encodeText:YK}=pd(),l4=class{constructor(e,t,n,s){this.name=e,this.code=t,this.codeBuf=YK(this.code),this.alphabet=s,this.codec=n(s)}encode(e){return this.codec.encode(e)}decode(e){for(let t of e)if(this.alphabet&&this.alphabet.indexOf(t)<0)throw new Error(`invalid character '${t}' in '${e}'`);return this.codec.decode(e)}};uS.exports=l4});var dS=K((F4e,hS)=>{"use strict";var QK=(r,e,t)=>{let n={};for(let l=0;l<e.length;++l)n[e[l]]=l;let s=r.length;for(;r[s-1]==="=";)--s;let i=new Uint8Array(s*t/8|0),o=0,a=0,c=0;for(let l=0;l<s;++l){let u=n[r[l]];if(u===void 0)throw new SyntaxError("Invalid character "+r[l]);a=a<<t|u,o+=t,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=t||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return i},XK=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},jK=r=>e=>({encode(t){return XK(t,e,r)},decode(t){return QK(t,e,r)}});hS.exports={rfc4648:jK}});var yS=K((K4e,gS)=>{"use strict";var cu=cS(),ZK=fS(),{rfc4648:nr}=dS(),{decodeText:JK,encodeText:eV}=pd(),tV=()=>({encode:JK,decode:eV}),pS=[["identity","\0",tV,""],["base2","0",nr(1),"01"],["base8","7",nr(3),"01234567"],["base10","9",cu,"0123456789"],["base16","f",nr(4),"0123456789abcdef"],["base16upper","F",nr(4),"0123456789ABCDEF"],["base32hex","v",nr(5),"0123456789abcdefghijklmnopqrstuv"],["base32hexupper","V",nr(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV"],["base32hexpad","t",nr(5),"0123456789abcdefghijklmnopqrstuv="],["base32hexpadupper","T",nr(5),"0123456789ABCDEFGHIJKLMNOPQRSTUV="],["base32","b",nr(5),"abcdefghijklmnopqrstuvwxyz234567"],["base32upper","B",nr(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"],["base32pad","c",nr(5),"abcdefghijklmnopqrstuvwxyz234567="],["base32padupper","C",nr(5),"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567="],["base32z","h",nr(5),"ybndrfg8ejkmcpqxot1uwisza345h769"],["base36","k",cu,"0123456789abcdefghijklmnopqrstuvwxyz"],["base36upper","K",cu,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"],["base58btc","z",cu,"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"],["base58flickr","Z",cu,"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"],["base64","m",nr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"],["base64pad","M",nr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="],["base64url","u",nr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"],["base64urlpad","U",nr(6),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_="]],mS=pS.reduce((r,e)=>(r[e[0]]=new ZK(e[0],e[1],e[2],e[3]),r),{}),rV=pS.reduce((r,e)=>(r[e[1]]=mS[e[0]],r),{});gS.exports={names:mS,codes:rV}});var ES=K((Gs,wS)=>{"use strict";var pc=yS(),{encodeText:nV,decodeText:md,concat:bS}=pd();function sV(r,e){if(!e)throw new Error("requires an encoded Uint8Array");let{name:t,codeBuf:n}=qo(r);return cV(t,e),bS([n,e],n.length+e.length)}function iV(r,e){let t=qo(r),n=nV(t.encode(e));return bS([t.codeBuf,n],t.codeBuf.length+n.length)}function oV(r){r instanceof Uint8Array&&(r=md(r));let e=r[0];return["f","F","v","V","t","T","b","B","c","C","h","k","K"].includes(e)&&(r=r.toLowerCase()),qo(r[0]).decode(r.substring(1))}function aV(r){if(r instanceof Uint8Array&&(r=md(r)),Object.prototype.toString.call(r)!=="[object String]")return!1;try{return qo(r[0]).name}catch{return!1}}function cV(r,e){qo(r).decode(md(e))}function qo(r){if(Object.prototype.hasOwnProperty.call(pc.names,r))return pc.names[r];if(Object.prototype.hasOwnProperty.call(pc.codes,r))return pc.codes[r];throw new Error(`Unsupported encoding: ${r}`)}function lV(r){return r instanceof Uint8Array&&(r=md(r)),qo(r[0])}Gs=wS.exports=sV;Gs.encode=iV;Gs.decode=oV;Gs.isEncoded=aV;Gs.encoding=qo;Gs.encodingFromData=lV;var uV=Object.freeze(pc.names),fV=Object.freeze(pc.codes);Gs.names=uV;Gs.codes=fV});var SS=K((V4e,_S)=>{_S.exports=vS;var xS=128,hV=127,dV=~hV,pV=Math.pow(2,31);function vS(r,e,t){e=e||[],t=t||0;for(var n=t;r>=pV;)e[t++]=r&255|xS,r/=128;for(;r&dV;)e[t++]=r&255|xS,r>>>=7;return e[t]=r|0,vS.bytes=t-n+1,e}});var TS=K((q4e,IS)=>{IS.exports=u4;var mV=128,RS=127;function u4(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw u4.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&RS)<<s:(o&RS)*Math.pow(2,s),s+=7}while(o>=mV);return u4.bytes=i-n,t}});var DS=K((z4e,AS)=>{var gV=Math.pow(2,7),yV=Math.pow(2,14),bV=Math.pow(2,21),wV=Math.pow(2,28),EV=Math.pow(2,35),xV=Math.pow(2,42),vV=Math.pow(2,49),_V=Math.pow(2,56),SV=Math.pow(2,63);AS.exports=function(r){return r<gV?1:r<yV?2:r<bV?3:r<wV?4:r<EV?5:r<xV?6:r<vV?7:r<_V?8:r<SV?9:10}});var PS=K(($4e,CS)=>{CS.exports={encode:SS(),decode:TS(),encodingLength:DS()}});var NS=K((H4e,kS)=>{"use strict";var RV=Object.freeze({identity:0,sha1:17,"sha2-256":18,"sha2-512":19,"sha3-512":20,"sha3-384":21,"sha3-256":22,"sha3-224":23,"shake-128":24,"shake-256":25,"keccak-224":26,"keccak-256":27,"keccak-384":28,"keccak-512":29,blake3:30,"murmur3-128":34,"murmur3-32":35,"dbl-sha2-256":86,md4:212,md5:213,bmt:214,"sha2-256-trunc254-padded":4114,"ripemd-128":4178,"ripemd-160":4179,"ripemd-256":4180,"ripemd-320":4181,x11:4352,kangarootwelve:7425,"sm3-256":21325,"blake2b-8":45569,"blake2b-16":45570,"blake2b-24":45571,"blake2b-32":45572,"blake2b-40":45573,"blake2b-48":45574,"blake2b-56":45575,"blake2b-64":45576,"blake2b-72":45577,"blake2b-80":45578,"blake2b-88":45579,"blake2b-96":45580,"blake2b-104":45581,"blake2b-112":45582,"blake2b-120":45583,"blake2b-128":45584,"blake2b-136":45585,"blake2b-144":45586,"blake2b-152":45587,"blake2b-160":45588,"blake2b-168":45589,"blake2b-176":45590,"blake2b-184":45591,"blake2b-192":45592,"blake2b-200":45593,"blake2b-208":45594,"blake2b-216":45595,"blake2b-224":45596,"blake2b-232":45597,"blake2b-240":45598,"blake2b-248":45599,"blake2b-256":45600,"blake2b-264":45601,"blake2b-272":45602,"blake2b-280":45603,"blake2b-288":45604,"blake2b-296":45605,"blake2b-304":45606,"blake2b-312":45607,"blake2b-320":45608,"blake2b-328":45609,"blake2b-336":45610,"blake2b-344":45611,"blake2b-352":45612,"blake2b-360":45613,"blake2b-368":45614,"blake2b-376":45615,"blake2b-384":45616,"blake2b-392":45617,"blake2b-400":45618,"blake2b-408":45619,"blake2b-416":45620,"blake2b-424":45621,"blake2b-432":45622,"blake2b-440":45623,"blake2b-448":45624,"blake2b-456":45625,"blake2b-464":45626,"blake2b-472":45627,"blake2b-480":45628,"blake2b-488":45629,"blake2b-496":45630,"blake2b-504":45631,"blake2b-512":45632,"blake2s-8":45633,"blake2s-16":45634,"blake2s-24":45635,"blake2s-32":45636,"blake2s-40":45637,"blake2s-48":45638,"blake2s-56":45639,"blake2s-64":45640,"blake2s-72":45641,"blake2s-80":45642,"blake2s-88":45643,"blake2s-96":45644,"blake2s-104":45645,"blake2s-112":45646,"blake2s-120":45647,"blake2s-128":45648,"blake2s-136":45649,"blake2s-144":45650,"blake2s-152":45651,"blake2s-160":45652,"blake2s-168":45653,"blake2s-176":45654,"blake2s-184":45655,"blake2s-192":45656,"blake2s-200":45657,"blake2s-208":45658,"blake2s-216":45659,"blake2s-224":45660,"blake2s-232":45661,"blake2s-240":45662,"blake2s-248":45663,"blake2s-256":45664,"skein256-8":45825,"skein256-16":45826,"skein256-24":45827,"skein256-32":45828,"skein256-40":45829,"skein256-48":45830,"skein256-56":45831,"skein256-64":45832,"skein256-72":45833,"skein256-80":45834,"skein256-88":45835,"skein256-96":45836,"skein256-104":45837,"skein256-112":45838,"skein256-120":45839,"skein256-128":45840,"skein256-136":45841,"skein256-144":45842,"skein256-152":45843,"skein256-160":45844,"skein256-168":45845,"skein256-176":45846,"skein256-184":45847,"skein256-192":45848,"skein256-200":45849,"skein256-208":45850,"skein256-216":45851,"skein256-224":45852,"skein256-232":45853,"skein256-240":45854,"skein256-248":45855,"skein256-256":45856,"skein512-8":45857,"skein512-16":45858,"skein512-24":45859,"skein512-32":45860,"skein512-40":45861,"skein512-48":45862,"skein512-56":45863,"skein512-64":45864,"skein512-72":45865,"skein512-80":45866,"skein512-88":45867,"skein512-96":45868,"skein512-104":45869,"skein512-112":45870,"skein512-120":45871,"skein512-128":45872,"skein512-136":45873,"skein512-144":45874,"skein512-152":45875,"skein512-160":45876,"skein512-168":45877,"skein512-176":45878,"skein512-184":45879,"skein512-192":45880,"skein512-200":45881,"skein512-208":45882,"skein512-216":45883,"skein512-224":45884,"skein512-232":45885,"skein512-240":45886,"skein512-248":45887,"skein512-256":45888,"skein512-264":45889,"skein512-272":45890,"skein512-280":45891,"skein512-288":45892,"skein512-296":45893,"skein512-304":45894,"skein512-312":45895,"skein512-320":45896,"skein512-328":45897,"skein512-336":45898,"skein512-344":45899,"skein512-352":45900,"skein512-360":45901,"skein512-368":45902,"skein512-376":45903,"skein512-384":45904,"skein512-392":45905,"skein512-400":45906,"skein512-408":45907,"skein512-416":45908,"skein512-424":45909,"skein512-432":45910,"skein512-440":45911,"skein512-448":45912,"skein512-456":45913,"skein512-464":45914,"skein512-472":45915,"skein512-480":45916,"skein512-488":45917,"skein512-496":45918,"skein512-504":45919,"skein512-512":45920,"skein1024-8":45921,"skein1024-16":45922,"skein1024-24":45923,"skein1024-32":45924,"skein1024-40":45925,"skein1024-48":45926,"skein1024-56":45927,"skein1024-64":45928,"skein1024-72":45929,"skein1024-80":45930,"skein1024-88":45931,"skein1024-96":45932,"skein1024-104":45933,"skein1024-112":45934,"skein1024-120":45935,"skein1024-128":45936,"skein1024-136":45937,"skein1024-144":45938,"skein1024-152":45939,"skein1024-160":45940,"skein1024-168":45941,"skein1024-176":45942,"skein1024-184":45943,"skein1024-192":45944,"skein1024-200":45945,"skein1024-208":45946,"skein1024-216":45947,"skein1024-224":45948,"skein1024-232":45949,"skein1024-240":45950,"skein1024-248":45951,"skein1024-256":45952,"skein1024-264":45953,"skein1024-272":45954,"skein1024-280":45955,"skein1024-288":45956,"skein1024-296":45957,"skein1024-304":45958,"skein1024-312":45959,"skein1024-320":45960,"skein1024-328":45961,"skein1024-336":45962,"skein1024-344":45963,"skein1024-352":45964,"skein1024-360":45965,"skein1024-368":45966,"skein1024-376":45967,"skein1024-384":45968,"skein1024-392":45969,"skein1024-400":45970,"skein1024-408":45971,"skein1024-416":45972,"skein1024-424":45973,"skein1024-432":45974,"skein1024-440":45975,"skein1024-448":45976,"skein1024-456":45977,"skein1024-464":45978,"skein1024-472":45979,"skein1024-480":45980,"skein1024-488":45981,"skein1024-496":45982,"skein1024-504":45983,"skein1024-512":45984,"skein1024-520":45985,"skein1024-528":45986,"skein1024-536":45987,"skein1024-544":45988,"skein1024-552":45989,"skein1024-560":45990,"skein1024-568":45991,"skein1024-576":45992,"skein1024-584":45993,"skein1024-592":45994,"skein1024-600":45995,"skein1024-608":45996,"skein1024-616":45997,"skein1024-624":45998,"skein1024-632":45999,"skein1024-640":46e3,"skein1024-648":46001,"skein1024-656":46002,"skein1024-664":46003,"skein1024-672":46004,"skein1024-680":46005,"skein1024-688":46006,"skein1024-696":46007,"skein1024-704":46008,"skein1024-712":46009,"skein1024-720":46010,"skein1024-728":46011,"skein1024-736":46012,"skein1024-744":46013,"skein1024-752":46014,"skein1024-760":46015,"skein1024-768":46016,"skein1024-776":46017,"skein1024-784":46018,"skein1024-792":46019,"skein1024-800":46020,"skein1024-808":46021,"skein1024-816":46022,"skein1024-824":46023,"skein1024-832":46024,"skein1024-840":46025,"skein1024-848":46026,"skein1024-856":46027,"skein1024-864":46028,"skein1024-872":46029,"skein1024-880":46030,"skein1024-888":46031,"skein1024-896":46032,"skein1024-904":46033,"skein1024-912":46034,"skein1024-920":46035,"skein1024-928":46036,"skein1024-936":46037,"skein1024-944":46038,"skein1024-952":46039,"skein1024-960":46040,"skein1024-968":46041,"skein1024-976":46042,"skein1024-984":46043,"skein1024-992":46044,"skein1024-1000":46045,"skein1024-1008":46046,"skein1024-1016":46047,"skein1024-1024":46048,"poseidon-bls12_381-a2-fc1":46081,"poseidon-bls12_381-a2-fc1-sc":46082});kS.exports={names:RV}});function IV(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,g=0,y=0,w=p.length;y!==w&&p[y]===0;)y++,m++;for(var E=(w-y)*u+1>>>0,R=new Uint8Array(E);y!==w;){for(var x=p[y],v=0,I=E-1;(x!==0||v<g)&&I!==-1;I--,v++)x+=256*R[I]>>>0,R[I]=x%a>>>0,x=x/a>>>0;if(x!==0)throw new Error("Non-zero carry");g=v,y++}for(var _=E-g;_!==E&&R[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(R[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var g=0,y=0;p[m]===c;)g++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var R=t[p.charCodeAt(m)];if(R===255)return;for(var x=0,v=w-1;(R!==0||x<y)&&v!==-1;v--,x++)R+=a*E[v]>>>0,E[v]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");y=x,m++}if(p[m]!==" "){for(var I=w-y;I!==w&&E[I]===0;)I++;for(var _=new Uint8Array(g+(w-I)),D=g;I!==w;)_[D++]=E[I++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var TV,AV,OS,LS=$e(()=>{TV=IV,AV=TV,OS=AV});var G4e,BS,Ys,MS,US,Ui=$e(()=>{G4e=new Uint8Array(0),BS=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ys=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},MS=r=>new TextEncoder().encode(r),US=r=>new TextDecoder().decode(r)});var f4,h4,d4,KS,p4,mc,Fi,DV,CV,xt,Qn=$e(()=>{LS();Ui();f4=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},h4=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KS(this,e)}},d4=class{constructor(e){this.decoders=e}or(e){return KS(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},KS=(r,e)=>new d4({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),p4=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new f4(e,t,n),this.decoder=new h4(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},mc=({name:r,prefix:e,encode:t,decode:n})=>new p4(r,e,t,n),Fi=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=OS(t,e);return mc({prefix:r,name:e,encode:n,decode:i=>Ys(s(i))})},DV=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let i=r.length;for(;r[i-1]==="=";)--i;let o=new Uint8Array(i*t/8|0),a=0,c=0,l=0;for(let u=0;u<i;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},CV=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},xt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>mc({prefix:e,name:r,encode(s){return CV(s,n,t)},decode(s){return DV(s,n,t,r)}})});var m4={};Ce(m4,{identity:()=>PV});var PV,VS=$e(()=>{Qn();Ui();PV=mc({prefix:"\0",name:"identity",encode:r=>US(r),decode:r=>MS(r)})});var g4={};Ce(g4,{base2:()=>kV});var kV,qS=$e(()=>{Qn();kV=xt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1})});var y4={};Ce(y4,{base8:()=>NV});var NV,zS=$e(()=>{Qn();NV=xt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3})});var b4={};Ce(b4,{base10:()=>OV});var OV,$S=$e(()=>{Qn();OV=Fi({prefix:"9",name:"base10",alphabet:"0123456789"})});var w4={};Ce(w4,{base16:()=>LV,base16upper:()=>BV});var LV,BV,HS=$e(()=>{Qn();LV=xt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),BV=xt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4})});var E4={};Ce(E4,{base32:()=>gc,base32hex:()=>KV,base32hexpad:()=>qV,base32hexpadupper:()=>zV,base32hexupper:()=>VV,base32pad:()=>UV,base32padupper:()=>FV,base32upper:()=>MV,base32z:()=>$V});var gc,MV,UV,FV,KV,VV,qV,zV,$V,x4=$e(()=>{Qn();gc=xt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),MV=xt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),UV=xt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),FV=xt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),KV=xt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),VV=xt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),qV=xt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),zV=xt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$V=xt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5})});var v4={};Ce(v4,{base36:()=>HV,base36upper:()=>WV});var HV,WV,WS=$e(()=>{Qn();HV=Fi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),WV=Fi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"})});var _4={};Ce(_4,{base58btc:()=>ys,base58flickr:()=>GV});var ys,GV,S4=$e(()=>{Qn();ys=Fi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),GV=Fi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"})});var R4={};Ce(R4,{base64:()=>YV,base64pad:()=>QV,base64url:()=>XV,base64urlpad:()=>jV});var YV,QV,XV,jV,GS=$e(()=>{Qn();YV=xt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),QV=xt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),XV=xt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),jV=xt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6})});var I4={};Ce(I4,{base256emoji:()=>rq});function eq(r){return r.reduce((e,t)=>(e+=ZV[t],e),"")}function tq(r){let e=[];for(let t of r){let n=JV[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var YS,ZV,JV,rq,QS=$e(()=>{Qn();YS=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),ZV=YS.reduce((r,e,t)=>(r[t]=e,r),[]),JV=YS.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);rq=mc({prefix:"\u{1F680}",name:"base256emoji",encode:eq,decode:tq})});function ZS(r,e,t){e=e||[],t=t||0;for(var n=t;r>=oq;)e[t++]=r&255|XS,r/=128;for(;r&iq;)e[t++]=r&255|XS,r>>>=7;return e[t]=r|0,ZS.bytes=t-n+1,e}function T4(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw T4.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&jS)<<s:(o&jS)*Math.pow(2,s),s+=7}while(o>=cq);return T4.bytes=i-n,t}var nq,XS,sq,iq,oq,aq,cq,jS,lq,uq,fq,hq,dq,pq,mq,gq,yq,bq,wq,Eq,lu,JS=$e(()=>{nq=ZS,XS=128,sq=127,iq=~sq,oq=Math.pow(2,31);aq=T4,cq=128,jS=127;lq=Math.pow(2,7),uq=Math.pow(2,14),fq=Math.pow(2,21),hq=Math.pow(2,28),dq=Math.pow(2,35),pq=Math.pow(2,42),mq=Math.pow(2,49),gq=Math.pow(2,56),yq=Math.pow(2,63),bq=function(r){return r<lq?1:r<uq?2:r<fq?3:r<hq?4:r<dq?5:r<pq?6:r<mq?7:r<gq?8:r<yq?9:10},wq={encode:nq,decode:aq,encodingLength:bq},Eq=wq,lu=Eq});var uu,yc,bc,yd=$e(()=>{JS();uu=(r,e=0)=>[lu.decode(r,e),lu.decode.bytes],yc=(r,e,t=0)=>(lu.encode(r,e,t),e),bc=r=>lu.encodingLength(r)});var zo,eR,tR,wc,hu=$e(()=>{Ui();yd();zo=(r,e)=>{let t=e.byteLength,n=bc(r),s=n+bc(t),i=new Uint8Array(s+t);return yc(r,i,0),yc(t,i,n),i.set(e,s),new wc(r,t,e,i)},eR=r=>{let e=Ys(r),[t,n]=uu(e),[s,i]=uu(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new wc(t,s,o,e)},tR=(r,e)=>r===e?!0:r.code===e.code&&r.size===e.size&&BS(r.bytes,e.bytes),wc=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}});var D4,A4,C4=$e(()=>{hu();D4=({name:r,code:e,encode:t})=>new A4(r,e,t),A4=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?zo(this.code,t):t.then(n=>zo(this.code,n))}else throw Error("Unknown type, must be binary type")}}});var P4={};Ce(P4,{sha256:()=>xq,sha512:()=>vq});var nR,xq,vq,sR=$e(()=>{C4();nR=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),xq=D4({name:"sha2-256",code:18,encode:nR("SHA-256")}),vq=D4({name:"sha2-512",code:19,encode:nR("SHA-512")})});var k4={};Ce(k4,{identity:()=>Rq});var iR,_q,oR,Sq,Rq,aR=$e(()=>{Ui();hu();iR=0,_q="identity",oR=Ys,Sq=r=>zo(iR,oR(r)),Rq={code:iR,name:_q,encode:oR,digest:Sq}});var cR=$e(()=>{Ui()});var p8e,m8e,lR=$e(()=>{p8e=new TextEncoder,m8e=new TextDecoder});var Ed,Aq,Dq,Cq,du,Pq,uR,fR,bd,wd,kq,Nq,Oq,hR=$e(()=>{yd();hu();S4();x4();Ui();Ed=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this.byteOffset=s.byteOffset,this.byteLength=s.byteLength,this.asCID=this,this._baseCache=new Map,Object.defineProperties(this,{byteOffset:wd,byteLength:wd,code:bd,version:bd,multihash:bd,bytes:bd,_baseCache:wd,asCID:wd})}toV0(){switch(this.version){case 0:return this;default:{let{code:e,multihash:t}=this;if(e!==du)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Pq)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=zo(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}equals(e){return e&&this.code===e.code&&this.version===e.version&&tR(this.multihash,e.multihash)}toString(e){let{bytes:t,version:n,_baseCache:s}=this;switch(n){case 0:return Dq(t,s,e||ys.encoder);default:return Cq(t,s,e||gc.encoder)}}toJSON(){return{code:this.code,version:this.version,hash:this.multihash.bytes}}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID("+this.toString()+")"}static isCID(e){return Nq(/^0\.0/,Oq),!!(e&&(e[fR]||e.asCID===e))}get toBaseEncodedString(){throw new Error("Deprecated, use .toString()")}get codec(){throw new Error('"codec" property is deprecated, use integer "code" property instead')}get buffer(){throw new Error("Deprecated .buffer property, use .bytes to get Uint8Array instead")}get multibaseName(){throw new Error('"multibaseName" property is deprecated')}get prefix(){throw new Error('"prefix" property is deprecated')}static asCID(e){if(e instanceof r)return e;if(e!=null&&e.asCID===e){let{version:t,code:n,multihash:s,bytes:i}=e;return new r(t,n,s,i||uR(t,n,s.bytes))}else if(e!=null&&e[fR]===!0){let{version:t,multihash:n,code:s}=e,i=eR(n);return r.create(t,s,i)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");switch(e){case 0:{if(t!==du)throw new Error(`Version 0 CID must use dag-pb (code: ${du}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=uR(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,du,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=Ys(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=s.subarray(t.multihashSize-t.digestSize),o=new wc(t.multihashCode,t.digestSize,i,s);return[t.version===0?r.createV0(o):r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=uu(e.subarray(t));return t+=h,f},s=n(),i=du;if(s===18?(s=0,t=0):s===1&&(i=n()),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=Aq(e,t),i=r.decode(s);return i._baseCache.set(n,e),i}},Aq=(r,e)=>{switch(r[0]){case"Q":{let t=e||ys;return[ys.prefix,t.decode(`${ys.prefix}${r}`)]}case ys.prefix:{let t=e||ys;return[ys.prefix,t.decode(r)]}case gc.prefix:{let t=e||gc;return[gc.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Dq=(r,e,t)=>{let{prefix:n}=t;if(n!==ys.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Cq=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let i=t.encode(r);return e.set(n,i),i}else return s},du=112,Pq=18,uR=(r,e,t)=>{let n=bc(r),s=n+bc(e),i=new Uint8Array(s+t.byteLength);return yc(r,i,0),yc(e,i,n),i.set(t,s),i},fR=Symbol.for("@ipld/js-cid/CID"),bd={writable:!1,configurable:!1,enumerable:!0},wd={writable:!1,enumerable:!1,configurable:!1},kq="0.0.0-dev",Nq=(r,e)=>{if(r.test(kq))console.warn(e);else throw new Error(e)},Oq=`CID.isCID(v) is deprecated and will be removed in the next major release.
Following code pattern:

if (CID.isCID(value)) {
  doSomethingWithCID(value)
}

Is replaced with:

const cid = CID.asCID(value)
if (cid) {
  // Make sure to use cid instead of value
  doSomethingWithCID(cid)
}
`});var dR=$e(()=>{hR();yd();Ui();C4();hu()});var N4,_8e,pR=$e(()=>{VS();qS();zS();$S();HS();x4();WS();S4();GS();QS();sR();aR();cR();lR();dR();N4={...m4,...g4,...y4,...b4,...w4,...E4,...v4,..._4,...R4,...I4},_8e={...P4,...k4}});function Ec(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var xd=$e(()=>{});function vd(r=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?Ec(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}var O4=$e(()=>{xd()});function gR(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var mR,L4,Lq,_d,B4=$e(()=>{pR();O4();mR=gR("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),L4=gR("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=vd(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),Lq={utf8:mR,"utf-8":mR,hex:N4.base16,latin1:L4,ascii:L4,binary:L4,...N4},_d=Lq});var yR={};Ce(yR,{toString:()=>Bq});function Bq(r,e="utf8"){let t=_d[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var bR=$e(()=>{B4()});var wR={};Ce(wR,{fromString:()=>Mq});function Mq(r,e="utf8"){let t=_d[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?Ec(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}var ER=$e(()=>{B4();xd()});var xR={};Ce(xR,{concat:()=>Uq});function Uq(r,e){e||(e=r.reduce((s,i)=>s+i.length,0));let t=vd(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return Ec(t)}var vR=$e(()=>{O4();xd()});var U4=K((B8e,AR)=>{"use strict";var _R=ES(),xc=PS(),{names:pu}=NS(),{toString:Sd}=(bR(),vu(yR)),{fromString:Fq}=(ER(),vu(wR)),{concat:Kq}=(vR(),vu(xR)),vc={};for(let r in pu){let e=r;vc[pu[e]]=e}Object.freeze(vc);function Vq(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return Sd(r,"base16")}function qq(r){return Fq(r,"base16")}function zq(r){if(!(r instanceof Uint8Array))throw new Error("must be passed a Uint8Array");return Sd(_R.encode("base58btc",r)).slice(1)}function $q(r){let e=r instanceof Uint8Array?Sd(r):r;return _R.decode("z"+e)}function SR(r){if(!(r instanceof Uint8Array))throw new Error("multihash must be a Uint8Array");if(r.length<2)throw new Error("multihash too short. must be > 2 bytes.");let e=xc.decode(r);if(!IR(e))throw new Error(`multihash unknown function code: 0x${e.toString(16)}`);r=r.slice(xc.decode.bytes);let t=xc.decode(r);if(t<0)throw new Error(`multihash invalid length: ${t}`);if(r=r.slice(xc.decode.bytes),r.length!==t)throw new Error(`multihash length inconsistent: 0x${Sd(r,"base16")}`);return{code:e,name:vc[e],length:t,digest:r}}function Hq(r,e,t){if(!r||e===void 0)throw new Error("multihash encode requires at least two args: digest, code");let n=RR(e);if(!(r instanceof Uint8Array))throw new Error("digest should be a Uint8Array");if(t==null&&(t=r.length),t&&r.length!==t)throw new Error("digest length should be equal to specified length.");let s=xc.encode(n),i=xc.encode(t);return Kq([s,i,r],s.length+i.length+r.length)}function RR(r){let e=r;if(typeof r=="string"){if(pu[r]===void 0)throw new Error(`Unrecognized hash function named: ${r}`);e=pu[r]}if(typeof e!="number")throw new Error(`Hash function code should be a number. Got: ${e}`);if(vc[e]===void 0&&!M4(e))throw new Error(`Unrecognized function code: ${e}`);return e}function M4(r){return r>0&&r<16}function IR(r){return!!(M4(r)||vc[r])}function TR(r){SR(r)}function Wq(r){return TR(r),r.subarray(0,2)}AR.exports={names:pu,codes:vc,toHexString:Vq,fromHexString:qq,toB58String:zq,fromB58String:$q,decode:SR,encode:Hq,coerceCode:RR,isAppCode:M4,validate:TR,prefix:Wq,isValidCode:IR}});var $R=K(Dd=>{"use strict";Object.defineProperty(Dd,"__esModule",{value:!0});var $4=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},Ad=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let s=new $4;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};Dd.EventIterator=Ad;Dd.default=Ad});var HR=K(mu=>{"use strict";Object.defineProperty(mu,"__esModule",{value:!0});var H4=$R();mu.EventIterator=H4.EventIterator;function rz(r,e,t){return new H4.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}mu.subscribe=rz;mu.default=H4.EventIterator});var G4=K((bge,ZR)=>{"use strict";var nz=typeof navigator<"u"&&navigator.product==="ReactNative";function sz(){return nz?"http://localhost":self.location?self.location.protocol+"//"+self.location.host:""}var gu=self.URL,jR=sz(),W4=class{constructor(e="",t=jR){this.super=new gu(e,t),this.path=this.pathname+this.search,this.auth=this.username&&this.password?this.username+":"+this.password:null,this.query=this.search&&this.search.startsWith("?")?this.search.slice(1):null}get hash(){return this.super.hash}get host(){return this.super.host}get hostname(){return this.super.hostname}get href(){return this.super.href}get origin(){return this.super.origin}get password(){return this.super.password}get pathname(){return this.super.pathname}get port(){return this.super.port}get protocol(){return this.super.protocol}get search(){return this.super.search}get searchParams(){return this.super.searchParams}get username(){return this.super.username}set hash(e){this.super.hash=e}set host(e){this.super.host=e}set hostname(e){this.super.hostname=e}set href(e){this.super.href=e}set password(e){this.super.password=e}set pathname(e){this.super.pathname=e}set port(e){this.super.port=e}set protocol(e){this.super.protocol=e}set search(e){this.super.search=e}set username(e){this.super.username=e}static createObjectURL(e){return gu.createObjectURL(e)}static revokeObjectURL(e){gu.revokeObjectURL(e)}toJSON(){return this.super.toJSON()}toString(){return this.super.toString()}format(){return this.toString()}};function iz(r){if(typeof r=="string")return new gu(r).toString();if(!(r instanceof gu)){let e=r.username&&r.password?`${r.username}:${r.password}@`:"",t=r.auth?r.auth+"@":"",n=r.port?":"+r.port:"",s=r.protocol?r.protocol+"//":"",i=r.host||"",o=r.hostname||"",a=r.search||(r.query?"?"+r.query:""),c=r.hash||"",l=r.pathname||"",u=r.path||l+a;return`${s}${e||t}${i||o+n}${u}${c}`}}ZR.exports={URLWithLegacySupport:W4,URLSearchParams:self.URLSearchParams,defaultBase:jR,format:iz}});var tI=K((wge,eI)=>{"use strict";var{URLWithLegacySupport:JR,format:oz}=G4();eI.exports=(r,e={},t={},n)=>{let s=e.protocol?e.protocol.replace(":",""):"http";s=(t[s]||n||s)+":";let i;try{i=new JR(r)}catch{i={}}let o=Object.assign({},e,{protocol:s||i.protocol,host:e.host||i.host});return new JR(r,oz(o)).toString()}});var nI=K((Ege,rI)=>{"use strict";var{URLWithLegacySupport:az,format:cz,URLSearchParams:lz,defaultBase:uz}=G4(),fz=tI();rI.exports={URL:az,URLSearchParams:lz,format:cz,relative:fz,defaultBase:uz}});var cI=K((Ige,aI)=>{function pz(){return!!(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Electron")>=0)}aI.exports=pz});var SI=K((b5e,e8)=>{var y5e=function(){typeof e8<"u"&&(e8.exports=m);var r=86400,e=3200,t=146097*e/400,n=r*t,s=1e3*n,i=864e13,o=4294967296,a=1e6,c="000000000",l=Math.trunc||function(_){var D=_-_%1;return D==0&&(_<0||_===0&&1/_!=1/0)?-0:D},u=m.prototype,f=(m.fromDate=function(_){return new m(+_)},m.fromInt64BE=R(0,1,2,3,0,4),m.fromInt64LE=R(3,2,1,0,4,0),m.fromString=function(N){var D,O=new m,N=(N+="").replace(/^\s*[+\-]?\d+/,function(z){var z=+z,te=1970+(z-1970)%400;return O.year=z-te,te}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(U,z,te){return z<0&&(te*=-1),D=6e4*(60*+z+ +te),""}).replace(/\.\d+$/,function(U){return O.nano=+(U+c).substr(1,9),""}).split(/\D+/);if(1<N.length?N[1]--:N[1]=0,O.time=D=Date.UTC.apply(Date,N)-(D||0),isNaN(D))throw new TypeError("Invalid Date");return g(O)},m.fromTimeT=function(_){return w(_,0)},u.year=0,u.time=0,u.nano=0,u.addNano=function(_){return this.nano+=+_||0,this},u.getNano=function(){var _=g(this);return(_.time%1e3*a+ +_.nano+1e9)%1e9},u.getTimeT=function(){var D=g(this),_=Math.floor(D.time/1e3),D=D.year;return D&&(_+=D*t*r/e),_},u.getYear=function(){return this.toDate().getUTCFullYear()+this.year},u.toDate=function(){return y(g(this).time)},u.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},u.toString=function(_){var D=this,O=D.toDate(),N={H:function(){return v(O.getUTCHours())},L:function(){return I(O.getUTCMilliseconds(),3)},M:function(){return v(O.getUTCMinutes())},N:function(){return I(D.getNano(),9)},S:function(){return v(O.getUTCSeconds())},Y:function(){var U=D.getYear();return 999999<U?"+"+U:9999<U?"+"+I(U,6):0<=U?I(U,4):-999999<=U?"-"+I(-U,6):U},a:function(){return d[O.getUTCDay()]},b:function(){return h[O.getUTCMonth()]},d:function(){return v(O.getUTCDate())},e:function(){return function(U){return(9<U?"":" ")+(0|U)}(O.getUTCDate())},m:function(){return v(O.getUTCMonth()+1)}};return function U(z){return z.replace(/%./g,function(te){var L=te[1],P=p[L],L=N[L];return P?U(P):L?L():te})}(_||f)},u.writeInt64BE=E(0,1,2,3,0,4),u.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),h=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return m;function m(_,D,O){var N=this;if(!(N instanceof m))return new m(_,D,O);N.time=+_||0,N.nano=+D||0,N.year=+O||0,g(N)}function g(_){var D,O,N,U=_.year,z=_.time,te=_.nano,P=((te<0||a<=te)&&(te-=(O=Math.floor(te/a))*a,z+=O,O=1),U%e);return(z<-i||i<z||P)&&((D=l(z/s))&&(U+=D*e,z-=D*s),(N=y(z)).setUTCFullYear(P+N.getUTCFullYear()),N=(z=+N)+(D=l((U-=P)/e))*s,D&&-i<=N&&N<=i&&(U-=D*e,z=N),O=1),O&&(_.year=U,_.time=z,_.nano=te),_}function y(_){var D=new Date(0);return D.setTime(_),D}function w(U,N){U=+U||0;var O=l((N=(N|0)*o)/n)+l(U/n),N=N%n+U%n,U=l(N/n);return U&&(O+=U,N-=U*n),new m(1e3*N,0,O*e)}function E(_,D,O,N,U,z){return function(P,L){var F=g(this);P=P||new Array(8),x(P,L|=0);var T=Math.floor(F.time/1e3),F=F.year*(t*r/e),B=l(F/o)+l(T/o),F=F%o+T%o,T=Math.floor(F/o);return T&&(B+=T,F-=T*o),te(P,L+U,B),te(P,L+z,F),P};function te(P,L,B){P[L+_]=B>>24&255,P[L+D]=B>>16&255,P[L+O]=B>>8&255,P[L+N]=255&B}}function R(_,D,O,N,U,z){return function(P,L){x(P,L|=0);var B=te(P,L+U);return w(te(P,L+z),B)};function te(P,L){return 16777216*P[L+_]+(P[L+D]<<16|P[L+O]<<8|P[L+N])}}function x(_,D){if(_=_&&_.length,_==null)throw new TypeError("Invalid Buffer");if(_<D+8)throw new RangeError("Out of range")}function v(_){return(9<_?"":"0")+(0|_)}function I(_,D){return(c+(0|_)).substr(-D)}}()});var WI=K((p6e,HI)=>{function _n(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}HI.exports=_n;_n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};_n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};_n.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};_n.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};_n.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};_n.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};_n.prototype.start=_n.prototype.try;_n.prototype.errors=function(){return this._errors};_n.prototype.attempts=function(){return this._attempts};_n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var s=this._errors[n],i=s.message,o=(r[i]||0)+1;r[i]=o,o>=t&&(e=s,t=o)}return e}});var GI=K($o=>{var Oz=WI();$o.operation=function(r){var e=$o.timeouts(r);return new Oz(e,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})};$o.timeouts=function(r){if(r instanceof Array)return[].concat(r);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in r)e[t]=r[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],s=0;s<e.retries;s++)n.push(this.createTimeout(s,e));return r&&r.forever&&!n.length&&n.push(this.createTimeout(s,e)),n.sort(function(i,o){return i-o}),n};$o.createTimeout=function(r,e){var t=e.randomize?Math.random()+1:1,n=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,r));return n=Math.min(n,e.maxTimeout),n};$o.wrap=function(r,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var n in r)typeof r[n]=="function"&&t.push(n)}for(var s=0;s<t.length;s++){var i=t[s],o=r[i];r[i]=function(c){var l=$o.operation(e),u=Array.prototype.slice.call(arguments,1),f=u.pop();u.push(function(h){l.retry(h)||(h&&(arguments[0]=l.mainError()),f.apply(this,arguments))}),l.attempt(function(){c.apply(r,u)})}.bind(r,o),r[i].options=e}}});var QI=K((g6e,YI)=>{YI.exports=GI()});var t$={};Ce(t$,{createHelia:()=>Zz});var Ur=re($d(),1);var Qd={};Ce(Qd,{base32:()=>Ot,base32hex:()=>ZT,base32hexpad:()=>eA,base32hexpadupper:()=>tA,base32hexupper:()=>JT,base32pad:()=>XT,base32padupper:()=>jT,base32upper:()=>QT,base32z:()=>rA});function $T(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function f(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var m=0,g=0,y=0,w=p.length;y!==w&&p[y]===0;)y++,m++;for(var E=(w-y)*u+1>>>0,R=new Uint8Array(E);y!==w;){for(var x=p[y],v=0,I=E-1;(x!==0||v<g)&&I!==-1;I--,v++)x+=256*R[I]>>>0,R[I]=x%a>>>0,x=x/a>>>0;if(x!==0)throw new Error("Non-zero carry");g=v,y++}for(var _=E-g;_!==E&&R[_]===0;)_++;for(var D=c.repeat(m);_<E;++_)D+=r.charAt(R[_]);return D}function h(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var m=0;if(p[m]!==" "){for(var g=0,y=0;p[m]===c;)g++,m++;for(var w=(p.length-m)*l+1>>>0,E=new Uint8Array(w);p[m];){var R=t[p.charCodeAt(m)];if(R===255)return;for(var x=0,v=w-1;(R!==0||x<y)&&v!==-1;v--,x++)R+=a*E[v]>>>0,E[v]=R%256>>>0,R=R/256>>>0;if(R!==0)throw new Error("Non-zero carry");y=x,m++}if(p[m]!==" "){for(var I=w-y;I!==w&&E[I]===0;)I++;for(var _=new Uint8Array(g+(w-I)),D=g;I!==w;)_[D++]=E[I++];return _}}}function d(p){var m=h(p);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:f,decodeUnsafe:h,decode:d}}var HT=$T,WT=HT,O8=WT;var o$=new Uint8Array(0);var L8=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},ws=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var B8=r=>new TextEncoder().encode(r),M8=r=>new TextDecoder().decode(r);var Hd=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Wd=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return F8(this,e)}},Gd=class{constructor(e){this.decoders=e}or(e){return F8(this,e)}decode(e){let t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},F8=(r,e)=>new Gd({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}}),Yd=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Hd(e,t,n),this.decoder=new Wd(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Yo=({name:r,prefix:e,encode:t,decode:n})=>new Yd(r,e,t,n),Zs=({prefix:r,name:e,alphabet:t})=>{let{encode:n,decode:s}=O8(t,e);return Yo({prefix:r,name:e,encode:n,decode:i=>ws(s(i))})},GT=(r,e,t,n)=>{let s={};for(let u=0;u<e.length;++u)s[e[u]]=u;let i=r.length;for(;r[i-1]==="=";)--i;let o=new Uint8Array(i*t/8|0),a=0,c=0,l=0;for(let u=0;u<i;++u){let f=s[r[u]];if(f===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},YT=(r,e,t)=>{let n=e[e.length-1]==="=",s=(1<<t)-1,i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},bt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Yo({prefix:e,name:r,encode(s){return YT(s,n,t)},decode(s){return GT(s,n,t,r)}});var Ot=bt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),QT=bt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),XT=bt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),jT=bt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ZT=bt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),JT=bt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),eA=bt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),tA=bt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),rA=bt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Xd={};Ce(Xd,{base58btc:()=>be,base58flickr:()=>nA});var be=Zs({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),nA=Zs({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Zd={};Ce(Zd,{base64:()=>Zn,base64pad:()=>sA,base64url:()=>jd,base64urlpad:()=>iA});var Zn=bt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),sA=bt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),jd=bt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),iA=bt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});Ur.default.formatters.b=r=>r==null?"undefined":be.baseEncode(r);Ur.default.formatters.t=r=>r==null?"undefined":Ot.baseEncode(r);Ur.default.formatters.m=r=>r==null?"undefined":Zn.baseEncode(r);Ur.default.formatters.p=r=>r==null?"undefined":r.toString();Ur.default.formatters.c=r=>r==null?"undefined":r.toString();Ur.default.formatters.k=r=>r==null?"undefined":r.toString();Ur.default.formatters.a=r=>r==null?"undefined":r.toString();function oA(r){let e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function k(r){let e=oA(`${r}:trace`);return Ur.default.enabled(`${r}:trace`)&&Ur.default.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=(0,Ur.default)(`${r}:trace`)),Object.assign((0,Ur.default)(r),{error:(0,Ur.default)(`${r}:error`),trace:e})}var Xo={};Ce(Xo,{abortedError:()=>hA,closeFailedError:()=>lA,deleteFailedError:()=>z8,getFailedError:()=>uA,hasFailedError:()=>fA,notFoundError:()=>Tc,openFailedError:()=>cA,putFailedError:()=>q8});var Es=re(Qo(),1);function cA(r){return r=r??new Error("Open failed"),(0,Es.default)(r,"ERR_OPEN_FAILED")}function lA(r){return r=r??new Error("Close failed"),(0,Es.default)(r,"ERR_CLOSE_FAILED")}function q8(r){return r=r??new Error("Put failed"),(0,Es.default)(r,"ERR_PUT_FAILED")}function uA(r){return r=r??new Error("Get failed"),(0,Es.default)(r,"ERR_GET_FAILED")}function z8(r){return r=r??new Error("Delete failed"),(0,Es.default)(r,"ERR_DELETE_FAILED")}function fA(r){return r=r??new Error("Has failed"),(0,Es.default)(r,"ERR_HAS_FAILED")}function Tc(r){return r=r??new Error("Not Found"),(0,Es.default)(r,"ERR_NOT_FOUND")}function hA(r){return r=r??new Error("Aborted"),(0,Es.default)(r,"ERR_ABORTED")}var Wi=class{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(let{cid:n,block:s}of e)await this.put(n,s,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(let n of e)yield{cid:n,block:await this.get(n,t)}}async delete(e,t){await Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(let n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}};var Rn={};Ce(Rn,{Digest:()=>Gi,create:()=>Sn,decode:()=>Jn,equals:()=>e1});var dA=W8,$8=128,pA=127,mA=~pA,gA=Math.pow(2,31);function W8(r,e,t){e=e||[],t=t||0;for(var n=t;r>=gA;)e[t++]=r&255|$8,r/=128;for(;r&mA;)e[t++]=r&255|$8,r>>>=7;return e[t]=r|0,W8.bytes=t-n+1,e}var yA=Jd,bA=128,H8=127;function Jd(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Jd.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&H8)<<s:(o&H8)*Math.pow(2,s),s+=7}while(o>=bA);return Jd.bytes=i-n,t}var wA=Math.pow(2,7),EA=Math.pow(2,14),xA=Math.pow(2,21),vA=Math.pow(2,28),_A=Math.pow(2,35),SA=Math.pow(2,42),RA=Math.pow(2,49),IA=Math.pow(2,56),TA=Math.pow(2,63),AA=function(r){return r<wA?1:r<EA?2:r<xA?3:r<vA?4:r<_A?5:r<SA?6:r<RA?7:r<IA?8:r<TA?9:10},DA={encode:dA,decode:yA,encodingLength:AA},CA=DA,Ac=CA;var Dc=(r,e=0)=>[Ac.decode(r,e),Ac.decode.bytes],jo=(r,e,t=0)=>(Ac.encode(r,e,t),e),Zo=r=>Ac.encodingLength(r);var Sn=(r,e)=>{let t=e.byteLength,n=Zo(r),s=n+Zo(t),i=new Uint8Array(s+t);return jo(r,i,0),jo(t,i,n),i.set(e,s),new Gi(r,t,e,i)},Jn=r=>{let e=ws(r),[t,n]=Dc(e),[s,i]=Dc(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Gi(t,s,o,e)},e1=(r,e)=>{if(r===e)return!0;{let t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&L8(r.bytes,t.bytes)}},Gi=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};var G8=(r,e)=>{let{bytes:t,version:n}=r;switch(n){case 0:return kA(t,t1(r),e||be.encoder);default:return NA(t,t1(r),e||Ot.encoder)}};var Y8=new WeakMap,t1=r=>{let e=Y8.get(r);if(e==null){let t=new Map;return Y8.set(r,t),t}return e},ge=class r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:e,multihash:t}=this;if(e!==Cc)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==OA)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:e,digest:t}=this.multihash,n=Sn(e,t);return r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return r.equals(this,e)}static equals(e,t){let n=t;return n&&e.code===n.code&&e.version===n.version&&e1(e.multihash,n.multihash)}toString(e){return G8(this,e)}toJSON(){return{"/":G8(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;let t=e;if(t instanceof r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){let{version:n,code:s,multihash:i,bytes:o}=t;return new r(n,s,i,o||Q8(n,s,i.bytes))}else if(t[LA]===!0){let{version:n,multihash:s,code:i}=t,o=Jn(s);return r.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Cc)throw new Error(`Version 0 CID must use dag-pb (code: ${Cc}) block encoding`);return new r(e,t,n,n.bytes)}case 1:{let s=Q8(e,t,n.bytes);return new r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return r.create(0,Cc,e)}static createV1(e,t){return r.create(1,e,t)}static decode(e){let[t,n]=r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){let t=r.inspectBytes(e),n=t.size-t.multihashSize,s=ws(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");let i=s.subarray(t.multihashSize-t.digestSize),o=new Gi(t.multihashCode,t.digestSize,i,s);return[t.version===0?r.createV0(o):r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0,n=()=>{let[f,h]=Dc(e.subarray(t));return t+=h,f},s=n(),i=Cc;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);let o=t,a=n(),c=n(),l=t+c,u=l-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:u,size:l}}static parse(e,t){let[n,s]=PA(e,t),i=r.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return t1(i).set(n,e),i}},PA=(r,e)=>{switch(r[0]){case"Q":{let t=e||be;return[be.prefix,t.decode(`${be.prefix}${r}`)]}case be.prefix:{let t=e||be;return[be.prefix,t.decode(r)]}case Ot.prefix:{let t=e||Ot;return[Ot.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},kA=(r,e,t)=>{let{prefix:n}=t;if(n!==be.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);let s=e.get(n);if(s==null){let i=t.encode(r).slice(1);return e.set(n,i),i}else return s},NA=(r,e,t)=>{let{prefix:n}=t,s=e.get(n);if(s==null){let i=t.encode(r);return e.set(n,i),i}else return s},Cc=112,OA=18,Q8=(r,e,t)=>{let n=Zo(r),s=n+Zo(e),i=new Uint8Array(s+t.byteLength);return jo(r,i,0),jo(e,i,n),i.set(t,s),i},LA=Symbol.for("@ipld/js-cid/CID");var Iu=85;var Pc=class extends Wi{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(Ot.encode(e.multihash.bytes),t),e}get(e){let t=this.data.get(Ot.encode(e.multihash.bytes));if(t==null)throw Tc();return t}has(e){return this.data.has(Ot.encode(e.multihash.bytes))}async delete(e){this.data.delete(Ot.encode(e.multihash.bytes))}async*getAll(){for(let[e,t]of this.data.entries())yield{cid:ge.createV1(Iu,Jn(Ot.decode(e))),block:t}}};function BA(r){return r[Symbol.asyncIterator]!=null}function MA(r){if(BA(r))return(async()=>{for await(let e of r);})();for(let e of r);}var Tr=MA;function UA(r){let[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}var Jo=UA;function FA(r){return r[Symbol.asyncIterator]!=null}function KA(r,e){if(FA(r))return async function*(){for await(let a of r)await e(a)&&(yield a)}();let t=Jo(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();let i=e(n);if(typeof i.then=="function")return async function*(){await i&&(yield n);for await(let a of t)await e(a)&&(yield a)}();let o=e;return function*(){i===!0&&(yield n);for(let a of t)o(a)&&(yield a)}()}var mr=KA;function De(){let r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}var Tu=class{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){let e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},ea=class{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Tu(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){let t=this.head;this.head=t.next=new Tu(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){let t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}};var n1=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function wt(r={}){return j8(t=>{let n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function X8(r={}){return j8(t=>{let n,s=[];for(;!t.isEmpty()&&(n=t.shift(),n!=null);){if(n.error!=null)throw n.error;n.done===!1&&s.push(n.value)}return n==null?{done:!0}:{done:n.done===!0,value:s}},r)}function j8(r,e){e=e??{};let t=e.onEnd,n=new ea,s,i,o,a=De(),c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((g,y)=>{i=w=>{i=null,n.push(w);try{g(r(n))}catch(E){y(E)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=De()})}},l=g=>i!=null?i(g):(n.push(g),s),u=g=>(n=new ea,i!=null?i({error:g}):(n.push({error:g}),s)),f=g=>{if(o)return s;if(e?.objectMode!==!0&&g?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:g})},h=g=>o?s:(o=!0,g!=null?u(g):l({done:!0})),d=()=>(n=new ea,h(),{done:!0}),p=g=>(h(g),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:d,throw:p,push:f,end:h,get readableLength(){return n.size},onEmpty:async g=>{let y=g?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let w,E;y!=null&&(w=new Promise((R,x)=>{E=()=>{x(new n1)},y.addEventListener("abort",E)}));try{await Promise.race([a.promise,w])}finally{E!=null&&y!=null&&y?.removeEventListener("abort",E)}}},t==null)return s;let m=s;return s={[Symbol.asyncIterator](){return this},next(){return m.next()},throw(g){return m.throw(g),t!=null&&(t(g),t=void 0),{done:!0}},return(){return m.return(),t!=null&&(t(),t=void 0),{done:!0}},push:f,end(g){return m.end(g),t!=null&&(t(g),t=void 0),s},get readableLength(){return m.readableLength}},s}function VA(r){return r[Symbol.asyncIterator]!=null}function qA(...r){let e=[];for(let t of r)VA(t)||e.push(t);return e.length===r.length?function*(){for(let t of e)yield*t}():async function*(){let t=wt({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(let s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}var Lt=qA;var j$=k("blockstore:core:tiered");var tH={...Xo};var Z8=re(Qo(),1);function Au(r){return r=r??new Error("Not Found"),(0,Z8.default)(r,"ERR_NOT_FOUND")}var J8=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function xs(r){return globalThis.Buffer!=null?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r}var s1={};Ce(s1,{base10:()=>zA});var zA=Zs({prefix:"9",name:"base10",alphabet:"0123456789"});var i1={};Ce(i1,{base16:()=>$A,base16upper:()=>HA});var $A=bt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),HA=bt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var o1={};Ce(o1,{base2:()=>WA});var WA=bt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var a1={};Ce(a1,{base256emoji:()=>jA});var eg=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),GA=eg.reduce((r,e,t)=>(r[t]=e,r),[]),YA=eg.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function QA(r){return r.reduce((e,t)=>(e+=GA[t],e),"")}function XA(r){let e=[];for(let t of r){let n=YA[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}var jA=Yo({prefix:"\u{1F680}",name:"base256emoji",encode:QA,decode:XA});var c1={};Ce(c1,{base36:()=>Js,base36upper:()=>ZA});var Js=Zs({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),ZA=Zs({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var l1={};Ce(l1,{base8:()=>JA});var JA=bt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var u1={};Ce(u1,{identity:()=>eD});var eD=Yo({prefix:"\0",name:"identity",encode:r=>M8(r),decode:r=>B8(r)});var yH=new TextEncoder,bH=new TextDecoder;var tg=512;var f1={};Ce(f1,{identity:()=>es});var ng=0,tD="identity",sg=ws,rD=r=>Sn(ng,sg(r)),es={code:ng,name:tD,encode:sg,digest:rD};var m1={};Ce(m1,{sha256:()=>Ne,sha512:()=>p1});var d1=({name:r,code:e,encode:t})=>new h1(r,e,t),h1=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Sn(this.code,t):t.then(n=>Sn(this.code,n))}else throw Error("Unknown type, must be binary type")}};var og=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Ne=d1({name:"sha2-256",code:18,encode:og("SHA-256")}),p1=d1({name:"sha2-512",code:19,encode:og("SHA-512")});var on={...u1,...o1,...l1,...s1,...i1,...Qd,...c1,...Xd,...Zd,...a1},RH={...m1,...f1};function vs(r=0){return globalThis.Buffer?.alloc!=null?xs(globalThis.Buffer.alloc(r)):new Uint8Array(r)}function Fr(r=0){return globalThis.Buffer?.allocUnsafe!=null?xs(globalThis.Buffer.allocUnsafe(r)):new Uint8Array(r)}function cg(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}var ag=cg("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),g1=cg("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);let e=Fr(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),nD={utf8:ag,"utf-8":ag,hex:on.base16,latin1:g1,ascii:g1,binary:g1,...on},Du=nD;function Q(r,e="utf8"){let t=Du[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?xs(globalThis.Buffer.from(r,"utf-8")):t.decoder.decode(`${t.prefix}${r}`)}function W(r,e="utf8"){let t=Du[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(r.buffer,r.byteOffset,r.byteLength).toString("utf8"):t.encoder.encode(r).substring(1)}var _s="/",lg=new TextEncoder().encode(_s),Cu=lg[0],rt=class r{_buf;constructor(e,t){if(typeof e=="string")this._buf=Q(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Cu)throw new Error("Invalid key")}toString(e="utf8"){return W(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new r(e.join(_s))}static random(){return new r(J8().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new r(e):typeof e.uint8Array=="function"?new r(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=lg),this._buf[0]!==Cu){let e=new Uint8Array(this._buf.byteLength+1);e.fill(Cu,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Cu;)this._buf=this._buf.subarray(0,-1)}less(e){let t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;let i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return r.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){let e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(_s).slice(1)}type(){return sD(this.baseNamespace())}name(){return iD(this.baseNamespace())}instance(e){return new r(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(_s)||(e+=_s),e+=this.type(),new r(e)}parent(){let e=this.list();return e.length===1?new r(_s):new r(e.slice(0,-1).join(_s))}child(e){return this.toString()===_s?e:e.toString()===_s?this:new r(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return r.withNamespaces([...this.namespaces(),...oD(e.map(t=>t.namespaces()))])}};function sD(r){let e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function iD(r){let e=r.split(":");return e[e.length-1]}function oD(r){return[].concat(...r)}var ug="SHARDING";function cD(r){return r[Symbol.asyncIterator]!=null}function lD(r){if(cD(r))return(async()=>{let t=[];for await(let n of r)t.push(n);return t})();let e=[];for(let t of r)e.push(t);return e}var Nc=lD;function uD(r){return r[Symbol.asyncIterator]!=null}function fD(r,e){return uD(r)?async function*(){yield*(await Nc(r)).sort(e)}():function*(){yield*Nc(r).sort(e)}()}var Pu=fD;function hD(r){return r[Symbol.asyncIterator]!=null}function dD(r,e){return hD(r)?async function*(){let t=0;if(!(e<1)){for await(let n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(let n of r)if(yield n,t++,t===e)return}}()}var ei=dD;var Ss=class{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(let{key:n,value:s}of e)await this.put(n,s,t),yield n}async*getMany(e,t={}){for await(let n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(let n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Tr(this.putMany(e,n)),e=[],await Tr(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){let s=e.prefix;n=mr(n,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>mr(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Pu(s,i),n)),e.offset!=null){let s=0,i=e.offset;n=mr(n,()=>s++>=i)}return e.limit!=null&&(n=ei(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){let s=e.prefix;n=mr(n,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>mr(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>Pu(s,i),n)),e.offset!=null){let s=e.offset,i=0;n=mr(n,()=>i++>=s)}return e.limit!=null&&(n=ei(n,e.limit)),n}};var Yi=class extends Ss{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){let t=this.data.get(e.toString());if(t==null)throw Au();return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(let[e,t]of this.data.entries())yield{key:new rt(e),value:t}}*_allKeys(){for(let e of this.data.keys())yield new rt(e)}};function pD(r){return r[Symbol.asyncIterator]!=null}function mD(r,e){if(pD(r))return async function*(){for await(let a of r)yield e(a)}();let t=Jo(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();let i=e(n);if(typeof i.then=="function")return async function*(){yield await i;for await(let a of t)yield e(a)}();let o=e;return function*(){yield i;for(let a of t)yield o(a)}()}var In=mD;function Ie(r,...e){if(r==null)throw new Error("Empty pipeline");if(y1(r)){let n=r;r=()=>n.source}else if(hg(r)||fg(r)){let n=r;r=()=>n}let t=[r,...e];if(t.length>1&&y1(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)y1(t[n])&&(t[n]=yD(t[n]));return gD(...t)}var gD=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},fg=r=>r?.[Symbol.asyncIterator]!=null,hg=r=>r?.[Symbol.iterator]!=null,y1=r=>r==null?!1:r.sink!=null&&r.source!=null,yD=r=>e=>{let t=r.sink(e);if(t?.then!=null){let n=wt({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s,i=r.source;if(fg(i))s=async function*(){yield*i,n.end()};else if(hg(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Lt(n,s())}return r.source};var yW=new rt(ug);var DW=k("datastore:core:tiered");function gr(r){let e=new globalThis.AbortController;function t(){e.abort();for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(let i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(let i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}let s=e.signal;return s.clear=n,s}function ED(r){return r[Symbol.asyncIterator]!=null}function xD(r,e){if(ED(r))return async function*(){for await(let a of r)await e(a),yield a}();let t=Jo(r),{value:n,done:s}=t.next();if(s===!0)return function*(){}();if(typeof e(n)?.then=="function")return async function*(){yield n;for await(let a of t)await e(a),yield a}();let o=e;return function*(){yield n;for(let a of t)o(a),yield a}()}var Qi=xD;var b1=class extends Map{metric;constructor(e){super();let{name:t,metrics:n}=e;this.metric=n.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){let t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};function ts(r){let{name:e,metrics:t}=r,n;return t!=null?n=new b1({name:e,metrics:t}):n=new Map,n}var Tn=class r extends Error{code;type;constructor(e="The operation was aborted"){super(e),this.code=r.code,this.type=r.type}static code="ABORT_ERR";static type="aborted"},b=class extends Error{code;props;constructor(e,t,n){super(e),this.code=t,this.name=n?.name??"CodeError",this.props=n??{}}},Oc=class r extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=r.code}static code="ERR_UNEXPECTED_PEER"},Xi=class r extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=r.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"};var T5=re(Tg(),1);function me(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}var ji=class{_refCounter;cid;priority;wantType;constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t??1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(be)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}};var ti=class{entry;cancel;sendDontHave;constructor(e,t,n,s,i){this.entry=new ji(e,t,n),this.cancel=!!s,this.sendDontHave=!!i}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(be)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}};var an=(r,e)=>{let t=["bitswap"];return e!=null&&t.push(e),r!=null&&t.push(`${r.toString().slice(0,8)}`),k(t.join(":"))};var ku=(r,e)=>{if(r.size!==e.size)return!1;for(let[t,n]of r){let s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!me(n,s)||n instanceof ti&&s instanceof ti&&!n.equals(s))return!1}return!0};var Lc=re(Mg(),1);function YD(r){let e=new Uint8Array(r.reduce((n,s)=>n+Lc.default.encodingLength(s),0)),t=0;for(let n of r)e=Lc.encode(n,e,t),t+=Lc.default.encodingLength(n);return e}var Ug=YD;var O1=re(Bu(),1),_5=re(I1(),1),S5=re(Rs(),1),L1=re(Uu(),1),R5=re(N1(),1);function nC(){S5.default._configure(),O1.default._configure(_5.default),L1.default._configure(R5.default)}nC();var I5=["uint64","int64","sint64","fixed64","sfixed64"];function sC(r){for(let e of I5){if(r[e]==null)continue;let t=r[e];r[e]=function(){return BigInt(t.call(this).toString())}}return r}function B1(r){return sC(new O1.default(r))}function iC(r){for(let e of I5){if(r[e]==null)continue;let t=r[e];r[e]=function(n){return t.call(this,n.toString())}}return r}function M1(){return iC(L1.default.create())}function ae(r,e){let t=B1(r instanceof Uint8Array?r:r.subarray());return e.decode(t)}function ce(r,e){let t=M1();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var ra;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(ra||(ra={}));function Fu(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function lt(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}let t=function(i,o){let a=e(i);o.int32(a)},n=function(i){let o=i.int32();return e(o)};return Fu("enum",ra.VARINT,t,n)}function le(r,e){return Fu("message",ra.LENGTH_DELIMITED,r,e)}var Ar;(function(r){let e;(function(a){let c;(function(h){h.Block="Block",h.Have="Have"})(c=a.WantType||(a.WantType={}));let l;(function(h){h[h.Block=0]="Block",h[h.Have=1]="Have"})(l||(l={})),function(h){h.codec=()=>lt(l)}(c=a.WantType||(a.WantType={}));let u;(function(h){let d;h.codec=()=>(d==null&&(d=le((p,m,g={})=>{g.lengthDelimited!==!1&&m.fork(),p.block!=null&&p.block.byteLength>0&&(m.uint32(10),m.bytes(p.block)),p.priority!=null&&p.priority!==0&&(m.uint32(16),m.int32(p.priority)),p.cancel!=null&&p.cancel!==!1&&(m.uint32(24),m.bool(p.cancel)),p.wantType!=null&&l[p.wantType]!==0&&(m.uint32(32),r.Wantlist.WantType.codec().encode(p.wantType,m)),p.sendDontHave!=null&&p.sendDontHave!==!1&&(m.uint32(40),m.bool(p.sendDontHave)),g.lengthDelimited!==!1&&m.ldelim()},(p,m)=>{let g={block:new Uint8Array(0),priority:0,cancel:!1,wantType:c.Block,sendDontHave:!1},y=m==null?p.len:p.pos+m;for(;p.pos<y;){let w=p.uint32();switch(w>>>3){case 1:g.block=p.bytes();break;case 2:g.priority=p.int32();break;case 3:g.cancel=p.bool();break;case 4:g.wantType=r.Wantlist.WantType.codec().decode(p);break;case 5:g.sendDontHave=p.bool();break;default:p.skipType(w&7);break}}return g})),d),h.encode=p=>ce(p,h.codec()),h.decode=p=>ae(p,h.codec())})(u=a.Entry||(a.Entry={}));let f;a.codec=()=>(f==null&&(f=le((h,d,p={})=>{if(p.lengthDelimited!==!1&&d.fork(),h.entries!=null)for(let m of h.entries)d.uint32(10),r.Wantlist.Entry.codec().encode(m,d);h.full!=null&&h.full!==!1&&(d.uint32(16),d.bool(h.full)),p.lengthDelimited!==!1&&d.ldelim()},(h,d)=>{let p={entries:[],full:!1},m=d==null?h.len:h.pos+d;for(;h.pos<m;){let g=h.uint32();switch(g>>>3){case 1:p.entries.push(r.Wantlist.Entry.codec().decode(h,h.uint32()));break;case 2:p.full=h.bool();break;default:h.skipType(g&7);break}}return p})),f),a.encode=h=>ce(h,a.codec()),a.decode=h=>ae(h,a.codec())})(e=r.Wantlist||(r.Wantlist={}));let t;(function(a){let c;a.codec=()=>(c==null&&(c=le((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.prefix!=null&&l.prefix.byteLength>0&&(u.uint32(10),u.bytes(l.prefix)),l.data!=null&&l.data.byteLength>0&&(u.uint32(18),u.bytes(l.data)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={prefix:new Uint8Array(0),data:new Uint8Array(0)},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.prefix=l.bytes();break;case 2:f.data=l.bytes();break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ce(l,a.codec()),a.decode=l=>ae(l,a.codec())})(t=r.Block||(r.Block={}));let n;(function(a){a.Have="Have",a.DontHave="DontHave"})(n=r.BlockPresenceType||(r.BlockPresenceType={}));let s;(function(a){a[a.Have=0]="Have",a[a.DontHave=1]="DontHave"})(s||(s={})),function(a){a.codec=()=>lt(s)}(n=r.BlockPresenceType||(r.BlockPresenceType={}));let i;(function(a){let c;a.codec=()=>(c==null&&(c=le((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.cid!=null&&l.cid.byteLength>0&&(u.uint32(10),u.bytes(l.cid)),l.type!=null&&s[l.type]!==0&&(u.uint32(16),r.BlockPresenceType.codec().encode(l.type,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={cid:new Uint8Array(0),type:n.Have},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.cid=l.bytes();break;case 2:f.type=r.BlockPresenceType.codec().decode(l);break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ce(l,a.codec()),a.decode=l=>ae(l,a.codec())})(i=r.BlockPresence||(r.BlockPresence={}));let o;r.codec=()=>(o==null&&(o=le((a,c,l={})=>{if(l.lengthDelimited!==!1&&c.fork(),a.wantlist!=null&&(c.uint32(10),r.Wantlist.codec().encode(a.wantlist,c)),a.blocks!=null)for(let u of a.blocks)c.uint32(18),c.bytes(u);if(a.payload!=null)for(let u of a.payload)c.uint32(26),r.Block.codec().encode(u,c);if(a.blockPresences!=null)for(let u of a.blockPresences)c.uint32(34),r.BlockPresence.codec().encode(u,c);a.pendingBytes!=null&&a.pendingBytes!==0&&(c.uint32(40),c.int32(a.pendingBytes)),l.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let l={blocks:[],payload:[],blockPresences:[],pendingBytes:0},u=c==null?a.len:a.pos+c;for(;a.pos<u;){let f=a.uint32();switch(f>>>3){case 1:l.wantlist=r.Wantlist.codec().decode(a,a.uint32());break;case 2:l.blocks.push(a.bytes());break;case 3:l.payload.push(r.Block.codec().decode(a,a.uint32()));break;case 4:l.blockPresences.push(r.BlockPresence.codec().decode(a,a.uint32()));break;case 5:l.pendingBytes=a.int32();break;default:a.skipType(f&7);break}}return l})),o),r.encode=a=>ce(a,r.codec()),r.decode=a=>ae(a,r.codec())})(Ar||(Ar={}));var ir=class r{static Entry=ti;static WantType={Block:Ar.Wantlist.WantType.Block,Have:Ar.Wantlist.WantType.Have};static BlockPresenceType={Have:Ar.BlockPresenceType.Have,DontHave:Ar.BlockPresenceType.DontHave};static deserialize=async(e,t)=>{let n=Ar.decode(e),s=n.wantlist?.full===!0,i=new r(s);return n.wantlist?.entries.forEach(o=>{if(o.block==null)return;let a=ge.decode(o.block);i.addEntry(a,o.priority??0,o.wantType,!!o.cancel,!!o.sendDontHave)}),n.blockPresences.forEach(o=>{if(o.cid==null)return;let a=ge.decode(o.cid);o.type===r.BlockPresenceType.Have?i.addHave(a):i.addDontHave(a)}),n.blocks.length>0?(await Promise.all(n.blocks.map(async o=>{let a=await Ne.digest(o),c=ge.createV0(a);i.addBlock(c,o)})),i):(n.payload.length>0&&(await Promise.all(n.payload.map(async o=>{if(o.prefix==null||o.data==null)return;let a=(0,T5.default)(o.prefix),c=a[0],l=a[1],u=a[2],f=u===Ne.code?Ne:await t?.getHasher(u);if(f==null)throw new b("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");let h=await f.digest(o.data),d=ge.create(c,l,h);i.addBlock(d,o.data)})),i.setPendingBytes(n.pendingBytes)),i)};static blockPresenceSize=e=>e.bytes.length+1;full;wantlist;blocks;blockPresences;pendingBytes;constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,i){n==null&&(n=r.WantType.Block);let o=e.toString(be),a=this.wantlist.get(o);a!=null?(a.wantType===n&&(a.priority=t),s===!0&&(a.cancel=!!s),i===!0&&(a.sendDontHave=!!i),n===r.WantType.Block&&a.wantType===r.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new ti(e,t,n,s,i))}addBlock(e,t){let n=e.toString(be);this.blocks.set(n,t)}addHave(e){let t=e.toString(be);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.Have)}addDontHave(e){let t=e.toString(be);this.blockPresences.has(t)||this.blockPresences.set(t,r.BlockPresenceType.DontHave)}cancel(e){let t=e.toString(be);this.wantlist.delete(t),this.addEntry(e,0,r.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){return Ar.encode({wantlist:{entries:Array.from(this.wantlist.values()).map(e=>({block:e.cid.bytes,priority:Number(e.priority),cancel:!!e.cancel,wantType:Ar.Wantlist.WantType.Block,sendDontHave:!1})),full:!!this.full},blocks:Array.from(this.blocks.values())})}serializeToBitswap110(){let e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:!!t.cancel,sendDontHave:!!t.sendDontHave})),full:!!this.full},blockPresences:[],payload:[],pendingBytes:this.pendingBytes,blocks:[]};for(let[t,n]of this.blocks.entries()){let s=ge.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,l=Ug([i,o,a,c]);e.payload.push({prefix:l,data:n})}for(let[t,n]of this.blockPresences)e.blockPresences.push({cid:ge.parse(t).bytes,type:n});return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),Ar.encode(e)}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!ku(this.wantlist,e.wantlist)||!ku(this.blocks,e.blocks)||!ku(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){let e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}};var A5={Block:Ar.Wantlist.WantType.Block,Have:Ar.Wantlist.WantType.Have},oC=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{let s=r(t),i=r(n);return s<i?-1:s>i?1:0}),si=class{static Entry=ji;set;_stats;constructor(e,t){this.set=t!=null?ts({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){let s=e.toString(be),i=this.set.get(s);i!=null?(i.inc(),i.priority=t,i.wantType===A5.Have&&n===A5.Block&&(i.wantType=n)):(this.set.set(s,new ji(e,t,n)),this._stats!=null&&this._stats.push(void 0,"wantListSize",1))}remove(e){let t=e.toString(be),n=this.set.get(t);n!=null&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats!=null&&this._stats.push(void 0,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(oC(e=>e[1].key,Array.from(this.set.entries())))}contains(e){let t=e.toString(be);return this.set.has(t)}get(e){let t=e.toString(be);return this.set.get(t)}};var Ku=class{partner;wantlist;exchangeCount;accounting;lastExchange;constructor(e){this.partner=e,this.wantlist=new si,this.exchangeCount=0,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}};var Uc=class extends Map{_cmp;_keys;constructor(e,t){super(),this._cmp=t??this._defaultSort,this._keys=[];for(let[n,s]of e??[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;let t=this._keys[e];this._keys.splice(e,1);let n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){let s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);let n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;let t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;let t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){let s=t+n>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)n=s;else return s}return t}*keys(){for(let e of this._keys)yield e}*values(){for(let e of this._keys)yield this.get(e)}*entries(){for(let e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t=this){if(e!=null)for(let n of this._keys){let s=this.get(n);if(s==null)throw new Error("Value cannot be undefined");e.apply(t,[[n,s]])}}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}};var aC={hasNewInfo(){return!1},merge(){}},Vu=class{_taskMerger;_byPeer;constructor(e=aC){this._taskMerger=e,this._byPeer=new Uc([],qu.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n==null&&(n=new qu(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){let t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};let{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};let i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(let[,e]of this._byPeer)return e}remove(e,t){this._byPeer.get(t.toString())?.remove(e)}tasksDone(e,t){let n=this._byPeer.get(e.toString());if(n==null)return;let s=this._byPeer.indexOf(e.toString());for(let i of t)n.taskDone(i);this._byPeer.update(s)}},qu=class{peerId;_taskMerger;_activeTotalSize;_pending;_active;constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new U1,this._active=new Set}pushTasks(e){for(let t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;let t=this._pending.get(e.topic);if(t!=null){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){let t=[];for(let n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0,n=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){let o=s[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}},U1=class{_tasks;constructor(){this._tasks=new Uc([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return this._tasks?.get(e)?.task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){let n=this._tasks.get(e);if(n==null)return;let s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}};var D5={hasNewInfo(r,e){let t=!1,n=!1;for(let s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){let t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}};var C5=ir.WantType,cC=16*1024,lC=1024,zu=class{_log;blockstore;network;_stats;_opts;ledgerMap;_running;_requestQueue;constructor(e,t,n,s,i,o={}){this._log=an(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=ts({name:"ipfs_bitswap_ledger_map",metrics:i.metrics}),this._running=!1,this._requestQueue=new Vu(D5)}_processOpts(e){return{maxSizeReplaceHasWithBlock:lC,targetMessageSize:cC,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks().catch(e=>{this._log.error("error processing stats",e)})})}async _processTasks(){if(!this._running)return;let{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;let s=new ir(!1);s.setPendingBytes(n);let i=[],o=new Map;for(let c of t){let l=ge.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(l),o.set(c.topic,c.data)):s.addHave(l):s.addDontHave(l)}let a=await this._getBlocks(i);for(let[c,l]of o){let u=ge.parse(c),f=a.get(c);f!=null?s.addBlock(u,f):l.sendDontHave&&s.addDontHave(u)}if(s.empty){e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e!=null&&await this.network.sendMessage(e,s);for(let[c,l]of a.entries())e!=null&&this.messageSent(e,ge.parse(c),l)}catch(c){this._log.error(c)}e!=null&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);return n!=null?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length!==0){for(let t of this.ledgerMap.values())for(let{cid:n,block:s}of e){let i=t.wantlistContains(n);if(i==null)continue;let o=s.length,a=this._sendAsBlock(i.wantType,o),c=o;a||(c=ir.blockPresenceSize(i.cid)),this._requestQueue.pushTasks(t.partner,[{topic:i.cid.toString(be),priority:i.priority,size:c,data:{blockSize:o,isWantBlock:a,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){let n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new si),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}let s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),s.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(let n of t)this._requestQueue.remove(n.toString(be),e)}async _addWants(e,t){let n=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(let i of t){let o=i.cid.toString(be),a=n.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:ir.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===C5.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{let c=this._sendAsBlock(i.wantType,a),l=a;c||(l=ir.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:l,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===C5.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){let t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){let t=new Map;return await Promise.all(e.map(async n=>{try{let s=await this.blockstore.get(n);t.set(n.toString(be),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(let n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){let s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){let t=e.toString(),n=this.ledgerMap.get(t);if(n!=null)return n;let s=new Ku(e);return this.ledgerMap.set(t,s),this._stats!=null&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}};var uC=Math.pow(2,7),fC=Math.pow(2,14),hC=Math.pow(2,21),F1=Math.pow(2,28),K1=Math.pow(2,35),V1=Math.pow(2,42),q1=Math.pow(2,49),He=128,or=127;function Kt(r){if(r<uC)return 1;if(r<fC)return 2;if(r<hC)return 3;if(r<F1)return 4;if(r<K1)return 5;if(r<V1)return 6;if(r<q1)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function dC(r,e,t=0){switch(Kt(r)){case 8:e[t++]=r&255|He,r/=128;case 7:e[t++]=r&255|He,r/=128;case 6:e[t++]=r&255|He,r/=128;case 5:e[t++]=r&255|He,r/=128;case 4:e[t++]=r&255|He,r>>>=7;case 3:e[t++]=r&255|He,r>>>=7;case 2:e[t++]=r&255|He,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function pC(r,e,t=0){switch(Kt(r)){case 8:e.set(t++,r&255|He),r/=128;case 7:e.set(t++,r&255|He),r/=128;case 6:e.set(t++,r&255|He),r/=128;case 5:e.set(t++,r&255|He),r/=128;case 4:e.set(t++,r&255|He),r>>>=7;case 3:e.set(t++,r&255|He),r>>>=7;case 2:e.set(t++,r&255|He),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function mC(r,e){let t=r[e],n=0;if(n+=t&or,t<He||(t=r[e+1],n+=(t&or)<<7,t<He)||(t=r[e+2],n+=(t&or)<<14,t<He)||(t=r[e+3],n+=(t&or)<<21,t<He)||(t=r[e+4],n+=(t&or)*F1,t<He)||(t=r[e+5],n+=(t&or)*K1,t<He)||(t=r[e+6],n+=(t&or)*V1,t<He)||(t=r[e+7],n+=(t&or)*q1,t<He))return n;throw new RangeError("Could not decode varint")}function gC(r,e){let t=r.get(e),n=0;if(n+=t&or,t<He||(t=r.get(e+1),n+=(t&or)<<7,t<He)||(t=r.get(e+2),n+=(t&or)<<14,t<He)||(t=r.get(e+3),n+=(t&or)<<21,t<He)||(t=r.get(e+4),n+=(t&or)*F1,t<He)||(t=r.get(e+5),n+=(t&or)*K1,t<He)||(t=r.get(e+6),n+=(t&or)*V1,t<He)||(t=r.get(e+7),n+=(t&or)*q1,t<He))return n;throw new RangeError("Could not decode varint")}function Vt(r,e,t=0){return e==null&&(e=Fr(Kt(r))),e instanceof Uint8Array?dC(r,e,t):pC(r,e,t)}function Kr(r,e=0){return r instanceof Uint8Array?mC(r,e):gC(r,e)}function _e(r,e){e==null&&(e=r.reduce((s,i)=>s+i.length,0));let t=Fr(e),n=0;for(let s of r)t.set(s,n),n+=s.length;return xs(t)}var k5=Symbol.for("@achingbrain/uint8arraylist");function P5(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(let n of r){let s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function $u(r){return!!r?.[k5]}var Ee=class r{constructor(...e){Object.defineProperty(this,k5,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(let n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if($u(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(let n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if($u(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){let t=P5(this.bufs,e);return t.buf[t.index]}set(e,t){let n=P5(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if($u(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){let{bufs:n,length:s}=this._subList(e,t);return _e(n,s)}subarray(e,t){let{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:_e(n,s)}sublist(e,t){let{bufs:n,length:s}=this._subList(e,t),i=new r;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};let n=[],s=0;for(let i=0;i<this.bufs.length;i++){let o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;let l=e>=a&&e<c,u=t>a&&t<=c;if(l&&u){if(e===a&&t===c){n.push(o);break}let f=e-a;n.push(o.subarray(f,f+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(u){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!$u(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');let n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;let s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");let i=256,o=new Int32Array(i);for(let f=0;f<i;f++)o[f]=-1;for(let f=0;f<s;f++)o[n[f]]=f;let a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1,u;for(let f=t;f<=c;f+=u){u=0;for(let h=l;h>=0;h--){let d=this.get(f+h);if(n[h]!==d){u=Math.max(1,h-a[d]);break}}if(u===0)return f}return-1}getInt8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){let n=Fr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){let s=vs(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){let s=vs(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){let s=vs(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){let t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){let n=Fr(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){let n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){let s=vs(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){let s=vs(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){let s=vs(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){let n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){let s=vs(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){let n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){let s=vs(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof r)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!me(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){let n=new r;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}};function Hu(r){return r[Symbol.asyncIterator]!=null}var Wu=r=>{let e=Kt(r),t=Fr(e);return Vt(r,t),Wu.bytes=e,t};Wu.bytes=0;function _t(r,e){e=e??{};let t=e.lengthEncoder??Wu;function*n(s){let i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return Hu(r)?async function*(){for await(let s of r)yield*n(s)}():function*(){for(let s of r)yield*n(s)}()}_t.single=(r,e)=>{e=e??{};let t=e.lengthEncoder??Wu;return new Ee(t(r.byteLength),r)};var na=re(Qo(),1);var yC=8,bC=1024*1024*4,eo;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(eo||(eo={}));var z1=r=>{let e=Kr(r);return z1.bytes=Kt(e),e};z1.bytes=0;function Ct(r,e){let t=new Ee,n=eo.LENGTH,s=-1,i=e?.lengthDecoder??z1,o=e?.maxLengthLength??yC,a=e?.maxDataLength??bC;function*c(){for(;t.byteLength>0;){if(n===eo.LENGTH)try{if(s=i(t),s<0)throw(0,na.default)(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>a)throw(0,na.default)(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");let l=i.bytes;t.consume(l),e?.onLength!=null&&e.onLength(s),n=eo.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw(0,na.default)(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(n===eo.DATA){if(t.byteLength<s)break;let l=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(l),yield l,n=eo.LENGTH}}}return Hu(r)?async function*(){for await(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,na.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(let l of r)t.append(l),yield*c();if(t.byteLength>0)throw(0,na.default)(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}Ct.fromReader=(r,e)=>{let t=1,n=async function*(){for(;;)try{let{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Ct(n,{...e??{},onLength:i=>{t=i}})};var Fe=class extends Event{constructor(e,t){super(e),this.detail=t}};var z5=re(F5(),1);var K5=Math.pow(2,31)-1,V5=1e3,q5=1;var G1="/ipfs/bitswap/1.0.0",Y1="/ipfs/bitswap/1.1.0",Q1="/ipfs/bitswap/1.2.0",vC=1024,_C=1024,SC=3e4,Yu=class{_log;_libp2p;_bitswap;_protocols;_stats;_running;_hashLoader;_maxInboundStreams;_maxOutboundStreams;_incomingStreamTimeout;_registrarIds;constructor(e,t,n,s={}){this._log=an(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[G1],s.b100Only!==!0&&(this._protocols.unshift(Y1),this._protocols.unshift(Q1)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader??{async getHasher(){throw new Error("Not implemented")}},this._maxInboundStreams=s.maxInboundStreams??vC,this._maxOutboundStreams=s.maxOutboundStreams??_C,this._incomingStreamTimeout=s.incomingStreamTimeout??SC}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});let e={onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect};this._registrarIds=[];for(let t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(let e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection(e){if(!this._running)return;let{stream:t,connection:n}=e,s=new z5.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",t.protocol,n.remotePeer);let i=()=>{t.abort(new b("Incoming Bitswap stream timed out","ERR_TIMEOUT"))},o=AbortSignal.timeout(this._incomingStreamTimeout);o.addEventListener("abort",i),await Ie(t,a=>Ct(a),async a=>{for await(let c of a){try{let l=await ir.deserialize(c.subarray(),this._hashLoader);await this._bitswap._receiveMessage(n.remotePeer,l)}catch(l){this._bitswap._receiveError(l);break}o.removeEventListener("abort",i),o=AbortSignal.timeout(this._incomingStreamTimeout),o.addEventListener("abort",i)}}),await t.close({signal:o})}).catch(i=>{this._log(i),t.abort(i)}).finally(()=>{s.clear()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return t.onProgress?.(new Fe("bitswap:network:find-providers",e)),this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){await Tr(ei(In(this.findProviders(e,t),async n=>this.connectTo(n.id,t).catch(s=>{this._log.error(s)})),3)).catch(n=>{this._log.error(n)})}async provide(e,t={}){t.onProgress?.(new Fe("bitswap:network:provide",e)),await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t,n={}){if(!this._running)throw new Error("network isn't running");let s=e.toString();this._log("sendMessage to %s",s,t),n.onProgress?.(new Fe("bitswap:network:send-wantlist",e)),await this._writeMessage(e,t,n),this._updateSentStats(e,t.blocks)}async connectTo(e,t={}){if(!this._running)throw new Error("network isn't running");return t.onProgress?.(new Fe("bitswap:network:dial",e)),this._libp2p.dial(e,t)}_updateSentStats(e,t){let n=e.toString();if(this._stats!=null){for(let s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}async _writeMessage(e,t,n={}){let s=await this._libp2p.dialProtocol(e,[Q1,Y1,G1]);try{let i;switch(s.protocol){case G1:i=t.serializeToBitswap100();break;case Y1:case Q1:i=t.serializeToBitswap110();break;default:throw new Error(`Unknown protocol: ${s.protocol}`)}await Ie([i],o=>_t(o),s),await s.close()}catch(i){n.onProgress?.(new Fe("bitswap:network:send-wantlist:error",{peer:e,error:i})),this._log(i),s.abort(i)}}};var r6=re(Dr(),1);var e6=r=>`unwant:${W(r.multihash.bytes,"base64")}`,t6=r=>`block:${W(r.multihash.bytes,"base64")}`,ju=class extends r6.EventEmitter{_log;constructor(e){super(),this.setMaxListeners(V5),this._log=an(e,"notif")}hasBlock(e,t){let n=t6(e);this._log(n),this.emit(n,t)}async wantBlock(e,t={}){if(e==null)throw new Error("Not a valid cid");let n=t6(e),s=e6(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{let a=()=>{this.removeListener(n,c),t.onProgress?.(new Fe("bitswap:want-block:unwant",e)),o(new Error(`Block for ${e} unwanted`))},c=l=>{this.removeListener(s,a),t.onProgress?.(new Fe("bitswap:want-block:block",e)),i(l)};this.once(s,a),this.once(n,c),t.signal?.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){let t=e6(e);this._log(t),this.emit(t)}};var c6=re(Dr(),1);var o6=re(Dr(),1),j1=re(i6(),1),Fc=class extends o6.EventEmitter{_options;_queue;_stats;_frequencyLastTime;_frequencyAccumulators;_movingAverages;_enabled;_timeout;constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=(0,j1.default)(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._enabled=!1}stop(){this._timeout!=null&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout!=null&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){let e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=void 0,this._queue.length>0){let e;for(;this._queue.length>0;){let t=e=this._queue.shift();t!=null&&this._applyOp(t)}e!=null&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){let t=e-this._frequencyLastTime;t>0&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){let s=this._frequencyAccumulators[e]??0;this._frequencyAccumulators[e]=0;let i=s/t*1e3,o=this._movingAverages[e];o==null&&(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c==null&&(c=o[a]=(0,j1.default)(a)),c.push(n,i)})}_applyOp(e){let t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]==null&&(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}};var a6={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]},Zu=class extends c6.EventEmitter{_initialCounters;_options;_enabled;_global;_peers;constructor(e,t=[],n=a6){super();let s=Object.assign({},a6,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new Fc(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=ts({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(let e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){let t=e.toString();return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e!=null)){let s=this._peers.get(e);s==null&&(s=new Fc(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){let t=e.toString(),n=this._peers.get(t);n!=null&&(n.stop(),this._peers.delete(t))}};var l6=kC;function kC(r,e,t){var n=null,s=null,i=function(){n&&(clearTimeout(n),s=null,n=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,l=arguments,u=t&&!n;if(i(),s=function(){r.apply(c,l)},n=setTimeout(function(){if(n=null,!u){var f=s;return s=null,f()}},e),u)return s()};return a.cancel=i,a.flush=o,a}var Ju=class{peerId;refcnt;network;_entries;_log;constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=an(e,"msgqueue"),this.sendEntries=l6(this.sendEntries.bind(this),q5)}addMessage(e,t={}){e.empty||this.send(e,t)}addEntries(e,t={}){this._entries=this._entries.concat(e),this.sendEntries(t)}sendEntries(e={}){if(this._entries.length===0)return;let t=new ir(!1);this._entries.forEach(n=>{n.cancel===!0?t.cancel(n.cid):t.addEntry(n.cid,n.priority)}),this._entries=[],this.addMessage(t,e)}async send(e,t={}){try{await this.network.connectTo(this.peerId,t)}catch(n){this._log.error("cant connect to peer %p: %s",this.peerId,n.message);return}this._log("sending message to peer %p",this.peerId),this.network.sendMessage(this.peerId,e,t).catch(n=>{this._log.error("send error",n)})}};var e0=class{peers;wantlist;network;_peerId;_log;constructor(e,t,n,s){this.peers=ts({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new si(n,s),this.network=t,this._peerId=e,this._log=an(e,"want")}_addEntries(e,t,n,s={}){let i=e.map((o,a)=>new ir.Entry(o,K5-a,ir.WantType.Block,t));i.forEach(o=>{o.cancel?n===!0?this.wantlist.removeForce(o.cid.toString(be)):this.wantlist.remove(o.cid):(this._log("adding to wantlist"),this.wantlist.add(o.cid,o.priority))});for(let o of this.peers.values())o.addEntries(i,s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t!=null){t.refcnt++;return}t=new Ju(this._peerId,e,this.network);let n=new ir(!0);for(let s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){let t=this.peers.get(e.toString());t!=null&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1,!1,t),t.signal?.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>{this.disconnected(e.peerId)})}};var NC={async getHasher(){throw new Error("Not implemented")}},OC={maxInboundStreams:1024,maxOutboundStreams:1024,incomingStreamTimeout:3e4,hashLoader:NC,statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},LC=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"],t0=class{_libp2p;_log;stats;network;blockstore;engine;wm;notifications;started;constructor(e,t,n={}){this._libp2p=e,this._log=an(this.peerId),n=Object.assign({},OC,n),this.stats=new Zu(e,LC,{enabled:n.statsEnabled,computeThrottleTimeout:n.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:n.statsComputeThrottleMaxQueueSize}),this.network=new Yu(e,this,this.stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new zu(this.peerId,t,this.network,this.stats,e),this.wm=new e0(this.peerId,this.network,this.stats,e),this.notifications=new ju(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;let n=[];for(let[s,i]of t.blocks.entries()){let o=ge.parse(s);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(async({cid:s,wasWanted:i,data:o})=>{await this._handleReceivedBlock(e,s,o,i)}))}async _handleReceivedBlock(e,t,n,s){this._log("received block");let i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,i),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this.stats.push(e,"blocksReceived",1),this.stats.push(e,"dataReceived",n.length),s&&(this.stats.push(e,"dupBlksReceived",1),this.stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError",e)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this.stats.disconnected(e)}enableStats(){this.stats.enable()}disableStats(){this.stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async want(e,t={}){let n=async(c,l)=>(this.wm.wantBlocks([c],l),this.notifications.wantBlock(c,l)),s=!1,i=async(c,l)=>{try{return await this.blockstore.get(c,l)}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u;return s||(s=!0,this.network.findAndConnect(c,l).catch(f=>{this._log.error(f)})),await n(c,l)}},o=new AbortController,a=gr([o.signal,t.signal]);try{return await Promise.race([this.notifications.wantBlock(e,{...t,signal:a}),i(e,{...t,signal:a})])}finally{o.abort(),a.clear()}}unwant(e){let t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>{this.notifications.unwantBlock(n)})}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this.notify(e,t)}async*putMany(e,t){yield*this.blockstore.putMany(Qi(e,({cid:n,block:s})=>{this.notify(n,s)}),t)}notify(e,t,n={}){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,block:t}]),this.network.provide(e,n).catch(s=>{this._log.error("Failed to provide: %s",s.message)})}getWantlist(){return this.wm.wantlist.entries()}get peers(){return this.engine.peers()}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this.stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}};var u6=(r,e,t={})=>new t0(r,e,t);var BC=["string","number","bigint","symbol"],MC=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function f6(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";let e=typeof r;if(BC.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(UC(r))return"Buffer";let t=FC(r);return t||"Object"}function UC(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function FC(r){let e=Object.prototype.toString.call(r).slice(8,-1);if(MC.includes(e))return e}var A=class{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}};A.uint=new A(0,"uint",!0);A.negint=new A(1,"negint",!0);A.bytes=new A(2,"bytes",!0);A.string=new A(3,"string",!0);A.array=new A(4,"array",!1);A.map=new A(5,"map",!1);A.tag=new A(6,"tag",!1);A.float=new A(7,"float",!0);A.false=new A(7,"false",!0);A.true=new A(7,"true",!0);A.null=new A(7,"null",!0);A.undefined=new A(7,"undefined",!0);A.break=new A(7,"break",!0);var G=class{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}};var ia=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",KC=new TextDecoder,VC=new TextEncoder;function r0(r){return ia&&globalThis.Buffer.isBuffer(r)}function Kc(r){return r instanceof Uint8Array?r0(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}var m6=ia?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):d6(r,e,t):(r,e,t)=>t-e>64?KC.decode(r.subarray(e,t)):d6(r,e,t),n0=ia?r=>r.length>64?globalThis.Buffer.from(r):h6(r):r=>r.length>64?VC.encode(r):h6(r),ns=r=>Uint8Array.from(r),oa=ia?(r,e,t)=>r0(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),g6=ia?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),Kc(globalThis.Buffer.concat(r,e))):(r,e)=>{let t=new Uint8Array(e),n=0;for(let s of r)n+s.length>t.length&&(s=s.subarray(0,t.length-n)),t.set(s,n),n+=s.length;return t},y6=ia?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function b6(r,e){if(r0(r)&&r0(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function h6(r){let e=[],t=0;for(let n=0;n<r.length;n++){let s=r.charCodeAt(n);s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(s=65536+((s&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128)}return e}function d6(r,e,t){let n=[];for(;e<t;){let s=r[e],i=null,o=s>239?4:s>223?3:s>191?2:1;if(e+o<=t){let a,c,l,u;switch(o){case 1:s<128&&(i=s);break;case 2:a=r[e+1],(a&192)===128&&(u=(s&31)<<6|a&63,u>127&&(i=u));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(u=(s&15)<<12|(a&63)<<6|c&63,u>2047&&(u<55296||u>57343)&&(i=u));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(u=(s&15)<<18|(a&63)<<12|(c&63)<<6|l&63,u>65535&&u<1114112&&(i=u))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=o}return Z1(n)}var p6=4096;function Z1(r){let e=r.length;if(e<=p6)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=p6));return t}var qC=256,Vc=class{constructor(e=qC){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){let s=t.length-(this.maxCursor-this.cursor)-1;t.set(e,s)}else{if(t){let s=t.length-(this.maxCursor-this.cursor)-1;s<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,s),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=y6(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){let n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=oa(n,0,this.cursor)}else t=g6(this.chunks,this.cursor);return e&&this.reset(),t}};var ne="CBOR decode error:",aa="CBOR encode error:",qc=[];qc[23]=1;qc[24]=2;qc[25]=3;qc[26]=5;qc[27]=9;function Is(r,e,t){if(r.length-e<t)throw new Error(`${ne} not enough data for type`)}var qt=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Vr(r,e,t){Is(r,e,1);let n=r[e];if(t.strict===!0&&n<qt[0])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function qr(r,e,t){Is(r,e,2);let n=r[e]<<8|r[e+1];if(t.strict===!0&&n<qt[1])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function zr(r,e,t){Is(r,e,4);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<qt[2])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);return n}function $r(r,e,t){Is(r,e,8);let n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],s=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(s);if(t.strict===!0&&i<qt[3])throw new Error(`${ne} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${ne} integers outside of the safe integer range are not supported`)}function w6(r,e,t,n){return new G(A.uint,Vr(r,e+1,n),2)}function E6(r,e,t,n){return new G(A.uint,qr(r,e+1,n),3)}function x6(r,e,t,n){return new G(A.uint,zr(r,e+1,n),5)}function v6(r,e,t,n){return new G(A.uint,$r(r,e+1,n),9)}function ln(r,e){return jt(r,0,e.value)}function jt(r,e,t){if(t<qt[0]){let n=Number(t);r.push([e|n])}else if(t<qt[1]){let n=Number(t);r.push([e|24,n])}else if(t<qt[2]){let n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<qt[3]){let n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{let n=BigInt(t);if(n<qt[4]){let s=[e|27,0,0,0,0,0,0,0],i=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,r.push(s)}else throw new Error(`${ne} encountered BigInt larger than allowable range`)}}ln.encodedSize=function(e){return jt.encodedSize(e.value)};jt.encodedSize=function(e){return e<qt[0]?1:e<qt[1]?2:e<qt[2]?3:e<qt[3]?5:9};ln.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function _6(r,e,t,n){return new G(A.negint,-1-Vr(r,e+1,n),2)}function S6(r,e,t,n){return new G(A.negint,-1-qr(r,e+1,n),3)}function R6(r,e,t,n){return new G(A.negint,-1-zr(r,e+1,n),5)}var J1=BigInt(-1),I6=BigInt(1);function T6(r,e,t,n){let s=$r(r,e+1,n);if(typeof s!="bigint"){let i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new G(A.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${ne} integers outside of the safe integer range are not supported`);return new G(A.negint,J1-BigInt(s),9)}function s0(r,e){let t=e.value,n=typeof t=="bigint"?t*J1-I6:t*-1-1;jt(r,e.type.majorEncoded,n)}s0.encodedSize=function(e){let t=e.value,n=typeof t=="bigint"?t*J1-I6:t*-1-1;return n<qt[0]?1:n<qt[1]?2:n<qt[2]?3:n<qt[3]?5:9};s0.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function zc(r,e,t,n){Is(r,e,t+n);let s=oa(r,e+t,e+t+n);return new G(A.bytes,s,t+n)}function A6(r,e,t,n){return zc(r,e,1,t)}function D6(r,e,t,n){return zc(r,e,2,Vr(r,e+1,n))}function C6(r,e,t,n){return zc(r,e,3,qr(r,e+1,n))}function P6(r,e,t,n){return zc(r,e,5,zr(r,e+1,n))}function k6(r,e,t,n){let s=$r(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ne} 64-bit integer bytes lengths not supported`);return zc(r,e,9,s)}function i0(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===A.string?n0(r.value):r.value),r.encodedBytes}function ca(r,e){let t=i0(e);jt(r,e.type.majorEncoded,t.length),r.push(t)}ca.encodedSize=function(e){let t=i0(e);return jt.encodedSize(t.length)+t.length};ca.compareTokens=function(e,t){return $C(i0(e),i0(t))};function $C(r,e){return r.length<e.length?-1:r.length>e.length?1:b6(r,e)}function $c(r,e,t,n,s){let i=t+n;Is(r,e,i);let o=new G(A.string,m6(r,e+t,e+i),i);return s.retainStringBytes===!0&&(o.byteValue=oa(r,e+t,e+i)),o}function N6(r,e,t,n){return $c(r,e,1,t,n)}function O6(r,e,t,n){return $c(r,e,2,Vr(r,e+1,n),n)}function L6(r,e,t,n){return $c(r,e,3,qr(r,e+1,n),n)}function B6(r,e,t,n){return $c(r,e,5,zr(r,e+1,n),n)}function M6(r,e,t,n){let s=$r(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ne} 64-bit integer string lengths not supported`);return $c(r,e,9,s,n)}var U6=ca;function la(r,e,t,n){return new G(A.array,n,t)}function F6(r,e,t,n){return la(r,e,1,t)}function K6(r,e,t,n){return la(r,e,2,Vr(r,e+1,n))}function V6(r,e,t,n){return la(r,e,3,qr(r,e+1,n))}function q6(r,e,t,n){return la(r,e,5,zr(r,e+1,n))}function z6(r,e,t,n){let s=$r(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ne} 64-bit integer array lengths not supported`);return la(r,e,9,s)}function $6(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return la(r,e,1,1/0)}function o0(r,e){jt(r,A.array.majorEncoded,e.value)}o0.compareTokens=ln.compareTokens;o0.encodedSize=function(e){return jt.encodedSize(e.value)};function ua(r,e,t,n){return new G(A.map,n,t)}function H6(r,e,t,n){return ua(r,e,1,t)}function W6(r,e,t,n){return ua(r,e,2,Vr(r,e+1,n))}function G6(r,e,t,n){return ua(r,e,3,qr(r,e+1,n))}function Y6(r,e,t,n){return ua(r,e,5,zr(r,e+1,n))}function Q6(r,e,t,n){let s=$r(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ne} 64-bit integer map lengths not supported`);return ua(r,e,9,s)}function X6(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return ua(r,e,1,1/0)}function a0(r,e){jt(r,A.map.majorEncoded,e.value)}a0.compareTokens=ln.compareTokens;a0.encodedSize=function(e){return jt.encodedSize(e.value)};function j6(r,e,t,n){return new G(A.tag,t,1)}function Z6(r,e,t,n){return new G(A.tag,Vr(r,e+1,n),2)}function J6(r,e,t,n){return new G(A.tag,qr(r,e+1,n),3)}function ey(r,e,t,n){return new G(A.tag,zr(r,e+1,n),5)}function ty(r,e,t,n){return new G(A.tag,$r(r,e+1,n),9)}function c0(r,e){jt(r,A.tag.majorEncoded,e.value)}c0.compareTokens=ln.compareTokens;c0.encodedSize=function(e){return jt.encodedSize(e.value)};var XC=20,jC=21,ZC=22,JC=23;function ry(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ne} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new G(A.null,null,1):new G(A.undefined,void 0,1)}function ny(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ne} indefinite length items not allowed`);return new G(A.break,void 0,1)}function ep(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ne} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ne} Infinity values are not supported`)}return new G(A.float,r,e)}function sy(r,e,t,n){return ep(tp(r,e+1),3,n)}function iy(r,e,t,n){return ep(rp(r,e+1),5,n)}function oy(r,e,t,n){return ep(uy(r,e+1),9,n)}function l0(r,e,t){let n=e.value;if(n===!1)r.push([A.float.majorEncoded|XC]);else if(n===!0)r.push([A.float.majorEncoded|jC]);else if(n===null)r.push([A.float.majorEncoded|ZC]);else if(n===void 0)r.push([A.float.majorEncoded|JC]);else{let s,i=!1;(!t||t.float64!==!0)&&(cy(n),s=tp(Pn,1),n===s||Number.isNaN(n)?(Pn[0]=249,r.push(Pn.slice(0,3)),i=!0):(ly(n),s=rp(Pn,1),n===s&&(Pn[0]=250,r.push(Pn.slice(0,5)),i=!0))),i||(eP(n),s=uy(Pn,1),Pn[0]=251,r.push(Pn.slice(0,9)))}}l0.encodedSize=function(e,t){let n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){cy(n);let s=tp(Pn,1);if(n===s||Number.isNaN(n))return 3;if(ly(n),s=rp(Pn,1),n===s)return 5}return 9};var ay=new ArrayBuffer(9),un=new DataView(ay,1),Pn=new Uint8Array(ay,0);function cy(r){if(r===1/0)un.setUint16(0,31744,!1);else if(r===-1/0)un.setUint16(0,64512,!1);else if(Number.isNaN(r))un.setUint16(0,32256,!1);else{un.setFloat32(0,r);let e=un.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)un.setUint16(0,31744,!1);else if(t===0)un.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{let s=t-127;s<-24?un.setUint16(0,0):s<-14?un.setUint16(0,(e&2147483648)>>16|1<<24+s,!1):un.setUint16(0,(e&2147483648)>>16|s+15<<10|n>>13,!1)}}}function tp(r,e){if(r.length-e<2)throw new Error(`${ne} not enough data for float16`);let t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;let n=t>>10&31,s=t&1023,i;return n===0?i=s*2**-24:n!==31?i=(s+1024)*2**(n-25):i=s===0?1/0:NaN,t&32768?-i:i}function ly(r){un.setFloat32(0,r,!1)}function rp(r,e){if(r.length-e<4)throw new Error(`${ne} not enough data for float32`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function eP(r){un.setFloat64(0,r,!1)}function uy(r,e){if(r.length-e<8)throw new Error(`${ne} not enough data for float64`);let t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}l0.compareTokens=ln.compareTokens;function Ke(r,e,t){throw new Error(`${ne} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function u0(r){return()=>{throw new Error(`${ne} ${r}`)}}var X=[];for(let r=0;r<=23;r++)X[r]=Ke;X[24]=w6;X[25]=E6;X[26]=x6;X[27]=v6;X[28]=Ke;X[29]=Ke;X[30]=Ke;X[31]=Ke;for(let r=32;r<=55;r++)X[r]=Ke;X[56]=_6;X[57]=S6;X[58]=R6;X[59]=T6;X[60]=Ke;X[61]=Ke;X[62]=Ke;X[63]=Ke;for(let r=64;r<=87;r++)X[r]=A6;X[88]=D6;X[89]=C6;X[90]=P6;X[91]=k6;X[92]=Ke;X[93]=Ke;X[94]=Ke;X[95]=u0("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)X[r]=N6;X[120]=O6;X[121]=L6;X[122]=B6;X[123]=M6;X[124]=Ke;X[125]=Ke;X[126]=Ke;X[127]=u0("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)X[r]=F6;X[152]=K6;X[153]=V6;X[154]=q6;X[155]=z6;X[156]=Ke;X[157]=Ke;X[158]=Ke;X[159]=$6;for(let r=160;r<=183;r++)X[r]=H6;X[184]=W6;X[185]=G6;X[186]=Y6;X[187]=Q6;X[188]=Ke;X[189]=Ke;X[190]=Ke;X[191]=X6;for(let r=192;r<=215;r++)X[r]=j6;X[216]=Z6;X[217]=J6;X[218]=ey;X[219]=ty;X[220]=Ke;X[221]=Ke;X[222]=Ke;X[223]=Ke;for(let r=224;r<=243;r++)X[r]=u0("simple values are not supported");X[244]=Ke;X[245]=Ke;X[246]=Ke;X[247]=ry;X[248]=u0("simple values are not supported");X[249]=sy;X[250]=iy;X[251]=oy;X[252]=Ke;X[253]=Ke;X[254]=Ke;X[255]=ny;var kn=[];for(let r=0;r<24;r++)kn[r]=new G(A.uint,r,1);for(let r=-1;r>=-24;r--)kn[31-r]=new G(A.negint,r,1);kn[64]=new G(A.bytes,new Uint8Array(0),1);kn[96]=new G(A.string,"",1);kn[128]=new G(A.array,0,1);kn[160]=new G(A.map,0,1);kn[244]=new G(A.false,!1,1);kn[245]=new G(A.true,!0,1);kn[246]=new G(A.null,null,1);function fy(r){switch(r.type){case A.false:return ns([244]);case A.true:return ns([245]);case A.null:return ns([246]);case A.bytes:return r.value.length?void 0:ns([64]);case A.string:return r.value===""?ns([96]):void 0;case A.array:return r.value===0?ns([128]):void 0;case A.map:return r.value===0?ns([160]):void 0;case A.uint:return r.value<24?ns([Number(r.value)]):void 0;case A.negint:if(r.value>=-24)return ns([31-Number(r.value)])}}var rP={float64:!1,mapSorter:iP,quickEncodeToken:fy};function nP(){let r=[];return r[A.uint.major]=ln,r[A.negint.major]=s0,r[A.bytes.major]=ca,r[A.string.major]=U6,r[A.array.major]=o0,r[A.map.major]=a0,r[A.tag.major]=c0,r[A.float.major]=l0,r}var hy=nP(),np=new Vc,h0=class r{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${aa} object contains circular references`);return new r(t,e)}},oi={null:new G(A.null,null),undefined:new G(A.undefined,void 0),true:new G(A.true,!0),false:new G(A.false,!1),emptyArray:new G(A.array,0),emptyMap:new G(A.map,0)},ai={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new G(A.float,r):r>=0?new G(A.uint,r):new G(A.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new G(A.uint,r):new G(A.negint,r)},Uint8Array(r,e,t,n){return new G(A.bytes,r)},string(r,e,t,n){return new G(A.string,r)},boolean(r,e,t,n){return r?oi.true:oi.false},null(r,e,t,n){return oi.null},undefined(r,e,t,n){return oi.undefined},ArrayBuffer(r,e,t,n){return new G(A.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new G(A.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[oi.emptyArray,new G(A.break)]:oi.emptyArray;n=h0.createCheck(n,r);let s=[],i=0;for(let o of r)s[i++]=f0(o,t,n);return t.addBreakTokens?[new G(A.array,r.length),s,new G(A.break)]:[new G(A.array,r.length),s]},Object(r,e,t,n){let s=e!=="Object",i=s?r.keys():Object.keys(r),o=s?r.size:i.length;if(!o)return t.addBreakTokens===!0?[oi.emptyMap,new G(A.break)]:oi.emptyMap;n=h0.createCheck(n,r);let a=[],c=0;for(let l of i)a[c++]=[f0(l,t,n),f0(s?r.get(l):r[l],t,n)];return sP(a,t),t.addBreakTokens?[new G(A.map,o),a,new G(A.break)]:[new G(A.map,o),a]}};ai.Map=ai.Object;ai.Buffer=ai.Uint8Array;for(let r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))ai[`${r}Array`]=ai.DataView;function f0(r,e={},t){let n=f6(r),s=e&&e.typeEncoders&&e.typeEncoders[n]||ai[n];if(typeof s=="function"){let o=s(r,n,e,t);if(o!=null)return o}let i=ai[n];if(!i)throw new Error(`${aa} unsupported type: ${n}`);return i(r,n,e,t)}function sP(r,e){e.mapSorter&&r.sort(e.mapSorter)}function iP(r,e){let t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);let s=t.type.major,i=hy[s].compareTokens(t,n);return i===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),i}function dy(r,e,t,n){if(Array.isArray(e))for(let s of e)dy(r,s,t,n);else t[e.type.major](r,e,n)}function py(r,e,t){let n=f0(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){let s=t.quickEncodeToken(n);if(s)return s;let i=e[n.type.major];if(i.encodedSize){let o=i.encodedSize(n,t),a=new Vc(o);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return Kc(a.chunks[0])}}return np.reset(),dy(np,n,e,t),np.toBytes(!0)}function fa(r,e){return e=Object.assign({},rP,e),py(r,hy,e)}var oP={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0},sp=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){let e=this.data[this._pos],t=kn[e];if(t===void 0){let n=X[e];if(!n)throw new Error(`${ne} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);let s=e&31;t=n(this.data,this._pos,s,this.options)}return this._pos+=t.encodedLength,t}},Hc=Symbol.for("DONE"),d0=Symbol.for("BREAK");function aP(r,e,t){let n=[];for(let s=0;s<r.value;s++){let i=Wc(e,t);if(i===d0){if(r.value===1/0)break;throw new Error(`${ne} got unexpected break to lengthed array`)}if(i===Hc)throw new Error(`${ne} found array but not enough entries (got ${s}, expected ${r.value})`);n[s]=i}return n}function cP(r,e,t){let n=t.useMaps===!0,s=n?void 0:{},i=n?new Map:void 0;for(let o=0;o<r.value;o++){let a=Wc(e,t);if(a===d0){if(r.value===1/0)break;throw new Error(`${ne} got unexpected break to lengthed map`)}if(a===Hc)throw new Error(`${ne} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ne} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in s))throw new Error(`${ne} found repeat map key "${a}"`);let c=Wc(e,t);if(c===Hc)throw new Error(`${ne} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?i.set(a,c):s[a]=c}return n?i:s}function Wc(r,e){if(r.done())return Hc;let t=r.next();if(t.type===A.break)return d0;if(t.type.terminal)return t.value;if(t.type===A.array)return aP(t,r,e);if(t.type===A.map)return cP(t,r,e);if(t.type===A.tag){if(e.tags&&typeof e.tags[t.value]=="function"){let n=Wc(r,e);return e.tags[t.value](n)}throw new Error(`${ne} tag not supported (${t.value})`)}throw new Error("unsupported")}function ip(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ne} data to decode must be a Uint8Array`);e=Object.assign({},oP,e);let t=e.tokenizer||new sp(r,e),n=Wc(t,e);if(n===Hc)throw new Error(`${ne} did not find any content to decode`);if(n===d0)throw new Error(`${ne} got unexpected break`);return[n,r.subarray(t.pos())]}function fn(r,e){let[t,n]=ip(r,e);if(n.length>0)throw new Error(`${ne} too many terminals, data makes no sense`);return t}var ap=re(gy(),1);var Yc=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},cp=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},yy=r=>globalThis.DOMException===void 0?new cp(r):new DOMException(r),by=r=>{let e=r.reason===void 0?yy("This operation was aborted."):r.reason;return e instanceof Error?e:yy(e)};function lp(r,e,t,n){let s,i=new Promise((o,a)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(e===Number.POSITIVE_INFINITY){o(r);return}if(n={customTimers:{setTimeout,clearTimeout},...n},n.signal){let{signal:c}=n;c.aborted&&a(by(c)),c.addEventListener("abort",()=>{a(by(c))})}s=n.customTimers.setTimeout.call(void 0,()=>{if(typeof t=="function"){try{o(t())}catch(u){a(u)}return}let c=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,l=t instanceof Error?t:new Yc(c);typeof r.cancel=="function"&&r.cancel(),a(l)},e),(async()=>{try{o(await r)}catch(c){a(c)}finally{n.customTimers.clearTimeout.call(void 0,s)}})()});return i.clear=()=>{clearTimeout(s),s=void 0},i}function up(r,e,t){let n=0,s=r.length;for(;s>0;){let i=Math.trunc(s/2),o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}var no=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Ts,fp=class{constructor(){Ts.set(this,[])}enqueue(e,t){t={priority:0,...t};let n={priority:t.priority,run:e};if(this.size&&no(this,Ts,"f")[this.size-1].priority>=t.priority){no(this,Ts,"f").push(n);return}let s=up(no(this,Ts,"f"),n,(i,o)=>o.priority-i.priority);no(this,Ts,"f").splice(s,0,n)}dequeue(){let e=no(this,Ts,"f").shift();return e?.run}filter(e){return no(this,Ts,"f").filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return no(this,Ts,"f").length}};Ts=new WeakMap;var wy=fp;var mt=function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},se=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},St,Xc,jc,li,x0,Zc,g0,Nn,Qc,Hr,y0,Wr,Jc,ci,b0,Ey,xy,Sy,vy,_y,w0,hp,dp,v0,Ry,E0,_0=class extends Error{},pp=class extends ap.default{constructor(e){var t,n,s,i;if(super(),St.add(this),Xc.set(this,void 0),jc.set(this,void 0),li.set(this,0),x0.set(this,void 0),Zc.set(this,void 0),g0.set(this,0),Nn.set(this,void 0),Qc.set(this,void 0),Hr.set(this,void 0),y0.set(this,void 0),Wr.set(this,0),Jc.set(this,void 0),ci.set(this,void 0),b0.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:wy,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(n=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&n!==void 0?n:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);mt(this,Xc,e.carryoverConcurrencyCount,"f"),mt(this,jc,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,"f"),mt(this,x0,e.intervalCap,"f"),mt(this,Zc,e.interval,"f"),mt(this,Hr,new e.queueClass,"f"),mt(this,y0,e.queueClass,"f"),this.concurrency=e.concurrency,this.timeout=e.timeout,mt(this,b0,e.throwOnTimeout===!0,"f"),mt(this,ci,e.autoStart===!1,"f")}get concurrency(){return se(this,Jc,"f")}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);mt(this,Jc,e,"f"),se(this,St,"m",v0).call(this)}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:se(this,b0,"f"),...t},new Promise((n,s)=>{se(this,Hr,"f").enqueue(async()=>{var i,o,a;mt(this,Wr,(o=se(this,Wr,"f"),o++,o),"f"),mt(this,li,(a=se(this,li,"f"),a++,a),"f");try{if(!((i=t.signal)===null||i===void 0)&&i.aborted)throw new _0("The task was aborted.");let c=e({signal:t.signal});t.timeout&&(c=lp(Promise.resolve(c),t.timeout)),t.signal&&(c=Promise.race([c,se(this,St,"m",Ry).call(this,t.signal)]));let l=await c;n(l),this.emit("completed",l)}catch(c){if(c instanceof Yc&&!t.throwOnTimeout){n();return}s(c),this.emit("error",c)}finally{se(this,St,"m",Sy).call(this)}},t),this.emit("add"),se(this,St,"m",w0).call(this)})}async addAll(e,t){return Promise.all(e.map(async n=>this.add(n,t)))}start(){return se(this,ci,"f")?(mt(this,ci,!1,"f"),se(this,St,"m",v0).call(this),this):this}pause(){mt(this,ci,!0,"f")}clear(){mt(this,Hr,new(se(this,y0,"f")),"f")}async onEmpty(){se(this,Hr,"f").size!==0&&await se(this,St,"m",E0).call(this,"empty")}async onSizeLessThan(e){se(this,Hr,"f").size<e||await se(this,St,"m",E0).call(this,"next",()=>se(this,Hr,"f").size<e)}async onIdle(){se(this,Wr,"f")===0&&se(this,Hr,"f").size===0||await se(this,St,"m",E0).call(this,"idle")}get size(){return se(this,Hr,"f").size}sizeBy(e){return se(this,Hr,"f").filter(e).length}get pending(){return se(this,Wr,"f")}get isPaused(){return se(this,ci,"f")}};Xc=new WeakMap,jc=new WeakMap,li=new WeakMap,x0=new WeakMap,Zc=new WeakMap,g0=new WeakMap,Nn=new WeakMap,Qc=new WeakMap,Hr=new WeakMap,y0=new WeakMap,Wr=new WeakMap,Jc=new WeakMap,ci=new WeakMap,b0=new WeakMap,St=new WeakSet,Ey=function(){return se(this,jc,"f")||se(this,li,"f")<se(this,x0,"f")},xy=function(){return se(this,Wr,"f")<se(this,Jc,"f")},Sy=function(){var e;mt(this,Wr,(e=se(this,Wr,"f"),e--,e),"f"),se(this,St,"m",w0).call(this),this.emit("next")},vy=function(){se(this,St,"m",dp).call(this),se(this,St,"m",hp).call(this),mt(this,Qc,void 0,"f")},_y=function(){let e=Date.now();if(se(this,Nn,"f")===void 0){let t=se(this,g0,"f")-e;if(t<0)mt(this,li,se(this,Xc,"f")?se(this,Wr,"f"):0,"f");else return se(this,Qc,"f")===void 0&&mt(this,Qc,setTimeout(()=>{se(this,St,"m",vy).call(this)},t),"f"),!0}return!1},w0=function(){if(se(this,Hr,"f").size===0)return se(this,Nn,"f")&&clearInterval(se(this,Nn,"f")),mt(this,Nn,void 0,"f"),this.emit("empty"),se(this,Wr,"f")===0&&this.emit("idle"),!1;if(!se(this,ci,"f")){let e=!se(this,St,"a",_y);if(se(this,St,"a",Ey)&&se(this,St,"a",xy)){let t=se(this,Hr,"f").dequeue();return t?(this.emit("active"),t(),e&&se(this,St,"m",hp).call(this),!0):!1}}return!1},hp=function(){se(this,jc,"f")||se(this,Nn,"f")!==void 0||(mt(this,Nn,setInterval(()=>{se(this,St,"m",dp).call(this)},se(this,Zc,"f")),"f"),mt(this,g0,Date.now()+se(this,Zc,"f"),"f"))},dp=function(){se(this,li,"f")===0&&se(this,Wr,"f")===0&&se(this,Nn,"f")&&(clearInterval(se(this,Nn,"f")),mt(this,Nn,void 0,"f")),mt(this,li,se(this,Xc,"f")?se(this,Wr,"f"):0,"f"),se(this,St,"m",v0).call(this)},v0=function(){for(;se(this,St,"m",w0).call(this););},Ry=async function(e){return new Promise((t,n)=>{e.addEventListener("abort",()=>{n(new _0("The task was aborted."))},{once:!0})})},E0=async function(e,t){return new Promise(n=>{let s=()=>{t&&!t()||(this.off(e,s),n())};this.on(e,s)})};var Bt=pp;var fP=42;function hP(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return ge.decode(r.subarray(1))}var dP={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};dP.tags[fP]=hP;var Iy=113;var Ty=class extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){let t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===A.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===A.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[A.uint.major](e,t){this.prefix(e);let n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[A.negint.major](e,t){this[A.uint.major](e,t)}[A.bytes.major](e,t){throw new Error(`${aa} unsupported type: Uint8Array`)}[A.string.major](e,t){this.prefix(e);let n=n0(JSON.stringify(t.value));e.push(n.length>32?Kc(n):n)}[A.array.major](e,t){this.prefix(e),this.inRecursive.push({type:A.array,elements:0}),e.push([91])}[A.map.major](e,t){this.prefix(e),this.inRecursive.push({type:A.map,elements:0}),e.push([123])}[A.tag.major](e,t){}[A.float.major](e,t){if(t.type.name==="break"){let o=this.inRecursive.pop();if(o){if(o.type===A.array)e.push([93]);else if(o.type===A.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${aa} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}let n=String(t.value),s=[],i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}};var so=class{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${ne} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${ne} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){let e=this._pos,t=!1,n=!1,s=a=>{for(;!this.done();){let c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new G(A.uint,0,this._pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${ne} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ne} unexpected token at position ${this._pos}`);n=!0,this._pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,s([48,49,50,51,52,53,54,55,56,57]));let i=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(i);return n?new G(A.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new G(o>=0?A.uint:A.negint,o,this._pos-e):new G(o>=0?A.uint:A.negint,BigInt(i),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ne} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let i=this._pos,o=0;i<this.data.length&&o<65536;i++,o++){let a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){let c=String.fromCharCode.apply(null,this.data.subarray(this._pos,i));return this._pos=i+1,new G(A.string,c,o)}}let e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${ne} unexpected end of unicode escape sequence at position ${this._pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ne} unexpected unicode escape character at position ${this._pos}`);i=i*16+a,this._pos++}return i},s=()=>{let i=this.ch(),o=null,a=i>239?4:i>223?3:i>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${ne} unexpected unicode sequence at position ${this._pos}`);let c,l,u,f;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(f=(i&31)<<6|c&63,f>127&&(o=f));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(f=(i&15)<<12|(c&63)<<6|l&63,f>2047&&(f<55296||f>57343)&&(o=f));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],u=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(u&192)===128&&(f=(i&15)<<18|(c&63)<<12|(l&63)<<6|u&63,f>65535&&f<1114112&&(o=f))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){let i=this.ch(),o;switch(i){case 92:if(this._pos++,this.done())throw new Error(`${ne} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ne} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new G(A.string,Z1(t),this._pos-e);default:if(i<32)throw new Error(`${ne} invalid control character at position ${this._pos}`);i<128?(t.push(i),this._pos++):s()}}throw new Error(`${ne} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new G(A.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new G(A.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new G(A.null,null,4);case 102:return this.expect([102,97,108,115,101]),new G(A.false,!1,5);case 116:return this.expect([116,114,117,101]),new G(A.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ne} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new G(A.break,void 0,1);if(this.ch()!==44)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new G(A.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new G(A.break,void 0,1);if(this.ch()!==44)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new G(A.break,void 0,1);let e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ne} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ne} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}};function S0(r,e){return e=Object.assign({tokenizer:new so(r,e)},e),fn(r,e)}var gP={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};gP.tags[42]=ge.parse;var Dy=297;var sj=new TextDecoder;var ij=new TextEncoder;var bP=new TextDecoder;function mp(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");let s=r[e++];if(t+=n<28?(s&127)<<n:(s&127)*2**n,s<128)break}return[t,e]}function R0(r,e){let t;[t,e]=mp(r,e);let n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function Cy(r,e){let t;return[t,e]=mp(r,e),[t&7,t>>3,e]}function wP(r){let e={},t=r.length,n=0;for(;n<t;){let s,i;if([s,i,n]=Cy(r,n),i===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=R0(r,n)}else if(i===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(s!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=R0(r,n),e.Name=bP.decode(o)}else if(i===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(s!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${s}) for Tsize`);[e.Tsize,n]=mp(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${i}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function Py(r){let e=r.length,t=0,n,s=!1,i;for(;t<e;){let a,c;if([a,c,t]=Cy(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(i)throw new Error("protobuf: (PBNode) duplicate Data section");[i,t]=R0(r,t),n&&(s=!0)}else if(c===2){if(s)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=R0(r,t),n.push(wP(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");let o={};return i&&(o.Data=i),o.Links=n||[],o}var aj=new TextEncoder,cj=2**32,lj=2**31;var hj=new TextEncoder;var ky=112;function Ny(r){let e=Py(r),t={};return e.Data&&(t.Data=e.Data),e.Links&&(t.Links=e.Links.map(n=>{let s={};try{s.Hash=ge.decode(n.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return n.Name!==void 0&&(s.Name=n.Name),n.Tsize!==void 0&&(s.Tsize=n.Tsize),s})),t}var Oy={codec:ky,async*walk(r){yield*Ny(r).Links.map(t=>t.Hash)}},Ly={codec:Iu,async*walk(){}},By=42,My={codec:Iy,async*walk(r){let e=[],t=[];t[By]=n=>{if(n[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");let s=ge.decode(n.subarray(1));return e.push(s),s},fn(r,{tags:t}),yield*e}},gp=class extends so{tokenBuffer;constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){let e=this._next();if(e.type===A.map){let t=this._next();if(t.type===A.string&&t.value==="/"){let n=this._next();if(n.type===A.string){if(this._next().type!==A.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new G(A.tag,42,0)}if(n.type===A.map){let s=this._next();if(s.type===A.string&&s.value==="bytes"){let i=this._next();if(i.type===A.string){for(let a=0;a<2;a++)if(this._next().type!==A.break)throw new Error("Invalid encoded Bytes form");let o=Zn.decode(`m${i.value}`);return new G(A.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}},Uy={codec:Dy,async*walk(r){let e=[],t=[];t[By]=n=>{let s=ge.parse(n);return e.push(s),s},S0(r,{tags:t,tokenizer:new gp(r,{tags:t,allowIndefinite:!0,allowUndefined:!0,allowNaN:!0,allowInfinity:!0,allowBigInt:!0,strict:!1,rejectDuplicateMapKeys:!1})}),yield*e}},Fy={codec:tg,async*walk(){}};var xP=[Ly,Oy,My,Uy,Fy],zy="/pin/",Ky="/pinned-block/",yp=Js,Vy=1;function qy(r){return r.version===0&&(r=r.toV1()),new rt(`${zy}${r.toString(yp)}`)}var I0=class{datastore;blockstore;dagWalkers;constructor(e,t,n){this.datastore=e,this.blockstore=t,this.dagWalkers={},[...xP,...n].forEach(s=>{this.dagWalkers[s.codec]=s})}async add(e,t={}){let n=qy(e);if(await this.datastore.has(n))throw new Error("Already pinned");let s=Math.round(t.depth??1/0);if(s<0)throw new Error("Depth must be greater than or equal to 0");let i=new Bt({concurrency:Vy});i.add(async()=>{await this.#e(e,i,c=>{c.pinnedBy.find(l=>me(l,e.bytes))==null&&(c.pinCount++,c.pinnedBy.push(e.bytes))},{...t,depth:s})});let o=De();i.on("error",c=>{i.clear(),o.reject(c)}),await Promise.race([i.onIdle(),o.promise]);let a={depth:s,metadata:t.metadata??{}};return await this.datastore.put(n,fa(a),t),{cid:e,...a}}async#e(e,t,n,s){if(s.depth===-1)return;let i=this.dagWalkers[e.code];if(i==null)throw new Error(`No dag walker found for cid codec ${e.code}`);let o=await this.blockstore.get(e,s);await this.#t(e,n,s);for await(let a of i.walk(o))t.add(async()=>{await this.#e(a,t,n,{...s,depth:s.depth-1})})}async#t(e,t,n){let s=new rt(`${Ky}${yp.encode(e.multihash.bytes)}`),i={pinCount:0,pinnedBy:[]};try{i=fn(await this.datastore.get(s,n))}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if(t(i),i.pinCount===0&&await this.datastore.has(s)){await this.datastore.delete(s);return}await this.datastore.put(s,fa(i),n),n.onProgress?.(new Fe("helia:pin:add",{detail:e}))}async rm(e,t={}){let n=qy(e),s=await this.datastore.get(n,t),i=fn(s);await this.datastore.delete(n,t);let o=new Bt({concurrency:Vy});return o.add(async()=>{await this.#e(e,o,a=>{a.pinCount--,a.pinnedBy=a.pinnedBy.filter(c=>me(c,e.bytes))},{...t,depth:i.depth})}),await o.onIdle(),{cid:e,...i}}async*ls(e={}){for await(let{key:t,value:n}of this.datastore.query({prefix:zy+(e.cid!=null?`${e.cid.toString(Js)}`:"")},e)){let s=ge.parse(t.toString().substring(5),Js),i=fn(n);yield{cid:s,...i}}}async isPinned(e,t={}){let n=new rt(`${Ky}${yp.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}};var io=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},bp=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}},$y=r=>globalThis.DOMException===void 0?new bp(r):new DOMException(r),Hy=r=>{let e=r.reason===void 0?$y("This operation was aborted."):r.reason;return e instanceof Error?e:$y(e)};function oo(r,e){let{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e,o,c=new Promise((l,u)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){let{signal:h}=e;h.aborted&&u(Hy(h)),h.addEventListener("abort",()=>{u(Hy(h))})}if(t===Number.POSITIVE_INFINITY){r.then(l,u);return}let f=new io;o=i.setTimeout.call(void 0,()=>{if(n){try{l(n())}catch(h){u(h)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?l():s instanceof Error?u(s):(f.message=s??`Promise timed out after ${t} milliseconds`,u(f))},t),(async()=>{try{l(await r)}catch(h){u(h)}})()}).finally(()=>{c.clear()});return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}var Wy=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");var wp="lock:worker:request-read",Ep="lock:worker:release-read",xp="lock:master:grant-read",vp="lock:worker:request-write",_p="lock:worker:release-write",Sp="lock:master:grant-write";var ui={},ha=r=>{r.addEventListener("message",e=>{ha.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{ha.dispatchEvent("message",r,e)})};ha.addEventListener=(r,e)=>{ui[r]==null&&(ui[r]=[]),ui[r].push(e)};ha.removeEventListener=(r,e)=>{ui[r]!=null&&(ui[r]=ui[r].filter(t=>t===e))};ha.dispatchEvent=function(r,e,t){ui[r]!=null&&ui[r].forEach(n=>n(e,t))};var Rp=ha;var Gy=(r,e,t,n,s)=>(i,o)=>{if(o.data.type!==t)return;let a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{let l=u=>{if(u==null||u.data==null)return;let f={type:u.data.type,name:u.data.name,identifier:u.data.identifier};f.type===n&&f.identifier===a.identifier&&(i.removeEventListener("message",l),c())};i.addEventListener("message",l)}))}}))},Yy=(r,e,t,n)=>async()=>{let s=Wy();return globalThis.postMessage({type:e,identifier:s,name:r}),await new Promise(i=>{let o=a=>{if(a==null||a.data==null)return;let c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:n,identifier:s,name:r})}))};globalThis.addEventListener("message",o)})},vP={singleProcess:!1},Qy=r=>{if(r=Object.assign({},vP,r),!!globalThis.document||r.singleProcess){let t=new EventTarget;return Rp.addEventListener("message",Gy(t,"requestReadLock",wp,Ep,xp)),Rp.addEventListener("message",Gy(t,"requestWriteLock",vp,_p,Sp)),t}return{isWorker:!0,readLock:t=>Yy(t,wp,xp,Ep),writeLock:t=>Yy(t,vp,Sp,_p)}};var ao={},fi;async function Ip(r,e){let t,n=new Promise(s=>{t=s});return r.add(async()=>await oo((async()=>await new Promise(s=>{t(()=>{s()})}))(),{milliseconds:e.timeout})),await n}var _P=(r,e)=>{if(fi.isWorker===!0)return{readLock:fi.readLock(r,e),writeLock:fi.writeLock(r,e)};let t=new Bt({concurrency:1}),n;return{async readLock(){if(n!=null)return await Ip(n,e);n=new Bt({concurrency:e.concurrency,autoStart:!1});let s=n,i=Ip(n,e);return t.add(async()=>(s.start(),await s.onIdle().then(()=>{n===s&&(n=null)}))),await i},async writeLock(){return n=null,await Ip(t,e)}}},SP={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function el(r){let e=Object.assign({},SP,r);return fi==null&&(fi=Qy(e),fi.isWorker!==!0&&(fi.addEventListener("requestReadLock",t=>{ao[t.data.name]!=null&&ao[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),fi.addEventListener("requestWriteLock",async t=>{ao[t.data.name]!=null&&ao[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),ao[e.name]==null&&(ao[e.name]=_P(e.name,e)),ao[e.name]}var T0=class{lock;child;pins;constructor(e,t,n={}){this.child=e,this.pins=t,this.lock=el({singleProcess:n.holdGcLock})}unwrap(){return this.child}async put(e,t,n={}){let s=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{s()}}async*putMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){let n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){let n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){let n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){let n=await this.lock.writeLock();try{let s=this;yield*this.child.deleteMany(async function*(){for await(let i of e){if(await s.pins.isPinned(i))throw new Error("CID was pinned");yield i}}(),t)}finally{n()}}async has(e,t={}){let n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){let t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}};var Tp=new rt("/version"),Xy=1;async function jy(r){if(!await r.has(Tp)){await r.put(Tp,Q(`${Xy}`));return}let e=await r.get(Tp),t=W(e);if(parseInt(t,10)!==Xy)throw new Error("Unknown datastore version, a datastore migration may be required")}var A0=class{child;bitswap;constructor(e,t={}){this.child=e,this.bitswap=t.bitswap}unwrap(){return this.child}async put(e,t,n={}){return await this.child.has(e)?(n.onProgress?.(new Fe("blocks:put:duplicate",e)),e):(this.bitswap?.isStarted()===!0&&(n.onProgress?.(new Fe("blocks:put:bitswap:notify",e)),this.bitswap.notify(e,t,n)),n.onProgress?.(new Fe("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){let n=mr(e,async({cid:i})=>{let o=await this.child.has(i);return o&&t.onProgress?.(new Fe("blocks:put-many:duplicate",i)),!o}),s=Qi(n,({cid:i,block:o})=>{t.onProgress?.(new Fe("blocks:put-many:bitswap:notify",i)),this.bitswap?.notify(i,o,t)});t.onProgress?.(new Fe("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(s,t)}async get(e,t={}){if(t.offline!==!0&&this.bitswap?.isStarted()!=null&&!await this.child.has(e)){t.onProgress?.(new Fe("blocks:get:bitswap:get",e));let n=await this.bitswap.want(e,t);return t.onProgress?.(new Fe("blocks:get:blockstore:put",e)),await this.child.put(e,n,t),n}return t.onProgress?.(new Fe("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){t.onProgress?.(new Fe("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Qi(e,async n=>{if(t.offline!==!0&&this.bitswap?.isStarted()===!0&&!await this.child.has(n)){t.onProgress?.(new Fe("blocks:get-many:bitswap:get",n));let s=await this.bitswap.want(n,t);t.onProgress?.(new Fe("blocks:get-many:blockstore:put",n)),await this.child.put(n,s,t)}}))}async delete(e,t={}){t.onProgress?.(new Fe("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){t.onProgress?.(new Fe("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(let n of e)yield n}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){e.onProgress?.(new Fe("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}};var Ap=k("helia"),D0=class{libp2p;blockstore;datastore;pins;#e;constructor(e){let t=[Ne,p1,es,...e.hashers??[]];this.#e=u6(e.libp2p,e.blockstore,{hashLoader:{getHasher:async s=>{let i=t.find(o=>o.code===s||o.name===s);if(i!=null)return i;throw new Error(`Could not load hasher for code/name "${s}"`)}}});let n=new A0(e.blockstore,{bitswap:this.#e});this.pins=new I0(e.datastore,n,e.dagWalkers??[]),this.libp2p=e.libp2p,this.blockstore=new T0(n,this.pins,{holdGcLock:e.holdGcLock}),this.datastore=e.datastore}async start(){await jy(this.datastore),await this.#e?.start(),await this.libp2p.start()}async stop(){await this.libp2p.stop(),await this.#e?.stop()}async gc(e={}){let t=await this.blockstore.lock.writeLock();try{let n=this,s=this.blockstore.unwrap();Ap("gc start"),await Tr(s.deleteMany(async function*(){for await(let{cid:i}of s.getAll())try{if(await n.pins.isPinned(i,e))continue;yield i,e.onProgress?.(new Fe("helia:gc:deleted",i))}catch(o){Ap.error("Error during gc",o),e.onProgress?.(new Fe("helia:gc:error",o))}}()))}finally{t()}Ap("gc finished")}};var ox=re(Dr(),1);var mf={};Ce(mf,{generateEphemeralKeyPair:()=>z9,generateKeyPair:()=>xl,generateKeyPairFromSeed:()=>PL,importKey:()=>Aa,keyStretcher:()=>Q9,keysPBM:()=>_a,marshalPrivateKey:()=>P2,marshalPublicKey:()=>vl,supportedKeys:()=>us,unmarshalPrivateKey:()=>qn,unmarshalPublicKey:()=>kr});var pte=re(sl(),1),mte=re(h9(),1);var pf=re(Qe(),1);var y2={};Ce(y2,{Ed25519PrivateKey:()=>yo,Ed25519PublicKey:()=>pl,generateKeyPair:()=>JO,generateKeyPairFromSeed:()=>g2,unmarshalEd25519PrivateKey:()=>jO,unmarshalEd25519PublicKey:()=>ZO});function Y0(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function jp(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function cl(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Y0(r.outputLen),Y0(r.blockLen)}function ya(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function d9(r,e){jp(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Q0=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;var p9=r=>r instanceof Uint8Array;var X0=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Bn=(r,e)=>r<<32-e|r>>>e,QN=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!QN)throw new Error("Non little-endian hardware is not supported");function Zp(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function gi(r){if(typeof r=="string"&&(r=Zp(r)),!p9(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function j0(...r){let e=new Uint8Array(r.reduce((n,s)=>n+s.length,0)),t=0;return r.forEach(n=>{if(!p9(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}var ba=class{clone(){return this._cloneInto()}},zZ={}.toString;function Z0(r){let e=n=>r().update(gi(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function po(r=32){if(Q0&&typeof Q0.getRandomValues=="function")return Q0.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function XN(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}var wa=class extends ba{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=X0(this.buffer)}update(e){ya(this);let{view:t,buffer:n,blockLen:s}=this;e=gi(e);let i=e.length;for(let o=0;o<i;){let a=Math.min(s-this.pos,i-o);if(a===s){let c=X0(e);for(;s<=i-o;o+=s)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ya(this),d9(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:s,isLE:i}=this,{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>s-o&&(this.process(n,0),o=0);for(let f=o;f<s;f++)t[f]=0;XN(n,s-8,BigInt(this.length*8),i),this.process(n,0);let a=X0(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,u=this.get();if(l>u.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<l;f++)a.setUint32(4*f,u[f],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:s,finished:i,destroyed:o,pos:a}=this;return e.length=s,e.pos=a,e.finished=i,e.destroyed=o,s%t&&e.buffer.set(n),e}};var J0=BigInt(4294967295),Jp=BigInt(32);function m9(r,e=!1){return e?{h:Number(r&J0),l:Number(r>>Jp&J0)}:{h:Number(r>>Jp&J0)|0,l:Number(r&J0)|0}}function jN(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let s=0;s<r.length;s++){let{h:i,l:o}=m9(r[s],e);[t[s],n[s]]=[i,o]}return[t,n]}var ZN=(r,e)=>BigInt(r>>>0)<<Jp|BigInt(e>>>0),JN=(r,e,t)=>r>>>t,eO=(r,e,t)=>r<<32-t|e>>>t,tO=(r,e,t)=>r>>>t|e<<32-t,rO=(r,e,t)=>r<<32-t|e>>>t,nO=(r,e,t)=>r<<64-t|e>>>t-32,sO=(r,e,t)=>r>>>t-32|e<<64-t,iO=(r,e)=>e,oO=(r,e)=>r,aO=(r,e,t)=>r<<t|e>>>32-t,cO=(r,e,t)=>e<<t|r>>>32-t,lO=(r,e,t)=>e<<t-32|r>>>64-t,uO=(r,e,t)=>r<<t-32|e>>>64-t;function fO(r,e,t,n){let s=(e>>>0)+(n>>>0);return{h:r+t+(s/2**32|0)|0,l:s|0}}var hO=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),dO=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,pO=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),mO=(r,e,t,n,s)=>e+t+n+s+(r/2**32|0)|0,gO=(r,e,t,n,s)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),yO=(r,e,t,n,s,i)=>e+t+n+s+i+(r/2**32|0)|0;var bO={fromBig:m9,split:jN,toBig:ZN,shrSH:JN,shrSL:eO,rotrSH:tO,rotrSL:rO,rotrBH:nO,rotrBL:sO,rotr32H:iO,rotr32L:oO,rotlSH:aO,rotlSL:cO,rotlBH:lO,rotlBL:uO,add:fO,add3L:hO,add3H:dO,add4L:pO,add4H:mO,add5H:yO,add5L:gO},Re=bO;var[wO,EO]=(()=>Re.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))))(),yi=new Uint32Array(80),bi=new Uint32Array(80),e2=class extends wa{constructor(){super(128,64,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){let{Ah:e,Al:t,Bh:n,Bl:s,Ch:i,Cl:o,Dh:a,Dl:c,Eh:l,El:u,Fh:f,Fl:h,Gh:d,Gl:p,Hh:m,Hl:g}=this;return[e,t,n,s,i,o,a,c,l,u,f,h,d,p,m,g]}set(e,t,n,s,i,o,a,c,l,u,f,h,d,p,m,g){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=s|0,this.Ch=i|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=u|0,this.Fh=f|0,this.Fl=h|0,this.Gh=d|0,this.Gl=p|0,this.Hh=m|0,this.Hl=g|0}process(e,t){for(let E=0;E<16;E++,t+=4)yi[E]=e.getUint32(t),bi[E]=e.getUint32(t+=4);for(let E=16;E<80;E++){let R=yi[E-15]|0,x=bi[E-15]|0,v=Re.rotrSH(R,x,1)^Re.rotrSH(R,x,8)^Re.shrSH(R,x,7),I=Re.rotrSL(R,x,1)^Re.rotrSL(R,x,8)^Re.shrSL(R,x,7),_=yi[E-2]|0,D=bi[E-2]|0,O=Re.rotrSH(_,D,19)^Re.rotrBH(_,D,61)^Re.shrSH(_,D,6),N=Re.rotrSL(_,D,19)^Re.rotrBL(_,D,61)^Re.shrSL(_,D,6),U=Re.add4L(I,N,bi[E-7],bi[E-16]),z=Re.add4H(U,v,O,yi[E-7],yi[E-16]);yi[E]=z|0,bi[E]=U|0}let{Ah:n,Al:s,Bh:i,Bl:o,Ch:a,Cl:c,Dh:l,Dl:u,Eh:f,El:h,Fh:d,Fl:p,Gh:m,Gl:g,Hh:y,Hl:w}=this;for(let E=0;E<80;E++){let R=Re.rotrSH(f,h,14)^Re.rotrSH(f,h,18)^Re.rotrBH(f,h,41),x=Re.rotrSL(f,h,14)^Re.rotrSL(f,h,18)^Re.rotrBL(f,h,41),v=f&d^~f&m,I=h&p^~h&g,_=Re.add5L(w,x,I,EO[E],bi[E]),D=Re.add5H(_,y,R,v,wO[E],yi[E]),O=_|0,N=Re.rotrSH(n,s,28)^Re.rotrBH(n,s,34)^Re.rotrBH(n,s,39),U=Re.rotrSL(n,s,28)^Re.rotrBL(n,s,34)^Re.rotrBL(n,s,39),z=n&i^n&a^i&a,te=s&o^s&c^o&c;y=m|0,w=g|0,m=d|0,g=p|0,d=f|0,p=h|0,{h:f,l:h}=Re.add(l|0,u|0,D|0,O|0),l=a|0,u=c|0,a=i|0,c=o|0,i=n|0,o=s|0;let P=Re.add3L(O,U,te);n=Re.add3H(P,D,N,z),s=P|0}({h:n,l:s}=Re.add(this.Ah|0,this.Al|0,n|0,s|0)),{h:i,l:o}=Re.add(this.Bh|0,this.Bl|0,i|0,o|0),{h:a,l:c}=Re.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:u}=Re.add(this.Dh|0,this.Dl|0,l|0,u|0),{h:f,l:h}=Re.add(this.Eh|0,this.El|0,f|0,h|0),{h:d,l:p}=Re.add(this.Fh|0,this.Fl|0,d|0,p|0),{h:m,l:g}=Re.add(this.Gh|0,this.Gl|0,m|0,g|0),{h:y,l:w}=Re.add(this.Hh|0,this.Hl|0,y|0,w|0),this.set(n,s,i,o,a,c,l,u,f,h,d,p,m,g,y,w)}roundClean(){yi.fill(0),bi.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};var t2=Z0(()=>new e2);var rf={};Ce(rf,{bitGet:()=>TO,bitLen:()=>IO,bitMask:()=>ll,bitSet:()=>AO,bytesToHex:()=>Ps,bytesToNumberBE:()=>ks,bytesToNumberLE:()=>Mn,concatBytes:()=>Os,createHmacDrbg:()=>s2,ensureBytes:()=>st,equalBytes:()=>SO,hexToBytes:()=>mo,hexToNumber:()=>n2,numberToBytesBE:()=>wi,numberToBytesLE:()=>Ns,numberToHexUnpadded:()=>b9,numberToVarBytesBE:()=>_O,utf8ToBytes:()=>RO,validateObject:()=>pn});var y9=BigInt(0),ef=BigInt(1),xO=BigInt(2),tf=r=>r instanceof Uint8Array,vO=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Ps(r){if(!tf(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=vO[r[t]];return e}function b9(r){let e=r.toString(16);return e.length&1?`0${e}`:e}function n2(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}function mo(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);let e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);let t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){let s=n*2,i=r.slice(s,s+2),o=Number.parseInt(i,16);if(Number.isNaN(o)||o<0)throw new Error("Invalid byte sequence");t[n]=o}return t}function ks(r){return n2(Ps(r))}function Mn(r){if(!tf(r))throw new Error("Uint8Array expected");return n2(Ps(Uint8Array.from(r).reverse()))}function wi(r,e){return mo(r.toString(16).padStart(e*2,"0"))}function Ns(r,e){return wi(r,e).reverse()}function _O(r){return mo(b9(r))}function st(r,e,t){let n;if(typeof e=="string")try{n=mo(e)}catch(i){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${i}`)}else if(tf(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);let s=n.length;if(typeof t=="number"&&s!==t)throw new Error(`${r} expected ${t} bytes, got ${s}`);return n}function Os(...r){let e=new Uint8Array(r.reduce((n,s)=>n+s.length,0)),t=0;return r.forEach(n=>{if(!tf(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}function SO(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function RO(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function IO(r){let e;for(e=0;r>y9;r>>=ef,e+=1);return e}function TO(r,e){return r>>BigInt(e)&ef}var AO=(r,e,t)=>r|(t?ef:y9)<<BigInt(e),ll=r=>(xO<<BigInt(r-1))-ef,r2=r=>new Uint8Array(r),g9=r=>Uint8Array.from(r);function s2(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=r2(r),s=r2(r),i=0,o=()=>{n.fill(1),s.fill(0),i=0},a=(...f)=>t(s,n,...f),c=(f=r2())=>{s=a(g9([0]),f),n=a(),f.length!==0&&(s=a(g9([1]),f),n=a())},l=()=>{if(i++>=1e3)throw new Error("drbg: tried 1000 values");let f=0,h=[];for(;f<e;){n=a();let d=n.slice();h.push(d),f+=n.length}return Os(...h)};return(f,h)=>{o(),c(f);let d;for(;!(d=h(l()));)c();return o(),d}}var DO={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||r instanceof Uint8Array,isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function pn(r,e,t={}){let n=(s,i,o)=>{let a=DO[i];if(typeof a!="function")throw new Error(`Invalid validator "${i}", expected function`);let c=r[s];if(!(o&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${i}`)};for(let[s,i]of Object.entries(e))n(s,i,!1);for(let[s,i]of Object.entries(t))n(s,i,!0);return r}var Mt=BigInt(0),ft=BigInt(1),go=BigInt(2),CO=BigInt(3),i2=BigInt(4),w9=BigInt(5),E9=BigInt(8),PO=BigInt(9),kO=BigInt(16);function ze(r,e){let t=r%e;return t>=Mt?t:e+t}function o2(r,e,t){if(t<=Mt||e<Mt)throw new Error("Expected power/modulo > 0");if(t===ft)return Mt;let n=ft;for(;e>Mt;)e&ft&&(n=n*r%t),r=r*r%t,e>>=ft;return n}function it(r,e,t){let n=r;for(;e-- >Mt;)n*=n,n%=t;return n}function nf(r,e){if(r===Mt||e<=Mt)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=ze(r,e),n=e,s=Mt,i=ft,o=ft,a=Mt;for(;t!==Mt;){let l=n/t,u=n%t,f=s-o*l,h=i-a*l;n=t,t=u,s=o,i=a,o=f,a=h}if(n!==ft)throw new Error("invert: does not exist");return ze(s,e)}function NO(r){let e=(r-ft)/go,t,n,s;for(t=r-ft,n=0;t%go===Mt;t/=go,n++);for(s=go;s<r&&o2(s,e,r)!==r-ft;s++);if(n===1){let o=(r+ft)/i2;return function(c,l){let u=c.pow(l,o);if(!c.eql(c.sqr(u),l))throw new Error("Cannot find square root");return u}}let i=(t+ft)/go;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,u=a.pow(a.mul(a.ONE,s),t),f=a.pow(c,i),h=a.pow(c,t);for(;!a.eql(h,a.ONE);){if(a.eql(h,a.ZERO))return a.ZERO;let d=1;for(let m=a.sqr(h);d<l&&!a.eql(m,a.ONE);d++)m=a.sqr(m);let p=a.pow(u,ft<<BigInt(l-d-1));u=a.sqr(p),f=a.mul(f,p),h=a.mul(h,u),l=d}return f}}function OO(r){if(r%i2===CO){let e=(r+ft)/i2;return function(n,s){let i=n.pow(s,e);if(!n.eql(n.sqr(i),s))throw new Error("Cannot find square root");return i}}if(r%E9===w9){let e=(r-w9)/E9;return function(n,s){let i=n.mul(s,go),o=n.pow(i,e),a=n.mul(s,o),c=n.mul(n.mul(a,go),o),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),s))throw new Error("Cannot find square root");return l}}return r%kO,NO(r)}var x9=(r,e)=>(ze(r,e)&ft)===ft,LO=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function a2(r){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=LO.reduce((n,s)=>(n[s]="function",n),e);return pn(r,t)}function BO(r,e,t){if(t<Mt)throw new Error("Expected power > 0");if(t===Mt)return r.ONE;if(t===ft)return e;let n=r.ONE,s=e;for(;t>Mt;)t&ft&&(n=r.mul(n,s)),s=r.sqr(s),t>>=ft;return n}function MO(r,e){let t=new Array(e.length),n=e.reduce((i,o,a)=>r.is0(o)?i:(t[a]=i,r.mul(i,o)),r.ONE),s=r.inv(n);return e.reduceRight((i,o,a)=>r.is0(o)?i:(t[a]=r.mul(i,t[a]),r.mul(i,o)),s),t}function c2(r,e){let t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function sf(r,e,t=!1,n={}){if(r<=Mt)throw new Error(`Expected Field ORDER > 0, got ${r}`);let{nBitLength:s,nByteLength:i}=c2(r,e);if(i>2048)throw new Error("Field lengths over 2048 bytes are not supported");let o=OO(r),a=Object.freeze({ORDER:r,BITS:s,BYTES:i,MASK:ll(s),ZERO:Mt,ONE:ft,create:c=>ze(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return Mt<=c&&c<r},is0:c=>c===Mt,isOdd:c=>(c&ft)===ft,neg:c=>ze(-c,r),eql:(c,l)=>c===l,sqr:c=>ze(c*c,r),add:(c,l)=>ze(c+l,r),sub:(c,l)=>ze(c-l,r),mul:(c,l)=>ze(c*l,r),pow:(c,l)=>BO(a,c,l),div:(c,l)=>ze(c*nf(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>nf(c,r),sqrt:n.sqrt||(c=>o(a,c)),invertBatch:c=>MO(a,c),cmov:(c,l,u)=>u?l:c,toBytes:c=>t?Ns(c,i):wi(c,i),fromBytes:c=>{if(c.length!==i)throw new Error(`Fp.fromBytes: expected ${i}, got ${c.length}`);return t?Mn(c):ks(c)}});return Object.freeze(a)}function v9(r,e){if(!r.isOdd)throw new Error("Field doesn't have isOdd");let t=r.sqrt(e);return r.isOdd(t)?r.neg(t):t}function _9(r){if(typeof r!="bigint")throw new Error("field order must be bigint");let e=r.toString(2).length;return Math.ceil(e/8)}function l2(r){let e=_9(r);return e+Math.ceil(e/2)}function S9(r,e,t=!1){let n=r.length,s=_9(e),i=l2(e);if(n<16||n<i||n>1024)throw new Error(`expected ${i}-1024 bytes of input, got ${n}`);let o=t?ks(r):Mn(r),a=ze(o,e-ft)+ft;return t?Ns(a,s):wi(a,s)}var FO=BigInt(0),u2=BigInt(1);function of(r,e){let t=(s,i)=>{let o=i.negate();return s?o:i},n=s=>{let i=Math.ceil(e/s)+1,o=2**(s-1);return{windows:i,windowSize:o}};return{constTimeNegate:t,unsafeLadder(s,i){let o=r.ZERO,a=s;for(;i>FO;)i&u2&&(o=o.add(a)),a=a.double(),i>>=u2;return o},precomputeWindow(s,i){let{windows:o,windowSize:a}=n(i),c=[],l=s,u=l;for(let f=0;f<o;f++){u=l,c.push(u);for(let h=1;h<a;h++)u=u.add(l),c.push(u);l=u.double()}return c},wNAF(s,i,o){let{windows:a,windowSize:c}=n(s),l=r.ZERO,u=r.BASE,f=BigInt(2**s-1),h=2**s,d=BigInt(s);for(let p=0;p<a;p++){let m=p*c,g=Number(o&f);o>>=d,g>c&&(g-=h,o+=u2);let y=m,w=m+Math.abs(g)-1,E=p%2!==0,R=g<0;g===0?u=u.add(t(E,i[y])):l=l.add(t(R,i[w]))}return{p:l,f:u}},wNAFCached(s,i,o,a){let c=s._WINDOW_SIZE||1,l=i.get(s);return l||(l=this.precomputeWindow(s,c),c!==1&&i.set(s,a(l))),this.wNAF(c,l,o)}}}function ul(r){return a2(r.Fp),pn(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...c2(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}var Un=BigInt(0),Gr=BigInt(1),af=BigInt(2),KO=BigInt(8),VO={zip215:!0};function qO(r){let e=ul(r);return pn(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function cf(r){let e=qO(r),{Fp:t,n,prehash:s,hash:i,randomBytes:o,nByteLength:a,h:c}=e,l=af<<BigInt(a*8)-Gr,u=t.create,f=e.uvRatio||((F,T)=>{try{return{isValid:!0,value:t.sqrt(F*t.inv(T))}}catch{return{isValid:!1,value:Un}}}),h=e.adjustScalarBytes||(F=>F),d=e.domain||((F,T,$)=>{if(T.length||$)throw new Error("Contexts/pre-hash are not supported");return F}),p=F=>typeof F=="bigint"&&Un<F,m=(F,T)=>p(F)&&p(T)&&F<T,g=F=>F===Un||m(F,l);function y(F,T){if(m(F,T))return F;throw new Error(`Expected valid scalar < ${T}, got ${typeof F} ${F}`)}function w(F){return F===Un?F:y(F,n)}let E=new Map;function R(F){if(!(F instanceof x))throw new Error("ExtendedPoint expected")}class x{constructor(T,$,Y,Z){if(this.ex=T,this.ey=$,this.ez=Y,this.et=Z,!g(T))throw new Error("x required");if(!g($))throw new Error("y required");if(!g(Y))throw new Error("z required");if(!g(Z))throw new Error("t required")}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(T){if(T instanceof x)throw new Error("extended point not allowed");let{x:$,y:Y}=T||{};if(!g($)||!g(Y))throw new Error("invalid affine point");return new x($,Y,Gr,u($*Y))}static normalizeZ(T){let $=t.invertBatch(T.map(Y=>Y.ez));return T.map((Y,Z)=>Y.toAffine($[Z])).map(x.fromAffine)}_setWindowSize(T){this._WINDOW_SIZE=T,E.delete(this)}assertValidity(){let{a:T,d:$}=e;if(this.is0())throw new Error("bad point: ZERO");let{ex:Y,ey:Z,ez:pe,et:ye}=this,Ae=u(Y*Y),we=u(Z*Z),ve=u(pe*pe),Je=u(ve*ve),Ye=u(Ae*T),Qt=u(ve*u(Ye+we)),Xt=u(Je+u($*u(Ae*we)));if(Qt!==Xt)throw new Error("bad point: equation left != right (1)");let Nt=u(Y*Z),sr=u(pe*ye);if(Nt!==sr)throw new Error("bad point: equation left != right (2)")}equals(T){R(T);let{ex:$,ey:Y,ez:Z}=this,{ex:pe,ey:ye,ez:Ae}=T,we=u($*Ae),ve=u(pe*Z),Je=u(Y*Ae),Ye=u(ye*Z);return we===ve&&Je===Ye}is0(){return this.equals(x.ZERO)}negate(){return new x(u(-this.ex),this.ey,this.ez,u(-this.et))}double(){let{a:T}=e,{ex:$,ey:Y,ez:Z}=this,pe=u($*$),ye=u(Y*Y),Ae=u(af*u(Z*Z)),we=u(T*pe),ve=$+Y,Je=u(u(ve*ve)-pe-ye),Ye=we+ye,Qt=Ye-Ae,Xt=we-ye,Nt=u(Je*Qt),sr=u(Ye*Xt),bs=u(Je*Xt),$i=u(Qt*Ye);return new x(Nt,sr,$i,bs)}add(T){R(T);let{a:$,d:Y}=e,{ex:Z,ey:pe,ez:ye,et:Ae}=this,{ex:we,ey:ve,ez:Je,et:Ye}=T;if($===BigInt(-1)){let v8=u((pe-Z)*(ve+we)),_8=u((pe+Z)*(ve-we)),qd=u(_8-v8);if(qd===Un)return this.double();let S8=u(ye*af*Ye),R8=u(Ae*af*Je),I8=R8+S8,T8=_8+v8,A8=R8-S8,_T=u(I8*qd),ST=u(T8*A8),RT=u(I8*A8),IT=u(qd*T8);return new x(_T,ST,IT,RT)}let Qt=u(Z*we),Xt=u(pe*ve),Nt=u(Ae*Y*Ye),sr=u(ye*Je),bs=u((Z+pe)*(we+ve)-Qt-Xt),$i=sr-Nt,Ic=sr+Nt,x8=u(Xt-$*Qt),wT=u(bs*$i),ET=u(Ic*x8),xT=u(bs*x8),vT=u($i*Ic);return new x(wT,ET,vT,xT)}subtract(T){return this.add(T.negate())}wNAF(T){return _.wNAFCached(this,E,T,x.normalizeZ)}multiply(T){let{p:$,f:Y}=this.wNAF(y(T,n));return x.normalizeZ([$,Y])[0]}multiplyUnsafe(T){let $=w(T);return $===Un?I:this.equals(I)||$===Gr?this:this.equals(v)?this.wNAF($).p:_.unsafeLadder(this,$)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return _.unsafeLadder(this,n).is0()}toAffine(T){let{ex:$,ey:Y,ez:Z}=this,pe=this.is0();T==null&&(T=pe?KO:t.inv(Z));let ye=u($*T),Ae=u(Y*T),we=u(Z*T);if(pe)return{x:Un,y:Gr};if(we!==Gr)throw new Error("invZ was invalid");return{x:ye,y:Ae}}clearCofactor(){let{h:T}=e;return T===Gr?this:this.multiplyUnsafe(T)}static fromHex(T,$=!1){let{d:Y,a:Z}=e,pe=t.BYTES;T=st("pointHex",T,pe);let ye=T.slice(),Ae=T[pe-1];ye[pe-1]=Ae&-129;let we=Mn(ye);we===Un||($?y(we,l):y(we,t.ORDER));let ve=u(we*we),Je=u(ve-Gr),Ye=u(Y*ve-Z),{isValid:Qt,value:Xt}=f(Je,Ye);if(!Qt)throw new Error("Point.fromHex: invalid y coordinate");let Nt=(Xt&Gr)===Gr,sr=(Ae&128)!==0;if(!$&&Xt===Un&&sr)throw new Error("Point.fromHex: x=0 and x_0=1");return sr!==Nt&&(Xt=u(-Xt)),x.fromAffine({x:Xt,y:we})}static fromPrivateKey(T){return N(T).point}toRawBytes(){let{x:T,y:$}=this.toAffine(),Y=Ns($,t.BYTES);return Y[Y.length-1]|=T&Gr?128:0,Y}toHex(){return Ps(this.toRawBytes())}}x.BASE=new x(e.Gx,e.Gy,Gr,u(e.Gx*e.Gy)),x.ZERO=new x(Un,Gr,Gr,Un);let{BASE:v,ZERO:I}=x,_=of(x,a*8);function D(F){return ze(F,n)}function O(F){return D(Mn(F))}function N(F){let T=a;F=st("private key",F,T);let $=st("hashed private key",i(F),2*T),Y=h($.slice(0,T)),Z=$.slice(T,2*T),pe=O(Y),ye=v.multiply(pe),Ae=ye.toRawBytes();return{head:Y,prefix:Z,scalar:pe,point:ye,pointBytes:Ae}}function U(F){return N(F).pointBytes}function z(F=new Uint8Array,...T){let $=Os(...T);return O(i(d($,st("context",F),!!s)))}function te(F,T,$={}){F=st("message",F),s&&(F=s(F));let{prefix:Y,scalar:Z,pointBytes:pe}=N(T),ye=z($.context,Y,F),Ae=v.multiply(ye).toRawBytes(),we=z($.context,Ae,pe,F),ve=D(ye+we*Z);w(ve);let Je=Os(Ae,Ns(ve,t.BYTES));return st("result",Je,a*2)}let P=VO;function L(F,T,$,Y=P){let{context:Z,zip215:pe}=Y,ye=t.BYTES;F=st("signature",F,2*ye),T=st("message",T),s&&(T=s(T));let Ae=Mn(F.slice(ye,2*ye)),we,ve,Je;try{we=x.fromHex($,pe),ve=x.fromHex(F.slice(0,ye),pe),Je=v.multiplyUnsafe(Ae)}catch{return!1}if(!pe&&we.isSmallOrder())return!1;let Ye=z(Z,ve.toRawBytes(),we.toRawBytes(),T);return ve.add(we.multiplyUnsafe(Ye)).subtract(Je).clearCofactor().equals(x.ZERO)}return v._setWindowSize(8),{CURVE:e,getPublicKey:U,sign:te,verify:L,ExtendedPoint:x,utils:{getExtendedPublicKey:N,randomPrivateKey:()=>o(t.BYTES),precompute(F=8,T=x.BASE){return T._setWindowSize(F),T.multiply(BigInt(3)),T}}}}var fl=BigInt(0),f2=BigInt(1);function zO(r){return pn(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function R9(r){let e=zO(r),{P:t}=e,n=E=>ze(E,t),s=e.montgomeryBits,i=Math.ceil(s/8),o=e.nByteLength,a=e.adjustScalarBytes||(E=>E),c=e.powPminus2||(E=>o2(E,t-BigInt(2),t));function l(E,R,x){let v=n(E*(R-x));return R=n(R-v),x=n(x+v),[R,x]}function u(E){if(typeof E=="bigint"&&fl<=E&&E<t)return E;throw new Error("Expected valid scalar 0 < scalar < CURVE.P")}let f=(e.a-BigInt(2))/BigInt(4);function h(E,R){let x=u(E),v=u(R),I=x,_=f2,D=fl,O=x,N=f2,U=fl,z;for(let P=BigInt(s-1);P>=fl;P--){let L=v>>P&f2;U^=L,z=l(U,_,O),_=z[0],O=z[1],z=l(U,D,N),D=z[0],N=z[1],U=L;let B=_+D,F=n(B*B),T=_-D,$=n(T*T),Y=F-$,Z=O+N,pe=O-N,ye=n(pe*B),Ae=n(Z*T),we=ye+Ae,ve=ye-Ae;O=n(we*we),N=n(I*n(ve*ve)),_=n(F*$),D=n(Y*(F+n(f*Y)))}z=l(U,_,O),_=z[0],O=z[1],z=l(U,D,N),D=z[0],N=z[1];let te=c(D);return n(_*te)}function d(E){return Ns(n(E),i)}function p(E){let R=st("u coordinate",E,i);return o===i&&(R[o-1]&=127),Mn(R)}function m(E){let R=st("scalar",E);if(R.length!==i&&R.length!==o)throw new Error(`Expected ${i} or ${o} bytes, got ${R.length}`);return Mn(a(R))}function g(E,R){let x=p(R),v=m(E),I=h(x,v);if(I===fl)throw new Error("Invalid private or public key received");return d(I)}let y=d(e.Gu);function w(E){return g(E,y)}return{scalarMult:g,scalarMultBase:w,getSharedSecret:(E,R)=>g(E,R),getPublicKey:E=>w(E),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:y}}var hl=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),I9=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752"),mJ=BigInt(0),$O=BigInt(1),h2=BigInt(2),HO=BigInt(5),T9=BigInt(10),WO=BigInt(20),GO=BigInt(40),A9=BigInt(80);function D9(r){let e=hl,n=r*r%e*r%e,s=it(n,h2,e)*n%e,i=it(s,$O,e)*r%e,o=it(i,HO,e)*i%e,a=it(o,T9,e)*o%e,c=it(a,WO,e)*a%e,l=it(c,GO,e)*c%e,u=it(l,A9,e)*l%e,f=it(u,A9,e)*l%e,h=it(f,T9,e)*o%e;return{pow_p_5_8:it(h,h2,e)*r%e,b2:n}}function C9(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function YO(r,e){let t=hl,n=ze(e*e*e,t),s=ze(n*n*e,t),i=D9(r*s).pow_p_5_8,o=ze(r*n*i,t),a=ze(e*o*o,t),c=o,l=ze(o*I9,t),u=a===r,f=a===ze(-r,t),h=a===ze(-r*I9,t);return u&&(o=c),(f||h)&&(o=l),x9(o,t)&&(o=ze(-o,t)),{isValid:u||f,value:o}}var Ls=sf(hl,void 0,!0),d2={a:BigInt(-1),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:Ls,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:BigInt(8),Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:t2,randomBytes:po,adjustScalarBytes:C9,uvRatio:YO},Ea=cf(d2);function P9(r,e,t){if(e.length>255)throw new Error("Context is too big");return j0(Zp("SigEd25519 no Ed25519 collisions"),new Uint8Array([t?1:0,e.length]),e,r)}var gJ=cf({...d2,domain:P9}),yJ=cf({...d2,domain:P9,prehash:t2}),dl=(()=>R9({P:hl,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{let e=hl,{pow_p_5_8:t,b2:n}=D9(r);return ze(it(t,BigInt(3),e)*n,e)},adjustScalarBytes:C9,randomBytes:po}))();var QO=(Ls.ORDER+BigInt(3))/BigInt(8),bJ=Ls.pow(h2,QO),wJ=Ls.sqrt(Ls.neg(Ls.ONE)),EJ=(Ls.ORDER-BigInt(5))/BigInt(8),xJ=BigInt(486662);var vJ=v9(Ls,Ls.neg(BigInt(486664)));var _J=BigInt("25063068953384623474111414158702152701244531502492656460079210482610430750235"),SJ=BigInt("54469307008909316920995813868745141605393597292927456921205312896311721017578"),RJ=BigInt("1159843021668779879193775521855586647937357759715417654439879720876111806838"),IJ=BigInt("40440834346308536858101042469323190826248399146238708352240133220865137265952");var TJ=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff");var xa=32,Bs=64,lf=32;async function k9(){let r=Ea.utils.randomPrivateKey(),e=Ea.getPublicKey(r);return{privateKey:B9(r,e),publicKey:e}}async function N9(r){if(r.length!==lf)throw new TypeError('"seed" must be 32 bytes in length.');if(!(r instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');let e=r,t=Ea.getPublicKey(e);return{privateKey:B9(e,t),publicKey:t}}async function O9(r,e){let t=r.subarray(0,lf);return Ea.sign(e,t)}async function L9(r,e,t){return Ea.verify(e,t,r)}function B9(r,e){let t=new Uint8Array(Bs);for(let n=0;n<lf;n++)t[n]=r[n],t[lf+n]=e[n];return t}var It={get(r=globalThis){let e=r.crypto;if(e==null||e.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var p2={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function uf(r){let e=r?.algorithm??"AES-GCM",t=r?.keyLength??16,n=r?.nonceLength??12,s=r?.digest??"SHA-256",i=r?.saltLength??16,o=r?.iterations??32767,a=It.get();t*=8;async function c(f,h){let d=a.getRandomValues(new Uint8Array(i)),p=a.getRandomValues(new Uint8Array(n)),m={name:e,iv:p};typeof h=="string"&&(h=Q(h));let g;if(h.length===0){g=await a.subtle.importKey("jwk",p2,{name:"AES-GCM"},!0,["encrypt"]);try{let w={name:"PBKDF2",salt:d,iterations:o,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}catch{g=await a.subtle.importKey("jwk",p2,{name:"AES-GCM"},!0,["encrypt"])}}else{let w={name:"PBKDF2",salt:d,iterations:o,hash:{name:s}},E=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);g=await a.subtle.deriveKey(w,E,{name:e,length:t},!0,["encrypt"])}let y=await a.subtle.encrypt(m,g,f);return _e([d,m.iv,new Uint8Array(y)])}async function l(f,h){let d=f.subarray(0,i),p=f.subarray(i,i+n),m=f.subarray(i+n),g={name:e,iv:p};typeof h=="string"&&(h=Q(h));let y;if(h.length===0)try{let E={name:"PBKDF2",salt:d,iterations:o,hash:{name:s}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(E,R,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",p2,{name:"AES-GCM"},!0,["decrypt"])}else{let E={name:"PBKDF2",salt:d,iterations:o,hash:{name:s}},R=await a.subtle.importKey("raw",h,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(E,R,{name:e,length:t},!0,["decrypt"])}let w=await a.subtle.decrypt(g,y,m);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}async function va(r,e){let n=await uf().encrypt(r,e);return Zn.encode(n)}var _a={};Ce(_a,{KeyType:()=>ot,PrivateKey:()=>Kn,PublicKey:()=>Fn});var ot;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.Secp256k1="Secp256k1"})(ot||(ot={}));var m2;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.Secp256k1=2]="Secp256k1"})(m2||(m2={}));(function(r){r.codec=()=>lt(m2)})(ot||(ot={}));var Fn;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ot.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.Type=ot.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Fn||(Fn={}));var Kn;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),ot.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.Type=ot.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Kn||(Kn={}));var pl=class{_key;constructor(e){this._key=Sa(e,xa)}async verify(e,t){return L9(this._key,t,e)}marshal(){return this._key}get bytes(){return Fn.encode({Type:ot.Ed25519,Data:this.marshal()}).subarray()}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}},yo=class{_key;_publicKey;constructor(e,t){this._key=Sa(e,Bs),this._publicKey=Sa(t,xa)}async sign(e){return O9(this._key,e)}get public(){return new pl(this._publicKey)}marshal(){return this._key}get bytes(){return Kn.encode({Type:ot.Ed25519,Data:this.marshal()}).subarray()}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}async id(){let e=es.digest(this.public.bytes);return be.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return va(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function jO(r){if(r.length>Bs){r=Sa(r,Bs+xa);let n=r.subarray(0,Bs),s=r.subarray(Bs,r.length);return new yo(n,s)}r=Sa(r,Bs);let e=r.subarray(0,Bs),t=r.subarray(xa);return new yo(e,t)}function ZO(r){return r=Sa(r,xa),new pl(r)}async function JO(){let{privateKey:r,publicKey:e}=await k9();return new yo(r,e)}async function g2(r){let{privateKey:e,publicKey:t}=await N9(r);return new yo(e,t)}function Sa(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new b(`Key must be a Uint8Array of length ${e}, got ${r.length}`,"ERR_INVALID_KEY_TYPE");return r}var zJ=re(Rt(),1),$J=re($0(),1),U9=re(Qe(),1);function Vn(r,e){let t=Uint8Array.from(r.abs().toByteArray());if(t=t[0]===0?t.subarray(1):t,e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=_e([new Uint8Array(e-t.length),t])}return W(t,"base64url")}function Yr(r){let e=ff(r);return new U9.default.jsbn.BigInteger(W(e,"base16"),16)}function ff(r,e){let t=Q(r,"base64urlpad");if(e!=null){if(t.length>e)throw new Error("byte array longer than desired length");t=_e([new Uint8Array(e-t.length),t])}return t}var F9={"P-256":256,"P-384":384,"P-521":521},eL=Object.keys(F9),b2=eL.join(" / ");async function K9(r){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new b(`Unknown curve: ${r}. Must be ${b2}`,"ERR_INVALID_CURVE");let e=await It.get().subtle.generateKey({name:"ECDH",namedCurve:r},!0,["deriveBits"]),t=async(i,o)=>{let a;o!=null?a=await It.get().subtle.importKey("jwk",rL(r,o),{name:"ECDH",namedCurve:r},!1,["deriveBits"]):a=e.privateKey;let c=await It.get().subtle.importKey("jwk",q9(r,i),{name:"ECDH",namedCurve:r},!1,[]),l=await It.get().subtle.deriveBits({name:"ECDH",namedCurve:r,public:c},a,F9[r]);return new Uint8Array(l,0,l.byteLength)},n=await It.get().subtle.exportKey("jwk",e.publicKey);return{key:tL(n),genSharedKey:t}}var V9={"P-256":32,"P-384":48,"P-521":66};function tL(r){if(r.crv==null||r.x==null||r.y==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");if(r.crv!=="P-256"&&r.crv!=="P-384"&&r.crv!=="P-521")throw new b(`Unknown curve: ${r.crv}. Must be ${b2}`,"ERR_INVALID_CURVE");let e=V9[r.crv];return _e([Uint8Array.from([4]),ff(r.x,e),ff(r.y,e)],1+e*2)}function q9(r,e){if(r!=="P-256"&&r!=="P-384"&&r!=="P-521")throw new b(`Unknown curve: ${r}. Must be ${b2}`,"ERR_INVALID_CURVE");let t=V9[r];if(!me(e.subarray(0,1),Uint8Array.from([4])))throw new b("Cannot unmarshal public key - invalid key format","ERR_INVALID_KEY_FORMAT");return{kty:"EC",crv:r,x:W(e.subarray(1,t+1),"base64url"),y:W(e.subarray(1+t),"base64url"),ext:!0}}var rL=(r,e)=>({...q9(r,e.public),d:W(e.private,"base64url")});var z9=K9;async function $9(r,e){let t=Zn.decode(r);return uf().decrypt(t,e)}var H9={SHA1:20,SHA256:32,SHA512:64};var nL={SHA1:"SHA-1",SHA256:"SHA-256",SHA512:"SHA-512"},sL=async(r,e)=>{let t=await It.get().subtle.sign({name:"HMAC"},r,e);return new Uint8Array(t,0,t.byteLength)};async function W9(r,e){let t=nL[r],n=await It.get().subtle.importKey("raw",e,{name:"HMAC",hash:{name:t}},!1,["sign"]);return{async digest(s){return sL(n,s)},length:H9[r]}}var Y9={"AES-128":{ivSize:16,keySize:16},"AES-256":{ivSize:16,keySize:32},Blowfish:{ivSize:8,keySize:32}};async function Q9(r,e,t){let n=Y9[r];if(n==null){let w=Object.keys(Y9).join(" / ");throw new b(`unknown cipher type '${r}'. Must be ${w}`,"ERR_INVALID_CIPHER_TYPE")}if(e==null)throw new b("missing hash type","ERR_MISSING_HASH_TYPE");let s=n.keySize,i=n.ivSize,o=20,a=Q("key expansion"),c=2*(i+s+o),l=await W9(e,t),u=await l.digest(a),f=[],h=0;for(;h<c;){let w=await l.digest(_e([u,a])),E=w.length;h+E>c&&(E=c-h),f.push(w),h+=E,u=await l.digest(u)}let d=c/2,p=_e(f),m=p.subarray(0,d),g=p.subarray(d,c),y=w=>({iv:w.subarray(0,i),cipherKey:w.subarray(i,i+s),macKey:w.subarray(i+s)});return{k1:y(m),k2:y(g)}}var _2={};Ce(_2,{MAX_KEY_SIZE:()=>bl,RsaPrivateKey:()=>Ra,RsaPublicKey:()=>yl,fromJwk:()=>pL,generateKeyPair:()=>mL,unmarshalRsaPrivateKey:()=>hL,unmarshalRsaPublicKey:()=>dL});var gl=re(Qe(),1);var Lee=re(eb(),1);function Pr(r){if(isNaN(r)||r<=0)throw new b("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return po(r)}var yee=re(G0(),1),x2=re(Qe(),1);function tb(r,e){return e.map(t=>Yr(r[t]))}function rb(r){return x2.default.pki.setRsaPrivateKey(...tb(r,["n","e","d","p","q","dp","dq","qi"]))}function nb(r){return x2.default.pki.setRsaPublicKey(...tb(r,["n","e"]))}var wo={};Ce(wo,{jwkToPkcs1:()=>aL,jwkToPkix:()=>lL,pkcs1ToJwk:()=>oL,pkixToJwk:()=>cL});var Eee=re(sl(),1),xee=re(G0(),1);var Ms=re(Qe(),1);function oL(r){let e=Ms.default.asn1.fromDer(W(r,"ascii")),t=Ms.default.pki.privateKeyFromAsn1(e);return{kty:"RSA",n:Vn(t.n),e:Vn(t.e),d:Vn(t.d),p:Vn(t.p),q:Vn(t.q),dp:Vn(t.dP),dq:Vn(t.dQ),qi:Vn(t.qInv),alg:"RS256"}}function aL(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");let e=Ms.default.pki.privateKeyToAsn1({n:Yr(r.n),e:Yr(r.e),d:Yr(r.d),p:Yr(r.p),q:Yr(r.q),dP:Yr(r.dp),dQ:Yr(r.dq),qInv:Yr(r.qi)});return Q(Ms.default.asn1.toDer(e).getBytes(),"ascii")}function cL(r){let e=Ms.default.asn1.fromDer(W(r,"ascii")),t=Ms.default.pki.publicKeyFromAsn1(e);return{kty:"RSA",n:Vn(t.n),e:Vn(t.e)}}function lL(r){if(r.n==null||r.e==null)throw new b("JWK was missing components","ERR_INVALID_PARAMETERS");let e=Ms.default.pki.publicKeyToAsn1({n:Yr(r.n),e:Yr(r.e)});return Q(Ms.default.asn1.toDer(e).getBytes(),"ascii")}async function sb(r){let e=await It.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await ab(e);return{privateKey:t[0],publicKey:t[1]}}async function v2(r){let t=[await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await uL(r)],n=await ab({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function ib(r,e){let t=await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await It.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,Uint8Array.from(e));return new Uint8Array(n,0,n.byteLength)}async function ob(r,e,t){let n=await It.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return It.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t)}async function ab(r){if(r.privateKey==null||r.publicKey==null)throw new b("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([It.get().subtle.exportKey("jwk",r.privateKey),It.get().subtle.exportKey("jwk",r.publicKey)])}async function uL(r){return It.get().subtle.importKey("jwk",{kty:r.kty,n:r.n,e:r.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function cb(r,e,t,n){let s=e?nb(r):rb(r),i=W(Uint8Array.from(t),"ascii"),o=n(i,s);return Q(o,"ascii")}function lb(r,e){return cb(r,!0,e,(t,n)=>n.encrypt(t))}function ub(r,e){return cb(r,!1,e,(t,n)=>n.decrypt(t))}function hf(r){if(r.kty!=="RSA")throw new b("invalid key type","ERR_INVALID_KEY_TYPE");if(r.n==null)throw new b("invalid key modulus","ERR_INVALID_KEY_MODULUS");return Q(r.n,"base64url").length*8}var bl=8192,yl=class{_key;constructor(e){this._key=e}async verify(e,t){return ob(this._key,t,e)}marshal(){return wo.jwkToPkix(this._key)}get bytes(){return Fn.encode({Type:ot.RSA,Data:this.marshal()}).subarray()}encrypt(e){return lb(this._key,e)}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}},Ra=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Pr(16)}async sign(e){return ib(this._key,e)}get public(){if(this._publicKey==null)throw new b("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new yl(this._publicKey)}decrypt(e){return ub(this._key,e)}marshal(){return wo.jwkToPkcs1(this._key)}get bytes(){return Kn.encode({Type:ot.RSA,Data:this.marshal()}).subarray()}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}async id(){let e=await this.public.hash();return W(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8"){let n=new gl.default.util.ByteBuffer(this.marshal()),s=gl.default.asn1.fromDer(n),i=gl.default.pki.privateKeyFromAsn1(s),o={algorithm:"aes256",count:1e4,saltSize:128/8,prfAlgorithm:"sha512"};return gl.default.pki.encryptRsaPrivateKey(i,e,o)}else{if(t==="libp2p-key")return va(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}};async function hL(r){let e=wo.pkcs1ToJwk(r);if(hf(e)>bl)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let t=await v2(e);return new Ra(t.privateKey,t.publicKey)}function dL(r){let e=wo.pkixToJwk(r);if(hf(e)>bl)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new yl(e)}async function pL(r){if(hf(r)>bl)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await v2(r);return new Ra(e.privateKey,e.publicKey)}async function mL(r){if(r>bl)throw new b("key size is too large","ERR_KEY_SIZE_TOO_LARGE");let e=await sb(r);return new Ra(e.privateKey,e.publicKey)}var A2={};Ce(A2,{Secp256k1PrivateKey:()=>El,Secp256k1PublicKey:()=>wl,generateKeyPair:()=>CL,unmarshalSecp256k1PrivateKey:()=>AL,unmarshalSecp256k1PublicKey:()=>DL});var gL=(r,e,t)=>r&e^~r&t,yL=(r,e,t)=>r&e^r&t^e&t,bL=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ei=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),xi=new Uint32Array(64),S2=class extends wa{constructor(){super(64,32,8,!1),this.A=Ei[0]|0,this.B=Ei[1]|0,this.C=Ei[2]|0,this.D=Ei[3]|0,this.E=Ei[4]|0,this.F=Ei[5]|0,this.G=Ei[6]|0,this.H=Ei[7]|0}get(){let{A:e,B:t,C:n,D:s,E:i,F:o,G:a,H:c}=this;return[e,t,n,s,i,o,a,c]}set(e,t,n,s,i,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=i|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let f=0;f<16;f++,t+=4)xi[f]=e.getUint32(t,!1);for(let f=16;f<64;f++){let h=xi[f-15],d=xi[f-2],p=Bn(h,7)^Bn(h,18)^h>>>3,m=Bn(d,17)^Bn(d,19)^d>>>10;xi[f]=m+xi[f-7]+p+xi[f-16]|0}let{A:n,B:s,C:i,D:o,E:a,F:c,G:l,H:u}=this;for(let f=0;f<64;f++){let h=Bn(a,6)^Bn(a,11)^Bn(a,25),d=u+h+gL(a,c,l)+bL[f]+xi[f]|0,m=(Bn(n,2)^Bn(n,13)^Bn(n,22))+yL(n,s,i)|0;u=l,l=c,c=a,a=o+d|0,o=i,i=s,s=n,n=d+m|0}n=n+this.A|0,s=s+this.B|0,i=i+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,u=u+this.H|0,this.set(n,s,i,o,a,c,l,u)}roundClean(){xi.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Ia=Z0(()=>new S2);function wL(r){let e=ul(r);pn(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:n,a:s}=e;if(t){if(!n.eql(s,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:EL,hexToBytes:xL}=rf,Eo={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){let{Err:e}=Eo;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");let t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:EL(n),l:r.subarray(t+2)}},toSig(r){let{Err:e}=Eo,t=typeof r=="string"?xL(r):r;if(!(t instanceof Uint8Array))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");let{d:s,l:i}=Eo._parseInt(t.subarray(2)),{d:o,l:a}=Eo._parseInt(i);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:s,s:o}},hexFromSig(r){let e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,t=l=>{let u=l.toString(16);return u.length&1?`0${u}`:u},n=e(t(r.s)),s=e(t(r.r)),i=n.length/2,o=s.length/2,a=t(i),c=t(o);return`30${t(o+i+4)}02${c}${s}02${a}${n}`}},Us=BigInt(0),mn=BigInt(1),$ee=BigInt(2),fb=BigInt(3),Hee=BigInt(4);function vL(r){let e=wL(r),{Fp:t}=e,n=e.toBytes||((p,m,g)=>{let y=m.toAffine();return Os(Uint8Array.from([4]),t.toBytes(y.x),t.toBytes(y.y))}),s=e.fromBytes||(p=>{let m=p.subarray(1),g=t.fromBytes(m.subarray(0,t.BYTES)),y=t.fromBytes(m.subarray(t.BYTES,2*t.BYTES));return{x:g,y}});function i(p){let{a:m,b:g}=e,y=t.sqr(p),w=t.mul(y,p);return t.add(t.add(w,t.mul(p,m)),g)}if(!t.eql(t.sqr(e.Gy),i(e.Gx)))throw new Error("bad generator point: equation left != right");function o(p){return typeof p=="bigint"&&Us<p&&p<e.n}function a(p){if(!o(p))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(p){let{allowedPrivateKeyLengths:m,nByteLength:g,wrapPrivateKey:y,n:w}=e;if(m&&typeof p!="bigint"){if(p instanceof Uint8Array&&(p=Ps(p)),typeof p!="string"||!m.includes(p.length))throw new Error("Invalid key");p=p.padStart(g*2,"0")}let E;try{E=typeof p=="bigint"?p:ks(st("private key",p,g))}catch{throw new Error(`private key must be ${g} bytes, hex or bigint, not ${typeof p}`)}return y&&(E=ze(E,w)),a(E),E}let l=new Map;function u(p){if(!(p instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(m,g,y){if(this.px=m,this.py=g,this.pz=y,m==null||!t.isValid(m))throw new Error("x required");if(g==null||!t.isValid(g))throw new Error("y required");if(y==null||!t.isValid(y))throw new Error("z required")}static fromAffine(m){let{x:g,y}=m||{};if(!m||!t.isValid(g)||!t.isValid(y))throw new Error("invalid affine point");if(m instanceof f)throw new Error("projective point not allowed");let w=E=>t.eql(E,t.ZERO);return w(g)&&w(y)?f.ZERO:new f(g,y,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(m){let g=t.invertBatch(m.map(y=>y.pz));return m.map((y,w)=>y.toAffine(g[w])).map(f.fromAffine)}static fromHex(m){let g=f.fromAffine(s(st("pointHex",m)));return g.assertValidity(),g}static fromPrivateKey(m){return f.BASE.multiply(c(m))}_setWindowSize(m){this._WINDOW_SIZE=m,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}let{x:m,y:g}=this.toAffine();if(!t.isValid(m)||!t.isValid(g))throw new Error("bad point: x or y not FE");let y=t.sqr(g),w=i(m);if(!t.eql(y,w))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){let{y:m}=this.toAffine();if(t.isOdd)return!t.isOdd(m);throw new Error("Field doesn't support isOdd")}equals(m){u(m);let{px:g,py:y,pz:w}=this,{px:E,py:R,pz:x}=m,v=t.eql(t.mul(g,x),t.mul(E,w)),I=t.eql(t.mul(y,x),t.mul(R,w));return v&&I}negate(){return new f(this.px,t.neg(this.py),this.pz)}double(){let{a:m,b:g}=e,y=t.mul(g,fb),{px:w,py:E,pz:R}=this,x=t.ZERO,v=t.ZERO,I=t.ZERO,_=t.mul(w,w),D=t.mul(E,E),O=t.mul(R,R),N=t.mul(w,E);return N=t.add(N,N),I=t.mul(w,R),I=t.add(I,I),x=t.mul(m,I),v=t.mul(y,O),v=t.add(x,v),x=t.sub(D,v),v=t.add(D,v),v=t.mul(x,v),x=t.mul(N,x),I=t.mul(y,I),O=t.mul(m,O),N=t.sub(_,O),N=t.mul(m,N),N=t.add(N,I),I=t.add(_,_),_=t.add(I,_),_=t.add(_,O),_=t.mul(_,N),v=t.add(v,_),O=t.mul(E,R),O=t.add(O,O),_=t.mul(O,N),x=t.sub(x,_),I=t.mul(O,D),I=t.add(I,I),I=t.add(I,I),new f(x,v,I)}add(m){u(m);let{px:g,py:y,pz:w}=this,{px:E,py:R,pz:x}=m,v=t.ZERO,I=t.ZERO,_=t.ZERO,D=e.a,O=t.mul(e.b,fb),N=t.mul(g,E),U=t.mul(y,R),z=t.mul(w,x),te=t.add(g,y),P=t.add(E,R);te=t.mul(te,P),P=t.add(N,U),te=t.sub(te,P),P=t.add(g,w);let L=t.add(E,x);return P=t.mul(P,L),L=t.add(N,z),P=t.sub(P,L),L=t.add(y,w),v=t.add(R,x),L=t.mul(L,v),v=t.add(U,z),L=t.sub(L,v),_=t.mul(D,P),v=t.mul(O,z),_=t.add(v,_),v=t.sub(U,_),_=t.add(U,_),I=t.mul(v,_),U=t.add(N,N),U=t.add(U,N),z=t.mul(D,z),P=t.mul(O,P),U=t.add(U,z),z=t.sub(N,z),z=t.mul(D,z),P=t.add(P,z),N=t.mul(U,P),I=t.add(I,N),N=t.mul(L,P),v=t.mul(te,v),v=t.sub(v,N),N=t.mul(te,U),_=t.mul(L,_),_=t.add(_,N),new f(v,I,_)}subtract(m){return this.add(m.negate())}is0(){return this.equals(f.ZERO)}wNAF(m){return d.wNAFCached(this,l,m,g=>{let y=t.invertBatch(g.map(w=>w.pz));return g.map((w,E)=>w.toAffine(y[E])).map(f.fromAffine)})}multiplyUnsafe(m){let g=f.ZERO;if(m===Us)return g;if(a(m),m===mn)return this;let{endo:y}=e;if(!y)return d.unsafeLadder(this,m);let{k1neg:w,k1:E,k2neg:R,k2:x}=y.splitScalar(m),v=g,I=g,_=this;for(;E>Us||x>Us;)E&mn&&(v=v.add(_)),x&mn&&(I=I.add(_)),_=_.double(),E>>=mn,x>>=mn;return w&&(v=v.negate()),R&&(I=I.negate()),I=new f(t.mul(I.px,y.beta),I.py,I.pz),v.add(I)}multiply(m){a(m);let g=m,y,w,{endo:E}=e;if(E){let{k1neg:R,k1:x,k2neg:v,k2:I}=E.splitScalar(g),{p:_,f:D}=this.wNAF(x),{p:O,f:N}=this.wNAF(I);_=d.constTimeNegate(R,_),O=d.constTimeNegate(v,O),O=new f(t.mul(O.px,E.beta),O.py,O.pz),y=_.add(O),w=D.add(N)}else{let{p:R,f:x}=this.wNAF(g);y=R,w=x}return f.normalizeZ([y,w])[0]}multiplyAndAddUnsafe(m,g,y){let w=f.BASE,E=(x,v)=>v===Us||v===mn||!x.equals(w)?x.multiplyUnsafe(v):x.multiply(v),R=E(this,g).add(E(m,y));return R.is0()?void 0:R}toAffine(m){let{px:g,py:y,pz:w}=this,E=this.is0();m==null&&(m=E?t.ONE:t.inv(w));let R=t.mul(g,m),x=t.mul(y,m),v=t.mul(w,m);if(E)return{x:t.ZERO,y:t.ZERO};if(!t.eql(v,t.ONE))throw new Error("invZ was invalid");return{x:R,y:x}}isTorsionFree(){let{h:m,isTorsionFree:g}=e;if(m===mn)return!0;if(g)return g(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:m,clearCofactor:g}=e;return m===mn?this:g?g(f,this):this.multiplyUnsafe(e.h)}toRawBytes(m=!0){return this.assertValidity(),n(f,this,m)}toHex(m=!0){return Ps(this.toRawBytes(m))}}f.BASE=new f(e.Gx,e.Gy,t.ONE),f.ZERO=new f(t.ZERO,t.ONE,t.ZERO);let h=e.nBitLength,d=of(f,e.endo?Math.ceil(h/2):h);return{CURVE:e,ProjectivePoint:f,normPrivateKeyToScalar:c,weierstrassEquation:i,isWithinCurveOrder:o}}function _L(r){let e=ul(r);return pn(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function hb(r){let e=_L(r),{Fp:t,n}=e,s=t.BYTES+1,i=2*t.BYTES+1;function o(P){return Us<P&&P<t.ORDER}function a(P){return ze(P,n)}function c(P){return nf(P,n)}let{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:f,isWithinCurveOrder:h}=vL({...e,toBytes(P,L,B){let F=L.toAffine(),T=t.toBytes(F.x),$=Os;return B?$(Uint8Array.from([L.hasEvenY()?2:3]),T):$(Uint8Array.from([4]),T,t.toBytes(F.y))},fromBytes(P){let L=P.length,B=P[0],F=P.subarray(1);if(L===s&&(B===2||B===3)){let T=ks(F);if(!o(T))throw new Error("Point is not on curve");let $=f(T),Y=t.sqrt($),Z=(Y&mn)===mn;return(B&1)===1!==Z&&(Y=t.neg(Y)),{x:T,y:Y}}else if(L===i&&B===4){let T=t.fromBytes(F.subarray(0,t.BYTES)),$=t.fromBytes(F.subarray(t.BYTES,2*t.BYTES));return{x:T,y:$}}else throw new Error(`Point of length ${L} was invalid. Expected ${s} compressed bytes or ${i} uncompressed bytes`)}}),d=P=>Ps(wi(P,e.nByteLength));function p(P){let L=n>>mn;return P>L}function m(P){return p(P)?a(-P):P}let g=(P,L,B)=>ks(P.slice(L,B));class y{constructor(L,B,F){this.r=L,this.s=B,this.recovery=F,this.assertValidity()}static fromCompact(L){let B=e.nByteLength;return L=st("compactSignature",L,B*2),new y(g(L,0,B),g(L,B,2*B))}static fromDER(L){let{r:B,s:F}=Eo.toSig(st("DER",L));return new y(B,F)}assertValidity(){if(!h(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!h(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(L){return new y(this.r,this.s,L)}recoverPublicKey(L){let{r:B,s:F,recovery:T}=this,$=I(st("msgHash",L));if(T==null||![0,1,2,3].includes(T))throw new Error("recovery id invalid");let Y=T===2||T===3?B+e.n:B;if(Y>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let Z=T&1?"03":"02",pe=l.fromHex(Z+d(Y)),ye=c(Y),Ae=a(-$*ye),we=a(F*ye),ve=l.BASE.multiplyAndAddUnsafe(pe,Ae,we);if(!ve)throw new Error("point at infinify");return ve.assertValidity(),ve}hasHighS(){return p(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return mo(this.toDERHex())}toDERHex(){return Eo.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return mo(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}let w={isValidPrivateKey(P){try{return u(P),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{let P=l2(e.n);return S9(e.randomBytes(P),e.n)},precompute(P=8,L=l.BASE){return L._setWindowSize(P),L.multiply(BigInt(3)),L}};function E(P,L=!0){return l.fromPrivateKey(P).toRawBytes(L)}function R(P){let L=P instanceof Uint8Array,B=typeof P=="string",F=(L||B)&&P.length;return L?F===s||F===i:B?F===2*s||F===2*i:P instanceof l}function x(P,L,B=!0){if(R(P))throw new Error("first arg must be private key");if(!R(L))throw new Error("second arg must be public key");return l.fromHex(L).multiply(u(P)).toRawBytes(B)}let v=e.bits2int||function(P){let L=ks(P),B=P.length*8-e.nBitLength;return B>0?L>>BigInt(B):L},I=e.bits2int_modN||function(P){return a(v(P))},_=ll(e.nBitLength);function D(P){if(typeof P!="bigint")throw new Error("bigint expected");if(!(Us<=P&&P<_))throw new Error(`bigint expected < 2^${e.nBitLength}`);return wi(P,e.nByteLength)}function O(P,L,B=N){if(["recovered","canonical"].some(Ye=>Ye in B))throw new Error("sign() legacy options not supported");let{hash:F,randomBytes:T}=e,{lowS:$,prehash:Y,extraEntropy:Z}=B;$==null&&($=!0),P=st("msgHash",P),Y&&(P=st("prehashed msgHash",F(P)));let pe=I(P),ye=u(L),Ae=[D(ye),D(pe)];if(Z!=null){let Ye=Z===!0?T(t.BYTES):Z;Ae.push(st("extraEntropy",Ye))}let we=Os(...Ae),ve=pe;function Je(Ye){let Qt=v(Ye);if(!h(Qt))return;let Xt=c(Qt),Nt=l.BASE.multiply(Qt).toAffine(),sr=a(Nt.x);if(sr===Us)return;let bs=a(Xt*a(ve+sr*ye));if(bs===Us)return;let $i=(Nt.x===sr?0:2)|Number(Nt.y&mn),Ic=bs;return $&&p(bs)&&(Ic=m(bs),$i^=1),new y(sr,Ic,$i)}return{seed:we,k2sig:Je}}let N={lowS:e.lowS,prehash:!1},U={lowS:e.lowS,prehash:!1};function z(P,L,B=N){let{seed:F,k2sig:T}=O(P,L,B),$=e;return s2($.hash.outputLen,$.nByteLength,$.hmac)(F,T)}l.BASE._setWindowSize(8);function te(P,L,B,F=U){let T=P;if(L=st("msgHash",L),B=st("publicKey",B),"strict"in F)throw new Error("options.strict was renamed to lowS");let{lowS:$,prehash:Y}=F,Z,pe;try{if(typeof T=="string"||T instanceof Uint8Array)try{Z=y.fromDER(T)}catch(Nt){if(!(Nt instanceof Eo.Err))throw Nt;Z=y.fromCompact(T)}else if(typeof T=="object"&&typeof T.r=="bigint"&&typeof T.s=="bigint"){let{r:Nt,s:sr}=T;Z=new y(Nt,sr)}else throw new Error("PARSE");pe=l.fromHex(B)}catch(Nt){if(Nt.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if($&&Z.hasHighS())return!1;Y&&(L=e.hash(L));let{r:ye,s:Ae}=Z,we=I(L),ve=c(Ae),Je=a(we*ve),Ye=a(ye*ve),Qt=l.BASE.multiplyAndAddUnsafe(pe,Je,Ye)?.toAffine();return Qt?a(Qt.x)===ye:!1}return{CURVE:e,getPublicKey:E,getSharedSecret:x,sign:z,verify:te,ProjectivePoint:l,Signature:y,utils:w}}var df=class extends ba{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,cl(e);let n=gi(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let s=this.blockLen,i=new Uint8Array(s);i.set(n.length>s?e.create().update(n).digest():n);for(let o=0;o<i.length;o++)i[o]^=54;this.iHash.update(i),this.oHash=e.create();for(let o=0;o<i.length;o++)i[o]^=106;this.oHash.update(i),i.fill(0)}update(e){return ya(this),this.iHash.update(e),this}digestInto(e){ya(this),jp(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:n,finished:s,destroyed:i,blockLen:o,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ta=(r,e,t)=>new df(r,e).update(t).digest();Ta.create=(r,e)=>new df(r,e);function SL(r){return{hash:r,hmac:(e,...t)=>Ta(r,e,j0(...t)),randomBytes:po}}function db(r,e){let t=n=>hb({...r,...SL(n)});return Object.freeze({...t(e),create:t})}var gb=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),pb=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),RL=BigInt(1),R2=BigInt(2),mb=(r,e)=>(r+e/R2)/e;function IL(r){let e=gb,t=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,u=l*l*r%e,f=it(u,t,e)*u%e,h=it(f,t,e)*u%e,d=it(h,R2,e)*l%e,p=it(d,s,e)*d%e,m=it(p,i,e)*p%e,g=it(m,a,e)*m%e,y=it(g,c,e)*g%e,w=it(y,a,e)*m%e,E=it(w,t,e)*u%e,R=it(E,o,e)*p%e,x=it(R,n,e)*l%e,v=it(x,R2,e);if(!I2.eql(I2.sqr(v),r))throw new Error("Cannot find square root");return v}var I2=sf(gb,void 0,void 0,{sqrt:IL}),Fs=db({a:BigInt(0),b:BigInt(7),Fp:I2,n:pb,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{let e=pb,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-RL*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=t,o=BigInt("0x100000000000000000000000000000000"),a=mb(i*r,e),c=mb(-n*r,e),l=ze(r-a*t-c*s,e),u=ze(-a*n-c*i,e),f=l>o,h=u>o;if(f&&(l=e-l),h&&(u=e-u),l>o||u>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:f,k1:l,k2neg:h,k2:u}}}},Ia),nte=BigInt(0);var ste=Fs.ProjectivePoint;function yb(){return Fs.utils.randomPrivateKey()}async function bb(r,e){let{digest:t}=await Ne.digest(e);try{return Fs.sign(t,r).toDERRawBytes()}catch(n){throw new b(String(n),"ERR_INVALID_INPUT")}}async function wb(r,e,t){try{let{digest:n}=await Ne.digest(t);return Fs.verify(e,n,r)}catch(n){throw new b(String(n),"ERR_INVALID_INPUT")}}function Eb(r){return Fs.ProjectivePoint.fromHex(r).toRawBytes(!0)}function xb(r){try{Fs.getPublicKey(r,!0)}catch(e){throw new b(String(e),"ERR_INVALID_PRIVATE_KEY")}}function T2(r){try{Fs.ProjectivePoint.fromHex(r)}catch(e){throw new b(String(e),"ERR_INVALID_PUBLIC_KEY")}}function vb(r){try{return Fs.getPublicKey(r,!0)}catch(e){throw new b(String(e),"ERR_INVALID_PRIVATE_KEY")}}var wl=class{_key;constructor(e){T2(e),this._key=e}async verify(e,t){return wb(this._key,t,e)}marshal(){return Eb(this._key)}get bytes(){return Fn.encode({Type:ot.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}},El=class{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??vb(e),xb(this._key),T2(this._publicKey)}async sign(e){return bb(this._key,e)}get public(){return new wl(this._publicKey)}marshal(){return this._key}get bytes(){return Kn.encode({Type:ot.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return me(this.bytes,e.bytes)}async hash(){let{bytes:e}=await Ne.digest(this.bytes);return e}async id(){let e=await this.public.hash();return W(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return va(this.bytes,e);throw new b(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}};function AL(r){return new El(r)}function DL(r){return new wl(r)}async function CL(){let r=yb();return new El(r)}var us={rsa:_2,ed25519:y2,secp256k1:A2};function D2(r){let e=Object.keys(us).join(" / ");return new b(`invalid or unsupported key type ${r}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function C2(r){if(r=r.toLowerCase(),r==="rsa"||r==="ed25519"||r==="secp256k1")return us[r];throw D2(r)}async function xl(r,e){return C2(r).generateKeyPair(e??2048)}async function PL(r,e,t){if(r.toLowerCase()!=="ed25519")throw new b("Seed key derivation is unimplemented for RSA or secp256k1","ERR_UNSUPPORTED_KEY_DERIVATION_TYPE");return g2(e)}function kr(r){let e=Fn.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case ot.RSA:return us.rsa.unmarshalRsaPublicKey(t);case ot.Ed25519:return us.ed25519.unmarshalEd25519PublicKey(t);case ot.Secp256k1:return us.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw D2(e.Type??"unknown")}}function vl(r,e){return e=(e??"rsa").toLowerCase(),C2(e),r.bytes}async function qn(r){let e=Kn.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case ot.RSA:return us.rsa.unmarshalRsaPrivateKey(t);case ot.Ed25519:return us.ed25519.unmarshalEd25519PrivateKey(t);case ot.Secp256k1:return us.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw D2(e.Type??"RSA")}}function P2(r,e){return e=(e??"rsa").toLowerCase(),C2(e),r.bytes}async function Aa(r,e){try{let s=await $9(r,e);return await qn(s)}catch{}let t=pf.default.pki.decryptRsaPrivateKey(r,e);if(t===null)throw new b("Cannot read the key, most likely the password is wrong or not a RSA key","ERR_CANNOT_DECRYPT_PEM");let n=pf.default.asn1.toDer(pf.default.pki.privateKeyToAsn1(t));return n=Q(n.getBytes(),"ascii"),us.rsa.unmarshalRsaPrivateKey(n)}var _l=Symbol.for("@libp2p/content-routing");var Ue=class extends EventTarget{#e=new Map;listenerCount(e){let t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,n){super.addEventListener(e,t,n);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(n!==!0&&n!==!1&&n?.once)??!1})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),t??null,n);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){let t=super.dispatchEvent(e),n=this.#e.get(e.type);return n==null||(n=n.filter(({once:s})=>!s),this.#e.set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new Ge(e,t))}},k2=class extends Event{detail;constructor(e,t){super(e,t),this.detail=t?.detail}},Ge=globalThis.CustomEvent??k2;var xo=Symbol.for("@libp2p/peer-discovery");var Sl=Symbol.for("@libp2p/peer-routing");var Tte=re(B0(),1),kL=re(Qe(),1);var Sb=re(Vp(),1),Rb=re(Rt(),1),_b={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function Rl(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){let a=Object.keys(_b).join(" / ");throw new b(`Hash '${s}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}let i=_b[s],o=(0,Sb.default)(r,e,t,n,i);return Rb.default.encode64(o,null)}var N2=Symbol.for("@libp2p/peer-id");function Da(r){return r!=null&&!!r[N2]}var LL=Symbol.for("nodejs.util.inspect.custom"),Ib=Object.values(on).map(r=>r.decoder).reduce((r,e)=>r.or(e),on.identity.decoder),Tb=114,O2=36,L2=37,Il=class{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[N2]=!0;toString(){return this.string==null&&(this.string=be.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return ge.createV1(Tb,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return me(this.multihash.bytes,e);if(typeof e=="string")return fe(e).equals(this);if(e?.multihash?.bytes!=null)return me(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[LL](){return`PeerId(${this.toString()})`}},vo=class extends Il{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},_o=class extends Il{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}},So=class extends Il{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}};function Ab(r){if(r.type==="RSA")return new vo(r);if(r.type==="Ed25519")return new _o(r);if(r.type==="secp256k1")return new So(r);throw new b("Not a PeerId","ERR_INVALID_PARAMETERS")}function fe(r,e){if(e=e??Ib,r.charAt(0)==="1"||r.charAt(0)==="Q"){let t=Jn(be.decode(`z${r}`));return r.startsWith("12D")?new _o({multihash:t}):r.startsWith("16U")?new So({multihash:t}):new vo({multihash:t})}return ht(Ib.decode(r))}function ht(r){try{let e=Jn(r);if(e.code===es.code){if(e.digest.length===O2)return new _o({multihash:e});if(e.digest.length===L2)return new So({multihash:e})}if(e.code===Ne.code)return new vo({multihash:e})}catch{return BL(ge.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function BL(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==Tb)throw new Error("Supplied PeerID CID is invalid");let e=r.multihash;if(e.code===Ne.code)return new vo({multihash:r.multihash});if(e.code===es.code){if(e.digest.length===O2)return new _o({multihash:r.multihash});if(e.digest.length===L2)return new So({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function cr(r,e){return r.length===O2?new _o({multihash:Sn(es.code,r),privateKey:e}):r.length===L2?new So({multihash:Sn(es.code,r),privateKey:e}):new vo({multihash:await Ne.digest(r),publicKey:r,privateKey:e})}var Mb=re(Bb(),1),vi=Mb.default;var Gb=re(Wb(),1);var Le;(function(r){r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH"})(Le||(Le={}));var bf=k("libp2p:keychain"),tB="/pkcs8/",Yb="/info/",Ro=new WeakMap,Io={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},M2={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function Ks(r){return r==null||typeof r!="string"?!1:r===(0,Gb.default)(r.trim())&&r.length>0}async function je(){let t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function fs(r){return new rt(tB+r)}function _i(r){return new rt(Yb+r)}var To=class{components;init;constructor(e,t){if(this.components=e,this.init=vi(M2,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<Io.minKeyLength)throw new Error(`dek.keyLength must be least ${Io.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<Io.minSaltLength)throw new Error(`dek.saltLength must be least ${Io.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<Io.minIterationCount)throw new Error(`dek.iterationCount must be least ${Io.minIterationCount}`);let n=this.init.pass!=null&&this.init.dek?.salt!=null?Rl(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Ro.set(this,{dek:n})}static generateOptions(){let e=Object.assign({},M2),t=Math.ceil(Io.minSaltLength/3)*3;return e.dek.salt=W(Pr(t),"base64"),e}static get options(){return M2}async createKey(e,t,n=2048){if(!Ks(e)||e==="self")throw await je(),new b("Invalid key name",Le.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await je(),new b("Invalid key type",Le.ERR_INVALID_KEY_TYPE);let s=fs(e);if(await this.components.datastore.has(s))throw await je(),new b("Key name already exists",Le.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await je(),new b("Invalid RSA key size",Le.ERR_INVALID_KEY_SIZE);break;default:break}let o;try{let a=await xl(t,n),c=await a.id(),l=Ro.get(this);if(l==null)throw new b("dek missing",Le.ERR_INVALID_PARAMETERS);let u=l.dek,f=await a.export(u);o={name:e,id:c};let h=this.components.datastore.batch();h.put(s,Q(f)),h.put(_i(e),Q(JSON.stringify(o))),await h.commit()}catch(a){throw await je(),a}return o}async listKeys(){let e={prefix:Yb},t=[];for await(let n of this.components.datastore.query(e))t.push(JSON.parse(W(n.value)));return t}async findKeyById(e){try{let n=(await this.listKeys()).find(s=>s.id===e);if(n==null)throw new b(`Key with id '${e}' does not exist.`,Le.ERR_KEY_NOT_FOUND);return n}catch(t){throw await je(),t}}async findKeyByName(e){if(!Ks(e))throw await je(),new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);let t=_i(e);try{let n=await this.components.datastore.get(t);return JSON.parse(W(n))}catch(n){throw await je(),bf.error(n),new b(`Key '${e}' does not exist.`,Le.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!Ks(e)||e==="self")throw await je(),new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);let t=fs(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(_i(e)),await s.commit(),n}async renameKey(e,t){if(!Ks(e)||e==="self")throw await je(),new b(`Invalid old key name '${e}'`,Le.ERR_OLD_KEY_NAME_INVALID);if(!Ks(t)||t==="self")throw await je(),new b(`Invalid new key name '${t}'`,Le.ERR_NEW_KEY_NAME_INVALID);let n=fs(e),s=fs(t),i=_i(e),o=_i(t);if(await this.components.datastore.has(s))throw await je(),new b(`Key '${t}' already exists`,Le.ERR_KEY_ALREADY_EXISTS);try{let c=await this.components.datastore.get(n),l=await this.components.datastore.get(i),u=JSON.parse(W(l));u.name=t;let f=this.components.datastore.batch();return f.put(s,c),f.put(o,Q(JSON.stringify(u))),f.delete(n),f.delete(i),await f.commit(),u}catch(c){throw await je(),c}}async exportKey(e,t){if(!Ks(e))throw await je(),new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);if(t==null)throw await je(),new b("Password is required",Le.ERR_PASSWORD_REQUIRED);let n=fs(e);try{let s=await this.components.datastore.get(n),i=W(s),o=Ro.get(this);if(o==null)throw new b("dek missing",Le.ERR_INVALID_PARAMETERS);let a=o.dek;return await(await Aa(i,a)).export(t)}catch(s){throw await je(),s}}async exportPeerId(e){let t="temporary-password",n=await this.exportKey(e,t),s=await Aa(n,t);return cr(s.public.bytes,s.bytes)}async importKey(e,t,n){if(!Ks(e)||e==="self")throw await je(),new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);if(t==null)throw await je(),new b("PEM encoded key is required",Le.ERR_PEM_REQUIRED);let s=fs(e);if(await this.components.datastore.has(s))throw await je(),new b(`Key '${e}' already exists`,Le.ERR_KEY_ALREADY_EXISTS);let o;try{o=await Aa(t,n)}catch{throw await je(),new b("Cannot read the key, most likely the password is wrong",Le.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();let u=Ro.get(this);if(u==null)throw new b("dek missing",Le.ERR_INVALID_PARAMETERS);let f=u.dek;t=await o.export(f)}catch(u){throw await je(),u}let c={name:e,id:a},l=this.components.datastore.batch();return l.put(s,Q(t)),l.put(_i(e),Q(JSON.stringify(c))),await l.commit(),c}async importPeer(e,t){try{if(!Ks(e))throw new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);if(t==null)throw new b("PeerId is required",Le.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw new b("PeerId.privKey is required",Le.ERR_MISSING_PRIVATE_KEY);let n=await qn(t.privateKey),s=fs(e);if(await this.components.datastore.has(s))throw await je(),new b(`Key '${e}' already exists`,Le.ERR_KEY_ALREADY_EXISTS);let o=Ro.get(this);if(o==null)throw new b("dek missing",Le.ERR_INVALID_PARAMETERS);let a=o.dek,c=await n.export(a),l={name:e,id:t.toString()},u=this.components.datastore.batch();return u.put(s,Q(c)),u.put(_i(e),Q(JSON.stringify(l))),await u.commit(),l}catch(n){throw await je(),n}}async getPrivateKey(e){if(!Ks(e))throw await je(),new b(`Invalid key name '${e}'`,Le.ERR_INVALID_KEY_NAME);try{let t=fs(e),n=await this.components.datastore.get(t);return W(n)}catch(t){throw await je(),bf.error(t),new b(`Key '${e}' does not exist.`,Le.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await je(),new b(`Invalid old pass type '${typeof e}'`,Le.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await je(),new b(`Invalid new pass type '${typeof t}'`,Le.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await je(),new b(`Invalid pass length ${t.length}`,Le.ERR_INVALID_PASS_LENGTH);bf("recreating keychain");let n=Ro.get(this);if(n==null)throw new b("dek missing",Le.ERR_INVALID_PARAMETERS);let s=n.dek;this.init.pass=t;let i=t!=null&&this.init.dek?.salt!=null?Rl(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Ro.set(this,{dek:i});let o=await this.listKeys();for(let a of o){let c=await this.components.datastore.get(fs(a.name)),l=W(c),u=await Aa(l,s),f=i.toString(),h=await u.export(f),d=this.components.datastore.batch(),p={name:a.name,id:a.id};d.put(fs(a.name),Q(h)),d.put(_i(a.name),Q(JSON.stringify(p))),await d.commit()}bf("keychain reconstructed")}};function Vs(r,e){let t={[Symbol.iterator]:()=>t,next:()=>{let n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}var lr=class{map;constructor(e){if(this.map=new Map,e!=null)for(let[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return Vs(this.map.entries(),e=>[fe(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,fe(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return Vs(this.map.keys(),e=>fe(e))}values(){return this.map.values()}get size(){return this.map.size}};var gn=class r{set;constructor(e){if(this.set=new Set,e!=null)for(let t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Vs(this.set.entries(),e=>{let t=fe(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{let n=fe(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return Vs(this.set.values(),e=>fe(e))}intersection(e){let t=new r;for(let n of e)this.has(n)&&t.add(n);return t}difference(e){let t=new r;for(let n of this)e.has(n)||t.add(n);return t}union(e){let t=new r;for(let n of e)t.add(n);for(let n of this)t.add(n);return t}};var U2=class r{list;constructor(e){if(this.list=[],e!=null)for(let t of e)this.list.push(t.toString())}[Symbol.iterator](){return Vs(this.list.entries(),e=>fe(e[1]))}concat(e){let t=new r(this);for(let n of e)t.push(n);return t}entries(){return Vs(this.list.entries(),e=>[e[0],fe(e[1])])}every(e){return this.list.every((t,n)=>e(fe(t),n,this))}filter(e){let t=new r;return this.list.forEach((n,s)=>{let i=fe(n);e(i,s,this)&&t.push(i)}),t}find(e){let t=this.list.find((n,s)=>e(fe(n),s,this));if(t!=null)return fe(t)}findIndex(e){return this.list.findIndex((t,n)=>e(fe(t),n,this))}forEach(e){this.list.forEach((t,n)=>{e(fe(t),n,this)})}includes(e){return this.list.includes(e.toString())}indexOf(e){return this.list.indexOf(e.toString())}pop(){let e=this.list.pop();if(e!=null)return fe(e)}push(...e){for(let t of e)this.list.push(t.toString())}shift(){let e=this.list.shift();if(e!=null)return fe(e)}unshift(...e){let t=this.list.length;for(let n=e.length-1;n>-1;n--)t=this.list.unshift(e[n].toString());return t}get length(){return this.list.length}};var F2;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.id=t.bytes();break;case 2:s.pubKey=t.bytes();break;case 3:s.privKey=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(F2||(F2={}));var wf=async()=>{let r=await xl("Ed25519"),e=await rB(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)};async function rB(r){return cr(vl(r.public),P2(r))}var Qb={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var Tl;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Tl||(Tl={}));var yn=class r{static createFromProtobuf=async e=>{let t=Tl.decode(e),n=await cr(t.publicKey);return new r({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");let n=e.domain,s=e.codec,i=e.marshal(),o=Xb(n,s,i),c=await(await qn(t.privateKey)).sign(o.subarray());return new r({peerId:t,payloadType:s,payload:i,signature:c})};static openAndCertify=async(e,t)=>{let n=await r.createFromProtobuf(e);if(!await n.validate(t))throw new b("envelope signature is not valid for the given domain",Qb.ERR_SIGNATURE_NOT_VALID);return n};peerId;payloadType;payload;signature;marshaled;constructor(e){let{peerId:t,payloadType:n,payload:s,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=Tl.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return me(this.marshal(),e.marshal())}async validate(e){let t=Xb(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return kr(this.peerId.publicKey).verify(t.subarray(),this.signature)}},Xb=(r,e,t)=>{let n=Q(r),s=Vt(n.byteLength),i=Vt(e.length),o=Vt(t.length);return new Ee(s,n,i,e,o,t)};function jb(r,e){let t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}var Ef=class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){let t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){let t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{let t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0,a=this.peekChar();if(a===void 0)return;let c=a==="0",l=2**(8*s)-1;for(;;){let u=this.readAtomically(()=>{let f=this.readChar();if(f===void 0)return;let h=Number.parseInt(f,e);if(!Number.isNaN(h))return h});if(u===void 0)break;if(i*=e,i+=u,i>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{let e=new Uint8Array(4);for(let t=0;t<e.length;t++){let n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){let e=t=>{for(let n=0;n<t.length/2;n++){let s=n*2;if(n<t.length-3){let o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}let i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{let t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;let i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};var Zb=45,nB=15,ka=new Ef;function K2(r){if(!(r.length>nB))return ka.new(r).parseWith(()=>ka.readIPv4Addr())}function V2(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Zb))return ka.new(r).parseWith(()=>ka.readIPv6Addr())}function xf(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>Zb))return ka.new(r).parseWith(()=>ka.readIPAddr())}var tne=parseInt("0xFFFF",16),rne=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function vf(r){return!!K2(r)}function _f(r){return!!V2(r)}function Na(r){return!!xf(r)}var tw=vf,cB=_f,q2=function(r){let e=0;if(r=r.toString().trim(),tw(r)){let t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(cB(r)){let t=r.split(":",8),n;for(n=0;n<t.length;n++){let i=tw(t[n]),o;i&&(o=q2(t[n]),t[n]=W(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,W(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);let i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}let s=new Uint8Array(e+16);for(n=0;n<t.length;n++){let i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},rw=function(r,e=0,t){e=~~e,t=t??r.length-e;let n=new DataView(r.buffer);if(t===4){let s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){let s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""};var Oa={},z2={},uB=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,-1,"ip6zone"],[43,8,"ipcidr"],[53,-1,"dns",!0],[54,-1,"dns4",!0],[55,-1,"dns6",!0],[56,-1,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,-1,"unix",!1,!0],[421,-1,"ipfs"],[421,-1,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,-1,"garlic64"],[448,0,"tls"],[449,-1,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,-1,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,-1,"memory"]];uB.forEach(r=>{let e=fB(...r);z2[e.code]=e,Oa[e.name]=e});function fB(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function he(r){if(typeof r=="number"){if(z2[r]!=null)return z2[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Oa[r]!=null)return Oa[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var Fne=he("ip4"),Kne=he("ip6"),Vne=he("ipcidr");function Al(r,e){switch(he(r).code){case 4:case 41:return dB(e);case 42:return iw(e);case 6:case 273:case 33:case 132:return aw(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return iw(e);case 421:return yB(e);case 444:return ow(e);case 445:return ow(e);case 466:return gB(e);default:return W(e,"base16")}}function H2(r,e){switch(he(r).code){case 4:return nw(e);case 41:return nw(e);case 42:return sw(e);case 6:case 273:case 33:case 132:return W2(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return sw(e);case 421:return pB(e);case 444:return bB(e);case 445:return wB(e);case 466:return mB(e);default:return Q(e,"base16")}}var $2=Object.values(on).map(r=>r.decoder),hB=function(){let r=$2[0].or($2[1]);return $2.slice(2).forEach(e=>r=r.or(e)),r}();function nw(r){if(!Na(r))throw new Error("invalid ip address");return q2(r)}function dB(r){let e=rw(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!Na(e))throw new Error("invalid ip address");return e}function W2(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function aw(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function sw(r){let e=Q(r),t=Uint8Array.from(Vt(e.length));return _e([t,e],t.length+e.length)}function iw(r){let e=Kr(r);if(r=r.slice(Kt(e)),r.length!==e)throw new Error("inconsistent lengths");return W(r)}function pB(r){let e;r[0]==="Q"||r[0]==="1"?e=Jn(be.decode(`z${r}`)).bytes:e=ge.parse(r).multihash.bytes;let t=Uint8Array.from(Vt(e.length));return _e([t,e],t.length+e.length)}function mB(r){let e=hB.decode(r),t=Uint8Array.from(Vt(e.length));return _e([t,e],t.length+e.length)}function gB(r){let e=Kr(r),t=r.slice(Kt(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+W(t,"base64url")}function yB(r){let e=Kr(r),t=r.slice(Kt(e));if(t.length!==e)throw new Error("inconsistent lengths");return W(t,"base58btc")}function bB(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);let t=Ot.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=W2(n);return _e([t,s],t.length+s.length)}function wB(r){let e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);let t=Ot.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");let s=W2(n);return _e([t,s],t.length+s.length)}function ow(r){let e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=W(e,"base32"),s=aw(t);return`${n}:${s}`}function cw(r){r=G2(r);let e=[],t=[],n=null,s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){let o=s[i],a=he(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw uw("invalid address: "+r);if(a.path===!0){n=G2(s.slice(i).join("/")),e.push([a.code,H2(a.code,n)]),t.push([a.code,n]);break}let c=H2(a.code,s[i]);e.push([a.code,c]),t.push([a.code,Al(a.code,c)])}return{string:lw(t),bytes:Q2(e),tuples:e,stringTuples:t,path:n}}function Y2(r){let e=[],t=[],n=null,s=0;for(;s<r.length;){let i=Kr(r,s),o=Kt(i),a=he(i),c=EB(a,r.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}let l=r.slice(s+o,s+o+c);if(s+=c+o,s>r.length)throw uw("Invalid address Uint8Array: "+W(r,"base16"));e.push([i,l]);let u=Al(i,l);if(t.push([i,u]),a.path===!0){n=u;break}}return{bytes:Uint8Array.from(r),string:lw(t),tuples:e,stringTuples:t,path:n}}function lw(r){let e=[];return r.map(t=>{let n=he(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),G2(e.join("/"))}function Q2(r){return _e(r.map(e=>{let t=he(e[0]),n=Uint8Array.from(Vt(t.code));return e.length>1&&e[1]!=null&&(n=_e([n,e[1]])),n}))}function EB(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{let t=Kr(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Kt(t)}}function G2(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function uw(r){return new Error("Error parsing address: "+r)}var xB=Symbol.for("nodejs.util.inspect.custom"),vB=[he("dns").code,he("dns4").code,he("dns6").code,he("dnsaddr").code],j2=new Map,fw=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Ao(r){return!!r?.[fw]}var X2=class r{bytes;#e;#t;#r;#n;[fw]=!0;constructor(e){e==null&&(e="");let t;if(e instanceof Uint8Array)t=Y2(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=cw(e)}else if(Ao(e))t=Y2(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,this.#e=t.string,this.#t=t.tuples,this.#r=t.stringTuples,this.#n=t.path}toString(){return this.#e}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="",o=he("tcp"),a=he("udp"),c=he("ip4"),l=he("ip6"),u=he("dns6"),f=he("ip6zone");for(let[d,p]of this.stringTuples())d===f.code&&(i=`%${p??""}`),vB.includes(d)&&(t=o.name,s=443,n=`${p??""}${i}`,e=d===u.code?6:4),(d===o.code||d===a.code)&&(t=he(d).name,s=parseInt(p??"")),(d===c.code||d===l.code)&&(t=he(d).name,n=`${p??""}${i}`,e=d===l.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.#t.map(([e])=>Object.assign({},he(e)))}protoCodes(){return this.#t.map(([e])=>e)}protoNames(){return this.#t.map(([e])=>he(e).name)}tuples(){return this.#t}stringTuples(){return this.#r}encapsulate(e){return e=new r(e),new r(this.toString()+e.toString())}decapsulate(e){let t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new r(n.slice(0,s))}decapsulateCode(e){let t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new r(Q2(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Oa.p2p.code&&e.push([n,s]),n===Oa["p2p-circuit"].code&&(e=[])});let t=e.pop();if(t?.[1]!=null){let n=t[1];return n[0]==="Q"||n[0]==="1"?W(be.decode(`z${n}`),"base58btc"):W(ge.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return this.#n}equals(e){return me(this.bytes,e.bytes)}async resolve(e){let t=this.protos().find(i=>i.resolvable);if(t==null)return[this];let n=j2.get(t.name);if(n==null)throw new b(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new r(i))}nodeAddress(){let e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){let t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[xB](){return`Multiaddr(${this.#e})`}};function oe(r){return new X2(r)}var hw="libp2p-peer-record",dw=Uint8Array.from([3,1]);var Dl;(function(r){let e;(function(n){let s;n.codec=()=>(s==null&&(s=le((i,o,a={})=>{a.lengthDelimited!==!1&&o.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(o.uint32(10),o.bytes(i.multiaddr)),a.lengthDelimited!==!1&&o.ldelim()},(i,o)=>{let a={multiaddr:new Uint8Array(0)},c=o==null?i.len:i.pos+o;for(;i.pos<c;){let l=i.uint32();switch(l>>>3){case 1:a.multiaddr=i.bytes();break;default:i.skipType(l&7);break}}return a})),s),n.encode=i=>ce(i,n.codec()),n.decode=i=>ae(i,n.codec())})(e=r.AddressInfo||(r.AddressInfo={}));let t;r.codec=()=>(t==null&&(t=le((n,s,i={})=>{if(i.lengthDelimited!==!1&&s.fork(),n.peerId!=null&&n.peerId.byteLength>0&&(s.uint32(10),s.bytes(n.peerId)),n.seq!=null&&n.seq!==0n&&(s.uint32(16),s.uint64(n.seq)),n.addresses!=null)for(let o of n.addresses)s.uint32(26),r.AddressInfo.codec().encode(o,s);i.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{let i={peerId:new Uint8Array(0),seq:0n,addresses:[]},o=s==null?n.len:n.pos+s;for(;n.pos<o;){let a=n.uint32();switch(a>>>3){case 1:i.peerId=n.bytes();break;case 2:i.seq=n.uint64();break;case 3:i.addresses.push(r.AddressInfo.codec().decode(n,n.uint32()));break;default:n.skipType(a&7);break}}return i})),t),r.encode=n=>ce(n,r.codec()),r.decode=n=>ae(n,r.codec())})(Dl||(Dl={}));var Qr=class r{static createFromProtobuf=e=>{let t=Dl.decode(e),n=ht(t.peerId),s=(t.addresses??[]).map(o=>oe(o.multiaddr)),i=t.seq;return new r({peerId:n,multiaddrs:s,seqNumber:i})};static DOMAIN=hw;static CODEC=dw;peerId;multiaddrs;seqNumber;domain=r.DOMAIN;codec=r.CODEC;marshaled;constructor(e){let{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Dl.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof r)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!jb(this.multiaddrs,e.multiaddrs))}};var Zt={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var La;(function(r){let e;(function(s){let i;s.codec=()=>(i==null&&(i=le((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.key!=null&&o.key!==""&&(a.uint32(10),a.string(o.key)),o.value!=null&&o.value.byteLength>0&&(a.uint32(18),a.bytes(o.value)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{let c={key:"",value:new Uint8Array(0)},l=a==null?o.len:o.pos+a;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:c.key=o.string();break;case 2:c.value=o.bytes();break;default:o.skipType(u&7);break}}return c})),i),s.encode=o=>ce(o,s.codec()),s.decode=o=>ae(o,s.codec())})(e=r.Peer$metadataEntry||(r.Peer$metadataEntry={}));let t;(function(s){let i;s.codec=()=>(i==null&&(i=le((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.key!=null&&o.key!==""&&(a.uint32(10),a.string(o.key)),o.value!=null&&(a.uint32(18),Rf.codec().encode(o.value,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{let c={key:""},l=a==null?o.len:o.pos+a;for(;o.pos<l;){let u=o.uint32();switch(u>>>3){case 1:c.key=o.string();break;case 2:c.value=Rf.codec().decode(o,o.uint32());break;default:o.skipType(u&7);break}}return c})),i),s.encode=o=>ce(o,s.codec()),s.decode=o=>ae(o,s.codec())})(t=r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.addresses!=null)for(let a of s.addresses)i.uint32(10),Sf.codec().encode(a,i);if(s.protocols!=null)for(let a of s.protocols)i.uint32(18),i.string(a);if(s.publicKey!=null&&(i.uint32(34),i.bytes(s.publicKey)),s.peerRecordEnvelope!=null&&(i.uint32(42),i.bytes(s.peerRecordEnvelope)),s.metadata!=null&&s.metadata.size!==0)for(let[a,c]of s.metadata.entries())i.uint32(50),r.Peer$metadataEntry.codec().encode({key:a,value:c},i);if(s.tags!=null&&s.tags.size!==0)for(let[a,c]of s.tags.entries())i.uint32(58),r.Peer$tagsEntry.codec().encode({key:a,value:c},i);o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={addresses:[],protocols:[],metadata:new Map,tags:new Map},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.addresses.push(Sf.codec().decode(s,s.uint32()));break;case 2:o.protocols.push(s.string());break;case 4:o.publicKey=s.bytes();break;case 5:o.peerRecordEnvelope=s.bytes();break;case 6:{let l=r.Peer$metadataEntry.codec().decode(s,s.uint32());o.metadata.set(l.key,l.value);break}case 7:{let l=r.Peer$tagsEntry.codec().decode(s,s.uint32());o.tags.set(l.key,l.value);break}default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(La||(La={}));var Sf;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={multiaddr:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.multiaddr=t.bytes();break;case 2:s.isCertified=t.bool();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Sf||(Sf={}));var Rf;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={value:0},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.value=t.uint32();break;case 2:s.expiry=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Rf||(Rf={}));function Ba(r,e){let t=La.decode(e);t.publicKey!=null&&r.publicKey==null&&(r=Ab({...r,publicKey:r.publicKey}));let n=new Map,s=BigInt(Date.now());for(let[i,o]of t.tags.entries())o.expiry!=null&&o.expiry<s||n.set(i,o);return{...t,id:r,addresses:t.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:oe(i),isCertified:o??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}var Z2="/peers/";function Ma(r){if(!Da(r)||r.type==null)throw new b("Invalid PeerId",Zt.ERR_INVALID_PARAMETERS);let e=r.toCID().toString();return new rt(`${Z2}${e}`)}async function pw(r,e,t){let n=new Map;for(let s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=oe(s.multiaddr)),!Ao(s.multiaddr))throw new b("Multiaddr was invalid",Zt.ERR_INVALID_PARAMETERS);if(!await e(r,s.multiaddr))continue;let i=s.isCertified??!1,o=s.multiaddr.toString(),a=n.get(o);a!=null?s.isCertified=a.isCertified||i:n.set(o,{multiaddr:s.multiaddr,isCertified:i})}return[...n.values()].sort((s,i)=>s.multiaddr.toString().localeCompare(i.multiaddr.toString())).map(({isCertified:s,multiaddr:i})=>({isCertified:s,multiaddr:i.bytes}))}async function Tf(r,e,t,n){if(e==null)throw new b("Invalid PeerData",Zt.ERR_INVALID_PARAMETERS);if(e.publicKey!=null&&r.publicKey!=null&&!me(e.publicKey,r.publicKey))throw new b("publicKey bytes do not match peer id publicKey bytes",Zt.ERR_INVALID_PARAMETERS);let s=n.existingPeer;if(s!=null&&!r.equals(s.id))throw new b("peer id did not match existing peer id",Zt.ERR_INVALID_PARAMETERS);let i=s?.addresses??[],o=new Set(s?.protocols??[]),a=s?.metadata??new Map,c=s?.tags??new Map,l=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=If(f,{validate:mw})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=If(f,{validate:gw,map:yw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){let f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(let[h,d]of f)d==null?a.delete(h):a.set(h,d);a=If([...a.entries()],{validate:mw})}if(e.tags!=null){let f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),h=new Map(c);for(let[d,p]of f)p==null?h.delete(d):h.set(d,p);c=If([...h.entries()],{validate:gw,map:yw})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let u={addresses:await pw(r,n.addressFilter??(async()=>!0),i),protocols:[...o.values()].sort((f,h)=>f.localeCompare(h)),metadata:a,tags:c,publicKey:s?.id.publicKey??e.publicKey??r.publicKey,peerRecordEnvelope:l};return r.type!=="RSA"&&delete u.publicKey,u}function If(r,e){let t=new Map;for(let[n,s]of r)s!=null&&e.validate(n,s);for(let[n,s]of r.sort(([i],[o])=>i.localeCompare(o)))s!=null&&t.set(n,e.map?.(n,s)??s);return t}function mw(r,e){if(typeof r!="string")throw new b("Metadata key must be a string",Zt.ERR_INVALID_PARAMETERS);if(!(e instanceof Uint8Array))throw new b("Metadata value must be a Uint8Array",Zt.ERR_INVALID_PARAMETERS)}function gw(r,e){if(typeof r!="string")throw new b("Tag name must be a string",Zt.ERR_INVALID_PARAMETERS);if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new b("Tag value must be an integer",Zt.ERR_INVALID_PARAMETERS);if(e.value<0||e.value>100)throw new b("Tag value must be between 0-100",Zt.ERR_INVALID_PARAMETERS)}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new b("Tag ttl must be an integer",Zt.ERR_INVALID_PARAMETERS);if(e.ttl<0)throw new b("Tag ttl must be between greater than 0",Zt.ERR_INVALID_PARAMETERS)}}function yw(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function Af(r,e,t){let n=r.toString().split("/")[2],s=Ot.decode(n),i=ht(s),o=t.get(i);if(o!=null)return o;let a=Ba(i,e);return t.set(i,a),a}function _B(r,e){return r==null?{}:{prefix:Z2,filters:(r.filters??[]).map(t=>({key:n,value:s})=>t(Af(n,s,e))),orders:(r.orders??[]).map(t=>(n,s)=>t(Af(n.key,n.value,e),Af(s.key,s.value,e)))}}var Df=class{peerId;datastore;lock;addressFilter;constructor(e,t={}){this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=el({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(Ma(e))}async delete(e){if(this.peerId.equals(e))throw new b("Cannot delete self peer",Zt.ERR_INVALID_PARAMETERS);await this.datastore.delete(Ma(e))}async load(e){let t=await this.datastore.get(Ma(e));return Ba(e,t)}async save(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),i=await Tf(e,t,"patch",{addressFilter:this.addressFilter});return this.#t(e,i,n,s)}async patch(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),i=await Tf(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,n,s)}async merge(e,t){let{existingBuf:n,existingPeer:s}=await this.#e(e),i=await Tf(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#t(e,i,n,s)}async*all(e){let t=new lr;for await(let{key:n,value:s}of this.datastore.query(_B(e??{},t))){let i=Af(n,s,t);i.id.equals(this.peerId)||(yield i)}}async#e(e){try{let t=await this.datastore.get(Ma(e)),n=Ba(e,t);return{existingBuf:t,existingPeer:n}}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}return{}}async#t(e,t,n,s){let i=La.encode(t);return n!=null&&me(i,n)?{peer:Ba(e,i),previous:s,updated:!1}:(await this.datastore.put(Ma(e),i),{peer:Ba(e,i),previous:s,updated:!0})}};var tt=k("libp2p:peer-store"),Cf=class{store;events;peerId;constructor(e,t={}){this.events=e.events,this.peerId=e.peerId,this.store=new Df(e,t)}async forEach(e,t){tt.trace("forEach await read lock");let n=await this.store.lock.readLock();tt.trace("forEach got read lock");try{for await(let s of this.store.all(t))e(s)}finally{tt.trace("forEach release read lock"),n()}}async all(e){tt.trace("all await read lock");let t=await this.store.lock.readLock();tt.trace("all got read lock");try{return await Nc(this.store.all(e))}finally{tt.trace("all release read lock"),t()}}async delete(e){tt.trace("delete await write lock");let t=await this.store.lock.writeLock();tt.trace("delete got write lock");try{await this.store.delete(e)}finally{tt.trace("delete release write lock"),t()}}async has(e){tt.trace("has await read lock");let t=await this.store.lock.readLock();tt.trace("has got read lock");try{return await this.store.has(e)}finally{tt.trace("has release read lock"),t()}}async get(e){tt.trace("get await read lock");let t=await this.store.lock.readLock();tt.trace("get got read lock");try{return await this.store.load(e)}finally{tt.trace("get release read lock"),t()}}async save(e,t){tt.trace("save await write lock");let n=await this.store.lock.writeLock();tt.trace("save got write lock");try{let s=await this.store.save(e,t);return this.#e(e,s),s.peer}finally{tt.trace("save release write lock"),n()}}async patch(e,t){tt.trace("patch await write lock");let n=await this.store.lock.writeLock();tt.trace("patch got write lock");try{let s=await this.store.patch(e,t);return this.#e(e,s),s.peer}finally{tt.trace("patch release write lock"),n()}}async merge(e,t){tt.trace("merge await write lock");let n=await this.store.lock.writeLock();tt.trace("merge got write lock");try{let s=await this.store.merge(e,t);return this.#e(e,s),s.peer}finally{tt.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){let n=await yn.openAndCertify(e,Qr.DOMAIN);if(t?.equals(n.peerId)===!1)return tt("envelope peer id was not the expected peer id - expected: %p received: %p",t,n.peerId),!1;let s=Qr.createFromProtobuf(n.payload),i;try{i=await this.get(n.peerId)}catch(o){if(o.code!=="ERR_NOT_FOUND")throw o}if(i?.peerRecordEnvelope!=null){let o=await yn.createFromProtobuf(i.peerRecordEnvelope),a=Qr.createFromProtobuf(o.payload);if(a.seqNumber>=s.seqNumber)return tt("sequence number was lower or equal to existing sequence number - stored: %d received: %d",a.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:e,addresses:s.multiaddrs.map(o=>({isCertified:!0,multiaddr:o}))}),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}};function bw(r,e){let t;return function(){let n=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(n,e)}}var SB=k("libp2p:address-manager"),RB=r=>r;function J2(r,e){let t=r.getPeerId();return t!=null&&fe(t).equals(e)&&(r=r.decapsulate(oe(`/p2p/${e.toString()}`))),r}var Pf=class{components;listen;announce;observed;announceFilter;constructor(e,t={}){let{listen:n=[],announce:s=[]}=t;this.components=e,this.listen=n.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Map,this.announceFilter=t.announceFilter??RB,this._updatePeerStoreAddresses=bw(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){let e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter(([t,n])=>n.confident).map(([t])=>oe(t))).map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{SB.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>oe(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>oe(e))}getObservedAddrs(){return Array.from(this.observed).map(([e])=>oe(e))}addObservedAddr(e){e=J2(e,this.components.peerId);let t=e.toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){e=J2(e,this.components.peerId);let t=e.toString(),s=(this.observed.get(t)??{confident:!1}).confident;this.observed.set(t,{confident:!0}),s||this._updatePeerStoreAddresses()}removeObservedAddr(e){e=J2(e,this.components.peerId);let t=e.toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(Array.from(this.observed).filter(([n,s])=>s.confident).map(([n])=>n));let t=new Set(e);return this.announceFilter(Array.from(t).map(n=>oe(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}};function ww(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}var em=class{components={};_started=!1;constructor(e={}){this.components={};for(let[t,n]of Object.entries(e))this.components[t]=n}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>ww(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}},IB=["metrics","connectionProtector"],TB=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Ew(r={}){let e=new em(r);return new Proxy(e,{get(n,s,i){if(typeof s=="string"&&!TB.includes(s)){let o=e.components[s];if(o==null&&!IB.includes(s))throw new b(`${s} not set`,"ERR_SERVICE_MISSING");return o}return Reflect.get(n,s,i)},set(n,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(n,s,i),!0}})}var Tw=re(xw(),1);var vw="[a-fA-F\\d:]",Si=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${vw})|(?<=${vw})(?=\\s|$))`:"",zn="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Pt="[a-fA-F\\d]{1,4}",kf=`
(?:
(?:${Pt}:){7}(?:${Pt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Pt}:){6}(?:${zn}|:${Pt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Pt}:){5}(?::${zn}|(?::${Pt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Pt}:){4}(?:(?::${Pt}){0,1}:${zn}|(?::${Pt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Pt}:){3}(?:(?::${Pt}){0,2}:${zn}|(?::${Pt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Pt}:){2}(?:(?::${Pt}){0,3}:${zn}|(?::${Pt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Pt}:){1}(?:(?::${Pt}){0,4}:${zn}|(?::${Pt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Pt}){0,5}:${zn}|(?::${Pt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),AB=new RegExp(`(?:^${zn}$)|(?:^${kf}$)`),DB=new RegExp(`^${zn}$`),CB=new RegExp(`^${kf}$`),tm=r=>r&&r.exact?AB:new RegExp(`(?:${Si(r)}${zn}${Si(r)})|(?:${Si(r)}${kf}${Si(r)})`,"g");tm.v4=r=>r&&r.exact?DB:new RegExp(`${Si(r)}${zn}${Si(r)}`,"g");tm.v6=r=>r&&r.exact?CB:new RegExp(`${Si(r)}${kf}${Si(r)}`,"g");var _w=tm;var Aw=re(Rw(),1),{isValid:PB,parse:kB}=Aw.default,NB=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],OB=NB.map(r=>new Tw.Netmask(r));function LB(r){for(let e of OB)if(e.contains(r))return!0;return!1}function Iw(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}var Dw=r=>{if(PB(r)){let e=kB(r);if(e.kind()==="ipv4")return LB(e.toNormalizedString());if(e.kind()==="ipv6")return Iw(r)}else if(Na(r)&&_w.v6().test(r))return Iw(r)};var Nr=Dw;function Cw(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{let t=e.stringTuples();return t[0][0]===4||t[0][0]===41?!!Nr(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}var hs=Symbol.for("@libp2p/transport");var Ri;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Ri||(Ri={}));var BB=r=>r.toString().split("/").slice(1),Pl=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),kt=r=>({match:e=>Pl(t=>t===r).match(e),pattern:r}),Lf=()=>({match:r=>Pl(e=>typeof e=="string").match(r),pattern:"{string}"}),Pw=()=>({match:r=>Pl(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),$n=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{be.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),Of=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{jd.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),ds=r=>({match:e=>{let t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),ps=(...r)=>({match:e=>{let t;for(let n of r){let s=n.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Tt=(...r)=>({match:e=>{for(let t of r){let n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function Wt(...r){function e(s){let i=BB(s);for(let o of r){let a=o.match(i);if(a===!1)return!1;i=a}return i}function t(s){return e(s)!==!1}function n(s){let i=e(s);return i===!1?!1:i.length===0}return{matches:t,exactMatch:n}}var nm=Tt(kt("dns4"),Lf()),sm=Tt(kt("dns6"),Lf()),im=Tt(kt("dnsaddr"),Lf()),kw=Tt(kt("dns"),Lf()),Aie=Wt(nm),Die=Wt(sm),Cie=Wt(im),Nw=Wt(ps(kw,im,nm,sm)),Ow=Tt(kt("ip4"),Pl(vf)),Lw=Tt(kt("ip6"),Pl(_f)),Bw=ps(Ow,Lw),Bf=ps(Bw,kw,nm,sm,im),Pie=Wt(Ow),kie=Wt(Lw),Mw=Wt(Bw),Mf=Tt(Bf,kt("tcp"),Pw()),kl=Tt(Bf,kt("udp"),Pw()),MB=ps(Mf,kl),Nie=Wt(Mf),Oie=Wt(kl),om=Tt(kl,kt("quic")),Uf=Tt(kl,kt("quic-v1")),UB=ps(om,Uf),Lie=Wt(om),Bie=Wt(Uf),rm=ps(Bf,Mf,kl,om,Uf),Uw=ps(Tt(rm,kt("ws"),ds($n()))),Mie=Wt(Uw),Fw=ps(Tt(rm,kt("wss"),ds($n())),Tt(rm,kt("tls"),kt("ws"),ds($n()))),Uie=Wt(Fw),Kw=Tt(MB,kt("webrtc-direct"),Of(),ds(Of()),ds($n())),Fie=Wt(Kw),Vw=Tt(Uf,kt("webtransport"),Of(),Of(),ds($n())),qw=Wt(Vw),am=ps(Uw,Fw,Tt(Mf,ds($n())),Tt(UB,ds($n())),Tt(Bf,ds($n())),Kw,Vw,$n()),Kie=Wt(am),zw=Tt(am,kt("p2p-circuit"),$n()),Nl=Wt(zw),FB=ps(Tt(zw,kt("webrtc")),Tt(am,kt("webrtc"),ds($n())),kt("webrtc")),Vie=Wt(FB);function cm(r){try{let{address:e}=r.nodeAddress();return!!Nr(e)}catch{return!0}}function KB(r,e){let t=cm(r.multiaddr),n=cm(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function VB(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function qB(r,e){let t=Nl.exactMatch(r.multiaddr),n=Nl.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function Ua(r,e){let t=KB(r,e);if(t!==0)return t;let n=qB(r,e);return n!==0?n:VB(r,e)}var um=re($d(),1),fm=re(Ww(),1);var Gw=globalThis.fetch,Yw=globalThis.Headers,Qie=globalThis.Request,Xie=globalThis.Response;function Ff(r,e,t){return`${r}?name=${e}&type=${t}`}async function Qw(r,e){return await(await Gw(r,{headers:new Yw({accept:"application/dns-json"}),signal:e})).json()}function Do(r,e){return`${e}_${r}`}var lm=Object.assign((0,um.default)("dns-over-http-resolver"),{error:(0,um.default)("dns-over-http-resolver:error")}),hm=class{constructor(e={}){this._cache=new fm.default({max:e?.maxCache??100}),this._TXTcache=new fm.default({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??Qw,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>e.abort())}getServers(){return this._servers}_getShuffledServers(){let e=[...this._servers];for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return await this.resolve4(e);case"AAAA":return await this.resolve6(e);case"TXT":return await this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){let t="A",n=this._cache.get(Do(e,t));if(n!=null)return n;let s=!1;for(let i of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(Ff(i,e,t),o.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(Do(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(s=!0),lm.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){let t="AAAA",n=this._cache.get(Do(e,t));if(n!=null)return n;let s=!1;for(let i of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(Ff(i,e,t),o.signal),c=a.Answer.map(u=>u.data),l=Math.min(...a.Answer.map(u=>u.TTL));return this._cache.set(Do(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(s=!0),lm.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){let t="TXT",n=this._TXTcache.get(Do(e,t));if(n!=null)return n;let s=!1;for(let i of this._getShuffledServers()){let o=new AbortController;this._abortControllers.push(o);try{let a=await this._request(Ff(i,e,t),o.signal),c=a.Answer.map(u=>[u.data.replace(/['"]+/g,"")]),l=Math.min(...a.Answer.map(u=>u.TTL));return this._TXTcache.set(Do(e,t),c,{ttl:l}),c}catch{o.signal.aborted&&(s=!0),lm.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}},Xw=hm;var jw=Xw;var{code:GB}=he("dnsaddr");async function Fa(r,e={}){let t=new jw;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});let n=r.getPeerId(),[,s]=r.stringTuples().find(([a])=>a===GB)??[];if(s==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${s}`)).flat().map(a=>a.split("=")[1]).filter(Boolean);return n!=null&&(o=o.filter(a=>a.includes(n))),o}var ms;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(ms||(ms={}));var H;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",r.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"})(H||(H={}));var YB={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:Fa},addressSorter:Ua},transportManager:{faultTolerance:Ri.FATAL_ALL}};function Zw(r){let e=vi(YB,r);if(e.transports==null||e.transports.length<1)throw new b(ms.ERR_TRANSPORTS_REQUIRED,H.ERR_TRANSPORTS_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw new b(ms.ERR_PROTECTOR_REQUIRED,H.ERR_PROTECTOR_REQUIRED);return e}var Jw="keep-alive";var jE=re(Am(),1);var CM=k("libp2p:get-peer");function Vf(r){if(Da(r))return{peerId:r,multiaddrs:[]};Array.isArray(r)||(r=[r]);let e;if(r.length>0){let t=r[0].getPeerId();e=t==null?void 0:fe(t),r.forEach(n=>{if(!Ao(n))throw CM.error("multiaddr %s was invalid",n),new b("Invalid Multiaddr",H.ERR_INVALID_MULTIADDR);let s=n.getPeerId();if(s==null){if(e!=null)throw new b("Multiaddrs must all have the same peer id or have no peer id",H.ERR_INVALID_PARAMETERS)}else{let i=fe(s);if(e==null||!e.equals(i))throw new b("Multiaddrs must all have the same peer id or have no peer id",H.ERR_INVALID_PARAMETERS)}})}return{peerId:e,multiaddrs:r}}function PM(r,e,t){let n=0,s=r.length;for(;s>0;){let i=Math.trunc(s/2),o=n+i;t(r[o],e)<=0?(n=++o,s-=i+1):s=i}return n}var Dm=class{#e=[];enqueue(e,t){let n=t?.peerId,s=t?.priority??0;if(n==null)throw new b("missing peer id",H.ERR_INVALID_PARAMETERS);let i={priority:s,peerId:n,run:e};if(this.size>0&&this.#e[this.size-1].priority>=s){this.#e.push(i);return}let o=PM(this.#e,i,(a,c)=>c.priority-a.priority);this.#e.splice(o,0,i)}dequeue(){return this.#e.shift()?.run}filter(e){if(e.peerId!=null){let t=e.peerId;return this.#e.filter(n=>t.equals(n.peerId)).map(n=>n.run)}return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}},$a=class extends Bt{constructor(e={}){super({...e,queueClass:Dm})}hasJob(e){return this.sizeBy({peerId:e})>0}};var qf="last-dial-failure";var zf=5,Ti=100,$f=50,GE=1e3*60*7;var Gt=k("libp2p:connection-manager:auto-dial"),Co={minConnections:zf,maxQueueLength:100,autoDialConcurrency:25,autoDialPriority:0,autoDialInterval:5e3,autoDialPeerRetryThreshold:GE,autoDialDiscoveredPeersDebounce:10},Hf=class{connectionManager;peerStore;queue;minConnections;autoDialPriority;autoDialIntervalMs;autoDialMaxQueueLength;autoDialPeerRetryThresholdMs;autoDialDiscoveredPeersDebounce;autoDialInterval;started;running;constructor(e,t){this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=t.minConnections??Co.minConnections,this.autoDialPriority=t.autoDialPriority??Co.autoDialPriority,this.autoDialIntervalMs=t.autoDialInterval??Co.autoDialInterval,this.autoDialMaxQueueLength=t.maxQueueLength??Co.maxQueueLength,this.autoDialPeerRetryThresholdMs=t.autoDialPeerRetryThreshold??Co.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=t.autoDialDiscoveredPeersDebounce??Co.autoDialDiscoveredPeersDebounce,this.started=!1,this.running=!1,this.queue=new $a({concurrency:t.autoDialConcurrency??Co.autoDialConcurrency}),this.queue.addListener("error",s=>{Gt.error("error during auto-dial",s)}),e.events.addEventListener("connection:close",()=>{this.autoDial().catch(s=>{Gt.error(s)})});let n;e.events.addEventListener("peer:discovery",()=>{clearTimeout(n),n=setTimeout(()=>{this.autoDial().catch(s=>{Gt.error(s)})},this.autoDialDiscoveredPeersDebounce)})}isStarted(){return this.started}start(){this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(e=>{Gt.error("error while autodialing",e)})},this.autoDialIntervalMs),this.started=!0}afterStart(){this.autoDial().catch(e=>{Gt.error("error while autodialing",e)})}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started)return;let e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections){this.minConnections>0&&Gt.trace("have enough connections %d/%d",t,this.minConnections);return}if(this.queue.size>this.autoDialMaxQueueLength){Gt("not enough connections %d/%d but auto dial queue is full",t,this.minConnections);return}if(this.running){Gt("not enough connections %d/%d - but skipping autodial as it is already running",t,this.minConnections);return}this.running=!0,Gt("not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);let n=new gn(this.connectionManager.getDialQueue().map(l=>l.peerId).filter(Boolean)),s=await this.peerStore.all({filters:[l=>l.addresses.length===0?(Gt.trace("not autodialing %p because they have no addresses"),!1):e.has(l.id)?(Gt.trace("not autodialing %p because they are already connected"),!1):n.has(l.id)?(Gt.trace("not autodialing %p because they are already being dialed"),!1):this.queue.hasJob(l.id)?(Gt.trace("not autodialing %p because they are already being autodialed"),!1):!0]}),i=s.sort(()=>Math.random()>.5?1:-1),o=new lr;for(let l of i)o.has(l.id)||o.set(l.id,[...l.tags.values()].reduce((u,f)=>u+f.value,0));let c=i.sort((l,u)=>{let f=o.get(l.id)??0,h=o.get(u.id)??0;return f>h?-1:f<h?1:0}).filter(l=>{let u=l.metadata.get(qf);if(u==null)return!0;let f=parseInt(W(u));return isNaN(f)?!0:Date.now()-f>this.autoDialPeerRetryThresholdMs});Gt("selected %d/%d peers to dial",c.length,s.length);for(let l of c)this.queue.add(async()=>{let u=this.connectionManager.getConnectionsMap().size;if(u>=this.minConnections){Gt("got enough connections now %d/%d",u,this.minConnections),this.queue.clear();return}Gt("connecting to a peerStore stored peer %p",l.id),await this.connectionManager.openConnection(l.id,{priority:this.autoDialPriority})},{peerId:l.id}).catch(u=>{Gt.error("could not connect to peerStore stored peer",u)});this.running=!1,this.started&&(this.autoDialInterval=setTimeout(()=>{this.autoDial().catch(l=>{Gt.error("error while autodialing",l)})},this.autoDialIntervalMs))}};var Ha=k("libp2p:connection-manager:connection-pruner"),YE={maxConnections:Ti,allow:[]},Wf=class{maxConnections;connectionManager;peerStore;allow;events;constructor(e,t={}){this.maxConnections=t.maxConnections??YE.maxConnections,this.allow=t.allow??YE.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,e.events.addEventListener("connection:open",()=>{this.maybePruneConnections().catch(n=>{Ha.error(n)})})}async maybePruneConnections(){let e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if(Ha("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;Ha("max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);let s=new lr;for(let a of e){let c=a.remotePeer;if(!s.has(c)){s.set(c,0);try{let l=await this.peerStore.get(c);s.set(c,[...l.tags.values()].reduce((u,f)=>u+f.value,0))}catch(l){l.code!=="ERR_NOT_FOUND"&&Ha.error("error loading peer tags",l)}}}let i=e.sort((a,c)=>{let l=s.get(a.remotePeer)??0,u=s.get(c.remotePeer)??0;if(l>u)return 1;if(l<u)return-1;let f=a.timeline.open,h=c.timeline.open;return f<h?1:f>h?-1:0}),o=[];for(let a of i)if(Ha("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>a.remoteAddr.toString().startsWith(l.toString()))||o.push(a),o.length===n)break;await Promise.all(o.map(async a=>{try{await a.close()}catch(c){Ha.error(c)}})),this.events.safeDispatchEvent("connection:prune",{detail:o})}};var Lm=re(Dr(),1);var Nm=re(Dr(),1);var QE=k("libp2p:connection-manager:utils");async function Om(r,e){if(!r.protoNames().includes("dnsaddr"))return[r];let n=await OM(r,e),o=(await Promise.all(n.map(async a=>Om(a,e)))).flat().reduce((a,c)=>(a.find(l=>l.equals(c))==null&&a.push(c),a),[]);return QE("resolved %s to",r,o.map(a=>a.toString())),o}async function OM(r,e){try{return r=oe(r.toString()),await r.resolve(e)}catch(t){return QE.error(`multiaddr ${r.toString()} could not be resolved`,t),[]}}function XE(...r){let e=[];for(let n of r)if(n!=null){try{(0,Nm.setMaxListeners)?.(1/0,n)}catch{}e.push(n)}let t=gr(e);try{(0,Nm.setMaxListeners)?.(1/0,t)}catch{}return t}var Jt=k("libp2p:connection-manager:dial-queue"),Ll={addressSorter:Ua,maxParallelDials:$f,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:1,dialTimeout:3e4,resolvers:{dnsaddr:Fa}},Gf=class{pendingDials;queue;peerId;peerStore;connectionGater;transportManager;addressSorter;maxPeerAddrsToDial;maxParallelDialsPerPeer;dialTimeout;inProgressDialCount;pendingDialCount;shutDownController;constructor(e,t={}){this.addressSorter=t.addressSorter??Ll.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Ll.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=t.maxParallelDialsPerPeer??Ll.maxParallelDialsPerPeer,this.dialTimeout=t.dialTimeout??Ll.dialTimeout,this.peerId=e.peerId,this.peerStore=e.peerStore,this.connectionGater=e.connectionGater,this.transportManager=e.transportManager,this.shutDownController=new AbortController;try{(0,Lm.setMaxListeners)?.(1/0,this.shutDownController.signal)}catch{}this.pendingDialCount=e.metrics?.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=e.metrics?.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(let[n,s]of Object.entries(t.resolvers??{}))j2.set(n,s);this.queue=new Bt({concurrency:t.maxParallelDials??Ll.maxParallelDials}),this.queue.on("add",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("active",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("completed",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("error",n=>{Jt.error("error in dial queue",n),this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("empty",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)}),this.queue.on("idle",()=>{this.pendingDialCount?.update(this.queue.size),this.inProgressDialCount?.update(this.queue.pending)})}stop(){this.shutDownController.abort()}async dial(e,t={}){let{peerId:n,multiaddrs:s}=Vf(e),i=s.map(u=>({multiaddr:u,isCertified:!1})),o=this.createDialAbortControllers(t.signal),a;try{a=await this.calculateMultiaddrs(n,i,{...t,signal:o})}catch(u){throw o.clear(),u}let c=this.pendingDials.find(u=>!!(u.peerId!=null&&n!=null&&u.peerId.equals(n)||a.map(({multiaddr:f})=>f.toString()).join()===u.multiaddrs.map(f=>f.toString()).join()));if(c!=null)return Jt("joining existing dial target for %p",n),o.clear(),c.promise;Jt("creating dial target for",a.map(({multiaddr:u})=>u.toString()));let l={id:LM(),status:"queued",peerId:n,multiaddrs:a.map(({multiaddr:u})=>u)};return l.promise=this.performDial(l,{...t,signal:o}).finally(()=>{this.pendingDials=this.pendingDials.filter(u=>u.id!==l.id),o.clear()}).catch(async u=>{if(Jt.error("dial failed to %s",l.multiaddrs.map(f=>f.toString()).join(", "),u),n!=null)try{await this.peerStore.patch(n,{metadata:{[qf]:Q(Date.now().toString())}})}catch(f){Jt.error("could not update last dial failure key for %p",n,f)}throw o.aborted?new b(u.message,H.ERR_TIMEOUT):u}),this.pendingDials.push(l),l.promise}createDialAbortControllers(e){let t=gr([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{(0,Lm.setMaxListeners)?.(1/0,t)}catch{}return t}async calculateMultiaddrs(e,t=[],n={}){if(e!=null){if(this.peerId.equals(e))throw new b("Tried to dial self",H.ERR_DIALED_SELF);if(await this.connectionGater.denyDialPeer?.(e)===!0)throw new b("The dial request is blocked by gater.allowDialPeer",H.ERR_PEER_DIAL_INTERCEPTED);if(t.length===0){Jt("loading multiaddrs for %p",e);try{let u=await this.peerStore.get(e);t.push(...u.addresses),Jt("loaded multiaddrs for %p",e,t.map(({multiaddr:f})=>f.toString()))}catch(u){if(u.code!==H.ERR_NOT_FOUND)throw u}}}let s=(await Promise.all(t.map(async u=>{let f=await Om(u.multiaddr,n);return f.length===1&&f[0].equals(u.multiaddr)?u:f.map(h=>({multiaddr:h,isCertified:!1}))}))).flat(),i=s.filter(u=>{if(this.transportManager.transportForMultiaddr(u.multiaddr)==null)return!1;let f=u.multiaddr.getPeerId();return e!=null&&f!=null?e.equals(f):!0}),o=new Map;for(let u of i){let f=u.multiaddr.toString(),h=o.get(f);if(h!=null){h.isCertified=h.isCertified||u.isCertified||!1;continue}o.set(f,u)}let a=[...o.values()];if((a.length===0||a.length>this.maxPeerAddrsToDial)&&(Jt("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:u})=>u.toString())),Jt("addresses for %p after filtering",e??"unknown peer",a.map(({multiaddr:u})=>u.toString()))),a.length===0)throw new b("The dial request has no valid addresses",H.ERR_NO_VALID_ADDRESSES);if(a.length>this.maxPeerAddrsToDial)throw new b("dial with more addresses than allowed",H.ERR_TOO_MANY_ADDRESSES);if(e!=null){let u=`/p2p/${e.toString()}`;a=a.map(f=>{let h=f.multiaddr.getPeerId();return f.multiaddr.protos().pop()?.path===!0?f:h!==e.toString()?{multiaddr:f.multiaddr.encapsulate(u),isCertified:f.isCertified}:f})}let c=[];for(let u of a)this.connectionGater.denyDialMultiaddr!=null&&await this.connectionGater.denyDialMultiaddr(u.multiaddr)||c.push(u);let l=c.sort(this.addressSorter);if(l.length===0)throw new b("The connection gater denied all addresses in the dial request",H.ERR_NO_VALID_ADDRESSES);return l}async performDial(e,t={}){let n=e.multiaddrs.map(()=>new AbortController);try{let s=new Bt({concurrency:this.maxParallelDialsPerPeer});s.on("error",o=>{Jt.error("error dialling",o)});let i=await Promise.any(e.multiaddrs.map(async(o,a)=>{let c=n[a];if(c==null)throw new b("dialAction did not come with an AbortController",H.ERR_INVALID_PARAMETERS);let l=XE(c.signal,t.signal);l.addEventListener("abort",()=>{Jt("dial to %a aborted",o)});let u=De();return await s.add(async()=>{if(l.aborted){Jt("dial to %a was aborted before reaching the head of the peer dial queue",o),u.reject(new Tn);return}await this.queue.add(async()=>{try{if(l.aborted){Jt("dial to %a was aborted before reaching the head of the dial queue",o),u.reject(new Tn);return}e.status="active";let f=await this.transportManager.dial(o,{...t,signal:l});if(c.signal.aborted){Jt("multiple dials succeeded, closing superfluous connection"),f.close().catch(h=>{Jt.error("error closing superfluous connection",h)}),u.reject(new Tn);return}n[a]=void 0,n.forEach(h=>{h!==void 0&&h.abort()}),Jt("dial to %a succeeded",o),u.resolve(f)}catch(f){Jt.error("error during dial of %a",o,f),u.reject(f)}},{...t,signal:l}).catch(f=>{u.reject(f)})},{signal:l}).catch(f=>{u.reject(f)}).finally(()=>{l.clear()}),u.promise}));if(i==null)throw new b("successful dial led to empty object returned from peer dial queue",H.ERR_TRANSPORT_DIAL_FAILED);return e.status="success",i}catch(s){throw e.status="error",e.multiaddrs.length===1&&s.name==="AggregateError"?s.errors[0]:s}}};function LM(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}var jr=k("libp2p:connection-manager"),UM=50,Po={minConnections:zf,maxConnections:Ti,inboundConnectionThreshold:5,maxIncomingPendingConnections:10,autoDialConcurrency:25,autoDialPriority:0,autoDialMaxQueueLength:100},Yf=class{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;maxConnections;dialQueue;autoDial;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;constructor(e,t={}){this.maxConnections=t.maxConnections??Po.maxConnections;let n=t.minConnections??Po.minConnections;if(this.maxConnections<n)throw new b("Connection Manager maxConnections must be greater than minConnections",H.ERR_INVALID_PARAMETERS);this.connections=new lr,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(t.allow??[]).map(s=>oe(s)),this.deny=(t.deny??[]).map(s=>oe(s)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Po.maxIncomingPendingConnections,this.inboundConnectionRateLimiter=new jE.RateLimiterMemory({points:t.inboundConnectionThreshold??Po.inboundConnectionThreshold,duration:1}),this.autoDial=new Hf({connectionManager:this,peerStore:e.peerStore,events:e.events},{minConnections:n,autoDialConcurrency:t.autoDialConcurrency??Po.autoDialConcurrency,autoDialPriority:t.autoDialPriority??Po.autoDialPriority,maxQueueLength:t.autoDialMaxQueueLength??Po.autoDialMaxQueueLength}),this.connectionPruner=new Wf({connectionManager:this,peerStore:e.peerStore,events:e.events},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new Gf({peerId:e.peerId,metrics:e.metrics,peerStore:e.peerStore,transportManager:e.transportManager,connectionGater:e.connectionGater},{addressSorter:t.addressSorter??Ua,maxParallelDials:t.maxParallelDials??$f,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,maxParallelDialsPerPeer:t.maxParallelDialsPerPeer??1,dialTimeout:t.dialTimeout??3e4,resolvers:t.resolvers??{dnsaddr:Fa}})}isStarted(){return this.started}async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{let e={inbound:0,outbound:0};for(let t of this.connections.values())for(let n of t)n.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{let e={};for(let t of this.connections.values())for(let n of t)for(let s of n.streams){let i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{let e={};for(let n of this.connections.values())for(let s of n){let i={};for(let o of s.streams){let a=`${o.direction} ${o.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(let[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}let t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);let i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.autoDial.start(),this.started=!0,jr("started")}async afterStart(){Promise.resolve().then(async()=>{let e=await this.peerStore.all({filters:[t=>t.tags.has(Jw)]});await Promise.all(e.map(async t=>{await this.openConnection(t.id).catch(n=>{jr.error(n)})}))}).catch(e=>{jr.error(e)}),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();let e=[];for(let t of this.connections.values())for(let n of t)e.push((async()=>{try{await n.close()}catch(s){jr.error(s)}})());jr("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),jr("stopped")}onConnect(e){this._onConnect(e).catch(t=>{jr.error(t)})}async _onConnect(e){let{detail:t}=e;if(!this.started){await t.close();return}let n=t.remotePeer,s=this.connections.get(n),i=!1;s!=null?s.push(t):(i=!0,this.connections.set(n,[t])),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){let{detail:t}=e;if(!this.started)return;let n=t.remotePeer,s=this.connections.get(n);s!=null&&s.length>1?(s=s.filter(i=>i.id!==t.id),this.connections.set(n,s)):s!=null&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(let n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.isStarted())throw new b("Not started",H.ERR_NODE_NOT_STARTED);t.signal?.throwIfAborted();let{peerId:n}=Vf(e);if(n!=null&&t.force!==!0){jr("dial %p",n);let a=this.getConnections(n);if(a.length>0)return jr("had an existing connection to %p",n),a[0]}let s=await this.dialQueue.dial(e,{...t,priority:t.priority??UM}),i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let o=!1;for(let a of i)a.id===s.id&&(o=!0);return o||i.push(s),s}async closeConnections(e,t={}){let n=this.connections.get(e)??[];await Promise.all(n.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return jr("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return jr("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){let s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return jr("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(jr("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){return this.dialQueue.pendingDials}};async function*Bl(r,e){yield*In(r,async t=>(await e.merge(t.id,{multiaddrs:t.multiaddrs}),t))}function Qf(r){let e=new Set;return mr(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*Xf(r,e=1){let t=0;for await(let n of r)t++,yield n;if(t<e)throw new b(`more peers required, seen: ${t}  min: ${e}`,"NOT_FOUND")}var jf=class{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new b("No content routers available",H.ERR_NO_ROUTERS_AVAILABLE);yield*Ie(Lt(...this.routers.map(n=>n.findProviders(e,t))),n=>Bl(n,this.components.peerStore),n=>Qf(n),n=>Xf(n))}async provide(e,t={}){if(this.routers.length===0)throw new b("No content routers available",H.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new b(ms.NOT_STARTED_YET,H.DHT_NOT_STARTED);await Promise.all(this.routers.map(async s=>{await s.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new b(ms.NOT_STARTED_YET,H.DHT_NOT_STARTED);return Promise.any(this.routers.map(async n=>n.get(e,t)))}};function FM(r){return r[Symbol.asyncIterator]!=null}function KM(r){if(FM(r))return(async()=>{for await(let e of r)return e})();for(let e of r)return e}var Hn=KM;var VM=k("libp2p:peer-routing"),Zf=class{components;routers;constructor(e,t){this.components=e,this.routers=t.routers??[]}async findPeer(e,t){if(this.routers.length===0)throw new b("No peer routers available",H.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw new b("Should not try to find self",H.ERR_FIND_SELF);let n=await Ie(Lt(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(i){VM.error(i)}}())),s=>mr(s,Boolean),s=>Bl(s,this.components.peerStore),async s=>Hn(s));if(n!=null)return n;throw new b(ms.NOT_FOUND,H.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw new b("No peer routers available",H.ERR_NO_ROUTERS_AVAILABLE);yield*Ie(Lt(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>Bl(n,this.components.peerStore),n=>Qf(n),n=>Xf(n))}};var Fm=k("libp2p:registrar"),Km=32,Vm=64,Jf=class{topologies;handlers;components;constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onConnect=this._onConnect.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:connect",this._onConnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){let t=this.handlers.get(e);if(t==null)throw new b(`No handler registered for protocol ${e}`,H.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){let t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new b(`Handler already registered for protocol ${e}`,H.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);let s=vi.bind({ignoreUndefined:!0})({maxInboundStreams:Km,maxOutboundStreams:Vm},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new b("invalid topology",H.ERR_INVALID_PARAMETERS);let n=`${(Math.random()*1e9).toString(36)}${Date.now()}`,s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),n}unregister(e){for(let[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){let t=e.detail;this.components.peerStore.get(t).then(n=>{for(let s of n.protocols){let i=this.topologies.get(s);if(i!=null)for(let o of i.values())o.onDisconnect?.(t)}}).catch(n=>{n.code!==H.ERR_NOT_FOUND&&Fm.error("could not inform topologies of disconnecting peer %p",t,n)})}_onConnect(e){let t=e.detail;this.components.peerStore.get(t).then(n=>{let s=this.components.connectionManager.getConnections(n.id)[0];if(s==null){Fm("peer %p connected but the connection manager did not have a connection",n);return}for(let i of n.protocols){let o=this.topologies.get(i);if(o!=null)for(let a of o.values())a.onConnect?.(t,s)}}).catch(n=>{n.code!==H.ERR_NOT_FOUND&&Fm.error("could not inform topologies of connecting peer %p",t,n)})}_onPeerUpdate(e){let{peer:t,previous:n}=e.detail,s=(n?.protocols??[]).filter(o=>!t.protocols.includes(o)),i=t.protocols.filter(o=>!(n?.protocols??[]).includes(o));for(let o of s){let a=this.topologies.get(o);if(a!=null)for(let c of a.values())c.onDisconnect?.(t.id)}for(let o of i){let a=this.topologies.get(o);if(a!=null)for(let c of a.values()){let l=this.components.connectionManager.getConnections(t.id)[0];l!=null&&c.onConnect?.(t.id,l)}}}};var ko=k("libp2p:transports"),eh=class{components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.components=e,this.started=!1,this.transports=new Map,this.listeners=ts({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Ri.FATAL_ALL}add(e){let t=e[Symbol.toStringTag];if(t==null)throw new b("Transport must have a valid tag",H.ERR_INVALID_KEY);if(this.transports.has(t))throw new b(`There is already a transport with the tag ${t}`,H.ERR_DUPLICATE_TRANSPORT);ko("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){let e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){let e=[];for(let[t,n]of this.listeners)for(ko("closing listeners for %s",t);n.length>0;){let s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),ko("all listeners closed");for(let t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){let n=this.transportForMultiaddr(e);if(n==null)throw new b(`No transport available for address ${String(e)}`,H.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=H.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(let t of this.listeners.values())for(let n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(let t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new b("Not started",H.ERR_NODE_NOT_STARTED);if(e==null||e.length===0){ko("no addresses were provided for listening, this node is dial only");return}let t=[];for(let[n,s]of this.transports.entries()){let i=s.filter(e),o=[];for(let l of i){ko("creating listener for %s on %a",n,l);let u=s.createListener({upgrader:this.components.upgrader}),f=this.listeners.get(n)??[];f==null&&(f=[],this.listeners.set(n,f)),f.push(u),u.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:u})}),u.addEventListener("close",()=>{let h=f.findIndex(d=>d===u);f.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:u})}),o.push(u.listen(l))}if(o.length===0){t.push(n);continue}if((await Promise.allSettled(o)).find(l=>l.status==="fulfilled")==null&&this.faultTolerance!==Ri.NO_FATAL)throw new b(`Transport (${n}) could not listen on any available address`,H.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){let n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===Ri.FATAL_ALL)throw new b(n,H.ERR_NO_VALID_ADDRESSES);ko(`libp2p in dial mode only: ${n}`)}}async remove(e){ko("removing %s",e);for(let t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){let e=[];for(let t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}};var $m=re(Dr(),1);var qs="/multistream/1.0.0";function qm(r){let e=async function*(){let t=yield,n=new Ee;for await(let s of r){if(t==null){n.append(s),t=yield n,n=new Ee;continue}for(n.append(s);n.length>=t;){let i=n.sublist(0,t);if(n.consume(t),t=yield i,t==null){n.length>0&&(t=yield n,n=new Ee);break}}}if(t!=null)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return e.next(),e}function th(r){let e=wt(),t=qm(r.source),n=De(),s,i=r.sink(async function*(){yield*e,yield*await n.promise}());return i.catch(a=>{s=a}),{reader:t,writer:e,stream:{sink:async a=>{if(s!=null){await Promise.reject(s);return}n.resolve(a),await i},source:t},rest:()=>e.end(),write:e.push,read:async()=>{let a=await t.next();if(a.value!=null)return a.value}}}var Ml=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function ZE(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function ur(r,e,t){let n=t??{},s=ZE(r);async function*i(){let o,a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){let{abortMessage:u,abortCode:f}=n;throw new Ml(u,f)}let l=new Promise((u,f)=>{o=()=>{let{abortMessage:h,abortCode:d}=n;f(new Ml(h,d))}});c=await Promise.race([l,s.next()]),o=null}catch(l){e.removeEventListener("abort",a);let u=l.type==="aborted"&&e.aborted;if(u&&n.onAbort!=null&&n.onAbort(r),typeof s.return=="function")try{let f=s.return();f instanceof Promise&&f.catch(h=>{n.onReturnError!=null&&n.onReturnError(h)})}catch(f){n.onReturnError!=null&&n.onReturnError(f)}if(u&&n.returnOnAbort===!0)return;throw l}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function qM(r,e,t){return n=>r(ur(n,e,t))}function Wa(r,e,t){return{sink:qM(r.sink,e,{...t,onAbort:void 0}),source:ur(r.source,e,t)}}var $M=k("libp2p:mss"),JE=Q(`
`);function Ul(r){let e=new Ee(r,JE);return _t.single(e)}function No(r,e,t={}){let n=Ul(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function ex(r,e,t={}){let n=new Ee;for(let s of e)n.append(Ul(s));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function HM(r,e){let t=1,n={[Symbol.asyncIterator]:()=>n,next:async()=>r.next(t)},s=n;e?.signal!=null&&(s=ur(n,e.signal));let i=a=>{t=a},o=await Ie(s,a=>Ct(a,{onLength:i,maxDataLength:1024}),async a=>Hn(a));if(o==null||o.length===0)throw new b("no buffer returned","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==JE[0])throw $M.error("Invalid mss message - missing newline - %s",o.subarray()),new b("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function Ga(r,e){let t=await HM(r,e);return W(t.subarray())}var Fl=k("libp2p:mss:select");async function Kl(r,e,t={}){e=Array.isArray(e)?[...e]:[e];let{reader:n,writer:s,rest:i,stream:o}=th(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");Fl.trace('select: write ["%s", "%s"]',qs,a);let c=Q(qs),l=Q(a);ex(s,[c,l],t);let u=await Ga(n,t);if(Fl.trace('select: read "%s"',u),u===qs&&(u=await Ga(n,t),Fl.trace('select: read "%s"',u)),u===a)return i(),{stream:o,protocol:a};for(let f of e){Fl.trace('select: write "%s"',f),No(s,Q(f),t);let h=await Ga(n,t);if(Fl.trace('select: read "%s" for "%s"',h,f),h===f)return i(),{stream:o,protocol:f}}throw i(),new b("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}var Vl=k("libp2p:mss:handle");async function ql(r,e,t){e=Array.isArray(e)?e:[e];let{writer:n,reader:s,rest:i,stream:o}=th(r);for(;;){let a=await Ga(s,t);if(Vl.trace('read "%s"',a),a===qs){Vl.trace('respond with "%s" for "%s"',qs,a),No(n,Q(qs),t);continue}if(e.includes(a))return No(n,Q(a),t),Vl.trace('respond with "%s" for "%s"',a,a),i(),{stream:o,protocol:a};if(a==="ls"){No(n,new Ee(...e.map(c=>Ul(Q(c)))),t),Vl.trace('respond with "%s" for %s',e,a);continue}No(n,Q("na"),t),Vl('respond with "na" for "%s"',a)}}var nx=re(Dr(),1);var rx=Symbol.for("@libp2p/connection");var rh=k("libp2p:connection"),GM=500,zm=class{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;transient;tags;_newStream;_close;_abort;_getStreams;constructor(e){let{remoteAddr:t,remotePeer:n,newStream:s,close:i,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=e.transient??!1,this._newStream=s,this._close=i,this._abort=o,this._getStreams=a,this.tags=[]}[Symbol.toStringTag]="Connection";[rx]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new b("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if(this.status==="closed")throw new b("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&t?.runOnTransientConnection!==!0)throw new b("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");let n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){rh("closing connection to %a",this.remoteAddr),this.status="closing",e.signal=e?.signal??AbortSignal.timeout(GM);try{(0,nx.setMaxListeners)?.(1/0,e.signal)}catch{}try{await Promise.all(this.streams.map(async t=>t.close(e))),await this._close(e),this.timeline.close=Date.now(),this.status="closed"}catch(t){rh.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){rh.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach(t=>{t.abort(e)}),rh.error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}};function sx(r){return new zm(r)}var dt=k("libp2p:upgrader");function QM(r,e){try{let{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==H.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return Km}function XM(r,e,t={}){try{let{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.code!==H.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return t.maxOutboundStreams??Vm}function ix(r,e,t){let n=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===r&&n++}),n}var nh=class{components;connectionEncryption;muxers;inboundUpgradeTimeout;events;constructor(e,t){this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??3e4,this.events=e.events}async shouldBlockConnection(e,t,n){let s=this.components.connectionGater[n];if(s!==void 0&&await s(e,t))throw new b(`The multiaddr connection is blocked by gater.${n}`,H.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new b("connection denied",H.ERR_CONNECTION_DENIED);let s,i,o,a,c,l=AbortSignal.timeout(this.inboundUpgradeTimeout),u=()=>{e.abort(new b("inbound upgrade timeout",H.ERR_TIMEOUT))};l.addEventListener("abort",u,{once:!0});try{(0,$m.setMaxListeners)?.(1/0,l)}catch{}try{if(await this.components.connectionGater.denyInboundConnection?.(e)===!0)throw new b("The multiaddr connection is blocked by gater.acceptConnection",H.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),dt("starting the inbound connection upgrade");let f=e;if(t?.skipProtection!==!0){let h=this.components.connectionProtector;h!=null&&(dt("protecting the inbound connection"),f=await h.protect(e))}try{if(s=f,t?.skipEncryption!==!0){({conn:s,remotePeer:i,protocol:c}=await this._encryptInbound(f));let h={...f,...s};await this.shouldBlockConnection(i,h,"denyInboundEncryptedConnection")}else{let h=e.remoteAddr.getPeerId();if(h==null)throw new b("inbound connection that skipped encryption must have a peer id",H.ERR_INVALID_MULTIADDR);let d=fe(h);c="native",i=d}if(o=s,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){let h=await this._multiplexInbound({...f,...s},this.muxers);a=h.muxerFactory,o=h.stream}}catch(h){throw dt.error("Failed to upgrade inbound connection",h),h}return await this.shouldBlockConnection(i,e,"denyInboundUpgradedConnection"),dt("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i,transient:t?.transient})}finally{l.removeEventListener("abort",u),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){let n=e.remoteAddr.getPeerId(),s;n!=null&&(s=fe(n),await this.shouldBlockConnection(s,e,"denyOutboundConnection"));let i,o,a,c,l;this.components.metrics?.trackMultiaddrConnection(e),dt("Starting the outbound connection upgrade");let u=e;if(t?.skipProtection!==!0){let f=this.components.connectionProtector;f!=null&&(u=await f.protect(e))}try{if(i=u,t?.skipEncryption!==!0){({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(u,s));let f={...u,...i};await this.shouldBlockConnection(o,f,"denyOutboundEncryptedConnection")}else{if(s==null)throw new b("Encryption was skipped but no peer id was passed",H.ERR_INVALID_PEER);c="native",o=s}if(a=i,t?.muxerFactory!=null)l=t.muxerFactory;else if(this.muxers.size>0){let f=await this._multiplexOutbound({...u,...i},this.muxers);l=f.muxerFactory,a=f.stream}}catch(f){throw dt.error("Failed to upgrade outbound connection",f),await e.close(f),f}return await this.shouldBlockConnection(o,e,"denyOutboundUpgradedConnection"),dt("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:l,remotePeer:o,transient:t?.transient})}_createConnection(e){let{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a,transient:c}=e,l,u,f;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:p=>{f!=null&&Promise.resolve().then(async()=>{let m=this.components.registrar.getProtocols(),{stream:g,protocol:y}=await ql(p,m);if(dt("%s: incoming stream opened on %s",n,y),f==null)return;let w=QM(y,this.components.registrar);if(ix(y,"inbound",f)===w){let R=new b(`Too many inbound protocol streams for protocol "${y}" - limit ${w}`,H.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw p.abort(R),R}p.source=g.source,p.sink=g.sink,p.protocol=y,await this.components.peerStore.merge(o,{protocols:[y]}),this.components.metrics?.trackProtocolStream(p,f),this._onStream({connection:f,stream:p,protocol:y})}).catch(async m=>{dt.error(m),p.timeline.close==null&&await p.close()})}}),u=async(p,m={})=>{if(l==null)throw new b("Stream is not multiplexed",H.ERR_MUXER_UNAVAILABLE);dt("%s: starting new stream on %s",n,p);let g=await l.newStream();try{if(m.signal==null){dt("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",p),m.signal=AbortSignal.timeout(3e4);try{(0,$m.setMaxListeners)?.(1/0,m.signal)}catch{}}let{stream:y,protocol:w}=await Kl(g,p,m),E=XM(w,this.components.registrar,m);if(ix(w,"outbound",f)>=E){let x=new b(`Too many outbound protocol streams for protocol "${w}" - limit ${E}`,H.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw g.abort(x),x}return await this.components.peerStore.merge(o,{protocols:[w]}),g.source=y.source,g.sink=y.sink,g.protocol=w,this.components.metrics?.trackProtocolStream(g,f),g}catch(y){throw dt.error("could not create new stream",y),g.timeline.close==null&&g.abort(y),y.code!=null?y:new b(String(y),H.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([l.sink(i.source),i.sink(l.source)]).catch(p=>{dt.error(p)}));let h=s.timeline;s.timeline=new Proxy(h,{set:(...p)=>(f!=null&&p[1]==="close"&&p[2]!=null&&h.close==null&&(async()=>{try{f.status==="open"&&await f.close()}catch(m){dt.error(m)}finally{this.events.safeDispatchEvent("connection:close",{detail:f})}})().catch(m=>{dt.error(m)}),Reflect.set(...p))}),s.timeline.upgraded=Date.now();let d=()=>{throw new b("connection is not multiplexed",H.ERR_CONNECTION_NOT_MULTIPLEXED)};return f=sx({remoteAddr:s.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:s.timeline,multiplexer:l?.protocol,encryption:t,transient:c,newStream:u??d,getStreams:()=>l!=null?l.streams:[],close:async p=>{await s.close(p),l!=null&&await l.close(p)},abort:p=>{s.abort(p),l?.abort(p)}}),this.events.safeDispatchEvent("connection:open",{detail:f}),f}_onStream(e){let{connection:t,stream:n,protocol:s}=e,{handler:i,options:o}=this.components.registrar.getHandler(s);if(t.transient&&o.runOnTransientConnection!==!0)throw new b("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:t,stream:n})}async _encryptInbound(e){let t=Array.from(this.connectionEncryption.keys());dt("handling inbound crypto protocol selection",t);try{let{stream:n,protocol:s}=await ql(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return dt("encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:s}}catch(n){throw new b(String(n),H.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){let n=Array.from(this.connectionEncryption.keys());dt("selecting outbound crypto protocol",n);try{let{stream:s,protocol:i}=await Kl(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return dt("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,s,t),protocol:i}}catch(s){throw new b(String(s),H.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){let n=Array.from(t.keys());dt("outbound selecting muxer %s",n);try{let{stream:s,protocol:i}=await Kl(e,n,{writeBytes:!0});dt("%s selected as muxer protocol",i);let o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw dt.error("error multiplexing outbound stream",s),new b(String(s),H.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){let n=Array.from(t.keys());dt("inbound handling muxers %s",n);try{let{stream:s,protocol:i}=await ql(e,n,{writeBytes:!0}),o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw dt.error("error multiplexing inbound stream",s),new b(String(s),H.ERR_MUXER_UNAVAILABLE)}}};var Or=k("libp2p"),Hm=class extends Ue{peerId;peerStore;contentRouting;peerRouting;keychain;metrics;services;components;#e;constructor(e){super();let t=new Ue,n=t.dispatchEvent.bind(t);t.dispatchEvent=c=>{let l=n(c),u=this.dispatchEvent(new Ge(c.type,{detail:c.detail}));return l||u};try{(0,ox.setMaxListeners)?.(1/0,t)}catch{}this.#e=!1,this.peerId=e.peerId,this.services={};let s=this.components=Ew({peerId:e.peerId,events:t,datastore:e.datastore??new Yi,connectionGater:Cw(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new Cf(s,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),s.events.addEventListener("peer:update",c=>{if(c.detail.previous==null){let l={id:c.detail.peer.id,multiaddrs:c.detail.peer.addresses.map(u=>u.multiaddr),protocols:c.detail.peer.protocols};s.events.safeDispatchEvent("peer:discovery",{detail:l})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(s)),this.components.upgrader=new nh(this.components,{connectionEncryption:(e.connectionEncryption??[]).map((c,l)=>this.configureComponent(`connection-encryption-${l}`,c(this.components))),muxers:(e.streamMuxers??[]).map((c,l)=>this.configureComponent(`stream-muxers-${l}`,c(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new eh(this.components,e.transportManager)),this.configureComponent("connectionManager",new Yf(this.components,e.connectionManager)),this.configureComponent("registrar",new Jf(this.components)),this.configureComponent("addressManager",new Pf(this.components,e.addresses));let i=To.generateOptions();this.keychain=this.configureComponent("keyChain",new To(this.components,{...i,...e.keychain}));let o=(e.peerRouters??[]).map((c,l)=>this.configureComponent(`peer-router-${l}`,c(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Zf(this.components,{routers:o}));let a=(e.contentRouters??[]).map((c,l)=>this.configureComponent(`content-router-${l}`,c(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new jf(this.components,{routers:a})),(e.peerDiscovery??[]).forEach((c,l)=>{this.configureComponent(`peer-discovery-${l}`,c(this.components)).addEventListener("peer",f=>{this.#t(f)})}),e.transports.forEach((c,l)=>{this.components.transportManager.add(this.configureComponent(`transport-${l}`,c(this.components)))}),e.services!=null)for(let c of Object.keys(e.services)){let l=e.services[c],u=l(this.components);if(u==null){Or.error("service factory %s returned null or undefined instance",c);continue}this.services[c]=u,this.configureComponent(c,u),u[_l]!=null&&(Or("registering service %s for content routing",c),a.push(u[_l])),u[Sl]!=null&&(Or("registering service %s for peer routing",c),o.push(u[Sl])),u[xo]!=null&&(Or("registering service %s for peer discovery",c),u[xo].addEventListener("peer",f=>{this.#t(f)}))}}configureComponent(e,t){return t==null&&Or.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.#e)return;this.#e=!0,Or("libp2p is starting"),(await this.keychain.listKeys()).find(t=>t.name==="self")==null&&(Or("importing self key into keychain"),await this.keychain.importPeer("self",this.components.peerId));try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.safeDispatchEvent("start",{detail:this}),Or("libp2p has started")}catch(t){throw Or.error("An error occurred starting libp2p",t),await this.stop(),t}}async stop(){this.#e&&(Or("libp2p is stopping"),this.#e=!1,await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.safeDispatchEvent("stop",{detail:this}),Or("libp2p has stopped"))}isStarted(){return this.#e}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){let e=new gn;for(let t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(t==null)throw new b("no protocols were provided to open a stream",H.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw new b("no protocols were provided to open a stream",H.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Ao(e)&&(e=fe(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(Or("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;let n=await this.peerStore.get(e);if(n.id.publicKey!=null)return n.id.publicKey;let s=_e([Q("/pk/"),e.multihash.digest]),i=await this.contentRouting.get(s,t);return kr(i),await this.peerStore.patch(e,{publicKey:i}),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}#t(e){let{detail:t}=e;if(t.id.toString()===this.peerId.toString()){Or.error(new Error(H.ERR_DISCOVERED_SELF));return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch(n=>{Or.error(n)})}};async function ax(r){if(r.peerId==null){let e=r.datastore;if(e!=null)try{let t=new To({datastore:e},vi(To.generateOptions(),r.keychain));r.peerId=await t.exportPeerId("self")}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}}return r.peerId==null&&(r.peerId=await wf()),new Hm(Zw(r))}async function cx(r){let e=await ax(r);return r.start!==!1&&await e.start(),e}var sh=class{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,n){this.gossip=e,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){let{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){let n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){let n=this.msgs.get(e);if(!n)return null;let s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){let t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{let i=this.msgs.get(s.msgIdStr);if(i&&i.validated&&e.has(s.topic)){let o=t.get(s.topic);o||(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){let t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;let{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{let n=this.msgs.get(t.msgIdStr);n&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){let t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}};var xx=re(Ex(),1),{RPC:Hl}=xx.default;var Ym="/floodsub/1.0.0",Qm="/meshsub/1.0.0",Xm="/meshsub/1.1.0";var vx="ERR_TOPIC_VALIDATOR_REJECT",_x="ERR_TOPIC_VALIDATOR_IGNORE";function gs(r){if(r.length<=1)return r;let e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){let n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function Sx(r){return W(r,"base64")}var Oo="StrictSign",Ya="StrictNoSign",Er;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Er||(Er={}));var Rx;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(Rx||(Rx={}));var Ai;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(Ai||(Ai={}));var xr;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(xr||(xr={}));var fr;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(fr||(fr={}));var hr;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(hr||(hr={}));function jm(r){switch(r){case Er.Ignore:return xr.Ignore;case Er.Reject:return xr.Reject}}async function Zm(r,e){switch(r){case Oo:{if(!e)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");let t=await qn(e.privateKey);return{type:Ai.Signing,author:e,key:e.publicKey,privateKey:t}}case Ya:return{type:Ai.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}var Ze="ERR_INVALID_PEER_SCORE_PARAMS";var JM={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},eU={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Ix(r={}){return{...JM,...r,topics:r.topics?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=tU(n),e),{}):{}}}function tU(r={}){return{...eU,...r}}function Tx(r){for(let[e,t]of Object.entries(r.topics))try{rU(t)}catch(n){throw new b(`invalid score parameters for topic ${e}: ${n.message}`,Ze)}if(r.topicScoreCap<0)throw new b("invalid topic score cap; must be positive (or 0 for no cap)",Ze);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new b("missing application specific score function",Ze);if(r.IPColocationFactorWeight>0)throw new b("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Ze);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new b("invalid IPColocationFactorThreshold; must be at least 1",Ze);if(r.behaviourPenaltyWeight>0)throw new b("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Ze);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new b("invalid BehaviourPenaltyDecay; must be between 0 and 1",Ze);if(r.decayInterval<1e3)throw new b("invalid DecayInterval; must be at least 1s",Ze);if(r.decayToZero<=0||r.decayToZero>=1)throw new b("invalid DecayToZero; must be between 0 and 1",Ze)}function rU(r){if(r.topicWeight<0)throw new b("invalid topic weight; must be >= 0",Ze);if(r.timeInMeshQuantum===0)throw new b("invalid TimeInMeshQuantum; must be non zero",Ze);if(r.timeInMeshWeight<0)throw new b("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Ze);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new b("invalid TimeInMeshQuantum; must be positive",Ze);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new b("invalid TimeInMeshCap; must be positive",Ze);if(r.firstMessageDeliveriesWeight<0)throw new b("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Ze);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new b("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Ze);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new b("invalid FirstMessageDeliveriesCap; must be positive",Ze);if(r.meshMessageDeliveriesWeight>0)throw new b("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Ze);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new b("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new b("invalid MeshMessageDeliveriesCap; must be positive",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new b("invalid MeshMessageDeliveriesThreshold; must be positive",Ze);if(r.meshMessageDeliveriesWindow<0)throw new b("invalid MeshMessageDeliveriesWindow; must be non-negative",Ze);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new b("invalid MeshMessageDeliveriesActivation; must be at least 1s",Ze);if(r.meshFailurePenaltyWeight>0)throw new b("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Ze);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new b("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Ze);if(r.invalidMessageDeliveriesWeight>0)throw new b("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Ze);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new b("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Ze)}var nU={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function Ax(r={}){return{...nU,...r}}function Dx(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{let c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let d=a.meshTime/c.timeInMeshQuantum;d>c.timeInMeshCap&&(d=c.timeInMeshCap),l+=d*c.timeInMeshWeight}let u=a.firstMessageDeliveries;if(u>c.firstMessageDeliveriesCap&&(u=c.firstMessageDeliveriesCap),l+=u*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){let d=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,p=d*d;l+=p*c.meshMessageDeliveriesWeight}let f=a.meshFailurePenalty;l+=f*c.meshFailurePenaltyWeight;let h=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=h*c.invalidMessageDeliveriesWeight,s+=l*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);let i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;let a=n.get(o),c=a?a.size:0;if(c>t.IPColocationFactorThreshold){let l=c-t.IPColocationFactorThreshold,u=l*l;s+=u*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){let o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}var kx=re(Px(),1),vr;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(vr||(vr={}));var ih=class{records;queue;constructor(){this.records=new Map,this.queue=new kx.default}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:vr.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);let n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){let e=Date.now(),t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}};function ah(r,e,t=()=>!0){let n=new Set;if(e<=0)return n;for(let s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function Nx(r,e){return ah(r,e,()=>!0)}var oh=class extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}};var Qa=k("libp2p:gossipsub:score"),ch=class{params;metrics;peerStats=new Map;peerIPs=new oh(()=>new Set);scoreCache=new Map;deliveryRecords=new ih;_backgroundInterval;scoreCacheValidityMs;computeScore;constructor(e,t,n){this.params=e,this.metrics=t,Tx(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??Dx}get size(){return this.peerStats.size}start(){if(this._backgroundInterval){Qa("Peer score already running");return}this._backgroundInterval=setInterval(()=>this.background(),this.params.decayInterval),Qa("started")}stop(){if(!this._backgroundInterval){Qa("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),Qa("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){let t=this.deliveryRecords.getRecord(e);return t?t.firstSeenTsMs:null}refreshScores(){let e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{let a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();let t=this.peerStats.get(e);if(!t)return 0;let n=Date.now(),s=this.scoreCache.get(e);if(s&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();let i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){let s=this.peerStats.get(e);s&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){let t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){let n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){let n=this.peerStats.get(e);n&&n.knownIPs.delete(t);let s=this.peerIPs.get(t);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){let t=this.peerStats.get(e);if(t){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;let i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){let o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){let n=this.peerStats.get(e);if(n){let s=this.getPtopicStats(n,t);s&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){let n=this.peerStats.get(e);if(n){let s=this.getPtopicStats(n,t);if(s){let i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){let o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);let s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==vr.unknown){Qa("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeenTsMs,vr[s.status]);return}s.status=vr.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case xr.Error:this.markInvalidMessageDelivery(e,n);return;case xr.Blacklisted:return}let i=this.deliveryRecords.ensureRecord(t);if(i.status!==vr.unknown){Qa("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,vr[i.status]);return}if(s===xr.Ignore){i.status=vr.ignored,i.peers.clear();return}i.status=vr.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){let s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case vr.unknown:s.peers.add(e);break;case vr.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case vr.invalid:this.markInvalidMessageDelivery(e,n);break;case vr.ignored:break}}markInvalidMessageDelivery(e,t){let n=this.peerStats.get(e);if(n){let s=this.getPtopicStats(n,t);s&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){let n=this.peerStats.get(e);if(n){let s=this.getPtopicStats(n,t);if(s){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){let s=this.peerStats.get(e);if(s){let i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o&&o.inMesh){let a=this.params.topics[t];if(n!==void 0){let l=i-n,u=l>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,l,u),u)return}let c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(let n of t){let s=this.peerIPs.get(n);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}};var lh=class{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){let n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s),o=this.promises.get(i);o||(o=new Map,this.promises.set(i,o));let a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){let e=Date.now(),t=new Map,n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size||this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);let n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case xr.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){let e=Date.now()-this.requestMsByMsgExpire,t=0;for(let[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics){let t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}};var Xa=class{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){let e=Date.now();for(let[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){let t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}};var Ox;(function(r){r.forward="forward",r.publish="publish"})(Ox||(Ox={}));var _r;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(_r||(_r={}));var Wn;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Wn||(Wn={}));var Za;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(Za||(Za={}));var Ja;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(Ja||(Ja={}));var ja;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(ja||(ja={}));function Lx(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",labelNames:["topic"],buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,1*t.maxMeshMessageDeliveriesWindowSec,2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,1*t.behaviourPenaltyThreshold,2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,1*t.gossipPromiseExpireSec,2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){let o=this.toTopic(n);switch(s){case _r.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},i);break;case _r.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},i);break;case _r.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},i);break;case _r.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},i);break;case _r.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},i);break;case _r.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},i);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},i);break}},onRemoveFromMesh(n,s,i){let o=this.toTopic(n);switch(s){case Wn.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},i);break;case Wn.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},i);break;case Wn.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},i);break;case Wn.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},i);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},i);break}},onReportValidation(n,s,i){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){let o=this.toTopic(n.message.topic);switch(s){case Er.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Er.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Er.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}i!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-i)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){let o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(let[i,o]of n){let a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){let i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o,a){let c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},i*o),this.msgPublishPeersByTopic.inc({topic:c},i),this.directPeersPublishedTotal.inc({topic:c},s.direct),this.floodsubPeersPublishedTotal.inc({topic:c},s.floodsub),this.meshPeersPublishedTotal.inc({topic:c},s.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},s.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){let s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){let s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onPrevalidationResult(n,s){let i=this.toTopic(n);switch(s){case hr.duplicate:this.prevalidationDuplicateTotal.inc({topic:i});break;case hr.invalid:this.prevalidationInvalidTotal.inc({topic:i});break;case hr.valid:this.prevalidationValidTotal.inc({topic:i});break;default:this.prevalidationUnknownTotal.inc({topic:i});break}},onMsgRecvInvalid(n,s){let i=this.toTopic(n),o=s.reason===xr.Error?s.error:s.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:i},1)},onDuplicateMsgDelivery(n,s,i){if(this.duplicateMsgDeliveryDelay.observe(s/1e3),i){let o=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:o},1)}},onPublishDuplicateMsg(n){let s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages&&this.rpcRecvMessage.inc(n.messages.length),n.control&&(this.rpcRecvControl.inc(1),n.control.ihave&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages&&this.rpcSentMessage.inc(n.messages.length),n.control){let i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(i>0||o>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(let l of n)l>=s.graylistThreshold&&i++,l>=s.publishThreshold&&o++,l>=s.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:ja.graylist},i),this.peersByScoreThreshold.set({threshold:ja.publish},o),this.peersByScoreThreshold.set({threshold:ja.gossip},a),this.peersByScoreThreshold.set({threshold:ja.mesh},c),this.score.set(n)},registerScoreWeights(n){for(let[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){let i=new Map;n.forEach((o,a)=>{let c=this.topicStrToLabel.get(a)??"unknown",l=i.get(c);l||(l=new Set,i.set(c,l)),o.forEach(u=>l?.add(u))});for(let[o,a]of i){let c=[];a.forEach(l=>{c.push(s.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}var Bx=Q("libp2p-pubsub:");async function Mx(r,e,t,n){switch(r.type){case Ai.Signing:{let s={from:r.author.toBytes(),data:n,seqno:Pr(8),topic:e,signature:void 0,key:void 0},i=_e([Bx,Hl.Message.encode(s).finish()]);s.signature=await r.privateKey.sign(i),s.key=r.key;let o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${W(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:o}}case Ai.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}}}}async function Ux(r,e){switch(r){case Ya:return e.signature!=null?{valid:!1,error:fr.SignaturePresent}:e.seqno!=null?{valid:!1,error:fr.SeqnoPresent}:e.key!=null?{valid:!1,error:fr.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case Oo:{if(e.seqno==null)return{valid:!1,error:fr.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:fr.InvalidSeqno};if(e.signature==null)return{valid:!1,error:fr.InvalidSignature};if(e.from==null)return{valid:!1,error:fr.InvalidPeerId};let t;try{t=ht(e.from)}catch{return{valid:!1,error:fr.InvalidPeerId}}let n;if(e.key){if(n=kr(e.key),t.publicKey!==void 0&&!me(n.bytes,t.publicKey))return{valid:!1,error:fr.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:fr.InvalidPeerId};n=kr(t.publicKey)}let s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=_e([Bx,Hl.Message.encode(s).finish()]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${W(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??vl(n)}}:{valid:!1,error:fr.InvalidSignature}}}}var Fx=(r,e)=>{let t=Q(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function Kx(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return Fx(r.from.toBytes(),r.sequenceNumber)}async function Vx(r){return await Ne.encode(r.data)}function iU(r,e,t,n,s){let i=0,o=new Map;if(Object.entries(e.topics).forEach(([h,d])=>{let p=s.get(h)??"unknown",m=t.topics[h];if(m===void 0)return;let g=o.get(p);g||(g={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(p,g));let y=0,w=0,E=0,R=0,x=0;if(d.inMesh){let D=Math.max(d.meshTime/m.timeInMeshQuantum,m.timeInMeshCap);y+=D*m.timeInMeshWeight}let v=d.firstMessageDeliveries;if(v>m.firstMessageDeliveriesCap&&(v=m.firstMessageDeliveriesCap),w+=v*m.firstMessageDeliveriesWeight,d.meshMessageDeliveriesActive&&d.meshMessageDeliveries<m.meshMessageDeliveriesThreshold){let D=m.meshMessageDeliveriesThreshold-d.meshMessageDeliveries,O=D*D;E+=O*m.meshMessageDeliveriesWeight}let I=d.meshFailurePenalty;R+=I*m.meshFailurePenaltyWeight;let _=d.invalidMessageDeliveries*d.invalidMessageDeliveries;x+=_*m.invalidMessageDeliveriesWeight,i+=(y+w+E+R+x)*m.topicWeight,g.p1w+=y,g.p2w+=w,g.p3w+=E,g.p3bw+=R,g.p4w+=x}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;let h=t.topicScoreCap/i;for(let d of o.values())d.p1w*=h,d.p2w*=h,d.p3w*=h,d.p3bw*=h,d.p4w*=h}let a=0,c=0,l=0,u=t.appSpecificScore(r);a+=u*t.appSpecificWeight,e.knownIPs.forEach(h=>{if(t.IPColocationFactorWhitelist.has(h))return;let d=n.get(h),p=d?d.size:0;if(p>t.IPColocationFactorThreshold){let m=p-t.IPColocationFactorThreshold,g=m*m;c+=g*t.IPColocationFactorWeight}});let f=e.behaviourPenalty*e.behaviourPenalty;return l+=f*t.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function qx(r,e,t,n,s){let i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(let o of r){let a=e.get(o);if(a){let c=iU(o,a,t,n,s);for(let[l,u]of c.byTopic){let f=i.byTopic.get(l);f||(f={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(l,f)),f.p1w.push(u.p1w),f.p2w.push(u.p2w),f.p3w.push(u.p3w),f.p3bw.push(u.p3bw),f.p4w.push(u.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}var uh=class{rawStream;pushable;closeController;maxBufferSize;constructor(e,t,n){this.rawStream=e,this.pushable=wt({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,Ie(ur(this.pushable,this.closeController.signal,{returnOnAbort:!0}),s=>_t(s),this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}},fh=class{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=ur(Ie(this.rawStream,n=>Ct(n,t)),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}};var zx=re(Gm(),1),$x={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function Hx(r,e){e={...e};let t=zx.default.Reader.create(r),n=r.length,s=n===void 0?t.len:t.pos+n,i={};for(;t.pos<s;){let o=t.uint32();switch(o>>>3){case 1:i.subscriptions&&i.subscriptions.length||(i.subscriptions=[]),i.subscriptions.length<e.maxSubscriptions?i.subscriptions.push(oU(t,t.uint32())):t.skipType(o&7);break;case 2:i.messages&&i.messages.length||(i.messages=[]),i.messages.length<e.maxMessages?i.messages.push(aU(t,t.uint32())):t.skipType(o&7);break;case 3:i.control=cU(t,t.uint32(),e);break;default:t.skipType(o&7);break}}return i}function oU(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.subscribe=r.bool();break;case 2:n.topic=r.string();break;default:r.skipType(s&7);break}}return n}function aU(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.from=r.bytes();break;case 2:n.data=r.bytes();break;case 3:n.seqno=r.bytes();break;case 4:n.topic=r.string();break;case 5:n.signature=r.bytes();break;case 6:n.key=r.bytes();break;default:r.skipType(s&7);break}}if(!n.topic)throw Error("missing required 'topic'");return n}function cU(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let i=r.uint32();switch(i>>>3){case 1:s.ihave&&s.ihave.length||(s.ihave=[]),s.ihave.length<t.maxControlMessages?s.ihave.push(lU(r,r.uint32(),t)):r.skipType(i&7);break;case 2:s.iwant&&s.iwant.length||(s.iwant=[]),s.iwant.length<t.maxControlMessages?s.iwant.push(uU(r,r.uint32(),t)):r.skipType(i&7);break;case 3:s.graft&&s.graft.length||(s.graft=[]),s.graft.length<t.maxControlMessages?s.graft.push(fU(r,r.uint32())):r.skipType(i&7);break;case 4:s.prune&&s.prune.length||(s.prune=[]),s.prune.length<t.maxControlMessages?s.prune.push(hU(r,r.uint32(),t)):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function lU(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIhaveMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function uU(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let i=r.uint32();switch(i>>>3){case 1:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIwantMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function fU(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.topicID=r.string();break;default:r.skipType(s&7);break}}return n}function hU(r,e,t){let n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){let i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.peers&&s.peers.length||(s.peers=[]),t.maxPeerInfos-- >0?s.peers.push(dU(r,r.uint32())):r.skipType(i&7);break;case 3:s.backoff=r.uint64();break;default:r.skipType(i&7);break}}return s}function dU(r,e){let t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){let s=r.uint32();switch(s>>>3){case 1:n.peerID=r.bytes();break;case 2:n.signedPeerRecord=r.bytes();break;default:r.skipType(s&7);break}}return n}var hh;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(hh||(hh={}));function Wx(r){for(let e of r.tuples())switch(e[0]){case hh.ip4:case hh.ip6:return Al(e[0],e[1])}return null}var Zr;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(Zr||(Zr={}));var Jm=class extends Ue{globalSignaturePolicy;multicodecs=[Xm,Qm];publishConfig;dataTransform;peers=new Set;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=wt({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;components;directPeerInitial=null;static multicodec=Xm;opts;decodeRpcLimits;metrics;status={code:Zr.stopped};maxInboundStreams;maxOutboundStreams;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();let n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...t,scoreParams:Ix(t.scoreParams),scoreThresholds:Ax(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??$x,this.globalSignaturePolicy=n.globalSignaturePolicy??Oo,n.fallbackToFloodsub&&this.multicodecs.push(Ym),this.log=k(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new Xa({validityMs:n.seenTTL}),this.publishedMessageIds=new Xa({validityMs:n.seenTTL}),t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case Oo:this.msgIdFn=Kx;break;case Ya:this.msgIdFn=Vx;break}if(t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new Xa({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??Sx,this.mcache=t.messageCache||new sh(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform&&(this.dataTransform=t.dataTransform),t.metricsRegister){if(!t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");let s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),1e3),i=Lx(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>this.onScrapeMetrics(i));for(let o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new lh(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new ch(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>fe(e))}isStarted(){return this.status.code===Zr.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await Zm(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=wt({objectMode:!0}),Ie(this.outboundInflightQueue,async i=>{for await(let{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>this.log.error("outbound inflight queue error",i)),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.merge(i.id,{multiaddrs:i.addrs})}));let e=this.components.registrar;await Promise.all(this.multicodecs.map(i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));let t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)},n=await Promise.all(this.multicodecs.map(i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,100);this.status={code:Zr.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>await this.connect(i)))}).catch(i=>{this.log(i)})},1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Zr.started)return;let{registrarTopologyIds:e}=this.status;this.status={code:Zr.stopped};let t=this.components.registrar;await Promise.all(this.multicodecs.map(n=>t.unhandle(n))),e.forEach(n=>t.unregister(n)),this.outboundInflightQueue.end();for(let n of this.streamsOutbound.values())n.close();this.streamsOutbound.clear();for(let n of this.streamsInbound.values())n.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;let n=t.remotePeer;this.addPeer(n,t.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),!(!this.isStarted()||t.status!=="open")&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{let s=new uh(await t.newStream(this.multicodecs),o=>this.log.error("outbound pipe error",o),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);let i=s.protocol;i===Ym&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}async createInboundStream(e,t){if(!this.isStarted())return;let n=e.toString();if(!this.peers.has(n))return;let s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close()),this.log("create inbound stream %s",n);let i=new fh(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>this.log(o))}addPeer(e,t,n){let s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.add(s),this.score.addPeer(s);let i=Wx(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){let t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);let n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),s?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(let i of this.topics.values())i.delete(t);for(let[i,o]of this.mesh)o.delete(t)===!0&&this.metrics?.onRemoveFromMesh(i,Wn.Dc,1);for(let i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===Zr.started}getMeshPeers(e){let t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){let t=this.topics.get(e);return(t?Array.from(t):[]).map(n=>fe(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Ie(t,async n=>{for await(let s of n)try{let i=s.subarray(),o=Hx(i,this.decodeRpcLimits);if(this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}let n=t.subscriptions?t.subscriptions.length:0,s=t.messages?t.messages.length:0,i=0,o=0,a=0,c=0;if(t.control&&(t.control.ihave&&(i=t.control.ihave.length),t.control.iwant&&(o=t.control.iwant.length),t.control.graft&&(a=t.control.graft.length),t.control.prune&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${i} iwant ${o} graft ${a} prune ${c}`),t.subscriptions&&t.subscriptions.length>0){let l=[];t.subscriptions.forEach(u=>{let f=u.topic,h=u.subscribe===!0;if(f!=null){if(this.allowedTopics&&!this.allowedTopics.has(f))return;this.handleReceivedSubscription(e,f,h),l.push({topic:f,subscribe:h})}}),this.dispatchEvent(new Ge("subscription-change",{detail:{peerId:e,subscriptions:l}}))}if(t.messages)for(let l of t.messages){if(this.allowedTopics&&!this.allowedTopics.has(l.topic))continue;let u=this.handleReceivedMessage(e,l).catch(f=>{this.metrics?.onMsgRecvError(l.topic),this.log(f)});this.opts.awaitRpcMessageHandler&&await u}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);let n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onPrevalidationResult(t.topic,n.code),n.code){case hr.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case hr.invalid:if(n.msgIdStr){let s=n.msgIdStr;this.score.rejectMessage(e.toString(),s,t.topic,n.reason),this.gossipTracer.rejectMessage(s,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case hr.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new Ge("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new Ge("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){let n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s)return{code:hr.duplicate,msgIdStr:s};let i=await Ux(this.globalSignaturePolicy,t);if(!i.valid)return{code:hr.invalid,reason:xr.Error,error:i.error};let o=i.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:hr.invalid,reason:xr.Error,error:fr.TransformFailed}}let a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:hr.duplicate,msgIdStr:c};this.seenCache.put(c);let u=this.topicValidators.get(t.topic);if(u!=null){let f;try{f=await u(e,o)}catch(h){let d=h.code;d===_x&&(f=Er.Ignore),d===vx?f=Er.Reject:f=Er.Ignore}if(f!==Er.Accept)return{code:hr.invalid,reason:jm(f),msgIdStr:c}}return{code:hr.valid,messageId:l,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n}))})}async handleControlMessage(e,t){if(t===void 0)return;let n=t.ihave?this.handleIHave(e,t.ihave):[],s=t.iwant?this.handleIWant(e,t.iwant):[],i=t.graft?await this.handleGraft(e,t.graft):[];if(t.prune&&await this.handlePrune(e,t.prune),!n.length&&!s.length&&!i.length)return;let o=this.sendRpc(e,{messages:s,control:{iwant:n,prune:i}}),a=n[0]?.messageIDs;a&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;let t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;let s=this.score.score(e);return s>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:Ja.LowScore}),[];let s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:Ja.MaxIhave}),[];let i=this.iasked.get(e)??0;if(i>=5e3)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:Ja.MaxIasked}),[];let o=new Map;if(t.forEach(({topicID:l,messageIDs:u})=>{if(!l||!u||!this.mesh.has(l))return;let f=0;u.forEach(h=>{let d=this.msgIdToStrFn(h);this.seenCache.has(d)||(o.set(d,h),f++)}),this.metrics?.onIhaveRcv(l,u.length,f)}),!o.size)return[];let a=o.size;a+i>5e3&&(a=5e3-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return gs(c),c=c.slice(0,a),this.iasked.set(e,i+a),[{messageIDs:c}]}handleIWant(e,t){if(!t.length)return[];let n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];let s=new Map,i=new Map,o=0;return t.forEach(({messageIDs:a})=>{a&&a.forEach(c=>{let l=this.msgIdToStrFn(c),u=this.mcache.getWithIWantCount(l,e);if(u==null){o++;return}if(i.set(u.msg.topic,1+(i.get(u.msg.topic)??0)),u.count>3){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(l,u.msg)})}),this.metrics?.onIwantRcv(i,o),s.size?(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){let n=[],s=this.score.score(e),i=Date.now(),o=this.opts.doPX;if(t.forEach(({topicID:c})=>{if(!c)return;let l=this.mesh.get(c);if(!l){o=!1;return}if(l.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(c),o=!1;return}let u=this.backoff.get(c)?.get(e);if(typeof u=="number"&&i<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,Za.GraftBackoff),o=!1;let f=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<f&&this.score.addPenalty(e,1,Za.GraftBackoff),this.addBackoff(e,c),n.push(c);return}if(s<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,c),n.push(c),o=!1,this.addBackoff(e,c);return}if(l.size>=this.opts.Dhi&&!this.outbound.get(e)){n.push(c),this.addBackoff(e,c);return}this.log("GRAFT: Add mesh link from %s in %s",e,c),this.score.graft(e,c),l.add(e),this.metrics?.onAddToMesh(c,_r.Subscribed,1)}),!n.length)return[];let a=!1;return await Promise.all(n.map(c=>this.makePrune(e,c,o,a)))}async handlePrune(e,t){let n=this.score.score(e);for(let{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;let a=this.mesh.get(s);if(!a)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Wn.Prune,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s||(s=new Map,this.backoff.set(t,s));let i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,Za.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%15!==0)return;let e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s+1*this.opts.heartbeatInterval<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){let e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>await this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(gs(e),e=e.slice(0,this.opts.prunePeers));let t=[];await Promise.all(e.map(async n=>{if(!n.peerID)return;let s=ht(n.peerID),i=s.toString();if(!this.peers.has(i)){if(!n.signedPeerRecord){t.push(i);return}try{if(!await this.components.peerStore.consumePeerRecord(n.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(i)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length&&await Promise.all(t.map(async n=>await this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);let t=fe(e),n=await this.components.connectionManager.openConnection(t);for(let s of this.multicodecs)for(let i of this.components.registrar.getTopologies(s))i.onConnect?.(t,n)}subscribe(e){if(this.status.code!==Zr.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(let t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==Zr.started)throw new Error("Pubsub is not started");let t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(let n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==Zr.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);let t=new Set,n=this.backoff.get(e),s=this.fanout.get(e);if(s&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),s.forEach(i=>{!this.direct.has(i)&&this.score.score(i)>=0&&(!n||!n.has(i))&&t.add(i)}),this.metrics?.onAddToMesh(e,_r.Fanout,t.size)),t.size<this.opts.D){let i=t.size;this.getRandomGossipPeers(e,this.opts.D,a=>!t.has(a)&&!this.direct.has(a)&&this.score.score(a)>=0&&(!n||!n.has(a))).forEach(a=>{t.add(a)}),this.metrics?.onAddToMesh(e,_r.Random,t.size-i)}this.mesh.set(e,t),t.forEach(i=>{this.log("JOIN: Add mesh link to %s in %s",i,e),this.sendGraft(i,e)})}leave(e){if(this.status.code!==Zr.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);let t=this.mesh.get(e);t&&(Promise.all(Array.from(t).map(async n=>(this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)))).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){let s=new Set,i=this.topics.get(e);i&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));let o=this.mesh.get(e);return o&&o.size>0&&o.forEach(a=>{t!==a&&!n?.has(a)&&s.add(a)}),s}selectPeersToPublish(e){let t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});let i=this.mesh.get(e);if(i&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++});else{let o=this.fanout.get(e);if(o&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{let a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n&&this.score.deliverMessage(n,e,t.topic);let i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,{messages:[t]})}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){let s=Date.now(),i=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");let{raw:o,msg:a}=await Mx(this.publishConfig,e,t,i),c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(l)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}let{tosend:f,tosendCount:h}=this.selectPeersToPublish(e),d=this.opts.emitSelf===!0&&this.subscriptions.has(e),p=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(f.size===0&&!p&&!d)throw Error("PublishError.InsufficientPeers");this.seenCache.put(l),this.mcache.put({msgId:c,msgIdStr:l},o,!0),this.publishedMessageIds.put(l);for(let g of f)this.sendRpc(g,{messages:[o]})||f.delete(g);let m=Date.now()-s;return this.metrics?.onPublishMsg(e,h,f.size,o.data!=null?o.data.length:0,m),d&&(f.add(this.components.peerId.toString()),super.dispatchEvent(new Ge("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:l,msg:a}})),super.dispatchEvent(new Ge("message",{detail:a}))),{recipients:Array.from(f.values()).map(g=>fe(g))}}reportMessageValidationResult(e,t,n){let s;if(n===Er.Accept){if(s=this.mcache.validate(e),s!=null){let{message:o,originatingPeers:a}=s;this.score.deliverMessage(t,e,o.topic),this.forwardMessage(e,s.message,t,a)}}else if(s=this.mcache.remove(e),s){let o=jm(n),{message:a,originatingPeers:c}=s;this.score.rejectMessage(t,e,a.topic,o);for(let l of c)this.score.rejectMessage(l,e,a.topic,o)}let i=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(s,n,i)}sendGraft(e,t){let n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){let s=[await this.makePrune(e,t,this.opts.doPX,!0)];this.sendRpc(e,{control:{prune:s}})}sendRpc(e,t){let n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;let s=this.control.get(e);s&&(this.piggybackControl(e,t,s),this.control.delete(e));let i=this.gossip.get(e);i&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));let o=Hl.encode(t).finish();try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s&&this.control.set(e,s),i&&this.gossip.set(e,i),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);for(let s of n.graft)s.topicID&&this.mesh.get(s.topicID)?.has(e)&&t.control.graft.push(s)}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);for(let s of n.prune)s.topicID&&!this.mesh.get(s.topicID)?.has(e)&&t.control.prune.push(s)}}piggybackGossip(e,t,n){t.control||(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){let s=this.opts.doPX,i=!1;for(let[o,a]of e){let c=a.map(f=>({topicID:f})),l=[],u=t.get(o);u&&(l=await Promise.all(u.map(async f=>await this.makePrune(o,f,s&&!(n.get(o)??!1),i))),t.delete(o)),this.sendRpc(o,{control:{graft:c,prune:l}})}for(let[o,a]of t){let c=await Promise.all(a.map(async l=>await this.makePrune(o,l,s&&!(n.get(o)??!1),i)));this.sendRpc(o,{control:{prune:c}})}}emitGossip(e){let t=this.mcache.getGossipIDs(new Set(e.keys()));for(let[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length||(gs(n),n.length>5e3&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size))return;let s=this.opts.Dlazy,i=.25*t.size,o=t;i>s&&(s=i),s>o.size?s=o.size:o=gs(Array.from(o)).slice(0,s),o.forEach(a=>{let c=n;n.length>5e3&&(c=gs(c.slice()).slice(0,5e3)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(let[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(let[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);let n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n,s){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===Qm)return{topicID:t,peers:[]};let i=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,o=i/1e3;if(this.doAddBackoff(e,t,i),!n)return{topicID:t,peers:[],backoff:o};let a=this.getRandomGossipPeers(t,this.opts.prunePeers,l=>l!==e&&this.score.score(l)>=0),c=await Promise.all(Array.from(a).map(async l=>{let u=fe(l),f;try{f=await this.components.peerStore.get(u)}catch(h){if(h.code!=="ERR_NOT_FOUND")throw h}return{peerID:u.toBytes(),signedPeerRecord:f?.peerRecordEnvelope}}));return{topicID:t,peers:c,backoff:o}}runHeartbeat=()=>{let e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(t=>{this.log("Error running heartbeat",t)}).finally(()=>{if(e?.(),this.status.code===Zr.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;t<this.opts.heartbeatInterval*.25&&(t+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}})};async heartbeat(){let{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;let a=new Map,c=p=>{let m=a.get(p);return m===void 0&&(m=this.score.score(p),a.set(p,m)),m},l=new Map,u=new Map,f=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();let h=new Map;this.mesh.forEach((p,m)=>{let g=this.topics.get(m),y=new Set,w=new Set;if(h.set(m,w),g){let x=gs(Array.from(g)),v=this.backoff.get(m);for(let I of x){let _=this.streamsOutbound.get(I);if(_&&this.multicodecs.includes(_.protocol)&&!p.has(I)&&!this.direct.has(I)){let D=c(I);(!v||!v.has(I))&&D>=0&&y.add(I),D>=this.opts.scoreThresholds.gossipThreshold&&w.add(I)}}}let E=(x,v)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",x,m),this.addBackoff(x,m),p.delete(x),c(x)>=this.opts.scoreThresholds.gossipThreshold&&w.add(x),this.metrics?.onRemoveFromMesh(m,v,1);let I=u.get(x);I?I.push(m):u.set(x,[m])},R=(x,v)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",x,m),this.score.graft(x,m),p.add(x),w.delete(x),this.metrics?.onAddToMesh(m,v,1);let I=l.get(x);I?I.push(m):l.set(x,[m])};if(p.forEach(x=>{let v=c(x);v<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",x,v,m),E(x,Wn.BadScore),f.set(x,!0))}),p.size<t){let x=e-p.size;Nx(y,x).forEach(I=>{R(I,_r.NotEnough)})}if(p.size>n){let x=Array.from(p);x.sort((I,_)=>c(_)-c(I)),x=x.slice(0,s).concat(gs(x.slice(s)));let v=0;if(x.slice(0,e).forEach(I=>{this.outbound.get(I)&&v++}),v<i){let I=D=>{let O=x[D];for(let N=D;N>0;N--)x[N]=x[N-1];x[0]=O};if(v>0){let D=v;for(let O=1;O<e&&D>0;O++)this.outbound.get(x[O])&&(I(O),D--)}let _=e-v;for(let D=e;D<x.length&&_>0;D++)this.outbound.get(x[D])&&(I(D),_--)}x.slice(e).forEach(I=>{E(I,Wn.Excess)})}if(p.size>=t){let x=0;if(p.forEach(v=>{this.outbound.get(v)&&x++}),x<i){let v=i-x;ah(y,v,_=>this.outbound.get(_)===!0).forEach(_=>{R(_,_r.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&p.size>1){let x=Array.from(p).sort((_,D)=>c(_)-c(D)),v=Math.floor(p.size/2),I=c(x[v]);if(I<this.opts.scoreThresholds.opportunisticGraftThreshold){let _=this.opts.opportunisticGraftPeers,D=ah(y,_,O=>c(O)>I);for(let O of D)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",O,m),R(O,_r.Opportunistic)}}});let d=Date.now();this.fanoutLastpub.forEach((p,m)=>{p+o<d&&(this.fanout.delete(m),this.fanoutLastpub.delete(m))}),this.fanout.forEach((p,m)=>{let g=this.topics.get(m);p.forEach(R=>{(!g.has(R)||c(R)<this.opts.scoreThresholds.publishThreshold)&&p.delete(R)});let y=this.topics.get(m),w=[],E=new Set;if(h.set(m,E),y){let R=gs(Array.from(y));for(let x of R){let v=this.streamsOutbound.get(x);if(v&&this.multicodecs.includes(v.protocol)&&!p.has(x)&&!this.direct.has(x)){let I=c(x);I>=this.opts.scoreThresholds.publishThreshold&&w.push(x),I>=this.opts.scoreThresholds.gossipThreshold&&E.add(x)}}}if(p.size<e){let R=e-p.size;w.slice(0,R).forEach(x=>{p.add(x),E?.delete(x)})}}),this.emitGossip(h),await this.sendGraftPrune(l,u,f),this.flush(),this.mcache.shift(),this.dispatchEvent(new Ge("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){let s=this.topics.get(e);if(!s)return new Set;let i=[];return s.forEach(o=>{let a=this.streamsOutbound.get(o);a&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=gs(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0,n=Date.now();e.connectedPeersBackoffSec.reset();for(let a of this.backoff.values()){t+=a.size;for(let[c,l]of a.entries())this.peers.has(c)&&e.connectedPeersBackoffSec.observe(Math.max(0,l-n)/1e3)}e.cacheSize.set({cache:"backoff"},t);for(let[a,c]of this.topics)e.topicPeersCount.set({topicStr:a},c.size);for(let[a,c]of this.mesh)e.meshPeerCounts.set({topicStr:a},c.size);let s=[],i=new Map;e.behaviourPenalty.reset();for(let a of this.peers.keys()){let c=this.score.score(a);s.push(c),i.set(a,c),e.behaviourPenalty.observe(this.score.peerStats.get(a)?.behaviourPenalty??0)}e.registerScores(s,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,i);let o=qx(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(o)}};function Yx(r={}){return e=>new Jm(e,r)}var dh=class extends Error{code;constructor(e,t){super(e),this.code=t}},e3=class extends dh{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted"}};function Qx(r){let e=wt();r.sink(e).catch(i=>{e.end(i)}),r.sink=async i=>{for await(let o of i)e.push(o);e.end()};let t=r.source;r.source[Symbol.iterator]!=null?t=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(t=r.source[Symbol.asyncIterator]());let n=new Ee;return{read:async(i,o)=>{o?.signal?.throwIfAborted();let a,c=new Promise((l,u)=>{a=()=>{u(new e3("Read aborted"))},o?.signal?.addEventListener("abort",a)});try{if(i==null){let{done:u,value:f}=await Promise.race([t.next(),c]);return u===!0?new Ee:f}for(;n.byteLength<i;){let{value:u,done:f}=await Promise.race([t.next(),c]);if(f===!0)throw new dh("unexpected end of input","ERR_UNEXPECTED_EOF");n.append(u)}let l=n.sublist(0,i);return n.consume(i),l}finally{a!=null&&o?.signal?.removeEventListener("abort",a)}},write:async(i,o)=>{o?.signal?.throwIfAborted(),i instanceof Uint8Array?e.push(i):e.push(i.subarray()),await e.onEmpty(o)},unwrap:()=>{let i=r.source;return r.source=async function*(){yield*n,yield*i}(),r}}}var ph=class extends Error{code;constructor(e,t){super(e),this.code=t}},Xx=r=>Kr(r);Xx.bytes=0;function Wl(r,e){let t=Qx(r);return{read:async s=>{let i=-1,o=new Ee,a=e?.lengthDecoder??Xx;for(;;){o.append(await t.read(1,s));try{i=a(o)}catch(c){if(c instanceof RangeError)continue;throw c}if(i>-1)break;if(e?.maxLengthLength!=null&&o.byteLength>e.maxLengthLength)throw new ph("message length length too long","ERR_MSG_LENGTH_TOO_LONG")}if(e?.maxDataLength!=null&&i>e.maxDataLength)throw new ph("message length too long","ERR_MSG_DATA_TOO_LONG");return t.read(i,s)},write:async(s,i)=>{await t.write(_t.single(s,e),i)},unwrap:()=>t.unwrap()}}function t3(){let r=De(),e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function jx(){let r=t3(),e=t3();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}var Zx=!!globalThis.process?.env?.DUMP_SESSION_KEYS;var zU=r=>r instanceof Uint8Array;var zs=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),Jx=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),$U=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!$U)throw new Error("Non little-endian hardware is not supported");function mh(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function gh(r){if(typeof r=="string"&&(r=mh(r)),!zU(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}var HU=r=>Object.prototype.toString.call(r)==="[object Object]"&&r.constructor===Object;function ev(r,e){if(e!==void 0&&(typeof e!="object"||!HU(e)))throw new Error("options must be object or undefined");return Object.assign(r,e)}function Lo(r,e){if(!(r instanceof Uint8Array))throw new Error("Uint8Array expected");if(typeof e=="number"&&r.length!==e)throw new Error(`Uint8Array length ${e} expected`)}function tv(r,e){if(r.length!==e.length)throw new Error("equalBytes: Different size of Uint8Arrays");let t=!0;for(let n=0;n<r.length;n++)t&&(t=r[n]===e[n]);return t}function r3(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let s=BigInt(32),i=BigInt(4294967295),o=Number(t>>s&i),a=Number(t&i),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function n3(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function WU(r){if(typeof r!="boolean")throw new Error(`Expected boolean, not ${r}`)}function rv(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function GU(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("hash must be wrapped by utils.wrapConstructor");n3(r.outputLen),n3(r.blockLen)}function YU(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function QU(r,e){rv(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var XU={number:n3,bool:WU,bytes:rv,hash:GU,exists:YU,output:QU},Sr=XU;var er=(r,e)=>r[e++]&255|(r[e++]&255)<<8,s3=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=gh(e),Lo(e,32);let t=er(e,0),n=er(e,2),s=er(e,4),i=er(e,6),o=er(e,8),a=er(e,10),c=er(e,12),l=er(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let u=0;u<8;u++)this.pad[u]=er(e,16+2*u)}process(e,t,n=!1){let s=n?0:2048,{h:i,r:o}=this,a=o[0],c=o[1],l=o[2],u=o[3],f=o[4],h=o[5],d=o[6],p=o[7],m=o[8],g=o[9],y=er(e,t+0),w=er(e,t+2),E=er(e,t+4),R=er(e,t+6),x=er(e,t+8),v=er(e,t+10),I=er(e,t+12),_=er(e,t+14),D=i[0]+(y&8191),O=i[1]+((y>>>13|w<<3)&8191),N=i[2]+((w>>>10|E<<6)&8191),U=i[3]+((E>>>7|R<<9)&8191),z=i[4]+((R>>>4|x<<12)&8191),te=i[5]+(x>>>1&8191),P=i[6]+((x>>>14|v<<2)&8191),L=i[7]+((v>>>11|I<<5)&8191),B=i[8]+((I>>>8|_<<8)&8191),F=i[9]+(_>>>5|s),T=0,$=T+D*a+O*(5*g)+N*(5*m)+U*(5*p)+z*(5*d);T=$>>>13,$&=8191,$+=te*(5*h)+P*(5*f)+L*(5*u)+B*(5*l)+F*(5*c),T+=$>>>13,$&=8191;let Y=T+D*c+O*a+N*(5*g)+U*(5*m)+z*(5*p);T=Y>>>13,Y&=8191,Y+=te*(5*d)+P*(5*h)+L*(5*f)+B*(5*u)+F*(5*l),T+=Y>>>13,Y&=8191;let Z=T+D*l+O*c+N*a+U*(5*g)+z*(5*m);T=Z>>>13,Z&=8191,Z+=te*(5*p)+P*(5*d)+L*(5*h)+B*(5*f)+F*(5*u),T+=Z>>>13,Z&=8191;let pe=T+D*u+O*l+N*c+U*a+z*(5*g);T=pe>>>13,pe&=8191,pe+=te*(5*m)+P*(5*p)+L*(5*d)+B*(5*h)+F*(5*f),T+=pe>>>13,pe&=8191;let ye=T+D*f+O*u+N*l+U*c+z*a;T=ye>>>13,ye&=8191,ye+=te*(5*g)+P*(5*m)+L*(5*p)+B*(5*d)+F*(5*h),T+=ye>>>13,ye&=8191;let Ae=T+D*h+O*f+N*u+U*l+z*c;T=Ae>>>13,Ae&=8191,Ae+=te*a+P*(5*g)+L*(5*m)+B*(5*p)+F*(5*d),T+=Ae>>>13,Ae&=8191;let we=T+D*d+O*h+N*f+U*u+z*l;T=we>>>13,we&=8191,we+=te*c+P*a+L*(5*g)+B*(5*m)+F*(5*p),T+=we>>>13,we&=8191;let ve=T+D*p+O*d+N*h+U*f+z*u;T=ve>>>13,ve&=8191,ve+=te*l+P*c+L*a+B*(5*g)+F*(5*m),T+=ve>>>13,ve&=8191;let Je=T+D*m+O*p+N*d+U*h+z*f;T=Je>>>13,Je&=8191,Je+=te*u+P*l+L*c+B*a+F*(5*g),T+=Je>>>13,Je&=8191;let Ye=T+D*g+O*m+N*p+U*d+z*h;T=Ye>>>13,Ye&=8191,Ye+=te*f+P*u+L*l+B*c+F*a,T+=Ye>>>13,Ye&=8191,T=(T<<2)+T|0,T=T+$|0,$=T&8191,T=T>>>13,Y+=T,i[0]=$,i[1]=Y,i[2]=Z,i[3]=pe,i[4]=ye,i[5]=Ae,i[6]=we,i[7]=ve,i[8]=Je,i[9]=Ye}finalize(){let{h:e,pad:t}=this,n=new Uint16Array(10),s=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=s,s=e[a]>>>13,e[a]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,n[0]=e[0]+5,s=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+s,s=n[a]>>>13,n[a]&=8191;n[9]-=8192;let i=(s^1)-1;for(let a=0;a<10;a++)n[a]&=i;i=~i;for(let a=0;a<10;a++)e[a]=e[a]&i|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535}update(e){Sr.exists(this);let{buffer:t,blockLen:n}=this;e=gh(e);let s=e.length;for(let i=0;i<s;){let o=Math.min(n-this.pos,s-i);if(o===n){for(;n<=s-i;i+=n)this.process(e,i);continue}t.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){this.h.fill(0),this.r.fill(0),this.buffer.fill(0),this.pad.fill(0)}digestInto(e){Sr.exists(this),Sr.output(e,this),this.finished=!0;let{buffer:t,h:n}=this,{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let o=0;o<8;o++)e[i++]=n[o]>>>0,e[i++]=n[o]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}};function jU(r){let e=(n,s)=>r(s).update(gh(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}var nv=jU(r=>new s3(r));var ZU=mh("expand 16-byte k"),JU=mh("expand 32-byte k"),eF=zs(ZU),tF=zs(JU),yh=r=>!(r.byteOffset%4),sv=r=>{let{core:e,rounds:t,counterRight:n,counterLen:s,allow128bitKeys:i,extendNonceFn:o,blockLen:a}=ev({rounds:20,counterRight:!1,counterLen:8,allow128bitKeys:!0,blockLen:64},r);Sr.number(s),Sr.number(t),Sr.number(a),Sr.bool(n),Sr.bool(i);let c=a/4;if(a%4!==0)throw new Error("Salsa/ChaCha: blockLen must be aligned to 4 bytes");return(l,u,f,h,d=0)=>{if(Sr.bytes(l),Sr.bytes(u),Sr.bytes(f),h||(h=new Uint8Array(f.length)),Sr.bytes(h),Sr.number(d),d<0||d>=2**32-1)throw new Error("Salsa/ChaCha: counter overflow");if(h.length<f.length)throw new Error(`Salsa/ChaCha: output (${h.length}) is shorter than data (${f.length})`);let p=[],m,g;if(l.length===32)yh(l)?m=l:(m=l.slice(),p.push(m)),g=tF;else if(l.length===16&&i)m=new Uint8Array(32),m.set(l),m.set(l,16),g=eF,p.push(m);else throw new Error(`Salsa/ChaCha: invalid 32-byte key, got length=${l.length}`);if(yh(u)||(u=u.slice(),p.push(u)),o){if(u.length<=16)throw new Error("Salsa/ChaCha: extended nonce must be bigger than 16 bytes");m=o(g,m,u.subarray(0,16),new Uint8Array(32)),p.push(m),u=u.subarray(16)}let y=16-s;if(u.length!==y)throw new Error(`Salsa/ChaCha: nonce must be ${y} or 16 bytes`);if(y!==12){let D=new Uint8Array(12);D.set(u,n?0:12-u.length),p.push(u=D)}let w=new Uint8Array(a),E=zs(w),R=zs(m),x=zs(u),v=yh(f)&&zs(f),I=yh(h)&&zs(h);p.push(E);let _=f.length;for(let D=0,O=d;D<_;O++){if(e(g,R,x,E,O,t),O>=2**32-1)throw new Error("Salsa/ChaCha: counter overflow");let N=Math.min(a,_-D);if(N===a&&I&&v){let U=D/4;if(D%4!==0)throw new Error("Salsa/ChaCha: invalid block position");for(let z=0;z<c;z++)I[U+z]=v[U+z]^E[z];D+=a;continue}for(let U=0;U<N;U++)h[D+U]=f[D+U]^w[U];D+=N}for(let D=0;D<p.length;D++)p[D].fill(0);return h}};var Ve=(r,e)=>r<<e|r>>>32-e;function rF(r,e,t,n,s,i=20){let o=r[0],a=r[1],c=r[2],l=r[3],u=e[0],f=e[1],h=e[2],d=e[3],p=e[4],m=e[5],g=e[6],y=e[7],w=s,E=t[0],R=t[1],x=t[2],v=o,I=a,_=c,D=l,O=u,N=f,U=h,z=d,te=p,P=m,L=g,B=y,F=w,T=E,$=R,Y=x;for(let pe=0;pe<i;pe+=2)v=v+O|0,F=Ve(F^v,16),te=te+F|0,O=Ve(O^te,12),v=v+O|0,F=Ve(F^v,8),te=te+F|0,O=Ve(O^te,7),I=I+N|0,T=Ve(T^I,16),P=P+T|0,N=Ve(N^P,12),I=I+N|0,T=Ve(T^I,8),P=P+T|0,N=Ve(N^P,7),_=_+U|0,$=Ve($^_,16),L=L+$|0,U=Ve(U^L,12),_=_+U|0,$=Ve($^_,8),L=L+$|0,U=Ve(U^L,7),D=D+z|0,Y=Ve(Y^D,16),B=B+Y|0,z=Ve(z^B,12),D=D+z|0,Y=Ve(Y^D,8),B=B+Y|0,z=Ve(z^B,7),v=v+N|0,Y=Ve(Y^v,16),L=L+Y|0,N=Ve(N^L,12),v=v+N|0,Y=Ve(Y^v,8),L=L+Y|0,N=Ve(N^L,7),I=I+U|0,F=Ve(F^I,16),B=B+F|0,U=Ve(U^B,12),I=I+U|0,F=Ve(F^I,8),B=B+F|0,U=Ve(U^B,7),_=_+z|0,T=Ve(T^_,16),te=te+T|0,z=Ve(z^te,12),_=_+z|0,T=Ve(T^_,8),te=te+T|0,z=Ve(z^te,7),D=D+O|0,$=Ve($^D,16),P=P+$|0,O=Ve(O^P,12),D=D+O|0,$=Ve($^D,8),P=P+$|0,O=Ve(O^P,7);let Z=0;n[Z++]=o+v|0,n[Z++]=a+I|0,n[Z++]=c+_|0,n[Z++]=l+D|0,n[Z++]=u+O|0,n[Z++]=f+N|0,n[Z++]=h+U|0,n[Z++]=d+z|0,n[Z++]=p+te|0,n[Z++]=m+P|0,n[Z++]=g+L|0,n[Z++]=y+B|0,n[Z++]=w+F|0,n[Z++]=E+T|0,n[Z++]=R+$|0,n[Z++]=x+Y|0}var nF=sv({core:rF,counterRight:!1,counterLen:4,allow128bitKeys:!1});var sF=new Uint8Array(16),iv=(r,e)=>{r.update(e);let t=e.length%16;t&&r.update(sF.subarray(t))},ov=(r,e,t,n,s)=>{let i=r(e,t,new Uint8Array(32)),o=nv.create(i);s&&iv(o,s),iv(o,n);let a=new Uint8Array(16),c=Jx(a);r3(c,0,BigInt(s?s.length:0),!0),r3(c,8,BigInt(n.length),!0),o.update(a);let l=o.digest();return i.fill(0),l},iF=r=>(e,t,n)=>(Lo(e,32),Lo(t),{tagLength:16,encrypt:(i,o)=>{let a=i.length,c=a+16;o?Lo(o,c):o=new Uint8Array(c),r(e,t,i,o,1);let l=ov(r,e,t,o.subarray(0,-16),n);return o.set(l,a),o},decrypt:(i,o)=>{let a=i.length,c=a-16;if(a<16)throw new Error("encrypted data must be at least 16 bytes");o?Lo(o,c):o=new Uint8Array(c);let l=i.subarray(0,-16),u=i.subarray(-16),f=ov(r,e,t,l,n);if(!tv(u,f))throw new Error("invalid tag");return r(e,t,l,o,1),o}}),i3=iF(nF);function cv(r,e,t){return cl(r),t===void 0&&(t=new Uint8Array(r.outputLen)),Ta(r,gi(t),gi(e))}var o3=new Uint8Array([0]),av=new Uint8Array;function lv(r,e,t,n=32){if(cl(r),Y0(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");let s=Math.ceil(n/r.outputLen);t===void 0&&(t=av);let i=new Uint8Array(s*r.outputLen),o=Ta.create(r,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let l=0;l<s;l++)o3[0]=l+1,a.update(l===0?av:c).update(t).update(o3).digestInto(c),i.set(c,r.outputLen*l),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),o3.fill(0),i.slice(0,n)}var a3={hashSHA256(r){return Ia(r)},getHKDF(r,e){let t=cv(Ia,e,r),s=lv(Ia,t,void 0,96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){let r=dl.utils.randomPrivateKey();return{publicKey:dl.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:dl.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return dl.getSharedSecret(r,e)},chaCha20Poly1305Encrypt(r,e,t,n){return i3(n,e,t).encrypt(r)},chaCha20Poly1305Decrypt(r,e,t,n,s){return i3(n,e,t).decrypt(r,s)}};var oF=r=>globalThis.Buffer?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r),tc=r=>{let e=oF(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};tc.bytes=2;var Gl=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};Gl.bytes=2;function uv(r){return _e([r.ne,r.ciphertext],r.ne.length+r.ciphertext.length)}function fv(r){return _e([r.ne,r.ns,r.ciphertext],r.ne.length+r.ns.length+r.ciphertext.length)}function hv(r){return _e([r.ns,r.ciphertext],r.ns.length+r.ciphertext.length)}function dv(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:new Uint8Array(0)}}function pv(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function mv(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}var yv=16;function bv(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65519){let i=s+65519;i>n.length&&(i=n.length);let o=r.encrypt(n.subarray(s,i),r.session);e?.encryptedPackets.increment(),yield tc(o.byteLength),yield o}}}function wv(r,e){return async function*(t){for await(let n of t)for(let s=0;s<n.length;s+=65535){let i=s+65535;if(i>n.length&&(i=n.length),i-yv<s)throw new Error("Invalid chunk");let o=n.subarray(s,i),a=n.subarray(s,i-yv),{plaintext:c,valid:l}=r.decrypt(o,r.session,a);if(!l)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}var bh;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(let i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={webtransportCerthashes:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.webtransportCerthashes.push(t.bytes());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(bh||(bh={}));var Ql;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identityKey!=null&&t.identityKey.byteLength>0)&&(n.uint32(10),n.bytes(t.identityKey??new Uint8Array(0))),(s.writeDefaults===!0||t.identitySig!=null&&t.identitySig.byteLength>0)&&(n.uint32(18),n.bytes(t.identitySig??new Uint8Array(0))),t.extensions!=null&&(n.uint32(34),bh.codec().encode(t.extensions,n,{writeDefaults:!1})),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.identityKey=t.bytes();break;case 2:s.identitySig=t.bytes();break;case 4:s.extensions=bh.codec().decode(t,t.uint32());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Ql||(Ql={}));async function Ev(r,e,t){let n=await cF(r,xv(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return aF(r.publicKey,n,t)}function aF(r,e,t){return Ql.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function cF(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return(await qn(r.privateKey)).sign(e)}async function c3(r){return cr(r.identityKey)}function l3(r){return Ql.decode(r)}function xv(r){let e=Q("noise-libp2p-static-key:");return _e([e,r],e.length+r.length)}async function u3(r,e,t){let n=await cr(e.identityKey);if(!n.equals(t))throw new Error(`Payload identity key ${n.toString()} does not match expected remote peer ${t.toString()}`);let s=xv(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await kr(n.publicKey).verify(s,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function Xl(r){return!(!(r instanceof Uint8Array)||r.length!==32)}function wh(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function $s(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");let t=Fr(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return xs(t)}var Yt=k("libp2p:noise");var wn;Zx?wn=Yt:wn=Object.assign(()=>{},{enabled:!1,trace:()=>{},error:()=>{}});function vv(r){wn(`LOCAL_STATIC_PUBLIC_KEY ${W(r.publicKey,"hex")}`),wn(`LOCAL_STATIC_PRIVATE_KEY ${W(r.privateKey,"hex")}`)}function f3(r){r?(wn(`LOCAL_PUBLIC_EPHEMERAL_KEY ${W(r.publicKey,"hex")}`),wn(`LOCAL_PRIVATE_EPHEMERAL_KEY ${W(r.privateKey,"hex")}`)):wn("Missing local ephemeral keys.")}function _v(r){wn(`REMOTE_STATIC_PUBLIC_KEY ${W(r,"hex")}`)}function h3(r){wn(`REMOTE_EPHEMERAL_PUBLIC_KEY ${W(r,"hex")}`)}function Sv(r){r.cs1&&r.cs2?(wn(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${W(r.cs1.k,"hex")}`),wn(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${W(r.cs2.k,"hex")}`)):wn("Missing cipher state.")}var lF="Cipherstate has reached maximum n, a new handshake must be performed",Eh=class{n;bytes;view;constructor(e=0){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error(lF)}};var xh=class{crypto;constructor(e){this.crypto=e}encryptWithAd(e,t,n){let s=this.encrypt(e.k,e.n,t,n);return e.n.increment(),s}decryptWithAd(e,t,n,s){let{plaintext:i,valid:o}=this.decrypt(e.k,e.n,t,n,s);return o&&e.n.increment(),{plaintext:i,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){let t=this.createEmptyKey();return me(t,e)}encrypt(e,t,n,s){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(s,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,s,i){t.assertValue();let o=this.crypto.chaCha20Poly1305Decrypt(s,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,s=!0;return this.hasKey(e.cs)?{plaintext:n,valid:s}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:s}}dh(e,t){try{let n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){let s=n;return Yt.error(s),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(_e([e,t],e.length+t.length))}mixKey(e,t){let[n,s]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(s),e.ck=n}initializeKey(e){return{k:e,n:new Eh}}initializeSymmetric(e){let t=Q(e,"utf-8"),n=this.hashProtocolName(t),s=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:s,h:n}}hashProtocolName(e){if(e.length<=32){let t=new Uint8Array(32);return t.set(e),t}else return this.getHash(e,new Uint8Array(0))}split(e){let[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0)),s=this.initializeKey(t),i=this.initializeKey(n);return{cs1:s,cs2:i}}writeMessageRegular(e,t){let n=this.encryptWithAd(e,new Uint8Array(0),t),s=this.createEmptyKey(),i=new Uint8Array(0);return{ne:s,ns:i,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}};var vh=class extends xh{initializeInitiator(e,t,n,s){let i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);let a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}initializeResponder(e,t,n,s){let i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);let a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}writeMessageA(e,t,n){let s=new Uint8Array(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();let i=e.e.publicKey;this.mixHash(e.ss,i);let o=this.encryptAndHash(e.ss,t);return{ne:i,ns:s,ciphertext:o}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();let n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let s=e.s.publicKey,i=this.encryptAndHash(e.ss,s);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let o=this.encryptAndHash(e.ss,t);return{ne:n,ns:i,ciphertext:o}}writeMessageC(e,t){let n=e.s.publicKey,s=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));let i=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:s,ciphertext:i},{cs1:c,cs2:l}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:l}}readMessageA(e,t){return Xl(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(Xl(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));let{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);s&&Xl(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:i,valid:s&&o}}readMessageC(e,t){let{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);if(s&&Xl(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));let{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:i,valid:s&&o,cs1:a,cs2:c}}initSession(e,t,n){let s=this.createEmptyKey(),i=new Uint8Array(32),o;return e?o=this.initializeInitiator(t,n,i,s):o=this.initializeResponder(t,n,i,s),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let s;if(e.mc===0)s=this.writeMessageA(e.hs,t,n);else if(e.mc===1)s=this.writeMessageB(e.hs,t);else if(e.mc===2){let{h:i,messageBuffer:o,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);s=o,e.h=i,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");s=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");s=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,s}recvMessage(e,t){let n=new Uint8Array(0),s=!1;if(e.mc===0)({plaintext:n,valid:s}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:s}=this.readMessageB(e.hs,t));else if(e.mc===2){let{h:i,plaintext:o,valid:a,cs1:c,cs2:l}=this.readMessageC(e.hs,t);n=o,s=a,e.h=i,e.cs1=c,e.cs2=l}return e.mc++,{plaintext:n,valid:s}}};var _h=class{isInitiator;session;remotePeer;remoteExtensions={webtransportCerthashes:[]};payload;connection;xx;staticKeypair;prologue;constructor(e,t,n,s,i,o,a,c){this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=i,this.connection=o,a&&(this.remotePeer=a),this.xx=c??new vh(s),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(vv(this.session.hs.s),this.isInitiator){Yt.trace("Stage 0 - Initiator starting to send first message.");let e=this.xx.sendMessage(this.session,new Uint8Array(0));await this.connection.write(uv(e)),Yt.trace("Stage 0 - Initiator finished sending first message."),f3(this.session.hs.e)}else{Yt.trace("Stage 0 - Responder waiting to receive first message...");let e=dv((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new Xi("xx handshake stage 0 validation fail");Yt.trace("Stage 0 - Responder received first message."),h3(this.session.hs.re)}}async exchange(){if(this.isInitiator){Yt.trace("Stage 1 - Initiator waiting to receive first message from responder...");let e=pv((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Xi("xx handshake stage 1 validation fail");Yt.trace("Stage 1 - Initiator received the message."),h3(this.session.hs.re),_v(this.session.hs.rs),Yt.trace("Initiator going to check remote's signature...");try{let s=l3(t);this.remotePeer=this.remotePeer||await c3(s),await u3(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){let i=s;throw new Oc(`Error occurred while verifying signed payload: ${i.message}`)}Yt.trace("All good with the signature!")}else{Yt.trace("Stage 1 - Responder sending out first message with signed payload and static key.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(fv(e)),Yt.trace("Stage 1 - Responder sent the second handshake message with signed payload."),f3(this.session.hs.e)}}async finish(){if(this.isInitiator){Yt.trace("Stage 2 - Initiator sending third handshake message.");let e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(hv(e)),Yt.trace("Stage 2 - Initiator sent message with signed payload.")}else{Yt.trace("Stage 2 - Responder waiting for third handshake message...");let e=mv((await this.connection.read()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Xi("xx handshake stage 2 validation fail");Yt.trace("Stage 2 - Responder received the message, finished handshake.");try{let s=l3(t);this.remotePeer=this.remotePeer||await c3(s),await u3(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){let i=s;throw new Oc(`Error occurred while verifying signed payload: ${i.message}`)}}Sv(this.session)}encrypt(e,t){let n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){let s=this.getCS(t,!1);return this.xx.decryptWithAd(s,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new Xi("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}};function Rv(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}var Sh=class{protocol="/noise";crypto;prologue;staticKeys;extensions;metrics;constructor(e={}){let{staticNoiseKey:t,extensions:n,crypto:s,prologueBytes:i,metrics:o}=e;this.crypto=s??a3,this.extensions=n,this.metrics=o?Rv(o):void 0,t?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(t):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=i??new Uint8Array(0)}async secureOutbound(e,t,n){let s=Wl(t,{lengthEncoder:tc,lengthDecoder:Gl,maxDataLength:65535}),i=await this.performHandshake({connection:s,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remoteExtensions:i.remoteExtensions,remotePeer:i.remotePeer}}async secureInbound(e,t,n){let s=Wl(t,{lengthEncoder:tc,lengthDecoder:Gl,maxDataLength:65535}),i=await this.performHandshake({connection:s,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remotePeer:i.remotePeer,remoteExtensions:i.remoteExtensions}}async performHandshake(e){let t=await Ev(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){let{isInitiator:n,remotePeer:s,connection:i}=e,o=new _h(n,t,this.prologue,this.crypto,this.staticKeys,i,s);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return o}async createSecureConnection(e,t){let[n,s]=jx(),i=e.unwrap();return await Ie(n,bv(t,this.metrics),i,o=>Ct(o,{lengthDecoder:Gl}),wv(t,this.metrics),n),s}};function rc(r={}){return()=>new Sh(r)}var nc="ERR_INVALID_FRAME",d3="ERR_UNREQUESTED_PING",p3="ERR_NOT_MATCHING_PING",m3="ERR_STREAM_ALREADY_EXISTS",g3="ERR_DECODE_INVALID_VERSION",y3="ERR_BOTH_CLIENTS",b3="ERR_RECV_WINDOW_EXCEEDED",Iv=new Set([nc,d3,p3,m3,g3,y3,b3]),Di="ERR_INVALID_CONFIG",Rh="ERR_MUXER_LOCAL_CLOSED",w3="ERR_MUXER_REMOTE_CLOSED";var Tv="ERR_STREAM_ABORT",Av="ERROR_MAX_OUTBOUND_STREAMS_EXCEEDED",Dv="ERR_DECODE_IN_PROGRESS",jl=256*1024,Cv=16*1024*1024;var Pv={log:k("libp2p:yamux"),enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:jl,maxStreamWindowSize:Cv,maxMessageSize:64*1024};function kv(r){if(r.keepAliveInterval<=0)throw new b("keep-alive interval must be positive",Di);if(r.maxInboundStreams<0)throw new b("max inbound streams must be larger or equal 0",Di);if(r.maxOutboundStreams<0)throw new b("max outbound streams must be larger or equal 0",Di);if(r.initialStreamWindowSize<jl)throw new b("InitialStreamWindowSize must be larger or equal 256 kB",Di);if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new b("MaxStreamWindowSize must be larger than the InitialStreamWindowSize",Di);if(r.maxStreamWindowSize>2**32-1)throw new b("MaxStreamWindowSize must be less than equal MAX_UINT32",Di);if(r.maxMessageSize<1024)throw new b("MaxMessageSize must be greater than a kilobyte",Di)}var yt;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(yt||(yt={}));var ct;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(ct||(ct={}));var uF=Object.values(ct).filter(r=>typeof r!="string"),Nv=0,En;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(En||(En={}));var Ci=12;function E3(r){let e=uF.filter(t=>(r.flag&t)===t).map(t=>ct[t]).join("|");return`streamID=${r.streamID} type=${yt[r.type]} flag=${e} length=${r.length}`}var Ov=2**24;function fF(r){if(r[0]!==Nv)throw new b("Invalid frame version",g3);return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*Ov+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*Ov+(r[9]<<16)+(r[10]<<8)+r[11]}}var Ih=class{source;buffer;frameInProgress;constructor(e){this.source=hF(e),this.buffer=new Ee,this.frameInProgress=!1}async*emitFrames(){for await(let e of this.source)for(this.buffer.append(e);;){let t=this.readHeader();if(t===void 0)break;let{type:n,length:s}=t;n===yt.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new b("decoding frame already in progress",Dv);if(this.buffer.length<Ci)return;let e=fF(this.buffer.subarray(0,Ci));return this.buffer.consume(Ci),e}async readBytes(e){if(this.buffer.length<e){for await(let n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}let t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function hF(r){if(r[Symbol.iterator]!==void 0){let e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){let e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function x3(r){let e=new Uint8Array(Ci);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}var dF="ERR_STREAM_RESET",pF="ERR_SINK_INVALID_STATE";function v3(r){return r!=null&&typeof r.then=="function"}var Pi=class{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;sinkController;sinkEnd;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;log;constructor(e){this.sinkController=new AbortController,this.sinkEnd=De(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.onEnd=e.onEnd,this.onCloseRead=e?.onCloseRead,this.onCloseWrite=e?.onCloseWrite,this.onReset=e?.onReset,this.onAbort=e?.onAbort,this.source=this.streamSource=wt({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.readStatus="closed",this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new b(`writable end state is "${this.writeStatus}" not "ready"`,pF);try{this.writeStatus="writing";let t={signal:this.sinkController.signal};if(this.direction==="outbound"){let n=this.sendNewStream(t);v3(n)&&await n}e=ur(e,this.sinkController.signal,{returnOnAbort:!0}),this.log.trace("sink reading from source");for await(let n of e){n=n instanceof Uint8Array?new Ee(n):n;let s=this.sendData(n,t);v3(s)&&await s}this.log.trace("sink finished reading from source"),this.writeStatus="done",this.log.trace("sink calling closeWrite"),await this.closeWrite(t),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.log.trace("closing gracefully"),this.status="closing",await Promise.all([this.closeRead(e),this.closeWrite(e)]),this.status="closed",this.log.trace("closed gracefully")}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);let t=this.readStatus;this.readStatus="closing",t==="ready"&&(this.log.trace("ending internal source queue"),this.streamSource.end()),this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),this.log.trace("closed readable end of stream")}async closeWrite(e={}){if(this.writeStatus==="closing"||this.writeStatus==="closed")return;this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus);let t=this.writeStatus;this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await this.sink([])),this.writeStatus="closing",t==="writing"&&await new Promise((n,s)=>{queueMicrotask(()=>{this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),this.sinkEnd.promise.then(n,s)})}),this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeWrite==null&&(this.log.trace("send close write to remote"),await this.sendCloseWrite(e)),this.writeStatus="closed",this.log.trace("closed writable end of stream")}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");let t=this.sendReset();v3(t)&&t.catch(n=>{this.log.error("error sending reset message",n)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;let e=new b("stream reset",dF);this.status="reset",this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("muxer destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}};var xn;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(xn||(xn={}));var Th=class extends Pi{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=xn.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=jl,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=Qi(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&await this.waitForSendWindowCapacity(t),this.status!=="open")return;let n=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-Ci,e.length),s=this.getSendFlags();this.sendFrame({type:yt.Data,flag:s,streamID:this._id,length:n},e.subarray(0,n)),this.sendWindowCapacity-=n,e.consume(n)}}async sendReset(){this.sendFrame({type:yt.WindowUpdate,flag:ct.RST,streamID:this._id,length:0})}async sendCloseWrite(){let e=this.getSendFlags()|ct.FIN;this.sendFrame({type:yt.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,n,s=()=>{this.status==="open"?n(new b("stream aborted",Tv)):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,o)=>{this.sendWindowCapacityUpdate=()=>{i()},n=o,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);let t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new b("receive window exceeded",b3,{available:this.recvWindowCapacity,recv:e.length});let n=await t();this.recvWindowCapacity-=e.length,this.sourcePush(n)}processFlags(e){(e&ct.ACK)===ct.ACK&&this.state===xn.SYNSent&&(this.state=xn.Established),(e&ct.FIN)===ct.FIN&&this.remoteCloseWrite(),(e&ct.RST)===ct.RST&&this.reset()}getSendFlags(){switch(this.state){case xn.Init:return this.state=xn.SYNSent,ct.SYN;case xn.SYNReceived:return this.state=xn.Established,ct.ACK;default:return 0}}sendWindowUpdate(){let e=this.getSendFlags(),t=Date.now(),n=this.getRTT();if(e===0&&n>0&&t-this.epochStart<n*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;let s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:yt.WindowUpdate,flag:e,streamID:this._id,length:s})}};var Lv="/yamux/1.0.0",mF=500,Ah=class{protocol=Lv;_init;constructor(e={}){this._init=e}createStreamMuxer(e){return new _3({...this._init,...e})}},_3=class{protocol=Lv;source;sink;config;log;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e){this.client=e.direction==="outbound",this.config={...Pv,...e},this.log=this.config.log,kv(this.config),this.closeController=new AbortController,this.onIncomingStream=e.onIncomingStream,this.onStreamEnd=e.onStreamEnd,this._streams=new Map,this.source=wt({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(t=>{t.destroy()})}}),this.sink=async t=>{t=ur(t,this.closeController.signal,{returnOnAbort:!0});let n,s;try{let i=new Ih(t);await Ie(i.emitFrames.bind(i),async o=>{for await(let{header:a,readData:c}of o)await this.handleFrame(a,c)}),n=En.NormalTermination}catch(i){let o=i.code;Iv.has(o)?(this.log?.error("protocol error in sink",i),n=En.ProtocolError):(this.log?.error("internal error in sink",i),n=En.InternalError),s=i}this.log?.trace("muxer sink ended"),s!=null?this.abort(s,n):await this.close({reason:n})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=0,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(t=>this.log?.error("keepalive error: %s",t))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new b("muxer closed remotely",w3);if(this.localGoAway!==void 0)throw new b("muxer closed locally",Rh);let t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new b("max outbound streams exceeded",Av);this.log?.trace("new outgoing stream id=%s",t);let n=this._newStream(t,e,xn.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new b("muxer closed remotely",w3);if(this.localGoAway!==void 0)throw new b("muxer closed locally",Rh);if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{let o=()=>{i(new b("muxer closed locally",Rh))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),s()}}),resolve:e};let t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}let n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;let t=e?.reason??En.NormalTermination;this.log?.trace("muxer close reason=%s",t),e.signal=e.signal??AbortSignal.timeout(mF);try{await Promise.all([...this._streams.values()].map(async n=>n.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(n){this.abort(n)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??En.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(let n of this._streams.values())n.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,s){if(this._streams.get(e)!=null)throw new b("Stream already exists",m3,{id:e});let i=new Th({id:e.toString(),name:t,state:n,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:k(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){let e=new Promise((t,n)=>{this.closeController.signal.addEventListener("abort",n,{once:!0})});for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let t;try{await Promise.race([e,new Promise(n=>{t=setTimeout(n,this.config.keepAliveInterval)})]),this.ping().catch(n=>this.log?.error("ping error: %s",n))}catch{clearInterval(t);return}}}async handleFrame(e,t){let{streamID:n,type:s,length:i}=e;if(this.log?.trace("received frame %s",E3(e)),n===0)switch(s){case yt.Ping:{this.handlePing(e);return}case yt.GoAway:{this.handleGoAway(i);return}default:throw new b("Invalid frame type",nc,{header:e})}else switch(e.type){case yt.Data:case yt.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new b("Invalid frame type",nc,{header:e})}}handlePing(e){if(e.flag===ct.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,ct.ACK);else if(e.flag===ct.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new b("Invalid frame flag",nc,{header:e})}handlePingResponse(e){if(this.activePing===void 0)throw new b("ping not requested",d3);if(this.activePing.id!==e)throw new b("ping doesn't match our id",p3);this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",En[e]??"unknown"),this.remoteGoAway=e;for(let t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){let{streamID:n,flag:s,type:i}=e;(s&ct.SYN)===ct.SYN&&this.incomingStream(n);let o=this._streams.get(n);if(o===void 0){if(i===yt.Data){if(this.log?.("discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else this.log?.("frame for missing stream id=%s",n);return}switch(i){case yt.WindowUpdate:{o.handleWindowUpdate(e);return}case yt.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new b("both endpoints are clients",y3);if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:yt.WindowUpdate,flag:ct.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:yt.WindowUpdate,flag:ct.RST,streamID:e,length:0});return}let t=this._newStream(e,void 0,xn.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %s",E3(e)),e.type===yt.Data){if(t===void 0)throw new b("invalid frame",nc);this.source.push(x3(e)),this.source.push(t)}else this.source.push(x3(e))}sendPing(e,t=ct.SYN){t===ct.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:yt.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=En.NormalTermination){this.log?.("sending GoAway reason=%s",En[e]),this.localGoAway=e,this.sendFrame({type:yt.GoAway,flag:0,streamID:0,length:e})}};function Bv(r={}){return()=>new Ah(r)}var gF=J("dns4"),yF=J("dns6"),bF=J("dnsaddr"),Ni=At(J("dns"),bF,gF,yF),Dh=At(J("ip4"),J("ip6")),sc=At(de(Dh,J("tcp")),de(Ni,J("tcp"))),Ch=de(Dh,J("udp")),wF=de(Ch,J("utp")),EF=de(Ch,J("quic")),xF=de(Ch,J("quic-v1")),S3=At(de(sc,J("ws")),de(Ni,J("ws"))),ic=At(de(S3,J("p2p")),S3),R3=At(de(sc,J("wss")),de(Ni,J("wss")),de(sc,J("tls"),J("ws")),de(Ni,J("tls"),J("ws"))),Bo=At(de(R3,J("p2p")),R3),I3=At(de(sc,J("http")),de(Dh,J("http")),de(Ni,J("http"))),T3=At(de(sc,J("https")),de(Dh,J("https")),de(Ni,J("https"))),Mv=de(Ch,J("webrtc-direct"),J("certhash")),Kv=At(de(Mv,J("p2p")),Mv),Uv=de(xF,J("webtransport"),J("certhash"),J("certhash")),Vv=At(de(Uv,J("p2p")),Uv),qv=At(de(ic,J("p2p-webrtc-star"),J("p2p")),de(Bo,J("p2p-webrtc-star"),J("p2p")),de(ic,J("p2p-webrtc-star")),de(Bo,J("p2p-webrtc-star"))),Cde=At(de(ic,J("p2p-websocket-star"),J("p2p")),de(Bo,J("p2p-websocket-star"),J("p2p")),de(ic,J("p2p-websocket-star")),de(Bo,J("p2p-websocket-star"))),zv=At(de(I3,J("p2p-webrtc-direct"),J("p2p")),de(T3,J("p2p-webrtc-direct"),J("p2p")),de(I3,J("p2p-webrtc-direct")),de(T3,J("p2p-webrtc-direct"))),Mo=At(S3,R3,I3,T3,qv,zv,sc,wF,EF,Ni,Kv,Vv),Pde=At(de(Mo,J("p2p-stardust"),J("p2p")),de(Mo,J("p2p-stardust"))),ki=At(de(Mo,J("p2p")),qv,zv,Kv,Vv,J("p2p")),Fv=At(de(ki,J("p2p-circuit"),ki),de(ki,J("p2p-circuit")),de(J("p2p-circuit"),ki),de(Mo,J("p2p-circuit")),de(J("p2p-circuit"),Mo),J("p2p-circuit")),$v=()=>At(de(Fv,$v),Fv),Gn=$v(),Hv=At(de(Gn,ki,Gn),de(ki,Gn),de(Gn,ki),Gn,ki);var kde=At(de(Gn,J("webrtc"),J("p2p")),de(Gn,J("webrtc")),de(Mo,J("webrtc"),J("p2p")),de(Mo,J("webrtc")),J("webrtc"));function Wv(r){function e(t){let n;try{n=oe(t)}catch{return!1}let s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function de(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Wv(e),partialMatch:e}}function At(...r){function e(n){let s=null;return r.some(i=>{let o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Wv(e),partialMatch:e}}function J(r){let e=r;function t(s){let i;try{i=oe(s)}catch{return!1}let o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}var Ph=k("libp2p:bootstrap"),vF="bootstrap",_F=50,SF=12e4,RF=1e3,A3=class extends Ue{static tag="bootstrap";timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??RF,this.list=[];for(let n of t.list){if(!Hv.matches(n)){Ph.error("Invalid multiaddr");continue}let s=oe(n),i=s.getPeerId();if(i==null){Ph.error("Invalid bootstrap multiaddr without peer id");continue}let o={id:fe(i),multiaddrs:[s],protocols:[]};this.list.push(o)}this._init=t}[xo]=this;[Symbol.toStringTag]="@libp2p/bootstrap";isStarted(){return!!this.timer}start(){this.isStarted()||(Ph("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{Ph.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(let e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??vF]:{value:this._init.tagValue??_F,ttl:this._init.tagTTL??SF}}}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}};function Yv(r){return e=>new A3(e,r)}async function*D3(r,e={}){let t=r.getReader();try{for(;;){let n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var e_=re(Zv(),1);var Nh=k("ipni-content-routing"),Jv={concurrentRequests:4,timeout:3e4},P3=class{started;httpQueue;shutDownController;clientUrl;timeout;constructor(e,t={}){Nh("enabled IPNI routing via",e),this.started=!1,this.shutDownController=new AbortController,this.httpQueue=new Bt({concurrency:t.concurrentRequests??Jv.concurrentRequests}),this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??Jv.timeout}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.shutDownController.abort(),this.started=!1}async*findProviders(e,t={}){Nh("findProviders starts: %c",e);let n=gr([this.shutDownController.signal,t.signal,AbortSignal.timeout(this.timeout)]),s=De(),i=De();this.httpQueue.add(async()=>(s.resolve(),i.promise));try{await s.promise;let o=`${this.clientUrl}cid/${e.toString()}?cascade=ipfs-dht`,c=await fetch(o,{headers:{Accept:"application/x-ndjson"},signal:n});if(c.body==null)throw new b("IPNI response had no body","ERR_BAD_RESPONSE");for await(let l of(0,e_.default)(D3(c.body)))l.Metadata==="gBI="&&(yield this.mapEvent(l))}catch(o){Nh.error("findProviders errored:",o)}finally{n.clear(),i.resolve(),Nh("findProviders finished: %c",e)}}mapEvent(e){let t=fe(e.Provider.ID),n=[];for(let i of e.Provider.Addrs){let o=oe(i);n.push(o)}return{id:t,multiaddrs:n,protocols:[]}}async provide(){}async put(){}async get(){throw new b("Not found","ERR_NOT_FOUND")}};function t_(r,e={}){return()=>new P3(r,e)}var r_="/lan",n_="/ipfs",s_="/kad/1.0.0",i_="/dht/record",k3="/dht/provider";var Oh=globalThis.CustomEvent??Event;async function*Uo(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);let n=e.ordered==null?!1:e.ordered,s=new EventTarget,i=[],o=De(),a=De(),c=!1,l,u=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(let p of r){if(i.length===t&&(o=De(),await o.promise),u)break;let m={done:!1};i.push(m),p().then(g=>{m.done=!0,m.ok=!0,m.value=g,s.dispatchEvent(new Oh("task-complete"))},g=>{m.done=!0,m.err=g,s.dispatchEvent(new Oh("task-complete"))})}c=!0,s.dispatchEvent(new Oh("task-complete"))}catch(p){l=p,s.dispatchEvent(new Oh("task-complete"))}});function f(){return n?i[0]?.done:!!i.find(p=>p.done)}function*h(){for(;i.length>0&&i[0].done;){let p=i[0];if(i.shift(),p.ok)yield p.value;else throw u=!0,o.resolve(),p.err;o.resolve()}}function*d(){for(;f();)for(let p=0;p<i.length;p++)if(i[p].done){let m=i[p];if(i.splice(p,1),p--,m.ok)yield m.value;else throw u=!0,o.resolve(),m.err;o.resolve()}}for(;;){if(f()||(a=De(),await a.promise),l!=null)throw l;if(n?yield*h():yield*d(),c&&i.length===0)break}}var Zl;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Zl||(Zl={}));function o_(r){let e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function a_(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}var tr=class r{key;value;timeReceived;constructor(e,t,n){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Zl.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:o_(this.timeReceived)}}static deserialize(e){let t=Zl.decode(e);return new r(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){let t=a_(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new r(e.key,e.value,t)}};var c_;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 3:s.author=t.bytes();break;case 4:s.signature=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(c_||(c_={}));var Oi;(function(r){let e;(function(a){a.PUT_VALUE="PUT_VALUE",a.GET_VALUE="GET_VALUE",a.ADD_PROVIDER="ADD_PROVIDER",a.GET_PROVIDERS="GET_PROVIDERS",a.FIND_NODE="FIND_NODE",a.PING="PING"})(e=r.MessageType||(r.MessageType={}));let t;(function(a){a[a.PUT_VALUE=0]="PUT_VALUE",a[a.GET_VALUE=1]="GET_VALUE",a[a.ADD_PROVIDER=2]="ADD_PROVIDER",a[a.GET_PROVIDERS=3]="GET_PROVIDERS",a[a.FIND_NODE=4]="FIND_NODE",a[a.PING=5]="PING"})(t||(t={})),function(a){a.codec=()=>lt(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(a){a.NOT_CONNECTED="NOT_CONNECTED",a.CONNECTED="CONNECTED",a.CAN_CONNECT="CAN_CONNECT",a.CANNOT_CONNECT="CANNOT_CONNECT"})(n=r.ConnectionType||(r.ConnectionType={}));let s;(function(a){a[a.NOT_CONNECTED=0]="NOT_CONNECTED",a[a.CONNECTED=1]="CONNECTED",a[a.CAN_CONNECT=2]="CAN_CONNECT",a[a.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(s||(s={})),function(a){a.codec=()=>lt(s)}(n=r.ConnectionType||(r.ConnectionType={}));let i;(function(a){let c;a.codec=()=>(c==null&&(c=le((l,u,f={})=>{if(f.lengthDelimited!==!1&&u.fork(),l.id!=null&&(u.uint32(10),u.bytes(l.id)),l.addrs!=null)for(let h of l.addrs)u.uint32(18),u.bytes(h);l.connection!=null&&(u.uint32(24),r.ConnectionType.codec().encode(l.connection,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={addrs:[]},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.id=l.bytes();break;case 2:f.addrs.push(l.bytes());break;case 3:f.connection=r.ConnectionType.codec().decode(l);break;default:l.skipType(d&7);break}}return f})),c),a.encode=l=>ce(l,a.codec()),a.decode=l=>ae(l,a.codec())})(i=r.Peer||(r.Peer={}));let o;r.codec=()=>(o==null&&(o=le((a,c,l={})=>{if(l.lengthDelimited!==!1&&c.fork(),a.type!=null&&(c.uint32(8),r.MessageType.codec().encode(a.type,c)),a.clusterLevelRaw!=null&&(c.uint32(80),c.int32(a.clusterLevelRaw)),a.key!=null&&(c.uint32(18),c.bytes(a.key)),a.record!=null&&(c.uint32(26),c.bytes(a.record)),a.closerPeers!=null)for(let u of a.closerPeers)c.uint32(66),r.Peer.codec().encode(u,c);if(a.providerPeers!=null)for(let u of a.providerPeers)c.uint32(74),r.Peer.codec().encode(u,c);l.lengthDelimited!==!1&&c.ldelim()},(a,c)=>{let l={closerPeers:[],providerPeers:[]},u=c==null?a.len:a.pos+c;for(;a.pos<u;){let f=a.uint32();switch(f>>>3){case 1:l.type=r.MessageType.codec().decode(a);break;case 10:l.clusterLevelRaw=a.int32();break;case 2:l.key=a.bytes();break;case 3:l.record=a.bytes();break;case 8:l.closerPeers.push(r.Peer.codec().decode(a,a.uint32()));break;case 9:l.providerPeers.push(r.Peer.codec().decode(a,a.uint32()));break;default:a.skipType(f&7);break}}return l})),o),r.encode=a=>ce(a,r.codec()),r.decode=a=>ae(a,r.codec())})(Oi||(Oi={}));var Dt=Oi.MessageType,TF=Oi.ConnectionType,f_=Object.keys(Dt),Et=class r{type;key;clusterLevelRaw;closerPeers;providerPeers;record;constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){let e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return Oi.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(l_),providerPeers:this.providerPeers.map(l_),record:this.record==null?void 0:this.record.serialize().subarray()})}static deserialize(e){let t=Oi.decode(e),n=new r(t.type??Oi.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(u_),n.providerPeers=t.providerPeers.map(u_),t.record?.length!=null&&(n.record=tr.deserialize(t.record)),n}};function l_(r){return{id:r.id.toBytes(),addrs:(r.multiaddrs??[]).map(t=>t.bytes),connection:TF.CONNECTED}}function u_(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:ht(r.id),multiaddrs:(r.addrs??[]).map(e=>oe(e)),protocols:[]}}function N3(r,e={}){let t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:f_.indexOf(r.type.toString())};return e.onProgress?.(new Ge("kad-dht:query:send-query",{detail:t})),t}function Jl(r,e={}){let t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]};return e.onProgress?.(new Ge("kad-dht:query:peer-response",{detail:t})),t}function Lh(r,e={}){let t={...r,name:"FINAL_PEER",type:2};return e.onProgress?.(new Ge("kad-dht:query:final-peer",{detail:t})),t}function Rr(r,e={}){let t={...r,name:"QUERY_ERROR",type:3};return e.onProgress?.(new Ge("kad-dht:query:query-error",{detail:t})),t}function O3(r,e={}){let t={...r,name:"PROVIDER",type:4};return e.onProgress?.(new Ge("kad-dht:query:provider",{detail:t})),t}function eu(r,e={}){let t={...r,name:"VALUE",type:5};return e.onProgress?.(new Ge("kad-dht:query:value",{detail:t})),t}function L3(r,e={}){let t={...r,name:"DIAL_PEER",type:7};return e.onProgress?.(new Ge("kad-dht:query:dial-peer",{detail:t})),t}function h_(r,e,t){if(t.length===0){let o="No records given";throw new b(o,"ERR_NO_RECORDS_RECEIVED")}let s=W(e).split("/");if(s.length<3){let o="Record key does not have a selector function";throw new b(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}let i=r[s[1].toString()];if(i==null){let o=`Unrecognized key prefix: ${s[1]}`;throw new b(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:i(e,t)}function AF(r,e){return 0}var d_={pk:AF};async function oc(r,e){let t=e.key,s=W(t).split("/");if(s.length<3)return;let i=r[s[1].toString()];if(i==null){let o="Invalid record keytype";throw new b(o,"ERR_INVALID_RECORD_KEY_TYPE")}await i(t,e.value)}var DF=async(r,e)=>{if(!(r instanceof Uint8Array))throw new b('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw new b("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(W(r.subarray(0,4))!=="/pk/")throw new b("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");let n=r.slice(4),s=await Ne.digest(e);if(!me(n,s.bytes))throw new b("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},p_={pk:DF};var CF=Q("/pk/");function ac(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;let s=Nr(n);return s==null?!0:!s})}}function cc(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{let[[t,n]]=e.stringTuples();if(n==="localhost")return!0;if(t!==4&&t!==6||n==null)return!1;let s=Nr(n);return s??!1})}}async function Li(r){return(await Ne.digest(r)).digest}async function Yn(r){return Li(r.toBytes())}function Hs(r){return new rt(`${i_}/${W(r,"base32")}`,!1)}function m_(r){return _e([CF,r.toBytes()])}function g_(r){return W(r.subarray(0,4))==="/pk/"}function y_(r){return ht(r.subarray(4))}function B3(r,e){let t=new Date;return new tr(r,e,t).serialize()}function b_(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{r()},e)}}var Bh=class{log;components;validators;selectors;peerRouting;queryManager;network;constructor(e,t){let{validators:n,selectors:s,peerRouting:i,queryManager:o,network:a,lan:c}=t;this.components=e,this.log=k(`libp2p:kad-dht:${c?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.network=a}async putLocal(e,t){let n=Hs(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);let t=Hs(e);this.log("fetching record for key %k",t);let n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);let s=tr.deserialize(n);return await oc(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);let i=B3(e,n);for(let{value:o,from:a}of t){if(me(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{let u=Hs(e);this.log(`Storing corrected record for key ${u.toString()}`),await this.components.datastore.put(u,i.subarray())}catch(u){this.log.error("Failed error correcting self",u)}continue}let c=!1,l=new Et(Dt.PUT_VALUE,e,0);l.record=tr.deserialize(i);for await(let u of this.network.sendRequest(a,l,s))u.name==="PEER_RESPONSE"&&u.record!=null&&me(u.record.value,tr.deserialize(i).value)&&(c=!0),yield u;c||(yield Rr({from:a,error:new b("value not put correctly","ERR_PUT_VALUE_INVALID")},s)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);let s=B3(e,t),i=Hs(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*Ie(this.peerRouting.getClosestPeers(e,{signal:n.signal}),o=>In(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[],l=new Et(Dt.PUT_VALUE,e,0);l.record=tr.deserialize(s),this.log("send put to %p",a.peer.id);for await(let u of this.network.sendRequest(a.peer.id,l,n))c.push(u),u.name==="PEER_RESPONSE"&&(u.record!=null&&me(u.record.value,tr.deserialize(s).value)||c.push(Rr({from:a.peer.id,error:new b("value not put correctly","ERR_PUT_VALUE_INVALID")},n)));return c}),o=>Uo(o,{ordered:!1,concurrency:3}),async function*(o){for await(let a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);let n=[];for await(let a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;let s=n.map(a=>a.value),i=0;try{i=h_(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}let o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new b("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{let i=await this.getLocal(e);yield eu({value:i.value,from:this.components.peerId},t)}catch(i){this.log("error getting local value for %b",e,i)}let n=this,s=async function*({peer:i,signal:o}){for await(let a of n.peerRouting.getValueOrPeers(i,e,{signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield eu({from:i,value:a.record.value},t))};yield*this.queryManager.run(e,s,t)}};var Mh=class{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){let{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,lan:c}=t;this.components=e,this.log=k(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);let s=new Et(Dt.ADD_PROVIDER,e.multihash.bytes,0);s.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let i=0,o=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];let c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(let l of this.network.sendMessage(a.peer.id,s,n))l.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),i++),c.push(l)}catch(l){this.log.error("error sending provide record to peer %p",a.peer.id,l),c.push(Rr({from:a.peer.id,error:l},n))}return c};yield*Ie(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>In(a,c=>o(c)),a=>Uo(a,{ordered:!1,concurrency:3}),async function*(a){for await(let c of a)yield*c}),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){let n=this.routingTable.kBucketSize,s=e.multihash.bytes,i=this;this.log("findProviders %c",e);let o=await this.providers.getProviders(e);if(o.length>0){let l=[];for(let u of o.slice(0,n))try{let f=await this.components.peerStore.get(u);l.push({id:u,multiaddrs:f.addresses.map(({multiaddr:h})=>h),protocols:f.protocols})}catch(f){if(f.code!=="ERR_NOT_FOUND")throw f;this.log("no peer store entry for %p",u)}yield Jl({from:this.components.peerId,messageType:Dt.GET_PROVIDERS,providers:l},t),yield O3({from:this.components.peerId,providers:l},t)}if(o.length>=n)return;let a=async function*({peer:l,signal:u}){let f=new Et(Dt.GET_PROVIDERS,s,0);yield*i.network.sendRequest(l,f,{...t,signal:u})},c=new Set(o.map(l=>l.toString()));for await(let l of this.queryManager.run(s,a,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);let u=[];for(let f of l.providers)c.has(f.id.toString())||(c.add(f.id.toString()),u.push(f));if(u.length>0&&(yield O3({from:l.from,providers:u},t)),c.size===n)return}}};var Uh=class extends Ue{log;protocol;running;components;constructor(e,t){super();let{protocol:n,lan:s}=t;this.components=e,this.log=k(`libp2p:kad-dht:${s?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield L3({peer:e},n),yield N3({to:e,type:t.type},n);let s;try{let o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),a=await this._writeReadMessage(o,t.serialize(),n);yield Jl({from:e,messageType:a.type,closer:a.closerPeers,providers:a.providerPeers,record:a.record},n)}catch(i){yield Rr({from:e,error:i},n)}finally{s!=null&&await s.close()}}async*sendMessage(e,t,n={}){if(!this.running)return;this.log("sending %s to %p",t.type,e),yield L3({peer:e},n),yield N3({to:e,type:t.type},n);let s;try{let o=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(o,t.serialize(),n),yield Jl({from:e,messageType:t.type},n)}catch(i){yield Rr({from:e,error:i},n)}finally{s!=null&&await s.close()}}async _writeMessage(e,t,n){n.signal!=null&&(e=Wa(e,n.signal)),await Ie([t],s=>_t(s),e,Tr)}async _writeReadMessage(e,t,n){n.signal!=null&&(e=Wa(e,n.signal));let s=await Ie([t],o=>_t(o),e,o=>Ct(o),async o=>{let a=await Hn(o);if(a!=null)return a;throw new b("No message received","ERR_NO_MESSAGE_RECEIVED")}),i=Et.deserialize(s);return i.closerPeers.forEach(o=>{this.dispatchEvent(new Ge("peer",{detail:o}))}),i.providerPeers.forEach(o=>{this.dispatchEvent(new Ge("peer",{detail:o}))}),i}};var Fh=class{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(s=>s.peerId.equals(e))!=null)return;let t=await Yn(e),n={peerId:e,distance:$s(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,i)=>wh(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;let t=await Promise.all(e.map(Yn)),n=this.peerDistances[this.peerDistances.length-1].distance;for(let s of t){let i=$s(this.originDhtKey,s);if(wh(i,n)<0)return!0}return!1}};var Kh=class{components;log;routingTable;network;validators;queryManager;constructor(e,t){let{routingTable:n,network:s,validators:i,queryManager:o,lan:a}=t;this.components=e,this.routingTable=n,this.network=s,this.validators=i,this.queryManager=o,this.log=k(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t,n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.components.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr),protocols:[]}}async*_getValueSingle(e,t,n={}){let s=new Et(Dt.GET_VALUE,t,0);yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){let n=m_(e);for await(let s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){let i=await cr(mf.marshalPublicKey({bytes:s.record.value}));if(!i.equals(e))throw new b("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw new b("public key missing","ERR_PUBLIC_KEY_MISSING");yield eu({from:e,value:i.publicKey},t)}throw new b(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);let n=await this.findPeerLocal(e);if(n!=null){this.log("found local"),yield Lh({from:this.components.peerId,peer:n},t);return}let s=this,i=async function*({peer:a,signal:c}){let l=new Et(Dt.FIND_NODE,e.toBytes(),0);for await(let u of s.network.sendRequest(a,l,{...t,signal:c}))if(yield u,u.name==="PEER_RESPONSE"){let f=u.closer.find(h=>h.id.equals(e));f!=null&&(yield Lh({from:u.from,peer:f},t))}},o=!1;for await(let a of this.queryManager.run(e.toBytes(),i,t))a.name==="FINAL_PEER"&&(o=!0),yield a;o||(yield Rr({from:this.components.peerId,error:new b("Not found","ERR_NOT_FOUND")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);let n=await Li(e),s=this.routingTable.closestPeers(n),i=this,o=new Fh(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await o.add(c)}));let a=async function*({peer:c,signal:l}){i.log("closerPeersSingle %s from %p",W(e,"base32"),c);let u=new Et(Dt.FIND_NODE,e,0);yield*i.network.sendRequest(c,u,{...t,signal:l})};for await(let c of this.queryManager.run(e,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l.id)}));this.log("found %d peers close to %b",o.length,e);for(let c of o.peers)try{let l=await this.components.peerStore.get(c);yield Lh({from:this.components.peerId,peer:{id:c,multiaddrs:l.addresses.map(({multiaddr:u})=>u),protocols:l.protocols}},t)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}}async*getValueOrPeers(e,t,n={}){for await(let s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{let o="invalid record received, discarded";this.log(o),yield Rr({from:s.from,error:new b(o,"ERR_INVALID_RECORD")},n);continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new b("invalid record received","ERR_INVALID_RECORD");await oc(this.validators,new tr(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){let n=await Li(e),s=this.routingTable.closestPeers(n),i=[];for(let o of s)if(!o.equals(t))try{let a=await this.components.peerStore.get(o);i.push({id:o,multiaddrs:a.addresses.map(({multiaddr:c})=>c),protocols:a.protocols})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),i}};var x_=re(E_(),1);var Ws=k("libp2p:kad-dht:providers"),Vh=class{components;cache;cleanupInterval;provideValidity;syncQueue;started;cleaner;constructor(e,t={}){let{cacheSize:n,cleanupInterval:s,provideValidity:i}=t;this.components=e,this.cleanupInterval=s??36e5,this.provideValidity=i??864e5,this.cache=(0,x_.default)(n??256),this.syncQueue=new Bt({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{Ws.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{let e=Date.now(),t=0,n=0,s=new Map,i=this.components.datastore.batch(),o=this.components.datastore.query({prefix:k3});for await(let a of o)try{let{cid:c,peerId:l}=v_(a.key),u=__(a.value).getTime(),f=Date.now(),h=f-u,d=h>this.provideValidity;if(Ws("comparing: %d - %d = %d > %d %s",f,u,h,this.provideValidity,d?"(expired)":""),d){n++,i.delete(a.key);let p=s.get(c)??new Set;p.add(l),s.set(c,p)}t++}catch(c){Ws.error(c.message)}s.size>0?(Ws("deleting %d / %d entries",n,t),await i.commit()):Ws("nothing to delete");for(let[a,c]of s){let l=tu(a),u=this.cache.get(l);if(u!=null){for(let f of c)u.delete(f);u.size===0?this.cache.remove(l):this.cache.set(l,u)}}Ws("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){let t=tu(e),n=this.cache.get(t);return n==null&&(n=await LF(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{Ws("%p provides %s",t,e);let n=await this._getProvidersMap(e);Ws("loaded %s provs",n.size);let s=new Date;n.set(t.toString(),s);let i=tu(e);this.cache.set(i,n),await OF(this.components.datastore,e,t,s)})}async getProviders(e){return this.syncQueue.add(async()=>(Ws("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>fe(n))),{throwOnTimeout:!0})}};function tu(r){let e=typeof r=="string"?r:W(r.multihash.bytes,"base32");return`${k3}/${e}`}async function OF(r,e,t,n){let s=[tu(e),"/",t.toString()].join(""),i=new rt(s),o=Vt(n.getTime());await r.put(i,o)}function v_(r){let e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function LF(r,e){let t=new Map,n=r.query({prefix:tu(e)});for await(let s of n){let{peerId:i}=v_(s.key);t.set(i,__(s.value))}return t}function __(r){return new Date(Kr(r))}var Fo=re(Dr(),1);var BF=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*S_(r){let{key:e,startingPeer:t,ourPeerId:n,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,cleanUp:l,queryFuncTimeout:u,log:f,peersSeen:h}=r,d=new Bt({concurrency:o}),p=await Li(e);function m(g,y){if(g==null)return;h.add(g);let w=BigInt("0x"+W($s(y,p),"base16"));d.add(async()=>{let E=[s];u!=null&&E.push(AbortSignal.timeout(u));let R=gr(E);try{for await(let x of i({key:e,peer:g,signal:R,pathIndex:a,numPaths:c})){if(R.aborted)return;if(x.name==="PEER_RESPONSE")for(let v of x.closer){if(h.has(v.id)){f("already seen %p in query",v.id);continue}if(n.equals(v.id)){f("not querying ourselves");continue}let I=await Yn(v.id);if(BigInt("0x"+W($s(I,p),"base16"))>w){f("skipping %p as they are not closer to %b than %p",v.id,e,g);continue}f("querying closer peer %p",v.id),m(v.id,I)}d.emit("completed",x)}}catch(x){if(!s.aborted)return Rr({from:g,error:x},r)}finally{R.clear()}},{priority:BF-w}).catch(E=>{f.error(E)})}m(t,await Yn(t)),yield*MF(d,s,l,f)}async function*MF(r,e,t,n){let s=De(),i=!0,o=[],a=()=>{i&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,r.size,r.pending),i=!1,r.clear(),o.splice(0,o.length))};for(r.on("completed",c=>{o.push(c),s.resolve()}),r.on("error",c=>{n("queue error",c),a(),s.reject(c)}),r.on("idle",()=>{n("queue idle"),i=!1,s.resolve()}),e.addEventListener("abort",()=>{n("abort queue");let c=i;a(),c&&s.reject(new b("Query aborted","ERR_QUERY_ABORTED"))}),t.addEventListener("cleanup",()=>{a(),s.resolve()});i;)for(await s.promise,s=De();o.length>0;){let c=o.shift();c!=null&&(yield c)}yield*o}var zh=class{components;lan;disjointPaths;alpha;shutDownController;running;queries;metrics;routingTable;initialQuerySelfHasRun;constructor(e,t){let{lan:n=!1,disjointPaths:s=20,alpha:i=3}=t;this.components=e,this.disjointPaths=s??20,this.running=!1,this.alpha=i??3,this.lan=n,this.queries=0,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.shutDownController=new AbortController;try{Fo.setMaxListeners!=null&&(0,Fo.setMaxListeners)(1/0,this.shutDownController.signal)}catch{}}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&this.metrics==null&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");let s=this.metrics?.queryTime.timer();if(n.signal==null){n.signal=AbortSignal.timeout(3e4);try{Fo.setMaxListeners!=null&&(0,Fo.setMaxListeners)(1/0,n.signal)}catch{}}let i=gr([this.shutDownController.signal,n.signal]);try{Fo.setMaxListeners!=null&&(0,Fo.setMaxListeners)(1/0,i)}catch{}let o=k(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+W(e,"base58btc")),a=Date.now(),c=new Ue;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial query-self query before continuing"),await Promise.race([new Promise((p,m)=>{i.addEventListener("abort",()=>{m(new Tn("Query was aborted before self-query ran"))})}),this.initialQuerySelfHasRun.promise]),this.initialQuerySelfHasRun=void 0),o("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries);let l=await Li(e),u=this.routingTable.closestPeers(l),f=u.slice(0,Math.min(this.disjointPaths,u.length));if(u.length===0){o.error("Running query with no peers");return}let h=new gn,d=f.map((p,m)=>S_({key:e,startingPeer:p,ourPeerId:this.components.peerId,signal:i,query:t,pathIndex:m,numPaths:f.length,alpha:this.alpha,cleanUp:c,queryFuncTimeout:n.queryFuncTimeout,log:o,peersSeen:h,onProgress:n.onProgress}));for await(let p of Lt(...d))yield p,p.name==="QUERY_ERROR"&&o("error",p.error)}catch(l){if(!(!this.running&&l.code==="ERR_QUERY_ABORTED"))throw l}finally{i.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),s?.(),c.dispatchEvent(new Ge("cleanup")),o("query:done in %dms",Date.now()-a)}}};var U3=re(Dr(),1);function FF(r){return r[Symbol.asyncIterator]!=null}function KF(r){if(FF(r))return(async()=>{let e=0;for await(let t of r)e++;return e})();{let e=0;for(let t of r)e++;return e}}var $h=KF;var VF=r=>{let e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function qF(r,e,t){let n,s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=VF(r),f=(...d)=>{let p=t.multiArgs?d:d[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),i(c)))},h=d=>{n(),o(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){let i=oo(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function R_(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=qF(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}var Hh=class{log;components;peerRouting;routingTable;count;interval;initialInterval;queryTimeout;started;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){let{peerRouting:n,lan:s,count:i,interval:o,queryTimeout:a,routingTable:c}=t;this.components=e,this.log=k(`libp2p:kad-dht:${s?"lan":"wan"}:query-self`),this.started=!1,this.peerRouting=n,this.routingTable=c,this.count=i??20,this.interval=o??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=a??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun}isStarted(){return this.started}start(){this.started||(this.started=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.started=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.started){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=De(),this.routingTable.size===0&&await R_(this.routingTable,"peer:add"),this.started){this.controller=new AbortController;let e=gr([this.controller.signal,AbortSignal.timeout(this.queryTimeout)]);try{U3.setMaxListeners!=null&&(0,U3.setMaxListeners)(1/0,e)}catch{}try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);let t=await Ie(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:e,isSelfQuery:!0}),n=>ei(n,this.count),async n=>$h(n));this.log("self-query ran successfully - found %d peers",t),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}catch(t){this.log.error("self-query error",t)}finally{e.clear()}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.started&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}};function I_(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function F3(){return{contacts:[],dontSplit:!1,left:null,right:null}}function ru(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}var Wh=class r extends Ue{localNodeId;root;numberOfNodesPerKBucket;numberOfNodesToPing;distance;arbiter;constructor(e){super(),this.localNodeId=e.localNodeId,this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket??20,this.numberOfNodesToPing=e.numberOfNodesToPing??3,this.distance=e.distance??r.distance,this.arbiter=e.arbiter??r.arbiter,ru("option.localNodeId as parameter 1",this.localNodeId),this.root=F3()}static arbiter(e,t){return(e.vectorClock??0)>(t.vectorClock??0)?e:t}static distance(e,t){let n=0,s=0,i=Math.min(e.length,t.length),o=Math.max(e.length,t.length);for(;s<i;++s)n=n*256+(e[s]^t[s]);for(;s<o;++s)n=n*256+255;return n}add(e){ru("contact.id",e?.id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);let s=this._indexOf(n,e.id);return s>=0?(this._update(n,s,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.safeDispatchEvent("added",{detail:e}),this):n.dontSplit?(this.safeDispatchEvent("ping",{detail:{oldContacts:n.contacts.slice(0,this.numberOfNodesToPing),newContact:e}}),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(ru("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let s=[this.root],i=0;s.length>0&&n.length<t;){let o=s.pop();if(o!=null)if(o.contacts===null){let a=this._determineNode(o,e,i++);s.push(o.left===a?o.right:o.left),s.push(a)}else n=n.concat(o.contacts)}return n.map(s=>({distance:this.distance(s.id,e),contact:s})).sort((s,i)=>s.distance-i.distance).slice(0,t).map(s=>s.contact)}count(){let e=0;for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length)}return e}_determineNode(e,t,n){let s=n>>3,i=n%8;return t.length<=s&&i!==0?e.left:t[s]&1<<7-i?e.right:e.left}get(e){ru("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let s=this._indexOf(n,e);return s>=0?n.contacts[s]:void 0}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(I_(e.contacts[n].id,t))return n;return-1}remove(e){ru("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);let s=this._indexOf(n,e);if(s>=0){let i=n.contacts.splice(s,1)[0];this.safeDispatchEvent("removed",{detail:i})}return this}_split(e,t){e.left=F3(),e.right=F3();for(let i of e.contacts)this._determineNode(e,i.id,t).contacts.push(i);e.contacts=null;let n=this._determineNode(e,this.localNodeId,t),s=e.left===n?e.right:e.left;s.dontSplit=!0}toArray(){let e=[];for(let t=[this.root];t.length>0;){let n=t.pop();n!=null&&(n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts))}return e}*toIterable(){for(let e=[this.root];e.length>0;){let t=e.pop();t!=null&&(t.contacts===null?e.push(t.right,t.left):yield*t.contacts)}}_update(e,t,n){if(!I_(e.contacts[t].id,n.id))throw new Error("wrong index for _update");let s=e.contacts[t],i=this.arbiter(s,n);i===s&&s!==n||(e.contacts.splice(t,1),e.contacts.push(i),this.safeDispatchEvent("updated",{detail:{incumbent:s,selection:i}}))}};var WF="kad-close",GF=50,T_=20,YF=1e4,QF=10,Gh=class extends Ue{kBucketSize;kb;pingQueue;log;components;lan;pingTimeout;pingConcurrency;running;protocol;tagName;tagValue;metrics;constructor(e,t){super();let{kBucketSize:n,pingTimeout:s,lan:i,pingConcurrency:o,protocol:a,tagName:c,tagValue:l}=t;this.components=e,this.log=k(`libp2p:kad-dht:${i?"lan":"wan"}:routing-table`),this.kBucketSize=n??T_,this.pingTimeout=s??YF,this.pingConcurrency=o??QF,this.lan=i,this.running=!1,this.protocol=a,this.tagName=c??WF,this.tagValue=l??GF;let u=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new Bt({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",u),this.pingQueue.addListener("next",u),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});let e=new Wh({localNodeId:await Yn(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.addEventListener("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new gn,n=b_(()=>{let s=new gn(e.closest(e.localNodeId,T_).map(a=>a.peer)),i=s.difference(t),o=t.difference(s);Promise.resolve().then(async()=>{for(let a of i)await this.components.peerStore.merge(a,{tags:{[this.tagName]:{value:this.tagValue}}});for(let a of o)await this.components.peerStore.merge(a,{tags:{[this.tagName]:void 0}})}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=s});e.addEventListener("added",s=>{n(),this.safeDispatchEvent("peer:add",{detail:s.detail.peer})}),e.addEventListener("removed",s=>{n(),this.safeDispatchEvent("peer:remove",{detail:s.detail.peer})})}_onPing(e){let{oldContacts:t,newContact:n}=e.detail;this.pingQueue.add(async()=>{if(!this.running)return;let s=0;try{await Promise.all(t.map(async i=>{try{let o={signal:AbortSignal.timeout(this.pingTimeout)};this.log("pinging old contact %p",i.peer),await(await(await this.components.connectionManager.openConnection(i.peer,o)).newStream(this.protocol,o)).close(),s++}catch(o){this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",i.peer,o),this.log("evicting old contact after ping failed %p",i.peer),this.kb.remove(i.id))}finally{this.metrics?.routingTableSize.update(this.size)}})),this.running&&s<t.length&&this.kb!=null&&(this.log("adding new contact %p",n.peer),this.kb.add(n))}catch(i){this.log.error("could not process k-bucket ping event",i)}}).catch(s=>{this.log.error("could not process k-bucket ping event",s)})}get size(){return this.kb==null?0:this.kb.count()}async find(e){let t=await Yn(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){let t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(s=>s.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await Yn(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");let t=await Yn(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}};var A_=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];var Yh=15,Qh=class{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e){let{peerRouting:t,routingTable:n,refreshInterval:s,refreshQueryTimeout:i,lan:o}=e;this.log=k(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=s??3e5,this.refreshQueryTimeout=i??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");let t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,e),this._numPeersForCpl(t)===0){let o=Math.min(2*(i+1),n.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}let s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);let i=await $h(this.peerRouting.getClosestPeers(s.toBytes(),{signal:AbortSignal.timeout(this.refreshQueryTimeout)}));this.log(`found ${i} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>Yh&&(e=Yh);let t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");let t=Pr(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return ht(s)}async _makePeerId(e,t,n){if(n>Yh)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Yh}`);let o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=A_[c],u=new ArrayBuffer(34),f=new DataView(u,0,u.byteLength);return f.setUint8(0,Ne.code),f.setUint8(1,32),f.setUint32(2,l,!1),new Uint8Array(f.buffer,f.byteOffset,f.byteLength)}_maxCommonPrefix(){let e=0;for(let t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(let n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(let{id:e}of this.routingTable.kb.toIterable()){let t=$s(this.routingTable.kb.localNodeId,e),n=0;for(let s of t)if(s===0)n++;else break;yield n}}};var nu=k("libp2p:kad-dht:rpc:handlers:add-provider"),Xh=class{providers;constructor(e){let{providers:t}=e;this.providers=t}async handle(e,t){if(nu("start"),t.key==null||t.key.length===0)throw new b("Missing key","ERR_MISSING_KEY");let n;try{n=ge.decode(t.key)}catch{throw new b("Invalid CID","ERR_INVALID_CID")}(t.providerPeers==null||t.providerPeers.length===0)&&nu.error("no providers found in message"),await Promise.all(t.providerPeers.map(async s=>{if(!s.id.equals(e)){nu("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){nu("no valid addresses for provider %p. Ignore",e);return}nu("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(i=>i.toString())),await this.providers.addProvider(n,s.id)}))}};var D_=k("libp2p:kad-dht:rpc:handlers:find-node"),jh=class{peerRouting;lan;components;constructor(e,t){let{peerRouting:n,lan:s}=t;this.components=e,this.peerRouting=n,this.lan=!!s}async handle(e,t){D_("incoming request from %p for peers closer to %b",e,t.key);let n=[];me(this.components.peerId.toBytes(),t.key)?n=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(i=>i.decapsulateCode(he("p2p").code)),protocols:[]}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?cc:ac).filter(({multiaddrs:i})=>i.length);let s=new Et(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?s.closerPeers=n:D_("could not find any peers closer to %b than %p",t.key,e),s}};var C_=k("libp2p:kad-dht:rpc:handlers:get-providers"),Zh=class{components;peerRouting;providers;lan;constructor(e,t){let{peerRouting:n,providers:s,lan:i}=t;this.components=e,this.peerRouting=n,this.providers=s,this.lan=!!i}async handle(e,t){let n;try{n=ge.decode(t.key)}catch{throw new b("Invalid CID","ERR_INVALID_CID")}C_("%p asking for providers for %s",e,n);let[s,i]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:l})=>l)),c=new Et(t.type,t.key,t.clusterLevel);return o.length>0&&(c.providerPeers=o),a.length>0&&(c.closerPeers=a),C_("got %s providers %s closerPeers",o.length,a.length),c}async _getAddresses(e){return[]}async _getPeers(e){let t=[],n=this.lan?cc:ac;for(let s of e)try{let i=await this.components.peerStore.get(s),o=n({id:s,multiaddrs:i.addresses.map(({multiaddr:a})=>a),protocols:i.protocols});o.multiaddrs.length>0&&t.push(o)}catch(i){if(i.code!=="ERR_NOT_FOUND")throw i}return t}};var uc=k("libp2p:kad-dht:rpc:handlers:get-value"),Jh=class{components;peerRouting;constructor(e,t){let{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){let n=t.key;if(uc("%p asked for key %b",e,n),n==null||n.length===0)throw new b("Invalid key","ERR_INVALID_KEY");let s=new Et(Dt.GET_VALUE,n,t.clusterLevel);if(g_(n)){uc("is public key");let a=y_(n),c;try{let l=await this.components.peerStore.get(a);if(l.id.publicKey==null)throw new b("No public key found in key book","ERR_NOT_FOUND");c=l.id.publicKey}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null)return uc("returning found public key"),s.record=new tr(n,c,new Date),s}let[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return i!=null&&(uc("had record for %b in local datastore",n),s.record=i),o.length>0&&(uc("had %s closer peers in routing table",o.length),s.closerPeers=o),s}async _checkLocalDatastore(e){uc("checkLocalDatastore looking for %b",e);let t=Hs(e),n;try{n=await this.components.datastore.get(t)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}let s=tr.deserialize(n);if(s==null)throw new b("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>1296e5){await this.components.datastore.delete(t);return}return s}};var JF=k("libp2p:kad-dht:rpc:handlers:ping"),ed=class{async handle(e,t){return JF("ping from %p",e),t}};var td=class{log;components;validators;constructor(e,t){let{validators:n}=t;this.components=e,this.log=k("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){let n=t.key;this.log("%p asked us to store value for key %b",e,n);let s=t.record;if(s==null){let i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new b(i,"ERR_EMPTY_RECORD")}try{await oc(this.validators,s),s.timeReceived=new Date;let i=Hs(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}};var rd=class{handlers;routingTable;log;constructor(e,t){let{providers:n,peerRouting:s,validators:i,lan:o}=t;this.log=k("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[Dt.GET_VALUE]:new Jh(e,{peerRouting:s}),[Dt.PUT_VALUE]:new td(e,{validators:i}),[Dt.FIND_NODE]:new jh(e,{peerRouting:s,lan:o}),[Dt.ADD_PROVIDER]:new Xh({providers:n}),[Dt.GET_PROVIDERS]:new Zh(e,{peerRouting:s,providers:n,lan:o}),[Dt.PING]:new ed}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}let n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{let{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}let i=this;await Ie(t,o=>Ct(o),async function*(o){for await(let a of o){let c=Et.deserialize(a);i.log("incoming %s from %p",c.type,s);let l=await i.handleMessage(s,c);l!=null&&(yield l.serialize())}},o=>_t(o),t)}).catch(t=>{this.log.error(t)})}};var nd=class extends Ue{log;components;protocol;running;registrarId;constructor(e,t){super();let{protocol:n,lan:s}=t;this.components=e,this.log=k(`libp2p:kad-dht:topology-listener:${s?"lan":"wan"}`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new Ge("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}};var eK=32,tK=64,su=class extends Ue{protocol;routingTable;providers;network;peerRouting;components;log;running;kBucketSize;clientMode;lan;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;constructor(e,t){super();let{kBucketSize:n,clientMode:s,validators:i,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:l,pingTimeout:u,pingConcurrency:f,maxInboundStreams:h,maxOutboundStreams:d,providers:p}=t;this.running=!1,this.components=e,this.lan=!!c,this.log=k(`libp2p:kad-dht:${c===!0?"lan":"wan"}`),this.protocol=`${l??n_}${c===!0?r_:""}${s_}`,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=h??eK,this.maxOutboundStreams=d??tK,this.routingTable=new Gh(e,{kBucketSize:n,lan:this.lan,pingTimeout:u,pingConcurrency:f,protocol:this.protocol}),this.providers=new Vh(e,p??{}),this.validators={...p_,...i},this.selectors={...d_,...o},this.network=new Uh(e,{protocol:this.protocol,lan:this.lan});let m=De();t.allowQueryWithZeroPeers===!0&&m.resolve(),this.queryManager=new zh(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.peerRouting=new Kh(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new Bh(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,lan:this.lan}),this.contentRouting=new Mh(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new Qh({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new rd(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new nd(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new Hh(e,{peerRouting:this.peerRouting,interval:a,initialInterval:t.initialQuerySelfInterval,lan:this.lan,initialQuerySelfHasRun:m,routingTable:this.routingTable}),this.network.addEventListener("peer",g=>{let y=g.detail;this.onPeerConnect(y).catch(w=>{this.log.error("could not add %p to routing table",y.id,w)}),this.dispatchEvent(new Ge("peer",{detail:y}))}),this.topologyListener.addEventListener("peer",g=>{let y=g.detail;Promise.resolve().then(async()=>{let w=await this.components.peerStore.get(y),E={id:y,multiaddrs:w.addresses.map(({multiaddr:R})=>R),protocols:w.protocols};await this.onPeerConnect(E)}).catch(w=>{this.log.error("could not add %p to routing table",y,w)})})}async onPeerConnect(e){if(this.log("peer %p connected with protocols",e.id,e.protocols),this.lan?e=cc(e):e=ac(e),e.multiaddrs.length===0){this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start()]),this.querySelf.start(),await this.routingTableRefresh.start()}async stop(){this.running=!1,this.querySelf.stop(),await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};var fc=k("libp2p:kad-dht"),K3=class{dht;constructor(e){this.dht=e}async provide(e,t={}){await Tr(this.dht.provide(e,t))}async*findProviders(e,t={}){for await(let n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Tr(this.dht.put(e,t,n))}async get(e,t){for await(let n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new b("Not found","ERR_NOT_FOUND")}},V3=class{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(let n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new b("Not found","ERR_NOT_FOUND")}async*getClosestPeers(e,t={}){for await(let n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}},rK=290,nK=54,sK=55,iK=56,oK=4,aK=41;function cK(r){let e=r.stringTuples();for(let t of e)if(t[0]===rK)return!1;if(e[0][0]===nK||e[0][0]===sK||e[0][0]===iK)return fc("%m is public %s",r,!0),!0;if(e[0][0]===oK||e[0][0]===aK){let t=Nr(`${e[0][1]}`),n=t==null||!t;return fc("%m is public %s",r,n),n}return!1}var sd=class extends Ue{wan;lan;components;contentRouting;peerRouting;constructor(e,t={}){super(),this.components=e,this.wan=new su(e,{protocolPrefix:"/ipfs",...t,lan:!1}),this.lan=new su(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}),this.contentRouting=new K3(this),this.peerRouting=new V3(this),this.wan.addEventListener("peer",n=>{this.dispatchEvent(new Ge("peer",{detail:n.detail}))}),this.lan.addEventListener("peer",n=>{this.dispatchEvent(new Ge("peer",{detail:n.detail}))}),t.clientMode==null&&e.events.addEventListener("self:peer:update",n=>{fc("received update of self-peer info");let s=n.detail.peer.addresses.some(({multiaddr:i})=>{let o=cK(i);return fc("%m is public %s",i,o),o});this.getMode().then(async i=>{s&&i==="client"?await this.setMode("server"):i==="server"&&!s&&await this.setMode("client")}).catch(i=>{fc.error("error setting dht server mode",i)})})}[Symbol.toStringTag]="@libp2p/dual-kad-dht";get[_l](){return this.contentRouting}get[Sl](){return this.peerRouting}get[xo](){return this}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(let s of Lt(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield s}async*get(e,t={}){let n=!1,s=!1;for await(let i of Lt(this.lan.get(e,t),this.wan.get(e,t)))yield i,i.name==="DIAL_PEER"&&(n=!0),i.name==="VALUE"&&(n=!0,i.value!=null&&(s=!0)),i.name==="SEND_QUERY"&&(n=!0);if(!n)throw new b("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");s||(yield Rr({from:this.components.peerId,error:new b("Not found","ERR_NOT_FOUND")},t))}async*provide(e,t={}){let n=0,s=0,i=[],o=[this.lan];await this.wan.getMode()==="server"&&o.push(this.wan);for await(let a of Lt(...o.map(c=>c.provide(e,t))))yield a,a.name==="SEND_QUERY"&&n++,a.name==="QUERY_ERROR"&&i.push(a.error),a.name==="PEER_RESPONSE"&&a.messageName==="ADD_PROVIDER"&&(fc("sent provider record for %s to %p",e,a.from),s++);if(s===0)throw i.length>0?new b(`Failed to provide to ${i.length} of ${n} peers`,"ERR_PROVIDES_FAILED",{errors:i}):new b("Failed to provide - no peers found","ERR_PROVIDES_FAILED")}async*findProviders(e,t={}){yield*Lt(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(let s of Lt(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield s,(s.name==="SEND_QUERY"||s.name==="FINAL_PEER")&&(n=!0);if(!n)throw new b("Peer lookup failed","ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*Lt(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}};var P_;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(P_||(P_={}));var k_;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(k_||(k_={}));function N_(r){return e=>new sd(e,r)}var z_=re(Am(),1);var ke;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(ke||(ke={}));var iu=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),q3=Object.freeze({NEW_STREAM:ke.NEW_STREAM,MESSAGE:ke.MESSAGE_INITIATOR,CLOSE:ke.CLOSE_INITIATOR,RESET:ke.RESET_INITIATOR}),O_=Object.freeze({MESSAGE:ke.MESSAGE_RECEIVER,CLOSE:ke.CLOSE_RECEIVER,RESET:ke.RESET_RECEIVER});var z3=1<<20,lK=4<<20,id=class{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=z3,t=lK){this._buffer=new Ee,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});let t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.code==="ERR_MSG_TOO_BIG")throw l;break}let{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;let c={id:n,type:s};(s===ke.NEW_STREAM||s===ke.MESSAGE_INITIATOR||s===ke.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){let{value:t,offset:n}=B_(e),{value:s,offset:i}=B_(e,n),o=t&7;if(iu[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:s}}},uK=128,L_=127;function B_(r,e=0){let t=0,n=0,s=e,i,o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&L_)<<n:(i&L_)*Math.pow(2,n),n+=7}while(i>=uK);return e=s-e,{value:t,offset:e}}function fK(r){return r[Symbol.asyncIterator]!=null}var od=1024*1024,M_=(r,e)=>{e.append(r)};function hK(r,e){return fK(r)?async function*(){let t=new Ee,n=!1,s=De(),i=Number(e?.size??od);if((isNaN(i)||i===0||i<0)&&(i=od),i!==Math.round(i))throw new Error("Batch size must be an integer");let o=e?.yieldAfter??0,a=e?.serialize??M_;for(Promise.resolve().then(async()=>{try{let c;for await(let l of r){if(a(l,t),t.byteLength>=i){clearTimeout(c),s.resolve();continue}c=setTimeout(()=>{s.resolve()},o)}clearTimeout(c),s.resolve()}catch(c){s.reject(c)}finally{n=!0}});!n;)if(await s.promise,s=De(),t.byteLength>0){let c=t;t=new Ee,yield c.subarray()}}():function*(){let t=new Ee,n=Number(e?.size??od);if((isNaN(n)||n===0||n<0)&&(n=od),n!==Math.round(n))throw new Error("Batch size must be an integer");let s=e?.serialize??M_;for(let i of r)s(i,t),t.byteLength>=n&&(yield t.subarray(0,n),t.consume(n));t.byteLength>0&&(yield t.subarray())}()}var U_=hK;function $3(r){return new Uint8Array(r)}var H3=10*1024,W3=class{_pool;_poolOffset;constructor(){this._pool=$3(H3),this._poolOffset=0}write(e,t){let n=this._pool,s=this._poolOffset;Vt(e.id<<3|e.type,n,s),s+=Kt(e.id<<3|e.type),(e.type===ke.NEW_STREAM||e.type===ke.MESSAGE_INITIATOR||e.type===ke.MESSAGE_RECEIVER)&&e.data!=null?(Vt(e.data.length,n,s),s+=Kt(e.data.length)):(Vt(0,n,s),s+=Kt(0));let i=n.subarray(this._poolOffset,s);H3-s<100?(this._pool=$3(H3),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===ke.NEW_STREAM||e.type===ke.MESSAGE_INITIATOR||e.type===ke.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}},F_=new W3;async function*K_(r,e=0){if(e==null||e===0){for await(let t of r){let n=new Ee;for(let s of t)F_.write(s,n);yield n.subarray()}return}yield*U_(r,{size:e,serialize:(t,n)=>{for(let s of t)F_.write(s,n)}})}var G3=class extends Pi{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types=e.direction==="outbound"?q3:O_,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:q3.NEW_STREAM,data:new Ee(Q(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}};function V_(r){let{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=z3}=r;return new G3({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:s,send:n,log:k(`libp2p:mplex:stream:${i}:${e}`)})}var Jr=k("libp2p:mplex"),dK=1024,pK=1024,mK=1024*1024*4,gK=5,yK=500;function q_(r){let e={...r,type:`${iu[r.type]} (${r.type})`};return r.type===ke.NEW_STREAM&&(e.data=W(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===ke.MESSAGE_INITIATOR||r.type===ke.MESSAGE_RECEIVER)&&(e.data=W(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}var ad=class{protocol="/mplex/6.7.0";sink;source;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;constructor(e){e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.closeTimeout=e.closeTimeout??yK,this.sink=this._createSink(),this._source=X8({objectMode:!0,onEnd:()=>{for(let t of this._streams.initiators.values())t.destroy();for(let t of this._streams.receivers.values())t.destroy()}}),this.source=Ie(this._source,t=>K_(t,this._init.minSendBytes)),this.closeController=new AbortController,this.rateLimiter=new z_.RateLimiterMemory({points:e.disconnectThreshold??gK,duration:1})}get streams(){let e=[];for(let t of this._streams.initiators.values())e.push(t);for(let t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");let t=this._streamId++;e=e==null?t.toString():e.toString();let n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;let t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){let{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){let{id:t,name:n,type:s,registry:i}=e;if(Jr("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??pK))throw new b("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);let c=V_({id:t,name:n,send:async l=>{Jr.enabled&&Jr.trace("%s stream %s send",s,t,q_(l)),this._source.push(l)},type:s,onEnd:()=>{Jr("%s stream with id %s and protocol %s ended",s,t,c.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return i.set(t,c),c}_createSink(){return async t=>{try{t=ur(t,this.closeController.signal,{returnOnAbort:!0});let n=new id(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(let s of t)for(let i of n.write(s))await this._handleIncoming(i);this._source.end()}catch(n){Jr("error in sink",n),this._source.end(n)}}}async _handleIncoming(e){let{id:t,type:n}=e;if(Jr.enabled&&Jr.trace("incoming message",q_(e)),e.type===ke.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??dK)){Jr("too many inbound streams open"),this._source.push({id:t,type:ke.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{Jr("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}let a=this._newReceiverStream({id:t,name:W(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}let i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){Jr("missing stream %s for message type %s",t,iu[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{Jr("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}let o=this._init.maxStreamBufferSize??mK;try{switch(n){case ke.MESSAGE_INITIATOR:case ke.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===ke.MESSAGE_INITIATOR?ke.RESET_RECEIVER:ke.RESET_INITIATOR}),new b("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");i.sourcePush(e.data);break;case ke.CLOSE_INITIATOR:case ke.CLOSE_RECEIVER:i.remoteCloseWrite();break;case ke.RESET_INITIATOR:case ke.RESET_RECEIVER:i.reset();break;default:Jr("unknown message type %s",n)}}catch(a){Jr.error("error while processing message",a),i.abort(a)}}};var Y3=class{protocol="/mplex/6.7.0";_init;constructor(e={}){this._init=e}createStreamMuxer(e={}){return new ad({...e,...this._init})}};function $_(r={}){return()=>new Y3(r)}var en;(function(r){r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",r.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",r.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"})(en||(en={}));var Bi=class extends b{constructor(e,t){super(`WebRTC transport error: ${e}`,t??""),this.name="WebRTCTransportError"}};var Q3=class extends Bi{constructor(e,t){super(`[stream: ${e}] data channel error: ${t}`,en.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}};function t4(r,e){return new Q3(r,e)}var X3=class extends Bi{constructor(e){super(`There was a problem with the Multiaddr which was passed in: ${e}`,en.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}};function cd(r){return new X3(r)}var j3=class extends Bi{constructor(e){super(`There was a problem with a provided argument: ${e}`,en.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}};function ou(r){return new j3(r)}var Z3=class extends Bi{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`,en.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}};function r4(r,e){return new Z3(r,e)}var J3=class extends Bi{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`,en.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}};function H_(r){return new J3(r)}var e4=class extends Bi{constructor(e){super(`unsupported hash algorithm: ${e}`,en.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}};function W_(r){return new e4(r)}var G_=function(r,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return r.concat(i||Array.prototype.slice.call(e))},bK=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}();var wK=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}();var EK=function(){function r(e,t,n,s){this.name=e,this.version=t,this.os=n,this.bot=s,this.type="bot-device"}return r}();var xK=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}();var vK=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}();var _K=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,SK=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,Y_=3,RK=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",_K]],Q_=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function j_(r){return r?X_(r):typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new vK:typeof navigator<"u"?X_(navigator.userAgent):AK()}function IK(r){return r!==""&&RK.reduce(function(e,t){var n=t[0],s=t[1];if(e)return e;var i=s.exec(r);return!!i&&[n,i]},!1)}function X_(r){var e=IK(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new xK;var s=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);s?s.length<Y_&&(s=G_(G_([],s,!0),DK(Y_-s.length),!0)):s=[];var i=s.join("."),o=TK(r),a=SK.exec(r);return a&&a[1]?new EK(t,i,o,a[1]):new bK(t,i,o)}function TK(r){for(var e=0,t=Q_.length;e<t;e++){var n=Q_[e],s=n[0],i=n[1],o=i.exec(r);if(o)return s}return null}function AK(){var r=typeof process<"u"&&process.version;return r?new wK(process.version.slice(1)):null}function DK(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}var Z_=j_(),au=Z_!=null&&Z_.name==="firefox",ld=async function*(){},ud=async r=>{};var J_=k("libp2p:webrtc:connection"),Ko=class{peerConnection;remoteAddr;timeline;metrics;source=ld();sink=ud;constructor(e){this.remoteAddr=e.remoteAddr,this.timeline=e.timeline,this.peerConnection=e.peerConnection,this.peerConnection.onconnectionstatechange=()=>{(this.peerConnection.connectionState==="closed"||this.peerConnection.connectionState==="disconnected"||this.peerConnection.connectionState==="failed")&&(this.timeline.close=Date.now())}}async close(e){J_.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){J_.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}};var hc=globalThis.RTCPeerConnection,n4=globalThis.RTCSessionDescription,eS=globalThis.RTCIceCandidate;function rr(r,e){let t=Wl(r,e),n={read:async(s,i)=>{let o=await t.read(i);return s.decode(o)},write:async(s,i,o)=>{await t.write(i.encode(s),o)},pb:s=>({read:async i=>n.read(s,i),write:async(i,o)=>n.write(i,s,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}var CK=r=>{let e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function PK(r,e,t){let n,s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();let a=[e].flat(),c=[],{addListener:l,removeListener:u}=CK(r),f=(...d)=>{let p=t.multiArgs?d:d[0];t.filter&&!t.filter(p)||(c.push(p),t.count===c.length&&(n(),i(c)))},h=d=>{n(),o(d)};n=()=>{for(let d of a)u(d,f);for(let d of t.rejectionEvents)u(d,h)};for(let d of a)l(d,f);for(let d of t.rejectionEvents)l(d,h);t.signal&&t.signal.addEventListener("abort",()=>{h(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){let i=oo(s,{milliseconds:t.timeout});return i.cancel=n,i}return s}function tS(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};let n=PK(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}var vn;(function(r){let e;(function(s){s.FIN="FIN",s.STOP_SENDING="STOP_SENDING",s.RESET="RESET"})(e=r.Flag||(r.Flag={}));let t;(function(s){s[s.FIN=0]="FIN",s[s.STOP_SENDING=1]="STOP_SENDING",s[s.RESET=2]="RESET"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.Flag||(r.Flag={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.flag!=null&&(i.uint32(8),r.Flag.codec().encode(s.flag,i)),s.message!=null&&(i.uint32(18),i.bytes(s.message)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.flag=r.Flag.codec().decode(s);break;case 2:o.message=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(vn||(vn={}));var kK=16*1024,NK=16*1024*1024,OK=30*1e3,LK=5,BK=2,s4=class extends Pi{channel;dataChannelOptions;incomingData;messageQueue;maxDataSize;constructor(e){switch(super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=wt(),this.messageQueue=new Ee,this.dataChannelOptions={bufferedAmountLowEventTimeout:e.dataChannelOptions?.bufferedAmountLowEventTimeout??OK,maxBufferedAmount:e.dataChannelOptions?.maxBufferedAmount??NK,maxMessageSize:e.dataChannelOptions?.maxMessageSize??e.maxDataSize},this.maxDataSize=e.maxDataSize,this.channel.readyState){case"open":break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new b("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=n=>{this.timeline.open=new Date().getTime(),this.messageQueue!=null&&(this._sendMessage(this.messageQueue).catch(s=>{this.abort(s)}),this.messageQueue=void 0)},this.channel.onclose=n=>{this.close().catch(s=>{this.log.error("error closing stream after channel closed",s)})},this.channel.onerror=n=>{let s=n.error;this.abort(s)};let t=this;this.channel.onmessage=async n=>{let{data:s}=n;s===null||s.byteLength===0||this.incomingData.push(new Uint8Array(s,0,s.byteLength))},Promise.resolve().then(async()=>{for await(let n of Ct(this.incomingData)){let s=t.processIncomingProtobuf(n.subarray());s!=null&&t.sourcePush(new Ee(s))}}).catch(n=>{this.log.error("error processing incoming data channel messages",n)})}sendNewStream(){}async _sendMessage(e,t=!0){if(t&&this.channel.bufferedAmount>this.dataChannelOptions.maxBufferedAmount)try{await tS(this.channel,"bufferedamountlow",{timeout:this.dataChannelOptions.bufferedAmountLowEventTimeout})}catch(n){throw n instanceof io?new Error("Timed out waiting for DataChannel buffer to clear"):n}if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new b("Invalid datachannel state - closed or closing","ERR_INVALID_STATE");if(this.channel.readyState==="open")for(let n of e)this.channel.send(n);else if(this.channel.readyState==="connecting")this.messageQueue==null&&(this.messageQueue=new Ee),this.messageQueue.append(e);else throw this.log.error("unknown datachannel state %s",this.channel.readyState),new b("Unknown datachannel state","ERR_INVALID_STATE")}async sendData(e){for(e=e.sublist();e.byteLength>0;){let t=Math.min(e.byteLength,this.maxDataSize),n=e.subarray(0,t),s=vn.encode({message:n}),i=_t.single(s);await this._sendMessage(i),e.consume(t)}}async sendReset(){await this._sendFlag(vn.Flag.RESET)}async sendCloseWrite(){await this._sendFlag(vn.Flag.FIN)}async sendCloseRead(){await this._sendFlag(vn.Flag.STOP_SENDING)}processIncomingProtobuf(e){let t=vn.decode(e);return t.flag!==void 0&&(t.flag===vn.Flag.FIN&&(this.incomingData.end(),this.remoteCloseWrite()),t.flag===vn.Flag.RESET&&this.reset(),t.flag===vn.Flag.STOP_SENDING&&this.remoteCloseRead()),t.message}async _sendFlag(e){this.log.trace("Sending flag: %s",e.toString());let t=vn.encode({flag:e}),n=_t.single(t);await this._sendMessage(n,!1)}};function dc(r){let{channel:e,direction:t,onEnd:n,dataChannelOptions:s}=r;return new s4({id:t==="inbound"?`i${e.id}`:`r${e.id}`,direction:t,maxDataSize:(s?.maxMessageSize??kK)-LK-BK,dataChannelOptions:s,onEnd:n,channel:e,log:k(`libp2p:webrtc:stream:${t}:${e.id}`)})}var rS="/webrtc",Vo=class{protocol;peerConnection;streamBuffer=[];metrics;dataChannelOptions;constructor(e){this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??rS,this.dataChannelOptions=e.dataChannelOptions,this.peerConnection.ondatachannel=({channel:t})=>{let n=dc({channel:t,direction:"inbound",dataChannelOptions:e.dataChannelOptions,onEnd:()=>{this.streamBuffer=this.streamBuffer.filter(s=>s.id!==n.id)}});this.streamBuffer.push(n)}}createStreamMuxer(e){return new i4({...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.streamBuffer,protocol:this.protocol})}},i4=class{init;streams;protocol;peerConnection;dataChannelOptions;metrics;close=async()=>{};abort=()=>{};source=ld();sink=ud;constructor(e){this.init=e,this.streams=e.streams,this.peerConnection=e.peerConnection,this.protocol=e.protocol??rS,this.metrics=e.metrics,this.peerConnection.ondatachannel=({channel:n})=>{let s=dc({channel:n,direction:"inbound",dataChannelOptions:this.dataChannelOptions,onEnd:()=>{this.streams=this.streams.filter(i=>i.id!==s.id),this.metrics?.increment({stream_end:!0}),e?.onStreamEnd?.(s)}});this.streams.push(s),e?.onIncomingStream!=null&&(this.metrics?.increment({incoming_stream:!0}),e.onIncomingStream(s))};let t=e?.onIncomingStream;t!=null&&this.streams.forEach(n=>{t(n)})}newStream(){let e=this.peerConnection.createDataChannel(""),t=dc({channel:e,direction:"outbound",dataChannelOptions:this.dataChannelOptions,onEnd:()=>{e.close(),this.streams=this.streams.filter(n=>n.id!==t.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(t)}});return this.streams.push(t),this.metrics?.increment({outgoing_stream:!0}),t}};var tn;(function(r){let e;(function(s){s.SDP_OFFER="SDP_OFFER",s.SDP_ANSWER="SDP_ANSWER",s.ICE_CANDIDATE="ICE_CANDIDATE"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.SDP_OFFER=0]="SDP_OFFER",s[s.SDP_ANSWER=1]="SDP_ANSWER",s[s.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.data!=null&&(i.uint32(18),i.string(s.data)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.data=s.string();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(tn||(tn={}));var fd=k("libp2p:webrtc:peer:util"),o4=async(r,e,t)=>{for(;;){let n=await Promise.race([r.promise,t.read()]);if(n instanceof Object){let s=n;if(s.type!==tn.Type.ICE_CANDIDATE)throw new Error("expected only ice candidates");if(s.data==null||s.data===""){fd.trace("end-of-candidates received");break}fd.trace("received new ICE candidate: %s",s.data);try{await e.addIceCandidate(new eS(JSON.parse(s.data)))}catch(i){throw fd.error("bad candidate received: ",i),new Error("bad candidate received")}}else break}await r.promise};function a4(r,e){r[au?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(fd.trace("receiver peerConnectionState state: ",r.connectionState),au?r.iceConnectionState:r.connectionState){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Error("RTCPeerConnection was closed"));break;default:break}}}var MK=30*1e3,Mi=k("libp2p:webrtc:peer");async function nS({rtcConfiguration:r,dataChannelOptions:e,stream:t}){let n=AbortSignal.timeout(MK),s=rr(Wa(t,n)).pb(tn),i=new hc(r);try{let o=new Vo({peerConnection:i,dataChannelOptions:e}),a=De(),c=De();n.onabort=()=>{a.reject(new b("Timed out while trying to connect","ERR_TIMEOUT"))},i.onicecandidate=({candidate:d})=>{c.promise.then(async()=>{await s.write({type:tn.Type.ICE_CANDIDATE,data:d!=null?JSON.stringify(d.toJSON()):""})},p=>{Mi.error("cannot set candidate since sending answer failed",p),a.reject(p)})},a4(i,a);let l=await s.read();if(l.type!==tn.Type.SDP_OFFER)throw new Error(`expected message type SDP_OFFER, received: ${l.type??"undefined"} `);let u=new n4({type:"offer",sdp:l.data});await i.setRemoteDescription(u).catch(d=>{throw Mi.error("could not execute setRemoteDescription",d),new Error("Failed to set remoteDescription")});let f=await i.createAnswer().catch(d=>{throw Mi.error("could not execute createAnswer",d),c.reject(d),new Error("Failed to create answer")});await s.write({type:tn.Type.SDP_ANSWER,data:f.sdp}),await i.setLocalDescription(f).catch(d=>{throw Mi.error("could not execute setLocalDescription",d),c.reject(d),new Error("Failed to set localDescription")}),c.resolve(),await o4(a,i,s);let h=iS(i.currentRemoteDescription?.sdp??"");return{pc:i,muxerFactory:o,remoteAddress:h}}catch(o){throw i.close(),o}}async function sS({rtcConfiguration:r,dataChannelOptions:e,signal:t,stream:n}){let s=rr(Wa(n,t)).pb(tn),i=new hc(r);try{let o=new Vo({peerConnection:i,dataChannelOptions:e}),a=De();a4(i,a),t.onabort=a.reject;let c=i.createDataChannel("init");i.onicecandidate=({candidate:d})=>{s.write({type:tn.Type.ICE_CANDIDATE,data:d!=null?JSON.stringify(d.toJSON()):""}).catch(p=>{Mi.error("error sending ICE candidate",p)})};let l=await i.createOffer();await s.write({type:tn.Type.SDP_OFFER,data:l.sdp}),await i.setLocalDescription(l).catch(d=>{throw Mi.error("could not execute setLocalDescription",d),new Error("Failed to set localDescription")});let u=await s.read();if(u.type!==tn.Type.SDP_ANSWER)throw new Error("remote should send an SDP answer");let f=new n4({type:"answer",sdp:u.data});await i.setRemoteDescription(f).catch(d=>{throw Mi.error("could not execute setRemoteDescription",d),new Error("Failed to set remoteDescription")}),await o4(a,i,s),c.close();let h=iS(i.currentRemoteDescription?.sdp??"");return{pc:i,muxerFactory:o,remoteAddress:h}}catch(o){throw i.close(),o}}function iS(r){let e=r.split(`\r
`).filter(n=>n.startsWith("a=candidate")).pop(),t=e?.split(" ");return e==null||t==null||t.length<5?(Mi("could not parse remote address from",e),"/webrtc"):`/dnsaddr/${t[4]}/${t[2].toLowerCase()}/${t[5]}/webrtc`}var hd=class extends Ue{peerId;transportManager;constructor(e){super(),this.peerId=e.peerId,this.transportManager=e.transportManager}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter(e=>e!==this).map(e=>e.getAddrs().filter(t=>Gn.matches(t)).map(t=>t.encapsulate(`/webrtc/p2p/${this.peerId}`))).flat()}async close(){this.safeDispatchEvent("close",{})}};var oS=k("libp2p:webrtc:peer"),UK="/webrtc",FK="/p2p-circuit",c4="/webrtc-signaling/0.0.1",KK=he("webrtc").code,dd=class{components;init;_started=!1;constructor(e,t={}){this.components=e,this.init=t}isStarted(){return this._started}async start(){await this.components.registrar.handle(c4,e=>{this._onProtocol(e).catch(t=>{oS.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)})},{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(c4),this._started=!1}createListener(e){return new hd(this.components)}[Symbol.toStringTag]="@libp2p/webrtc";[hs]=!0;filter(e){return e.filter(t=>t.protoCodes().includes(KK))}async dial(e,t){oS.trace("dialing address: ",e);let{baseAddr:n,peerId:s}=VK(e);if(t.signal==null){let a=new AbortController;t.signal=a.signal}let i=await this.components.transportManager.dial(n,t),o=await i.newStream(c4,{...t,runOnTransientConnection:!0});try{let{pc:a,muxerFactory:c,remoteAddress:l}=await sS({stream:o,rtcConfiguration:this.init.rtcConfiguration,dataChannelOptions:this.init.dataChannel,signal:t.signal}),u=await t.upgrader.upgradeOutbound(new Ko({peerConnection:a,timeline:{open:Date.now()},remoteAddr:oe(l).encapsulate(`/p2p/${s.toString()}`)}),{skipProtection:!0,skipEncryption:!0,muxerFactory:c});return await o.close(),u}catch(a){throw o.abort(a),a}finally{await i.close()}}async _onProtocol({connection:e,stream:t}){try{let{pc:n,muxerFactory:s,remoteAddress:i}=await nS({rtcConfiguration:this.init.rtcConfiguration,connection:e,stream:t,dataChannelOptions:this.init.dataChannel});await this.components.upgrader.upgradeInbound(new Ko({peerConnection:n,timeline:{open:new Date().getTime()},remoteAddr:oe(i).encapsulate(`/p2p/${e.remotePeer.toString()}`)}),{skipEncryption:!0,skipProtection:!0,muxerFactory:s})}catch(n){throw t.abort(n),n}finally{await e.close()}}};function VK(r){let e=r.toString().split(UK+"/");if(e.length!==2)throw new b("webrtc protocol was not present in multiaddr",en.ERR_INVALID_MULTIADDR);if(!e[0].includes(FK))throw new b("p2p-circuit protocol was not present in multiaddr",en.ERR_INVALID_MULTIADDR);let t=oe(e[0]),s=oe("/"+e[1]).getPeerId();if(s==null)throw new b("destination peer id was missing",en.ERR_INVALID_MULTIADDR);let i=t.protos().pop();if(i===void 0)throw new b("invalid multiaddr",en.ERR_INVALID_MULTIADDR);return i.name!=="p2p"&&(t=t.encapsulate(`/p2p/${s}`)),{baseAddr:t,peerId:fe(s)}}var LR=re(U4(),1);var DR=re(U4(),1);var F4=k("libp2p:webrtc:sdp"),K4=Object.values(on).map(r=>r.decoder).reduce((r,e)=>r.or(e));function CR(r){let e=r.getConfiguration().certificates?.at(0);if(e==null||e.getFingerprints==null){F4.trace("fetching fingerprint from local SDP");let n=r.localDescription;return n==null?void 0:Yq(n.sdp)}if(F4.trace("fetching fingerprint from local certificate"),e.getFingerprints().length===0)return;let t=e.getFingerprints()[0].value;if(t==null)throw r4("","no fingerprint on local certificate");return t}var Gq=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function Yq(r){return r.match(Gq)?.groups?.fingerprint}function Qq(r){for(let e of r.protoNames())if(e.startsWith("ip"))return e.toUpperCase();return F4("Warning: multiaddr does not appear to contain IP4 or IP6, defaulting to IP6",r),"IP6"}function Rd(r){let t=r.stringTuples().filter(n=>n[0]===z4).map(n=>n[1])[0];if(t===void 0||t==="")throw cd(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function V4(r){let e=K4.decode(r);return DR.decode(e)}function Xq(r){let e=V4(Rd(r)),t=q4(e.name),n=e.digest.reduce((i,o)=>i+o.toString(16).padStart(2,"0"),""),s=n.match(/.{1,2}/g);if(s==null)throw r4(n,r.toString());return[`${t.toUpperCase()} ${s.join(":").toUpperCase()}`,n]}function q4(r){switch(r){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw W_(r)}}function jq(r,e){let{host:t,port:n}=r.toOptions(),s=Qq(r),[i]=Xq(r);return`v=0
o=- 0 0 IN ${s} ${t}
s=-
c=IN ${s} ${t}
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:passive
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${i}
a=sctp-port:5000
a=max-message-size:16384
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host\r
`}function PR(r,e){return{type:"answer",sdp:jq(r,e)}}function kR(r,e){if(r.sdp===void 0)throw ou("Can't munge a missing SDP");return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+`
`).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+`
`),r}var NR=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),OR=r=>[...Array(r)].map(()=>NR.at(Math.floor(Math.random()*NR.length))).join("");var Id=k("libp2p:webrtc:transport"),Jq=1e4,ez=he("webrtc-direct").code,z4=he("certhash").code,Td=class{metrics;components;init;constructor(e,t={}){this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dial events by type"})})}async dial(e,t){let n=await this._connect(e,t);return Id(`dialing address - ${e.toString()}`),n}createListener(e){throw H_("WebRTCTransport.createListener")}filter(e){return e.filter(tz)}[Symbol.toStringTag]="@libp2p/webrtc-direct";[hs]=!0;async _connect(e,t){let n=new AbortController,s=n.signal,i=e.getPeerId();if(i===null)throw cd("we need to have the remote's PeerId");let o=fe(i),a=V4(Rd(e)),c=await hc.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:q4(a.name)}),l=new hc({certificates:[c]});try{let u=new Promise((_,D)=>{let O=l.createDataChannel("",{negotiated:!0,id:0}),N=setTimeout(()=>{let U=`Data channel was never opened: state: ${O.readyState}`;Id.error(U),this.metrics?.dialerEvents.increment({open_error:!0}),D(t4("data",U))},Jq);O.onopen=U=>{clearTimeout(N),_(O)},O.onerror=U=>{clearTimeout(N);let te=`Error opening a data channel for handshaking: ${U.target?.toString()??"not specified"}`;Id.error(te),this.metrics?.dialerEvents.increment({unknown_error:!0}),D(t4("data",te))}}),f="libp2p+webrtc+v1/"+OR(32),h=await l.createOffer(),d=kR(h,f);await l.setLocalDescription(d);let p=PR(e,f);await l.setRemoteDescription(p);let m=await u,g=this.components.peerId,y=this.generateNoisePrologue(l,a.code,e),w=rc({prologueBytes:y})(),E=dc({channel:m,direction:"inbound",dataChannelOptions:this.init.dataChannel}),R={...E,sink:E.sink.bind(E),source:async function*(){for await(let _ of E.source)for(let D of _)yield D}()},x=new Ko({peerConnection:l,remoteAddr:e,timeline:{open:Date.now()},metrics:this.metrics?.dialerEvents}),v=au?"iceconnectionstatechange":"connectionstatechange";l.addEventListener(v,()=>{switch(l.connectionState){case"failed":case"disconnected":case"closed":x.close().catch(_=>{Id.error("error closing connection",_)}).finally(()=>{n.abort()});break;default:break}},{signal:s}),this.metrics?.dialerEvents.increment({peer_connection:!0});let I=new Vo({peerConnection:l,metrics:this.metrics?.dialerEvents,dataChannelOptions:this.init.dataChannel});return await w.secureInbound(g,R,o),await t.upgrader.upgradeOutbound(x,{skipProtection:!0,skipEncryption:!0,muxerFactory:I})}catch(u){throw l.close(),u}}generateNoisePrologue(e,t,n){if(e.getConfiguration().certificates?.length===0)throw ou("no local certificate");let s=CR(e);if(s==null)throw ou("no local fingerprint found");let i=s.trim().toLowerCase().replaceAll(":",""),o=Q(i,"hex"),a=LR.encode(o,t),c=K4.decode(Rd(n)),l=Q("libp2p-webrtc-noise:");return _e([l,a,c])}};function tz(r){let e=r.protoCodes();return e.includes(ez)&&e.includes(z4)&&r.getPeerId()!=null&&!e.includes(he("p2p-circuit").code)}function BR(r){return e=>new Td(e,r)}function MR(r){return e=>new dd(e,r)}function UR(r){let e;try{e=he("sni").code}catch{return null}for(let[t,n]of r)if(t===e&&n!==void 0)return n;return null}function FR(r){return r.some(([e,t])=>e===he("tls").code)}function rn(r,e,t){let n=KR[he(r).name];if(n===void 0)throw new Error(`Can't interpret protocol ${he(r).name}`);let s=n(e,t);return r===he("ip6").code?`[${s}]`:s}var KR={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${rn(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${rn(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${rn(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${rn(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{let t=FR(e),n=UR(e);if(t&&n!==null)return`https://${n}`;let s=t?"https://":"http://",i=e.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=rn(i[0],i[1]??"",e);return o=o.replace("tcp://",""),`${s}${o}`},tls:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return rn(t[0],t[1]??"",e)},sni:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return rn(t[0],t[1]??"",e)},https:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=rn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{let t=FR(e),n=UR(e);if(t&&n!==null)return`wss://${n}`;let s=t?"wss://":"ws://",i=e.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=rn(i[0],i[1]??"",e);return o=o.replace("tcp://",""),`${s}${o}`},wss:(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=rn(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${rn(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${rn(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{let t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${rn(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function VR(r,e){let n=oe(r).stringTuples(),s=n.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");let i=he(s[0]),o=KR[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",n);return e?.assumeHttp!==!1&&s[0]===he("tcp").code&&(a=a.replace("tcp://","http://"),(s[1]==="443"||s[1]==="80")&&(s[1]==="443"&&(a=a.replace("http://","https://")),a=a.substring(0,a.lastIndexOf(":")))),a}var qR=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})};var zR=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(let s of n){try{await qR(r)}catch(i){if(i.message==="socket closed")break;throw i}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(s)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{let a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>{r.close()})})});var GR=re(HR(),1);function WR(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}var YR=r=>{r.binaryType="arraybuffer";let e=async()=>{await new Promise((i,o)=>{if(n){i();return}if(s!=null){o(s);return}let a=u=>{r.removeEventListener("open",c),r.removeEventListener("error",l),u()},c=()=>{a(i)},l=u=>{a(()=>{o(u.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){let i=new GR.EventIterator(({push:o,stop:a,fail:c})=>{let l=f=>{let h=null;typeof f.data=="string"&&(h=Q(f.data)),WR(f.data)&&(h=new Uint8Array(f.data)),f.data instanceof Uint8Array&&(h=f.data),h!=null&&o(h)},u=f=>{c(f.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",u),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",u),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(let o of i)yield WR(o)?new Uint8Array(o):o}(),n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})};var QR=(r,e)=>{e=e??{};let t=YR(r),n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{let o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:zR(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}};var XR=WebSocket;var sI=re(nI(),1),hz={http:"ws",https:"wss"},dz="ws",iI=(r,e)=>(0,sI.relative)(r,e,hz,dz);function oI(r,e){let t=typeof window>"u"?"":window.location;e=e??{};let n=iI(r,t.toString()),s=new XR(n,e.websocket);return QR(s,e)}var lI=re(cI(),1),Y4=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,Cd=(0,lI.default)(),Pd=Y4&&!Cd,uI=Cd&&!Y4,fI=Cd&&Y4,hI=typeof globalThis.process<"u"&&typeof globalThis.process.release<"u"&&globalThis.process.release.name==="node"&&!Cd,kd=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,Tge=typeof globalThis.process<"u"&&typeof globalThis.process.env<"u"&&globalThis.process.env["NODE"+(()=>"_")()+"ENV"]==="test",dI=typeof navigator<"u"&&navigator.product==="ReactNative";function gI(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return ic.matches(t)||Bo.matches(t)})}function yI(r){return r.filter(e=>{if(e.protoCodes().includes(290))return!1;let t=e.decapsulateCode(421);return Bo.matches(t)})}function bI(){throw new Error("WebSocket Servers can not be created in the browser!")}var Q4=k("libp2p:websockets:socket");function wI(r,e,t){t=t??{};let n={async sink(s){t?.signal!=null&&(s=ur(s,t.signal));try{await r.sink(s)}catch(i){i.type!=="aborted"&&Q4.error(i)}},source:t.signal!=null?ur(r.source,t.signal):r.source,remoteAddr:e,timeline:{open:Date.now()},async close(s={}){let i=Date.now();s.signal=s.signal??AbortSignal.timeout(500);let o=()=>{let{host:a,port:c}=n.remoteAddr.toOptions();Q4("timeout closing stream to %s:%s after %dms, destroying it manually",a,c,Date.now()-i),this.abort(new b("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};s.signal.addEventListener("abort",o);try{await r.close()}catch(a){this.abort(a)}finally{s.signal.removeEventListener("abort",o),n.timeline.close=Date.now()}},abort(s){let{host:i,port:o}=n.remoteAddr.toOptions();Q4("timeout closing stream to %s:%s due to error",i,o,s),r.destroy(),n.timeline.close=Date.now()}};return r.socket.addEventListener("close",()=>{n.timeline.close==null&&(n.timeline.close=Date.now())},{once:!0}),n}var Ki=k("libp2p:websockets"),X4=class{init;constructor(e){this.init=e}[Symbol.toStringTag]="@libp2p/websockets";[hs]=!0;async dial(e,t){Ki("dialing %s",e),t=t??{};let n=await this._connect(e,t),s=wI(n,e);Ki("new outbound connection %s",s.remoteAddr);let i=await t.upgrader.upgradeOutbound(s);return Ki("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){if(t?.signal?.aborted===!0)throw new Tn;let n=e.toOptions();Ki("dialing %s:%s",n.host,n.port);let s=De(),i=oI(VR(e),this.init);if(i.socket.addEventListener("error",()=>{let c=new b(`Could not connect to ${e.toString()}`,"ERR_CONNECTION_FAILED");Ki.error("connection error:",c),s.reject(c)}),t.signal==null)return await Promise.race([i.connected(),s.promise]),Ki("connected %s",e),i;let o,a=new Promise((c,l)=>{if(o=()=>{l(new Tn),i.close().catch(u=>{Ki.error("error closing raw socket",u)})},t?.signal?.aborted===!0){o();return}t?.signal?.addEventListener("abort",o)});try{await Promise.race([a,s.promise,i.connected()])}finally{o!=null&&t?.signal?.removeEventListener("abort",o)}return Ki("connected %s",e),i}createListener(e){return bI({...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):Pd||kd?yI(e):gI(e)}};function EI(r={}){return()=>new X4(r)}var yu=k("libp2p:webtransport:stream");async function j4(r,e,t,n,s){let i=r.writable.getWriter(),o=r.readable.getReader();await i.ready;function a(){let h=n.findIndex(d=>d===f);h!==-1&&(n.splice(h,1),f.timeline.close=Date.now(),s?.(f))}let c=!1,l=!1;(async function(){let h=await i.closed.catch(d=>d);if(h!=null){let d=h.message;d.includes("aborted by the remote server")||d.includes("STOP_SENDING")||yu.error(`WebTransport writer closed unexpectedly: streamId=${e} err=${h.message}`)}c=!0,c&&l&&a()})().catch(()=>{yu.error("WebTransport failed to cleanup closed stream")}),async function(){let h=await o.closed.catch(d=>d);h!=null&&yu.error(`WebTransport reader closed unexpectedly: streamId=${e} err=${h.message}`),l=!0,c&&l&&a()}().catch(()=>{yu.error("WebTransport failed to cleanup closed stream")});let u=!1,f={id:e,status:"open",writeStatus:"ready",readStatus:"ready",abort(h){c||(i.abort(h).catch(d=>{yu.error("could not abort stream",d)}),c=!0),l=!0,this.status="aborted",this.writeStatus="closed",this.readStatus="closed",this.timeline.reset=this.timeline.close=this.timeline.closeRead=this.timeline.closeWrite=Date.now(),a()},async close(h){this.status="closing",await Promise.all([f.closeRead(h),f.closeWrite(h)]),a(),this.status="closed",this.timeline.close=Date.now()},async closeRead(h){if(!l){this.readStatus="closing";try{await o.cancel()}catch(d){d.toString().includes("RESET_STREAM")===!0&&(c=!0)}this.timeline.closeRead=Date.now(),this.readStatus="closed",l=!0}c&&a()},async closeWrite(h){if(!c){c=!0,this.writeStatus="closing";try{await i.close()}catch(d){d.toString().includes("RESET_STREAM")===!0&&(l=!0)}this.timeline.closeWrite=Date.now(),this.writeStatus="closed"}l&&a()},direction:t,timeline:{open:Date.now()},metadata:{},source:async function*(){for(;;){let h=await o.read();if(h.done){l=!0,c&&a();return}yield new Ee(h.value)}}(),sink:async function(h){if(u)throw new Error("sink already called on stream");u=!0;try{this.writeStatus="writing";for await(let d of h)if(d instanceof Uint8Array)await i.write(d);else for(let p of d)await i.write(p);this.writeStatus="done"}finally{this.timeline.closeWrite=Date.now(),this.writeStatus="closed",await f.closeWrite()}}};return f}function Z4(){return{source:{[Symbol.asyncIterator](){return{async next(){return new Promise(()=>{})}}}},sink:async r=>new Promise(()=>{})}}function xI(r,e){return e.filter(n=>!!r.find(s=>me(n,s))).length===e.length}var yz=Object.values(on).map(r=>r.decoder).reduce((r,e)=>r.or(e));function bz(r){return Rn.decode(yz.decode(r))}function vI(r){if(!qw.matches(r))throw new b("Invalid multiaddr, was not a WebTransport address","ERR_INVALID_MULTIADDR");let e=r.stringTuples(),t=e.filter(([o,a])=>o===he("certhash").code).map(([o,a])=>bz(a??"")),n=e.filter(([o,a])=>o===he("p2p").code).map(([o,a])=>fe(a??""))[0],s=r.toOptions(),i=s.host;return s.family===6&&i?.includes(":")&&(i=`[${i}]`),{url:`https://${i}:${s.port}`,certhashes:t,remotePeer:n}}var nn=k("libp2p:webtransport"),J4=class{components;config;constructor(e,t={}){this.components=e,this.config={maxInboundStreams:t.maxInboundStreams??1e3}}[Symbol.toStringTag]="@libp2p/webtransport";[hs]=!0;async dial(e,t){t?.signal?.throwIfAborted(),nn("dialing %s",e);let n=this.components.peerId;if(n===void 0)throw new Error("Need a local peerid");t=t??{};let{url:s,certhashes:i,remotePeer:o}=vI(e);if(o==null)throw new Error("Need a target peerid");if(i.length===0)throw new Error("Expected multiaddr to contain certhashes");let a,c,l=()=>{};try{let u=!1,f=new WebTransport(`${s}/.well-known/libp2p-webtransport?type=noise`,{serverCertificateHashes:i.map(h=>({algorithm:"sha-256",value:h.digest}))});if(l=h=>{try{if(c!=null){if(c.timeline.close!=null)return;c.timeline.close=Date.now()}if(u)return;f.close(h)}catch(d){nn.error("error closing wt session",d)}finally{u=!0}},f.closed.then(async()=>{await c?.close()}).catch(h=>{nn.error("error on remote wt session close",h),c?.abort(h)}).finally(()=>{c==null&&l()}),a=()=>{a!=null&&t.signal?.removeEventListener("abort",a),l()},t.signal?.addEventListener("abort",a),await f.ready,!await this.authenticateWebTransport(f,n,o,i))throw new Error("Failed to authenticate webtransport");return c={close:async h=>{nn("Closing webtransport"),l()},abort:h=>{nn("aborting webtransport due to passed err",h),l({closeCode:0,reason:h.message})},remoteAddr:e,timeline:{open:Date.now()},...Z4()},t?.signal?.throwIfAborted(),await t.upgrader.upgradeOutbound(c,{skipEncryption:!0,muxerFactory:this.webtransportMuxer(f,l),skipProtection:!0})}catch(u){throw nn.error("caught wt session err",u),l({closeCode:0,reason:u.message}),u}finally{a!=null&&t.signal?.removeEventListener("abort",a)}}async authenticateWebTransport(e,t,n,s){let i=await e.createBidirectionalStream(),o=i.writable.getWriter(),a=i.readable.getReader();await o.ready;let c={source:async function*(){for(;;){let f=await a.read();if(f.value!=null&&(yield f.value),f.done)break}}(),sink:async function(f){for await(let h of f)await o.write(h)}},l=rc()(),{remoteExtensions:u}=await l.secureOutbound(t,c,n);if(o.close().catch(f=>{nn.error(`Failed to close authentication stream writer: ${f.message}`)}),a.cancel().catch(f=>{nn.error(`Failed to close authentication stream reader: ${f.message}`)}),!xI(u?.webtransportCerthashes??[],s.map(f=>f.bytes)))throw new Error("Our certhashes are not a subset of the remote's reported certhashes");return!0}webtransportMuxer(e,t){let n=0,s=this.config;return{protocol:"webtransport",createStreamMuxer:i=>{typeof i=="function"&&(i={onIncomingStream:i});let o=[];return async function(){let c=e.incomingBidirectionalStreams.getReader();for(;;){let{done:l,value:u}=await c.read();if(l)break;if(o.length>=s.maxInboundStreams)u.writable.close().catch(f=>{nn.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)}),u.readable.cancel().catch(f=>{nn.error(`Failed to close inbound stream that crossed our maxInboundStream limit: ${f.message}`)});else{let f=await j4(u,String(n++),"inbound",o,i?.onStreamEnd);o.push(f),i?.onIncomingStream?.(f)}}}().catch(()=>{nn.error("WebTransport failed to receive incoming stream")}),{protocol:"webtransport",streams:o,newStream:async c=>{let l=await e.createBidirectionalStream(),u=await j4(l,String(n++),i?.direction??"outbound",o,i?.onStreamEnd);return o.push(u),u},close:async c=>{nn("Closing webtransport muxer"),t()},abort:c=>{nn("Aborting webtransport muxer with err:",c),t({closeCode:0,reason:c.message})},...Z4()}}}}createListener(e){throw new Error("Webtransport servers are not supported in Node or the browser")}filter(e){return e.filter(t=>t.protoNames().includes("webtransport"))}};function _I(r={}){return e=>new J4(e,r)}var Br=re(Qo(),1);var kI=re(SI(),1);var RI="ERR_IPNS_EXPIRED_RECORD",Nd="ERR_UNRECOGNIZED_VALIDITY";var Qs="ERR_SIGNATURE_VERIFICATION",II="ERR_UNRECOGNIZED_FORMAT";var t8="ERR_UNDEFINED_PARAMETER",TI="ERR_INVALID_RECORD_DATA",AI="ERR_INVALID_VALUE",DI="ERR_INVALID_EMBEDDED_KEY";var CI="ERR_RECORD_TOO_LARGE";var Xs;(function(r){let e;(function(s){s.EOL="EOL"})(e=r.ValidityType||(r.ValidityType={}));let t;(function(s){s[s.EOL=0]="EOL"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.ValidityType||(r.ValidityType={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.value!=null&&(i.uint32(10),i.bytes(s.value)),s.signatureV1!=null&&(i.uint32(18),i.bytes(s.signatureV1)),s.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(s.validityType,i)),s.validity!=null&&(i.uint32(34),i.bytes(s.validity)),s.sequence!=null&&(i.uint32(40),i.uint64(s.sequence)),s.ttl!=null&&(i.uint32(48),i.uint64(s.ttl)),s.pubKey!=null&&(i.uint32(58),i.bytes(s.pubKey)),s.signatureV2!=null&&(i.uint32(66),i.bytes(s.signatureV2)),s.data!=null&&(i.uint32(74),i.bytes(s.data)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.value=s.bytes();break;case 2:o.signatureV1=s.bytes();break;case 3:o.validityType=r.ValidityType.codec().decode(s);break;case 4:o.validity=s.bytes();break;case 5:o.sequence=s.uint64();break;case 6:o.ttl=s.uint64();break;case 7:o.pubKey=s.bytes();break;case 8:o.signatureV2=s.bytes();break;case 9:o.data=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(Xs||(Xs={}));var r8=k("ipns:utils"),wz=Q("/ipns/"),Ez=114;function xz(r){let e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");let n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].padEnd(6,"0").slice(0,3),10);return new Date(Date.UTC(n,s,i,o,a,c,l))}var NI=async(r,e)=>{if(e==null||r==null){let n=new Error("one or more of the provided parameters are not defined");throw r8.error(n),(0,Br.default)(n,t8)}let t;if(e.pubKey!=null){try{t=kr(e.pubKey)}catch(s){throw r8.error(s),s}if(!(await cr(e.pubKey)).equals(r))throw(0,Br.default)(new Error("Embedded public key did not match PeerID"),DI)}else r.publicKey!=null&&(t=kr(r.publicKey));if(t!=null)return t;throw(0,Br.default)(new Error("no public key is available"),t8)};var OI=r=>{let e=Q("ipns-signature:");return _e([e,r])};function bu(r){let e=Xs.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw(0,Br.default)(new Error("missing data or signatureV2"),Qs);let t=BI(e.data),n=vz(t.Value),s;try{s=kI.default.fromDate(xz(W(t.Validity)))}catch{throw r8.error("unrecognized validity format (not an rfc3339 format)"),(0,Br.default)(new Error("unrecognized validity format (not an rfc3339 format)"),II)}if(e.value!=null&&e.signatureV1!=null)return _z(e),{value:n,validityType:Xs.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:Xs.ValidityType.EOL,validity:s,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}var LI=r=>ht(r.slice(wz.length));var BI=r=>{let e=fn(r);if(e.ValidityType===0)e.ValidityType=Xs.ValidityType.EOL;else throw(0,Br.default)(new Error("Unknown validity type"),Nd);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e},vz=r=>{if(r!=null){if(Da(r))return`/ipns/${r.toCID().toString(Js)}`;if(r instanceof Uint8Array){let n=W(r);n.startsWith("/")&&(r=n)}let e=r.toString().trim();if(e.startsWith("/")&&e.length>1)return e;let t=ge.asCID(r);if(t!=null)return t.code===Ez?`/ipns/${t.toString(Js)}`:`/ipfs/${t.toV1().toString()}`;try{return r instanceof Uint8Array?`/ipfs/${ge.decode(r).toV1().toString()}`:`/ipfs/${ge.parse(e).toV1().toString()}`}catch{}}throw(0,Br.default)(new Error("Value must be a valid content path starting with /"),AI)},_z=r=>{if(r.data==null)throw(0,Br.default)(new Error("Record data is missing"),TI);let e=BI(r.data);if(!me(e.Value,r.value??new Uint8Array(0)))throw(0,Br.default)(new Error('Field "value" did not match between protobuf and CBOR'),Qs);if(!me(e.Validity,r.validity??new Uint8Array(0)))throw(0,Br.default)(new Error('Field "validity" did not match between protobuf and CBOR'),Qs);if(e.ValidityType!==r.validityType)throw(0,Br.default)(new Error('Field "validityType" did not match between protobuf and CBOR'),Qs);if(e.Sequence!==r.sequence)throw(0,Br.default)(new Error('Field "sequence" did not match between protobuf and CBOR'),Qs);if(e.TTL!==r.ttl)throw(0,Br.default)(new Error('Field "ttl" did not match between protobuf and CBOR'),Qs)};function MI(r,e){let t=e.map((n,s)=>({record:bu(n),index:s}));return t.sort((n,s)=>{let i=n.record.sequence,o=s.record.sequence;if(i>o)return-1;if(i<o)return 1;let a=n.record.validity.toDate(),c=s.record.validity.toDate();return a.getTime()>c.getTime()?-1:a.getTime()<c.getTime()?1:0}),t[0].index}var wu=re(Qo(),1);var Od=k("ipns:validator"),Sz=1024*10,Rz=async(r,e)=>{let t=bu(e),n;try{let s=OI(t.data);n=await r.verify(s,t.signatureV2)}catch{n=!1}if(!n)throw Od.error("record signature verification failed"),(0,wu.default)(new Error("record signature verification failed"),Qs);if(t.validityType===Xs.ValidityType.EOL){if(t.validity.toDate().getTime()<Date.now())throw Od.error("record has expired"),(0,wu.default)(new Error("record has expired"),RI)}else if(t.validityType!=null)throw Od.error("unrecognized validity type"),(0,wu.default)(new Error("unrecognized validity type"),Nd);Od("ipns record for %b is valid",t.value)};async function UI(r,e){if(e.byteLength>Sz)throw(0,wu.default)(new Error("record too large"),CI);let t=LI(r),n=bu(e),s=await NI(t,n);await Rz(s,e)}var s8=re(Dr(),1);var FI="libp2p",KI="autonat",VI="1.0.0";var Te;(function(r){let e;(function(l){l.DIAL="DIAL",l.DIAL_RESPONSE="DIAL_RESPONSE"})(e=r.MessageType||(r.MessageType={}));let t;(function(l){l[l.DIAL=0]="DIAL",l[l.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(t||(t={})),function(l){l.codec=()=>lt(t)}(e=r.MessageType||(r.MessageType={}));let n;(function(l){l.OK="OK",l.E_DIAL_ERROR="E_DIAL_ERROR",l.E_DIAL_REFUSED="E_DIAL_REFUSED",l.E_BAD_REQUEST="E_BAD_REQUEST",l.E_INTERNAL_ERROR="E_INTERNAL_ERROR"})(n=r.ResponseStatus||(r.ResponseStatus={}));let s;(function(l){l[l.OK=0]="OK",l[l.E_DIAL_ERROR=100]="E_DIAL_ERROR",l[l.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",l[l.E_BAD_REQUEST=200]="E_BAD_REQUEST",l[l.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(s||(s={})),function(l){l.codec=()=>lt(s)}(n=r.ResponseStatus||(r.ResponseStatus={}));let i;(function(l){let u;l.codec=()=>(u==null&&(u=le((f,h,d={})=>{if(d.lengthDelimited!==!1&&h.fork(),f.id!=null&&(h.uint32(10),h.bytes(f.id)),f.addrs!=null)for(let p of f.addrs)h.uint32(18),h.bytes(p);d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={addrs:[]},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.id=f.bytes();break;case 2:d.addrs.push(f.bytes());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ce(f,l.codec()),l.decode=f=>ae(f,l.codec())})(i=r.PeerInfo||(r.PeerInfo={}));let o;(function(l){let u;l.codec=()=>(u==null&&(u=le((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.peer!=null&&(h.uint32(10),r.PeerInfo.codec().encode(f.peer,h)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.peer=r.PeerInfo.codec().decode(f,f.uint32());break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ce(f,l.codec()),l.decode=f=>ae(f,l.codec())})(o=r.Dial||(r.Dial={}));let a;(function(l){let u;l.codec=()=>(u==null&&(u=le((f,h,d={})=>{d.lengthDelimited!==!1&&h.fork(),f.status!=null&&(h.uint32(8),r.ResponseStatus.codec().encode(f.status,h)),f.statusText!=null&&(h.uint32(18),h.string(f.statusText)),f.addr!=null&&(h.uint32(26),h.bytes(f.addr)),d.lengthDelimited!==!1&&h.ldelim()},(f,h)=>{let d={},p=h==null?f.len:f.pos+h;for(;f.pos<p;){let m=f.uint32();switch(m>>>3){case 1:d.status=r.ResponseStatus.codec().decode(f);break;case 2:d.statusText=f.string();break;case 3:d.addr=f.bytes();break;default:f.skipType(m&7);break}}return d})),u),l.encode=f=>ce(f,l.codec()),l.decode=f=>ae(f,l.codec())})(a=r.DialResponse||(r.DialResponse={}));let c;r.codec=()=>(c==null&&(c=le((l,u,f={})=>{f.lengthDelimited!==!1&&u.fork(),l.type!=null&&(u.uint32(8),r.MessageType.codec().encode(l.type,u)),l.dial!=null&&(u.uint32(18),r.Dial.codec().encode(l.dial,u)),l.dialResponse!=null&&(u.uint32(26),r.DialResponse.codec().encode(l.dialResponse,u)),f.lengthDelimited!==!1&&u.ldelim()},(l,u)=>{let f={},h=u==null?l.len:l.pos+u;for(;l.pos<h;){let d=l.uint32();switch(d>>>3){case 1:f.type=r.MessageType.codec().decode(l);break;case 2:f.dial=r.Dial.codec().decode(l,l.uint32());break;case 3:f.dialResponse=r.DialResponse.codec().decode(l,l.uint32());break;default:l.skipType(d&7);break}}return f})),c),r.encode=l=>ce(l,r.codec()),r.decode=l=>ae(l,r.codec())})(Te||(Te={}));var qe=k("libp2p:autonat"),n8=4,i8=class{components;startupDelay;refreshInterval;protocol;timeout;maxInboundStreams;maxOutboundStreams;verifyAddressTimeout;started;constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??FI}/${KI}/${VI}`,this.timeout=t.timeout??3e4,this.maxInboundStreams=t.maxInboundStreams??1,this.maxOutboundStreams=t.maxOutboundStreams??1,this.startupDelay=t.startupDelay??5e3,this.refreshInterval=t.refreshInterval??6e4,this._verifyExternalAddresses=this._verifyExternalAddresses.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{qe.error("error handling incoming autonat stream",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.startupDelay),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),clearTimeout(this.verifyAddressTimeout),this.started=!1}async handleIncomingAutonatStream(e){let t=AbortSignal.timeout(this.timeout),n=()=>{e.stream.abort(new b("handleIncomingAutonatStream timeout",H.ERR_TIMEOUT))};t.addEventListener("abort",n,{once:!0});try{(0,s8.setMaxListeners)?.(1/0,t)}catch{}let s=this.components.addressManager.getAddresses().map(i=>i.toOptions().host);try{let i=this;await Ie(e.stream,o=>Ct(o),async function*(o){let a=await Hn(o);if(a==null){qe("no message received"),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"No message was sent"}});return}let c;try{c=Te.decode(a)}catch(m){qe.error("could not decode message",m),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"Could not decode message"}});return}let l=c.dial;if(l==null){qe.error("dial was missing from message"),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}});return}let u,f=l.peer;if(f==null||f.id==null){qe.error("PeerId missing from message"),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}});return}try{u=ht(f.id)}catch(m){qe.error("invalid PeerId",m),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}});return}if(qe("incoming request from %p",u),!e.connection.remotePeer.equals(u)){qe("target peer %p did not equal sending peer %p",u,e.connection.remotePeer),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}});return}let h=f.addrs.map(m=>oe(m)).filter(m=>{let g=m.toOptions().host===e.connection.remoteAddr.toOptions().host;return qe.trace("request to dial %a was sent from %a is same host %s",m,e.connection.remoteAddr,g),g}).filter(m=>{let g=m.toOptions().host,y=!(Nr(g)??!1);return qe.trace("host %s was public %s",g,y),y}).filter(m=>{let g=m.toOptions().host,y=!s.includes(g);return qe.trace("host %s was not our host %s",g,y),y}).filter(m=>{let g=!!i.components.transportManager.transportForMultiaddr(m);return qe.trace("transport for %a is supported %s",m,g),g}).map(m=>(m.getPeerId()==null&&(m=m.encapsulate(`/p2p/${u.toString()}`)),m));if(h.length===0){qe("no valid multiaddrs for %p in message",u),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}});return}qe("dial multiaddrs %s for peer %p",h.map(m=>m.toString()).join(", "),u);let d="",p=h[0];for await(let m of h){let g;p=m;try{if(g=await i.components.connectionManager.openConnection(m,{signal:t}),!g.remoteAddr.equals(m))throw qe.error("tried to dial %a but dialed %a",m,g.remoteAddr),new Error("Unexpected remote address");qe("Success %p",u),yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.OK,addr:g.remoteAddr.decapsulateCode(he("p2p").code).bytes}});return}catch(y){qe("could not dial %p",u,y),d=y.message}finally{g!=null&&await g.close()}}yield Te.encode({type:Te.MessageType.DIAL_RESPONSE,dialResponse:{status:Te.ResponseStatus.E_DIAL_ERROR,statusText:d,addr:p.bytes}})},o=>_t(o),e.stream)}catch(i){qe.error("error handling incoming autonat stream",i)}finally{t.removeEventListener("abort",n)}}_verifyExternalAddresses(){this.verifyExternalAddresses().catch(e=>{qe.error("error verifying external address",e)})}async verifyExternalAddresses(){if(clearTimeout(this.verifyAddressTimeout),!this.isStarted())return;let e=this.components.addressManager,t=e.getObservedAddrs().filter(i=>{let o=i.toOptions();return!(Nr(o.host)??!1)});if(t.length===0){qe("no public addresses found, not requesting verification"),this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval);return}let n=AbortSignal.timeout(this.timeout);try{(0,s8.setMaxListeners)?.(1/0,n)}catch{}let s=this;try{qe("verify multiaddrs %s",t.map(f=>f.toString()).join(", "));let i=Te.encode({type:Te.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toBytes(),addrs:t.map(f=>f.bytes)}}}),a=(await wf()).toBytes(),c={},l=[],u=async f=>{let h=()=>{};try{qe("asking %p to verify multiaddr",f.id);let d=await s.components.connectionManager.openConnection(f.id,{signal:n}),p=await d.newStream(this.protocol,{signal:n});h=()=>{p.abort(new b("verifyAddress timeout",H.ERR_TIMEOUT))},n.addEventListener("abort",h,{once:!0});let m=await Ie([i],y=>_t(y),p,y=>Ct(y),async y=>Hn(y));if(m==null){qe("no response received from %p",d.remotePeer);return}let g=Te.decode(m);if(g.type!==Te.MessageType.DIAL_RESPONSE||g.dialResponse==null){qe("invalid autonat response from %p",d.remotePeer);return}if(g.dialResponse.status===Te.ResponseStatus.OK){let y=d.remoteAddr.toOptions(),w;if(y.family===4)w=y.host.split(".")[0];else if(y.family===6)w=y.host.split(":")[0];else{qe('remote address "%s" was not IP4 or IP6?',y.host);return}if(l.includes(w)){qe("already have response from network segment %d - %s",w,y.host);return}l.push(w)}return g.dialResponse}catch(d){qe.error("error asking remote to verify multiaddr",d)}finally{n.removeEventListener("abort",h)}};for await(let f of Uo(In(this.components.peerRouting.getClosestPeers(a,{signal:n}),h=>async()=>u(h)),{concurrency:n8}))try{if(f==null)continue;let h=f.addr==null?t[0]:oe(f.addr);if(qe("autonat response for %a is %s",h,f.status),f.status===Te.ResponseStatus.E_BAD_REQUEST||f.status===Te.ResponseStatus.E_DIAL_REFUSED||f.addr==null&&t.length>1)continue;if(!t.some(p=>p.equals(h))){qe("peer reported %a as %s but it was not in our observed address list",h,f.status);continue}let d=h.toString();if(c[d]==null&&(c[d]={success:0,failure:0}),f.status===Te.ResponseStatus.OK?c[d].success++:f.status===Te.ResponseStatus.E_DIAL_ERROR&&c[d].failure++,c[d].success===n8){qe("%a is externally dialable",h),e.confirmObservedAddr(h);return}if(c[d].failure===n8){qe("%a is not externally dialable",h),e.removeObservedAddr(h);return}}catch(h){qe.error("could not verify external address",h)}}finally{this.verifyAddressTimeout=setTimeout(this._verifyExternalAddresses,this.refreshInterval)}}};function qI(r={}){return e=>new i8(e,r)}var Bz=re(Dr(),1);var o8="/libp2p/relay";var zI="circuit-relay-relay";var $I=BigInt(131072),Vi="/libp2p/circuit/relay/0.2.0/hop",Ld="/libp2p/circuit/relay/0.2.0/stop",Pz=30*1e3,kz=30*1e3;var js;(function(r){let e;(function(s){s.RESERVE="RESERVE",s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.RESERVE=0]="RESERVE",s[s.CONNECT=1]="CONNECT",s[s.STATUS=2]="STATUS"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.peer!=null&&(i.uint32(18),_c.codec().encode(s.peer,i)),s.reservation!=null&&(i.uint32(26),Bd.codec().encode(s.reservation,i)),s.limit!=null&&(i.uint32(34),Sc.codec().encode(s.limit,i)),s.status!=null&&(i.uint32(40),Ut.codec().encode(s.status,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.peer=_c.codec().decode(s,s.uint32());break;case 3:o.reservation=Bd.codec().decode(s,s.uint32());break;case 4:o.limit=Sc.codec().decode(s,s.uint32());break;case 5:o.status=Ut.codec().decode(s);break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(js||(js={}));var Xn;(function(r){let e;(function(s){s.CONNECT="CONNECT",s.STATUS="STATUS"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.CONNECT=0]="CONNECT",s[s.STATUS=1]="STATUS"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.peer!=null&&(i.uint32(18),_c.codec().encode(s.peer,i)),s.limit!=null&&(i.uint32(26),Sc.codec().encode(s.limit,i)),s.status!=null&&(i.uint32(32),Ut.codec().encode(s.status,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.peer=_c.codec().decode(s,s.uint32());break;case 3:o.limit=Sc.codec().decode(s,s.uint32());break;case 4:o.status=Ut.codec().decode(s);break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(Xn||(Xn={}));var _c;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={id:new Uint8Array(0),addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.id=t.bytes();break;case 2:s.addrs.push(t.bytes());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(_c||(_c={}));var Bd;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(let i of t.addrs)n.uint32(18),n.bytes(i);t.voucher!=null&&(n.uint32(26),n.bytes(t.voucher)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={expire:0n,addrs:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.expire=t.uint64();break;case 2:s.addrs.push(t.bytes());break;case 3:s.voucher=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Bd||(Bd={}));var Sc;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.duration=t.uint32();break;case 2:s.data=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(Sc||(Sc={}));var Ut;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(Ut||(Ut={}));var a8;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(a8||(a8={}));(function(r){r.codec=()=>lt(a8)})(Ut||(Ut={}));var c8;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 1:s.relay=t.bytes();break;case 2:s.peer=t.bytes();break;case 3:s.expiration=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(c8||(c8={}));var h6e=k("libp2p:circuit-relay:utils");async function l8(r){let e=new TextEncoder().encode(r),t=await Ne.digest(e);return ge.createV0(t)}function u8(r){let e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}var Lz=re(QI(),1);var R6e=k("libp2p:circuit-relay:advert-service");var tye=k("libp2p:circuit-relay:server");var Mz=k("libp2p:stream:converter");function f8(r){let{stream:e,remoteAddr:t}=r,{sink:n,source:s}=e,i=async function*(){for await(let c of s)c instanceof Uint8Array?yield c:yield*c}(),o={async sink(c){try{await n(c),a()}catch(l){l.type!=="aborted"&&Mz(l)}},source:i,remoteAddr:t,timeline:{open:Date.now(),close:void 0},async close(c){a(),await e.close(c)},abort(c){a(),e.abort(c)}};function a(){o.timeline.close==null&&(o.timeline.close=Date.now())}return o}var qi=k("libp2p:circuit-relay:discover-relays"),Md=class extends Ue{peerId;peerStore;contentRouting;registrar;started;topologyId;constructor(e){super(),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(Vi,{onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.discover().catch(e=>{qi.error("error listening on relays",e)}),this.started=!0}stop(){this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){qi("searching peer store for relays");let e=await this.peerStore.all({filters:[t=>t.protocols.includes(Vi)],orders:[()=>Math.random()<.5?1:-1]});for(let t of e)qi("found relay peer %p in content peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});qi("found %d relay peers in peer store",e.length);try{qi("searching content routing for relays");let t=await l8(o8),n=0;for await(let s of this.contentRouting.findProviders(t))if(s.multiaddrs.length>0&&!s.id.equals(this.peerId)){let i=s.id;n++,await this.peerStore.merge(i,{multiaddrs:s.multiaddrs}),qi("found relay peer %p in content routing",i),this.safeDispatchEvent("relay:discover",{detail:i})}qi("found %d relay peers in content routing",n)}catch(t){qi.error("failed when finding relays on the network",t)}}};var h8=k("libp2p:circuit-relay:transport:listener"),d8=class extends Ue{connectionManager;relayStore;listeningAddrs;constructor(e){super(),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new lr,this.relayStore.addEventListener("relay:removed",t=>{this.#e(t.detail)})}async listen(e){h8("listen on %a",e);let t=e.getPeerId(),n;if(t!=null){let i=fe(t),o=this.connectionManager.getConnectionsMap().get(i)??[];o.length>0&&(n=o[0])}if(n==null){let i=e.toString().split("/p2p-circuit").find(a=>a!==""),o=oe(i);n=await this.connectionManager.openConnection(o)}if(!this.relayStore.hasReservation(n.remotePeer)){await this.relayStore.addRelay(n.remotePeer,"configured");return}let s=this.relayStore.getReservation(n.remotePeer);if(s==null)throw new b("Did not have reservation after making reservation","ERR_NO_RESERVATION");if(this.listeningAddrs.has(n.remotePeer)){h8("already listening on relay %p",n.remotePeer);return}this.listeningAddrs.set(n.remotePeer,s.addrs.map(i=>oe(i).encapsulate("/p2p-circuit"))),this.safeDispatchEvent("listening",{})}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}#e(e){let t=this.listeningAddrs.has(e);h8("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&this.safeDispatchEvent("close",{})}};function jI(r){return new d8(r)}var Ir=k("libp2p:circuit-relay:transport:reservation-store"),Fz=60*1e3*10,Kz=60*1e3*5,Vz=30*1e3,Ud=class extends Ue{peerId;connectionManager;transportManager;peerStore;events;reserveQueue;reservations;maxDiscoveredRelays;maxReservationQueueLength;reservationCompletionTimeout;started;constructor(e,t){super(),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new lr,this.maxDiscoveredRelays=t?.discoverRelays??0,this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??1e4,this.started=!1,this.reserveQueue=new $a({concurrency:t?.reservationConcurrency??1}),this.events.addEventListener("peer:disconnect",n=>{this.#t(n.detail)})}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}async addRelay(e,t){if(this.peerId.equals(e)){Ir("not trying to use self as relay");return}if(this.reserveQueue.size>this.maxReservationQueueLength){Ir("not adding relay as the queue is full");return}if(this.reserveQueue.hasJob(e)){Ir("relay peer is already in the reservation queue");return}Ir("add relay %p",e),await this.reserveQueue.add(async()=>{try{let n=this.reservations.get(e);if(n!=null){if(u8(n.reservation.expire)>Fz){Ir("already have reservation on relay peer %p and it expires in more than 10 minutes",e);return}clearTimeout(n.timeout),this.reservations.delete(e)}if(t==="discovered"&&[...this.reservations.values()].reduce((u,f)=>(f.type==="discovered"&&u++,u),0)>=this.maxDiscoveredRelays){Ir("already have enough discovered relays");return}let s=AbortSignal.timeout(this.reservationCompletionTimeout),i=await this.connectionManager.openConnection(e,{signal:s});if(i.remoteAddr.protoNames().includes("p2p-circuit")){Ir("not creating reservation over relayed connection");return}let o=await this.#e(i,{signal:s});Ir("created reservation on relay peer %p",e);let a=u8(o.expire),c=Math.min(Math.max(a-Kz,Vz),Math.pow(2,31)-1),l=setTimeout(()=>{this.addRelay(e,t).catch(u=>{Ir.error("could not refresh reservation to relay %p",e,u)})},c);this.reservations.set(e,{timeout:l,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{[zI]:{value:1,ttl:a}}}),await this.transportManager.listen([oe(`/p2p/${e.toString()}/p2p-circuit`)])}catch(n){Ir.error("could not reserve slot on %p",e,n);let s=this.reservations.get(e);s!=null&&clearTimeout(s.timeout),this.reservations.delete(e)}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}async#e(e,t){t.signal?.throwIfAborted(),Ir("requesting reservation from %p",e.remotePeer);let n=await e.newStream(Vi,t),i=rr(n).pb(js);await i.write({type:js.Type.RESERVE},t);let o;try{o=await i.read(t)}catch(c){throw Ir.error("error parsing reserve message response from %p because",e.remotePeer,c),c}finally{await n.close()}if(o.status===Ut.OK&&o.reservation!=null)return o.reservation;let a=`reservation failed with status ${o.status??"undefined"}`;throw Ir.error(a),new Error(a)}#t(e){let t=this.reservations.get(e);t!=null&&(Ir("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(Ir("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}};var dr=k("libp2p:circuit-relay:transport"),qz=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(oe)}catch{return!1}return!0},p8={maxInboundStopStreams:Ti,maxOutboundStopStreams:Ti,stopTimeout:3e4},m8=class{discovery;registrar;peerStore;connectionManager;peerId;upgrader;addressManager;connectionGater;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;stopTimeout;started;constructor(e,t){this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??p8.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??p8.maxOutboundStopStreams,this.stopTimeout=t.stopTimeout??p8.stopTimeout,t.discoverRelays!=null&&t.discoverRelays>0&&(this.discovery=new Md(e),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(s=>{dr.error("could not add discovered relay %p",n.detail,s)})})),this.reservationStore=new Ud(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.discover().catch(n=>{dr.error("could not discover relays",n)})}),this.started=!1}isStarted(){return this.started}async start(){await this.reservationStore.start(),await this.discovery?.start(),await this.registrar.handle(Ld,e=>{this.onStop(e).catch(t=>{dr.error("error while handling STOP protocol",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),this.started=!0}async stop(){this.discovery?.stop(),await this.reservationStore.stop(),await this.registrar.unhandle(Ld),this.started=!1}[hs]=!0;[Symbol.toStringTag]="libp2p/circuit-relay-v2";async dial(e,t={}){if(e.protoCodes().filter(p=>p===290).length!==1){let p="Invalid circuit relay address";throw dr.error(p,e),new b(p,H.ERR_RELAYED_DIAL)}let n=e.toString().split("/p2p-circuit"),s=oe(n[0]),i=oe(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){let p=`Circuit relay dial to ${e.toString()} failed as address did not have peer ids`;throw dr.error(p),new b(p,H.ERR_RELAYED_DIAL)}let c=fe(o),l=fe(a),u=!1,h=this.connectionManager.getConnections(c)[0];h==null&&(await this.peerStore.merge(c,{multiaddrs:[s]}),h=await this.connectionManager.openConnection(c,t),u=!0);let d;try{return d=await h.newStream([Vi]),await this.connectV2({stream:d,connection:h,destinationPeer:l,destinationAddr:i,relayAddr:s,ma:e,disconnectOnFailure:u})}catch(p){throw dr.error(`Circuit relay dial to destination ${l.toString()} via relay ${c.toString()} failed`,p),d?.abort(p),u&&await h.close(),p}}async connectV2({stream:e,connection:t,destinationPeer:n,destinationAddr:s,relayAddr:i,ma:o,disconnectOnFailure:a}){try{let c=rr(e),l=c.pb(js);await l.write({type:js.Type.CONNECT,peer:{id:n.toBytes(),addrs:[oe(s).bytes]}});let u=await l.read();if(u.status!==Ut.OK)throw new b(`failed to connect via relay with status ${u?.status?.toString()??"undefined"}`,H.ERR_HOP_REQUEST_FAILED);let f=f8({stream:c.unwrap(),remoteAddr:o,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`)});return dr("new outbound transient connection %a",f.remoteAddr),await this.upgrader.upgradeOutbound(f,{transient:!0})}catch(c){throw dr.error(`Circuit relay dial to destination ${n.toString()} via relay ${t.remotePeer.toString()} failed`,c),a&&await t.close(),c}}createListener(e){return jI({connectionManager:this.connectionManager,relayStore:this.reservationStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Gn.matches(t))}async onStop({connection:e,stream:t}){let n=AbortSignal.timeout(this.stopTimeout),s=rr(t).pb(Xn),i=await s.read({signal:n});if(dr("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){dr.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:Xn.Type.STATUS,status:Ut.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(i.type!==Xn.Type.CONNECT){dr.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Xn.Type.STATUS,status:Ut.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!qz(i)){dr.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:Xn.Type.STATUS,status:Ut.MALFORMED_MESSAGE},{signal:n}),await t.close();return}let o=ht(i.peer.id);if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,o)===!0){dr.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:Xn.Type.STATUS,status:Ut.PERMISSION_DENIED},{signal:n}),await t.close();return}dr.trace("sending success response to %p",e.remotePeer),await s.write({type:Xn.Type.STATUS,status:Ut.OK},{signal:n});let a=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`),c=this.addressManager.getAddresses()[0],l=f8({stream:s.unwrap().unwrap(),remoteAddr:a,localAddr:c});dr("new inbound transient connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{transient:!0}),dr("%s connection %a upgraded","inbound",l.remoteAddr)}};function g8(r={}){return e=>new m8(e,r)}var ZI=()=>{let r=new Error("Delay aborted");return r.name="AbortError",r},zz=new WeakMap;function $z({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(ZI());let i,o,a,c=r??clearTimeout,l=()=>{c(i),a(ZI())},u=()=>{s&&s.removeEventListener("abort",l)},f=new Promise((h,d)=>{o=()=>{u(),h(n)},a=d,i=(e??setTimeout)(o,t)});return s&&s.addEventListener("abort",l,{once:!0}),zz.set(f,()=>{c(i),i=null,o()}),f}}var Hz=$z(),JI=Hz;var jn;(function(r){let e;(function(s){s.UNUSED="UNUSED",s.CONNECT="CONNECT",s.SYNC="SYNC"})(e=r.Type||(r.Type={}));let t;(function(s){s[s.UNUSED=0]="UNUSED",s[s.CONNECT=100]="CONNECT",s[s.SYNC=300]="SYNC"})(t||(t={})),function(s){s.codec=()=>lt(t)}(e=r.Type||(r.Type={}));let n;r.codec=()=>(n==null&&(n=le((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.observedAddresses!=null)for(let a of s.observedAddresses)i.uint32(18),i.bytes(a);o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{let o={observedAddresses:[]},a=i==null?s.len:s.pos+i;for(;s.pos<a;){let c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.observedAddresses.push(s.bytes());break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>ce(s,r.codec()),r.decode=s=>ae(s,r.codec())})(jn||(jn={}));var pt=k("libp2p:dcutr"),eT=1024*4,tT=100,Fd={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1},Kd=class{started;timeout;retries;maxInboundStreams;maxOutboundStreams;peerStore;registrar;connectionManager;addressManager;transportManager;topologyId;constructor(e,t){this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??Fd.timeout,this.retries=t.retries??Fd.retries,this.maxInboundStreams=t.maxInboundStreams??Fd.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Fd.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(Eu,{onConnect:(e,t)=>{t.transient&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{pt.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(Eu,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{pt.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(Eu),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){let s={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([Eu],{signal:s.signal,runOnTransientConnection:!0});let i=rr(t,{maxDataLength:eT}).pb(jn);pt("B sending connect to %p",e.remotePeer);let o=Date.now();await i.write({type:jn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(f=>f.bytes)},s),pt("B receiving connect from %p",e.remotePeer);let a=await i.read(s);if(a.type!==jn.Type.CONNECT)throw pt("A sent wrong message type"),new b("DCUtR message type was incorrect",H.ERR_INVALID_MESSAGE);let c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw pt("A did not have any dialable multiaddrs"),new b("DCUtR connect message had no multiaddrs",H.ERR_INVALID_MESSAGE);let l=Date.now()-o;pt("A sending sync, rtt %dms",l),await i.write({type:jn.Type.SYNC,observedAddresses:[]},s),pt("A waiting for half RTT"),await JI(l/2),pt("B dialing",c);let u=await this.connectionManager.openConnection(c,{signal:s.signal,priority:tT});pt("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,u.remoteAddr),await e.close(s);break}catch(i){if(pt.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,i),t?.abort(i),n===this.retries)throw i}finally{t!=null&&await t.close(s)}}}async attemptUnilateralConnectionUpgrade(e){let n=(await this.peerStore.get(e.remotePeer)).addresses.map(s=>{let i=s.multiaddr;return i.getPeerId()==null?i.encapsulate(`/p2p/${e.remotePeer}`):i}).filter(s=>this.isPublicAndDialable(s));if(n.length>0){let s=AbortSignal.timeout(this.timeout);try{pt("attempting unilateral connection upgrade to %a",n);let i=await this.connectionManager.openConnection(n,{signal:s,force:!0});if(i.transient)throw new Error("Could not open a new, non-transient, connection");return pt("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,i.remoteAddr),await e.close(),!0}catch(i){pt.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,i)}}else pt("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){let n={signal:AbortSignal.timeout(this.timeout)};try{let s=rr(e,{maxDataLength:eT}).pb(jn);pt("A receiving connect");let i=await s.read(n);if(i.type!==jn.Type.CONNECT)throw pt("B sent wrong message type"),new b("DCUtR message type was incorrect",H.ERR_INVALID_MESSAGE);if(i.observedAddresses.length===0)throw pt("B sent no multiaddrs"),new b("DCUtR connect message had no multiaddrs",H.ERR_INVALID_MESSAGE);let o=this.getDialableMultiaddrs(i.observedAddresses);if(o.length===0)throw pt("B had no dialable multiaddrs"),new b("DCUtR connect message had no dialable multiaddrs",H.ERR_INVALID_MESSAGE);if(pt("A sending connect"),await s.write({type:jn.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),pt("A receiving sync"),(await s.read(n)).type!==jn.Type.SYNC)throw new b("DCUtR message type was incorrect",H.ERR_INVALID_MESSAGE);pt("A dialing",o);let c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:tT,force:!0});pt("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(s){pt.error("incoming DCUtR from %p failed",t.remotePeer,s),e.abort(s)}finally{await e.close(n)}}getDialableMultiaddrs(e){let t=[];for(let n of e)if(!(n==null||n.length===0))try{let s=oe(n);if(!this.isPublicAndDialable(s))continue;t.push(s)}catch{}return t}isPublicAndDialable(e){if(Nl.matches(e))return!1;if(Nw.matches(e))return!0;if(!Mw.matches(e)||this.transportManager.transportForMultiaddr(e)==null)return!1;let n=e.toOptions();return Nr(n.host)===!1}};var Eu="/libp2p/dcutr";function rT(r={}){return e=>new Kd(e,r)}var nT="0.46.11";var y8=`js-libp2p/${nT}`;var sT="0.1.0",iT="id",oT="id/push",aT="1.0.0",cT="1.0.0";var w8=re(Dr(),1);var zi;(function(r){let e;r.codec=()=>(e==null&&(e=le((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(let i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(let i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{let s={listenAddrs:[],protocols:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){let o=t.uint32();switch(o>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>ce(t,r.codec()),r.decode=t=>ae(t,r.codec())})(zi||(zi={}));var pr=k("libp2p:identify"),b8=1024*8,sn={protocolPrefix:"ipfs",agentVersion:y8,timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1,maxObservedAddresses:10,maxIdentifyMessageSize:8192,runOnConnectionOpen:!0,runOnTransientConnection:!0},Vd=class{identifyProtocolStr;identifyPushProtocolStr;host;started;timeout;peerId;peerStore;registrar;connectionManager;addressManager;maxInboundStreams;maxOutboundStreams;maxPushIncomingStreams;maxPushOutgoingStreams;maxIdentifyMessageSize;maxObservedAddresses;events;runOnTransientConnection;constructor(e,t){this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.identifyProtocolStr=`/${t.protocolPrefix??sn.protocolPrefix}/${iT}/${aT}`,this.identifyPushProtocolStr=`/${t.protocolPrefix??sn.protocolPrefix}/${oT}/${cT}`,this.timeout=t.timeout??sn.timeout,this.maxInboundStreams=t.maxInboundStreams??sn.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??sn.maxOutboundStreams,this.maxPushIncomingStreams=t.maxPushIncomingStreams??sn.maxPushIncomingStreams,this.maxPushOutgoingStreams=t.maxPushOutgoingStreams??sn.maxPushOutgoingStreams,this.maxIdentifyMessageSize=t.maxIdentifyMessageSize??sn.maxIdentifyMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??sn.maxObservedAddresses,this.runOnTransientConnection=t.runOnTransientConnection??sn.runOnTransientConnection,this.host={protocolVersion:`${t.protocolPrefix??sn.protocolPrefix}/${sT}`,agentVersion:t.agentVersion??sn.agentVersion},(t.runOnConnectionOpen??sn.runOnConnectionOpen)&&e.events.addEventListener("connection:open",n=>{let s=n.detail;this.identify(s).catch(i=>{pr.error("error during identify trigged by connection:open",i)})}),e.events.addEventListener("self:peer:update",n=>{this.push().catch(s=>{pr.error(s)})}),this.host.agentVersion===y8&&(hI||uI?this.host.agentVersion+=` UserAgent=${globalThis.process.version}`:(Pd||kd||fI||dI)&&(this.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:Q(this.host.agentVersion),ProtocolVersion:Q(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{pr.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{pr.error(t)})},{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){let t=this.addressManager.getAddresses().map(u=>u.decapsulateCode(he("p2p").code)),n=new Qr({peerId:this.peerId,multiaddrs:t}),s=await yn.seal(n,this.peerId),i=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=W(o.metadata.get("AgentVersion")??Q(this.host.agentVersion)),c=W(o.metadata.get("ProtocolVersion")??Q(this.host.protocolVersion)),l=e.map(async u=>{let f,h=AbortSignal.timeout(this.timeout);try{(0,w8.setMaxListeners)?.(1/0,h)}catch{}try{f=await u.newStream([this.identifyPushProtocolStr],{signal:h,runOnTransientConnection:this.runOnTransientConnection}),await rr(f,{maxDataLength:this.maxIdentifyMessageSize??b8}).pb(zi).write({listenAddrs:t.map(p=>p.bytes),signedPeerRecord:s.marshal(),protocols:i,agentVersion:a,protocolVersion:c},{signal:h}),await f.close({signal:h})}catch(d){pr.error("could not push identify update to peer",d),f?.abort(d)}});await Promise.all(l)}async push(){if(!this.isStarted())return;let e=[];await Promise.all(this.connectionManager.getConnections().map(async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==H.ERR_NOT_FOUND)throw n}})),await this.pushToConnections(e)}async _identify(e,t={}){let n;t.signal=t.signal??AbortSignal.timeout(this.timeout);try{n=await e.newStream([this.identifyProtocolStr],{...t,runOnTransientConnection:this.runOnTransientConnection});let i=await rr(n,{maxDataLength:this.maxIdentifyMessageSize??b8}).pb(zi).read(t);return await n.close(t),i}catch(s){throw pr.error("error while reading identify message",s),n?.abort(s),s}}async identify(e,t={}){let n=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:o}=n;if(s==null)throw new b("public key was missing from identify message",H.ERR_MISSING_PUBLIC_KEY);let a=await cr(s);if(!e.remotePeer.equals(a))throw new b("identified peer does not match the expected peer",H.ERR_INVALID_PEER);if(this.peerId.equals(a))throw new b("identified peer is our own peer id?",H.ERR_INVALID_PEER);let c=Wz(o);pr("identify completed for peer %p and protocols %o",a,i),pr("our observed address is %a",c),c!=null&&this.addressManager.getObservedAddrs().length<(this.maxObservedAddresses??1/0)&&(pr("storing our observed address %a",c),this.addressManager.addObservedAddr(c));let l=await this.#e(e.remotePeer,n),u={peerId:a,protocolVersion:n.protocolVersion,agentVersion:n.agentVersion,publicKey:n.publicKey,listenAddrs:n.listenAddrs.map(f=>oe(f)),observedAddr:n.observedAddr==null?void 0:oe(n.observedAddr),protocols:n.protocols,signedPeerRecord:l};return this.events.safeDispatchEvent("peer:identify",{detail:u}),u}async _handleIdentify(e){let{connection:t,stream:n}=e,s=AbortSignal.timeout(this.timeout);try{(0,w8.setMaxListeners)?.(1/0,s)}catch{}try{let i=this.peerId.publicKey??new Uint8Array(0),o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(u=>u.decapsulateCode(he("p2p").code)),c=o.peerRecordEnvelope;if(a.length>0&&c==null){let u=new Qr({peerId:this.peerId,multiaddrs:a});c=(await yn.seal(u,this.peerId)).marshal().subarray()}await rr(n).pb(zi).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:i,listenAddrs:a.map(u=>u.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols},{signal:s}),await n.close({signal:s})}catch(i){pr.error("could not respond to identify request",i),n.abort(i)}}async _handlePush(e){let{connection:t,stream:n}=e;try{if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");let s={signal:AbortSignal.timeout(this.timeout)},o=await rr(n,{maxDataLength:this.maxIdentifyMessageSize??b8}).pb(zi).read(s);await n.close(s),await this.#e(t.remotePeer,o)}catch(s){pr.error("received invalid message",s),n.abort(s);return}pr("handled push from %p",t.remotePeer)}async#e(e,t){if(pr("received identify from %p",e),t==null)throw new Error("Message was null or undefined");let n={addresses:t.listenAddrs.map(i=>({isCertified:!1,multiaddr:oe(i)})),protocols:t.protocols,metadata:new Map,peerRecordEnvelope:t.signedPeerRecord},s;if(t.signedPeerRecord!=null){pr("received signedPeerRecord in push from %p",e);let i=t.signedPeerRecord,o=await yn.openAndCertify(i,Qr.DOMAIN),a=Qr.createFromProtobuf(o.payload);if(!a.peerId.equals(o.peerId))throw new Error("signing key does not match PeerId in the PeerRecord");if(!e.equals(a.peerId))throw new Error("signing key does not match remote PeerId");let c;try{c=await this.peerStore.get(a.peerId)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}if(c!=null&&(n.metadata=c.metadata,c.peerRecordEnvelope!=null)){let l=await yn.createFromProtobuf(c.peerRecordEnvelope),u=Qr.createFromProtobuf(l.payload);u.seqNumber>=a.seqNumber&&(pr("sequence number was lower or equal to existing sequence number - stored: %d received: %d",u.seqNumber,a.seqNumber),a=u,i=c.peerRecordEnvelope)}n.peerRecordEnvelope=i,n.addresses=a.multiaddrs.map(l=>({isCertified:!0,multiaddr:l})),s={seq:a.seqNumber,addresses:a.multiaddrs}}else pr("%p did not send a signed peer record",e);return t.agentVersion!=null&&n.metadata.set("AgentVersion",Q(t.agentVersion)),t.protocolVersion!=null&&n.metadata.set("ProtocolVersion",Q(t.protocolVersion)),await this.peerStore.patch(e,n),s}};function Wz(r){if(r!=null&&r.length>0)try{return oe(r)}catch{}}function lT(r={}){return e=>new Vd(e,r)}var uT="1.0.0",fT="ping",hT="ipfs";var Rc=k("libp2p:ping"),E8=class{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnTransientConnection;constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??hT}/${fT}/${uT}`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnTransientConnection=t.runOnTransientConnection??!0}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){Rc("incoming ping from %p",e.connection.remotePeer);let{stream:t}=e,n=Date.now();Ie(t,t).catch(s=>{Rc.error("incoming ping from %p failed with error",e.connection.remotePeer,s)}).finally(()=>{let s=Date.now()-n;Rc("incoming ping from %p complete in %dms",e.connection.remotePeer,s)})}async ping(e,t={}){Rc("pinging %p",e);let n=Date.now(),s=Pr(32),i=await this.components.connectionManager.openConnection(e,t),o,a=()=>{};t.signal=t.signal??AbortSignal.timeout(this.timeout);try{o=await i.newStream(this.protocol,{...t,runOnTransientConnection:this.runOnTransientConnection}),a=()=>{o?.abort(new b("ping timeout",H.ERR_TIMEOUT))},t.signal.addEventListener("abort",a,{once:!0});let c=await Ie([s],o,async u=>Hn(u)),l=Date.now()-n;if(c==null)throw new b(`Did not receive a ping ack after ${l}ms`,H.ERR_WRONG_PING_ACK);if(!me(s,c.subarray()))throw new b(`Received wrong ping ack after ${l}ms`,H.ERR_WRONG_PING_ACK);return Rc("ping %p complete in %dms",i.remotePeer,l),l}catch(c){throw Rc.error("error while pinging %p",i.remotePeer,c),o?.abort(c),c}finally{t.signal.removeEventListener("abort",a),o!=null&&await o.close()}}};function dT(r={}){return e=>new E8(e,r)}var pT={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function mT(){return{addresses:{listen:["/webrtc"]},transports:[g8({discoverRelays:1}),MR(),BR(),_I(),EI()],connectionEncryption:[rc()],streamMuxers:[Bv(),$_()],peerDiscovery:[Yv(pT)],contentRouters:[t_("https://cid.contact")],services:{identify:lT(),autoNAT:qI(),pubsub:Yx(),dcutr:rT(),dht:N_({clientMode:!0,validators:{ipns:UI},selectors:{ipns:MI}}),ping:dT()}}}async function gT(r,e){let t=mT();return e=e??{},cx({datastore:r,...t,...e,start:!1})}var yT="2.0.3",bT="helia";var jz=k("helia");async function Zz(r={}){let e=r.datastore??new Yi,t=r.blockstore??new Pc,n;Jz(r.libp2p)?n=r.libp2p:n=await gT(e,r.libp2p);let s=new D0({...r,datastore:e,blockstore:t,libp2p:n});return r.start!==!1&&await s.start(),e$(s),s}function Jz(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}function e$(r){try{if(r.libp2p.services.identify.host.agentVersion.match(/js-libp2p\/\d+\.\d+\.\d+\sUserAgent=/)==null)return;r.libp2p.services.identify.host.agentVersion=`${bT}/${yT} ${r.libp2p.services.identify.host.agentVersion}`}catch(e){jz.error("could not add Helia to agent version",e)}}return vu(t$);})();
/*! Bundled license information:

@noble/hashes/esm/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/modular.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/curve.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/edwards.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/montgomery.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/abstract/weierstrass.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/_shortw_utils.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/esm/secp256k1.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/esm/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)

@libp2p/webtransport/dist/src/index.js:
  (*! TODO unclear how to add backpressure here? *)
*/
return Helia}));
